<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_hcd_queue.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>dwc_otg_hcd_queue.c</h1><a href="dwc__otg__hcd__queue_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/* ==========================================================================</span>
00002 <span class="comment"> * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_hcd_queue.c $</span>
00003 <span class="comment"> * $Revision: #44 $</span>
00004 <span class="comment"> * $Date: 2011/10/26 $</span>
00005 <span class="comment"> * $Change: 1873028 $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
00008 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
00009 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
00010 <span class="comment"> * </span>
00011 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
00012 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
00013 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
00014 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
00015 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
00016 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
00017 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
00018 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
00019 <span class="comment"> * below, then you are not authorized to use the Software.</span>
00020 <span class="comment"> * </span>
00021 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
00022 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
00025 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
00026 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
00027 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
00028 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
00031 <span class="comment"> * DAMAGE.</span>
00032 <span class="comment"> * ========================================================================== */</span>
00033 <span class="preprocessor">#ifndef DWC_DEVICE_ONLY</span>
00034 <span class="preprocessor"></span>
00042 <span class="preprocessor">#include "<a class="code" href="dwc__otg__hcd_8h.html">dwc_otg_hcd.h</a>"</span>
00043 <span class="preprocessor">#include "<a class="code" href="dwc__otg__regs_8h.html">dwc_otg_regs.h</a>"</span>
00044 
<a name="l00053"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a6">00053</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a6">dwc_otg_hcd_qh_free</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
00054 {
00055         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd, *qtd_tmp;
00056 
00057         <span class="comment">/* Free each QTD in the QTD list */</span>
00058         DWC_SPINLOCK(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>);
00059         DWC_CIRCLEQ_FOREACH_SAFE(qtd, qtd_tmp, &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>, qtd_list_entry) {
00060                 DWC_CIRCLEQ_REMOVE(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>, qtd, qtd_list_entry);
00061                 <a class="code" href="dwc__otg__hcd_8h.html#a57">dwc_otg_hcd_qtd_free</a>(qtd);
00062         }
00063 
00064         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
00065                 <a class="code" href="dwc__otg__hcd__ddma_8c.html#a19">dwc_otg_hcd_qh_free_ddma</a>(hcd, qh);
00066         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o9">dw_align_buf</a>) {
00067                 uint32_t buf_size;
00068                 <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a> == UE_ISOCHRONOUS) {
00069                         buf_size = 4096;
00070                 } <span class="keywordflow">else</span> {
00071                         buf_size = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o16">max_transfer_size</a>;
00072                 }
00073                 DWC_DMA_FREE(buf_size, qh-&gt;<a class="code" href="structdwc__otg__qh.html#o9">dw_align_buf</a>, qh-&gt;<a class="code" href="structdwc__otg__qh.html#o10">dw_align_buf_dma</a>);
00074         }
00075 
00076         DWC_FREE(qh);
00077         DWC_SPINUNLOCK(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>);
00078         <span class="keywordflow">return</span>;
00079 }
00080 
00081 <span class="preprocessor">#define BitStuffTime(bytecount)  ((8 * 7* bytecount) / 6)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#define HS_HOST_DELAY           5       </span><span class="comment">/* nanoseconds */</span>
00083 <span class="preprocessor">#define FS_LS_HOST_DELAY        1000    </span><span class="comment">/* nanoseconds */</span>
00084 <span class="preprocessor">#define HUB_LS_SETUP            333     </span><span class="comment">/* nanoseconds */</span>
00085 <span class="preprocessor">#define NS_TO_US(ns)            ((ns + 500) / 1000)</span>
00086 <span class="preprocessor"></span>                                <span class="comment">/* convert &amp; round nanoseconds to microseconds */</span>
00087 
00088 <span class="keyword">static</span> uint32_t calc_bus_time(<span class="keywordtype">int</span> speed, <span class="keywordtype">int</span> is_in, <span class="keywordtype">int</span> is_isoc, <span class="keywordtype">int</span> bytecount)
00089 {
00090         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> retval;
00091 
00092         <span class="keywordflow">switch</span> (speed) {
00093         <span class="keywordflow">case</span> USB_SPEED_HIGH:
00094                 <span class="keywordflow">if</span> (is_isoc) {
00095                         retval =
00096                             ((38 * 8 * 2083) +
00097                              (2083 * (3 + BitStuffTime(bytecount)))) / 1000 +
00098                             HS_HOST_DELAY;
00099                 } <span class="keywordflow">else</span> {
00100                         retval =
00101                             ((55 * 8 * 2083) +
00102                              (2083 * (3 + BitStuffTime(bytecount)))) / 1000 +
00103                             HS_HOST_DELAY;
00104                 }
00105                 <span class="keywordflow">break</span>;
00106         <span class="keywordflow">case</span> USB_SPEED_FULL:
00107                 <span class="keywordflow">if</span> (is_isoc) {
00108                         retval =
00109                             (8354 * (31 + 10 * BitStuffTime(bytecount))) / 1000;
00110                         <span class="keywordflow">if</span> (is_in) {
00111                                 retval = 7268 + FS_LS_HOST_DELAY + retval;
00112                         } <span class="keywordflow">else</span> {
00113                                 retval = 6265 + FS_LS_HOST_DELAY + retval;
00114                         }
00115                 } <span class="keywordflow">else</span> {
00116                         retval =
00117                             (8354 * (31 + 10 * BitStuffTime(bytecount))) / 1000;
00118                         retval = 9107 + FS_LS_HOST_DELAY + retval;
00119                 }
00120                 <span class="keywordflow">break</span>;
00121         <span class="keywordflow">case</span> USB_SPEED_LOW:
00122                 <span class="keywordflow">if</span> (is_in) {
00123                         retval =
00124                             (67667 * (31 + 10 * BitStuffTime(bytecount))) /
00125                             1000;
00126                         retval =
00127                             64060 + (2 * HUB_LS_SETUP) + FS_LS_HOST_DELAY +
00128                             retval;
00129                 } <span class="keywordflow">else</span> {
00130                         retval =
00131                             (66700 * (31 + 10 * BitStuffTime(bytecount))) /
00132                             1000;
00133                         retval =
00134                             64107 + (2 * HUB_LS_SETUP) + FS_LS_HOST_DELAY +
00135                             retval;
00136                 }
00137                 <span class="keywordflow">break</span>;
00138         <span class="keywordflow">default</span>:
00139                 DWC_WARN(<span class="stringliteral">"Unknown device speed\n"</span>);
00140                 retval = -1;
00141         }
00142 
00143         <span class="keywordflow">return</span> NS_TO_US(retval);
00144 }
00145 
<a name="l00154"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a5">00154</a> <span class="preprocessor">#define SCHEDULE_SLOP 10</span>
<a name="l00155"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a8">00155</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a8">qh_init</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh, dwc_otg_hcd_urb_t * urb)
00156 {
00157         <span class="keywordtype">char</span> *speed, *type;
00158         <span class="keywordtype">int</span> dev_speed;
00159         uint32_t hub_addr, hub_port;
00160 
00161         dwc_memset(qh, 0, <span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>));
00162 
00163         <span class="comment">/* Initialize QH */</span>
00164         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a> = dwc_otg_hcd_get_pipe_type(&amp;urb-&gt;pipe_info);
00165         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o1">ep_is_in</a> = dwc_otg_hcd_is_pipe_in(&amp;urb-&gt;pipe_info) ? 1 : 0;
00166 
00167         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o4">data_toggle</a> = DWC_OTG_HC_PID_DATA0;
00168         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o2">maxp</a> = dwc_otg_hcd_get_mps(&amp;urb-&gt;pipe_info);
00169         DWC_CIRCLEQ_INIT(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>);
00170         DWC_LIST_INIT(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
00171         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a> = NULL;
00172 
00173         <span class="comment">/* FS/LS Enpoint on HS Hub </span>
00174 <span class="comment">         * NOT virtual root hub */</span>
00175         dev_speed = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a>-&gt;speed(hcd, urb-&gt;<a class="code" href="structdwc__otg__hcd.html#o23">priv</a>);
00176 
00177         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a>-&gt;hub_info(hcd, urb-&gt;<a class="code" href="structdwc__otg__hcd.html#o23">priv</a>, &amp;hub_addr, &amp;hub_port);
00178         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o8">do_split</a> = 0;
00179 
00180         <span class="keywordflow">if</span> (((dev_speed == USB_SPEED_LOW) ||
00181              (dev_speed == USB_SPEED_FULL)) &amp;&amp;
00182             (hub_addr != 0 &amp;&amp; hub_addr != 1)) {
00183                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>,
00184                             <span class="stringliteral">"QH init: EP %d: TT found at hub addr %d, for port %d\n"</span>,
00185                             dwc_otg_hcd_get_ep_num(&amp;urb-&gt;pipe_info), hub_addr,
00186                             hub_port);
00187                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#o8">do_split</a> = 1;
00188         }
00189 
00190         <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a> == UE_INTERRUPT || qh-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a> == UE_ISOCHRONOUS) {
00191                 <span class="comment">/* Compute scheduling parameters once and save them. */</span>
00192                 <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt;
00193 
00195                 <span class="keywordtype">int</span> bytecount =
00196                     <a class="code" href="dwc__otg__hcd_8h.html#a4">dwc_hb_mult</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#o2">maxp</a>) * <a class="code" href="dwc__otg__hcd_8h.html#a5">dwc_max_packet</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#o2">maxp</a>);
00197 
00198                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_0">usecs</a> =
00199                     calc_bus_time((qh-&gt;<a class="code" href="structdwc__otg__qh.html#o8">do_split</a> ? USB_SPEED_HIGH : dev_speed),
00200                                   qh-&gt;<a class="code" href="structdwc__otg__qh.html#o1">ep_is_in</a>, (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a> == UE_ISOCHRONOUS),
00201                                   bytecount);
00202                 <span class="comment">/* Start in a slightly future (micro)frame. */</span>
00203                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> = <a class="code" href="dwc__otg__hcd_8h.html#a67">dwc_frame_num_inc</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o12">frame_number</a>,
00204                                                     <a class="code" href="dwc__otg__hcd__queue_8c.html#a5">SCHEDULE_SLOP</a>);
00205                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_1">interval</a> = urb-&gt;<a class="code" href="structdwc__otg__qh.html#z38_1">interval</a>;
00206 
00207 <span class="preprocessor">#if 0</span>
00208 <span class="preprocessor"></span>                <span class="comment">/* Increase interrupt polling rate for debugging. */</span>
00209                 <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a> == UE_INTERRUPT) {
00210                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_1">interval</a> = 8;
00211                 }
00212 <span class="preprocessor">#endif</span>
00213 <span class="preprocessor"></span>                hprt.<a class="code" href="unionhprt0__data.html#o0">d32</a> = DWC_READ_REG32(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>);
00214                 <span class="keywordflow">if</span> ((hprt.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o14">prtspd</a> == DWC_HPRT0_PRTSPD_HIGH_SPEED) &amp;&amp;
00215                     ((dev_speed == USB_SPEED_LOW) ||
00216                      (dev_speed == USB_SPEED_FULL))) {
00217                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_1">interval</a> *= 8;
00218                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> |= 0x7;
00219                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_3">start_split_frame</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a>;
00220                 }
00221 
00222         }
00223 
00224         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD QH Initialized\n"</span>);
00225         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"DWC OTG HCD QH  - qh = %p\n"</span>, qh);
00226         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"DWC OTG HCD QH  - Device Address = %d\n"</span>,
00227                     dwc_otg_hcd_get_dev_addr(&amp;urb-&gt;pipe_info));
00228         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"DWC OTG HCD QH  - Endpoint %d, %s\n"</span>,
00229                     dwc_otg_hcd_get_ep_num(&amp;urb-&gt;pipe_info),
00230                     dwc_otg_hcd_is_pipe_in(&amp;urb-&gt;pipe_info) ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>);
00231         <span class="keywordflow">switch</span> (dev_speed) {
00232         <span class="keywordflow">case</span> USB_SPEED_LOW:
00233                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#o3">dev_speed</a> = DWC_OTG_EP_SPEED_LOW;
00234                 speed = <span class="stringliteral">"low"</span>;
00235                 <span class="keywordflow">break</span>;
00236         <span class="keywordflow">case</span> USB_SPEED_FULL:
00237                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#o3">dev_speed</a> = DWC_OTG_EP_SPEED_FULL;
00238                 speed = <span class="stringliteral">"full"</span>;
00239                 <span class="keywordflow">break</span>;
00240         <span class="keywordflow">case</span> USB_SPEED_HIGH:
00241                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#o3">dev_speed</a> = DWC_OTG_EP_SPEED_HIGH;
00242                 speed = <span class="stringliteral">"high"</span>;
00243                 <span class="keywordflow">break</span>;
00244         <span class="keywordflow">default</span>:
00245                 speed = <span class="stringliteral">"?"</span>;
00246                 <span class="keywordflow">break</span>;
00247         }
00248         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"DWC OTG HCD QH  - Speed = %s\n"</span>, speed);
00249 
00250         <span class="keywordflow">switch</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a>) {
00251         <span class="keywordflow">case</span> UE_ISOCHRONOUS:
00252                 type = <span class="stringliteral">"isochronous"</span>;
00253                 <span class="keywordflow">break</span>;
00254         <span class="keywordflow">case</span> UE_INTERRUPT:
00255                 type = <span class="stringliteral">"interrupt"</span>;
00256                 <span class="keywordflow">break</span>;
00257         <span class="keywordflow">case</span> UE_CONTROL:
00258                 type = <span class="stringliteral">"control"</span>;
00259                 <span class="keywordflow">break</span>;
00260         <span class="keywordflow">case</span> UE_BULK:
00261                 type = <span class="stringliteral">"bulk"</span>;
00262                 <span class="keywordflow">break</span>;
00263         <span class="keywordflow">default</span>:
00264                 type = <span class="stringliteral">"?"</span>;
00265                 <span class="keywordflow">break</span>;
00266         }
00267 
00268         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"DWC OTG HCD QH  - Type = %s\n"</span>, type);
00269 
00270 <span class="preprocessor">#ifdef DEBUG</span>
00271 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a> == UE_INTERRUPT) {
00272                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"DWC OTG HCD QH - usecs = %d\n"</span>,
00273                             qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_0">usecs</a>);
00274                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"DWC OTG HCD QH - interval = %d\n"</span>,
00275                             qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_1">interval</a>);
00276         }
00277 <span class="preprocessor">#endif</span>
00278 <span class="preprocessor"></span>
00279 }
00280 
<a name="l00290"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a9">00290</a> <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *<a class="code" href="dwc__otg__hcd__queue_8c.html#a9">dwc_otg_hcd_qh_create</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
00291                                     dwc_otg_hcd_urb_t * urb, <span class="keywordtype">int</span> atomic_alloc)
00292 {
00293         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
00294 
00295         <span class="comment">/* Allocate memory */</span>
00297         qh = <a class="code" href="dwc__otg__hcd_8h.html#a52">dwc_otg_hcd_qh_alloc</a>(atomic_alloc);
00298         <span class="keywordflow">if</span> (qh == NULL) {
00299                 DWC_ERROR(<span class="stringliteral">"qh allocation failed"</span>);
00300                 <span class="keywordflow">return</span> NULL;
00301         }
00302 
00303         <a class="code" href="dwc__otg__hcd__queue_8c.html#a8">qh_init</a>(hcd, qh, urb);
00304 
00305         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>
00306             &amp;&amp; (<a class="code" href="dwc__otg__hcd__ddma_8c.html#a18">dwc_otg_hcd_qh_init_ddma</a>(hcd, qh) &lt; 0)) {
00307                 <a class="code" href="dwc__otg__hcd__queue_8c.html#a6">dwc_otg_hcd_qh_free</a>(hcd, qh);
00308                 <span class="keywordflow">return</span> NULL;
00309         }
00310 
00311         <span class="keywordflow">return</span> qh;
00312 }
00313 
<a name="l00319"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a10">00319</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a10">periodic_channel_available</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
00320 {
00321         <span class="comment">/*</span>
00322 <span class="comment">         * Currently assuming that there is a dedicated host channnel for each</span>
00323 <span class="comment">         * periodic transaction plus at least one host channel for</span>
00324 <span class="comment">         * non-periodic transactions.</span>
00325 <span class="comment">         */</span>
00326         <span class="keywordtype">int</span> status;
00327         <span class="keywordtype">int</span> num_channels;
00328 
00329         num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o18">host_channels</a>;
00330         <span class="keywordflow">if</span> ((hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o15">periodic_channels</a> + hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o16">non_periodic_channels</a> &lt; num_channels)
00331             &amp;&amp; (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o15">periodic_channels</a> &lt; num_channels - 1)) {
00332                 status = 0;
00333         } <span class="keywordflow">else</span> {
00334                 DWC_INFO(<span class="stringliteral">"%s: Total channels: %d, Periodic: %d, Non-periodic: %d\n"</span>,
00335                         __func__, num_channels, hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o15">periodic_channels</a>, hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o16">non_periodic_channels</a>);    <span class="comment">//NOTICE</span>
00336                 status = -DWC_E_NO_SPACE;
00337         }
00338 
00339         <span class="keywordflow">return</span> status;
00340 }
00341 
<a name="l00352"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a11">00352</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a11">check_periodic_bandwidth</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
00353 {
00354         <span class="keywordtype">int</span> status;
00355         int16_t max_claimed_usecs;
00356 
00357         status = 0;
00358 
00359         <span class="keywordflow">if</span> ((qh-&gt;<a class="code" href="structdwc__otg__qh.html#o3">dev_speed</a> == DWC_OTG_EP_SPEED_HIGH) || qh-&gt;<a class="code" href="structdwc__otg__qh.html#o8">do_split</a>) {
00360                 <span class="comment">/*</span>
00361 <span class="comment">                 * High speed mode.</span>
00362 <span class="comment">                 * Max periodic usecs is 80% x 125 usec = 100 usec.</span>
00363 <span class="comment">                 */</span>
00364 
00365                 max_claimed_usecs = 100 - qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_0">usecs</a>;
00366         } <span class="keywordflow">else</span> {
00367                 <span class="comment">/*</span>
00368 <span class="comment">                 * Full speed mode.</span>
00369 <span class="comment">                 * Max periodic usecs is 90% x 1000 usec = 900 usec.</span>
00370 <span class="comment">                 */</span>
00371                 max_claimed_usecs = 900 - qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_0">usecs</a>;
00372         }
00373 
00374         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o11">periodic_usecs</a> &gt; max_claimed_usecs) {
00375                 DWC_INFO(<span class="stringliteral">"%s: already claimed usecs %d, required usecs %d\n"</span>, __func__, hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o11">periodic_usecs</a>, qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_0">usecs</a>);        <span class="comment">//NOTICE</span>
00376                 status = -DWC_E_NO_SPACE;
00377         }
00378 
00379         <span class="keywordflow">return</span> status;
00380 }
00381 
<a name="l00392"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a12">00392</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a12">check_max_xfer_size</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
00393 {
00394         <span class="keywordtype">int</span> status;
00395         uint32_t max_xfer_size;
00396         uint32_t max_channel_xfer_size;
00397 
00398         status = 0;
00399 
00400         max_xfer_size = <a class="code" href="dwc__otg__hcd_8h.html#a5">dwc_max_packet</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#o2">maxp</a>) * <a class="code" href="dwc__otg__hcd_8h.html#a4">dwc_hb_mult</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#o2">maxp</a>);
00401         max_channel_xfer_size = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o16">max_transfer_size</a>;
00402 
00403         <span class="keywordflow">if</span> (max_xfer_size &gt; max_channel_xfer_size) {
00404                 DWC_INFO(<span class="stringliteral">"%s: Periodic xfer length %d &gt; "</span> <span class="stringliteral">"max xfer length for channel %d\n"</span>,
00405                                 __func__, max_xfer_size, max_channel_xfer_size);        <span class="comment">//NOTICE</span>
00406                 status = -DWC_E_NO_SPACE;
00407         }
00408 
00409         <span class="keywordflow">return</span> status;
00410 }
00411 
<a name="l00421"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a13">00421</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a13">schedule_periodic</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
00422 {
00423         <span class="keywordtype">int</span> status = 0;
00424 
00425         status = <a class="code" href="dwc__otg__hcd__queue_8c.html#a10">periodic_channel_available</a>(hcd);
00426         <span class="keywordflow">if</span> (status) {
00427                 DWC_INFO(<span class="stringliteral">"%s: No host channel available for periodic "</span> <span class="stringliteral">"transfer.\n"</span>, __func__);        <span class="comment">//NOTICE</span>
00428                 <span class="keywordflow">return</span> status;
00429         }
00430 
00431         status = <a class="code" href="dwc__otg__hcd__queue_8c.html#a11">check_periodic_bandwidth</a>(hcd, qh);
00432         <span class="keywordflow">if</span> (status) {
00433                 DWC_INFO(<span class="stringliteral">"%s: Insufficient periodic bandwidth for "</span> <span class="stringliteral">"periodic transfer.\n"</span>, __func__);  <span class="comment">//NOTICE</span>
00434                 <span class="keywordflow">return</span> status;
00435         }
00436 
00437         status = <a class="code" href="dwc__otg__hcd__queue_8c.html#a12">check_max_xfer_size</a>(hcd, qh);
00438         <span class="keywordflow">if</span> (status) {
00439                 DWC_INFO(<span class="stringliteral">"%s: Channel max transfer size too small "</span> <span class="stringliteral">"for periodic transfer.\n"</span>, __func__);      <span class="comment">//NOTICE</span>
00440                 <span class="keywordflow">return</span> status;
00441         }
00442 
00443         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
00444                 <span class="comment">/* Don't rely on SOF and start in ready schedule */</span>
00445                 DWC_LIST_INSERT_TAIL(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o8">periodic_sched_ready</a>, &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
00446         }
00447         <span class="keywordflow">else</span> {
00448         <span class="comment">/* Always start in the inactive schedule. */</span>
00449         DWC_LIST_INSERT_TAIL(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o7">periodic_sched_inactive</a>, &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
00450         }
00451 
00452         <span class="comment">/* Reserve the periodic channel. */</span>
00453         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o15">periodic_channels</a>++;
00454 
00455         <span class="comment">/* Update claimed usecs per (micro)frame. */</span>
00456         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o11">periodic_usecs</a> += qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_0">usecs</a>;
00457 
00458         <span class="keywordflow">return</span> status;
00459 }
00460 
<a name="l00468"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a14">00468</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a14">dwc_otg_hcd_qh_add</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
00469 {
00470         <span class="keywordtype">int</span> status = 0;
00471         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.d32 = 0 };
00472 
00473         <span class="keywordflow">if</span> (!DWC_LIST_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>)) {
00474                 <span class="comment">/* QH already in a schedule. */</span>
00475                 <span class="keywordflow">return</span> status;
00476         }
00477 
00478         <span class="comment">/* Add the new QH to the appropriate schedule */</span>
00479         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd_8h.html#a3">dwc_qh_is_non_per</a>(qh)) {
00480                 <span class="comment">/* Always start in the inactive schedule. */</span>
00481                 DWC_LIST_INSERT_TAIL(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o4">non_periodic_sched_inactive</a>,
00482                                      &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
00483         } <span class="keywordflow">else</span> {
00484                 status = <a class="code" href="dwc__otg__hcd__queue_8c.html#a13">schedule_periodic</a>(hcd, qh);
00485                 <span class="keywordflow">if</span> ( !hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o13">periodic_qh_count</a> ) {
00486                         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o4">sofintr</a> = 1;
00487                         DWC_MODIFY_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>,
00488                                                                 intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
00489                 }
00490                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o13">periodic_qh_count</a>++;
00491         }
00492 
00493         <span class="keywordflow">return</span> status;
00494 }
00495 
<a name="l00502"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a15">00502</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a15">deschedule_periodic</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
00503 {
00504         DWC_LIST_REMOVE_INIT(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
00505 
00506         <span class="comment">/* Release the periodic channel reservation. */</span>
00507         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o15">periodic_channels</a>--;
00508 
00509         <span class="comment">/* Update claimed usecs per (micro)frame. */</span>
00510         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o11">periodic_usecs</a> -= qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_0">usecs</a>;
00511 }
00512 
<a name="l00519"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a16">00519</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a16">dwc_otg_hcd_qh_remove</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
00520 {
00521         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.d32 = 0 };
00522 
00523         <span class="keywordflow">if</span> (DWC_LIST_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>)) {
00524                 <span class="comment">/* QH is not in a schedule. */</span>
00525                 <span class="keywordflow">return</span>;
00526         }
00527 
00528         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd_8h.html#a3">dwc_qh_is_non_per</a>(qh)) {
00529                 <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a> == &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>) {
00530                         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a> =
00531                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a>-&gt;next;
00532                 }
00533                 DWC_LIST_REMOVE_INIT(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
00534         } <span class="keywordflow">else</span> {
00535                 <a class="code" href="dwc__otg__hcd__queue_8c.html#a15">deschedule_periodic</a>(hcd, qh);
00536                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o13">periodic_qh_count</a>--;
00537                 <span class="keywordflow">if</span>( !hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o13">periodic_qh_count</a> ) {
00538                         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o4">sofintr</a> = 1;
00539                                 DWC_MODIFY_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>,
00540                                                                         intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
00541                 }
00542         }
00543 }
00544 
<a name="l00558"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a17">00558</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a17">dwc_otg_hcd_qh_deactivate</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh,
00559                                <span class="keywordtype">int</span> sched_next_periodic_split)
00560 {       
00561         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd_8h.html#a3">dwc_qh_is_non_per</a>(qh)) {
00562                 <a class="code" href="dwc__otg__hcd__queue_8c.html#a16">dwc_otg_hcd_qh_remove</a>(hcd, qh);
00563                 <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>)) {
00564                         <span class="comment">/* Add back to inactive non-periodic schedule. */</span>
00565                         <a class="code" href="dwc__otg__hcd__queue_8c.html#a14">dwc_otg_hcd_qh_add</a>(hcd, qh);
00566                 }
00567         } <span class="keywordflow">else</span> {
00568                 uint16_t frame_number = <a class="code" href="dwc__otg__hcd__if_8h.html#a22">dwc_otg_hcd_get_frame_number</a>(hcd);
00569 
00570                 <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o8">do_split</a>) {
00571                         <span class="comment">/* Schedule the next continuing periodic split transfer */</span>
00572                         <span class="keywordflow">if</span> (sched_next_periodic_split) {
00573 
00574                                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> = frame_number;
00575                                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd_8h.html#a65">dwc_frame_num_le</a>(frame_number,
00576                                                      dwc_frame_num_inc
00577                                                      (qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_3">start_split_frame</a>,
00578                                                       1))) {
00579                                         <span class="comment">/*</span>
00580 <span class="comment">                                         * Allow one frame to elapse after start</span>
00581 <span class="comment">                                         * split microframe before scheduling</span>
00582 <span class="comment">                                         * complete split, but DONT if we are</span>
00583 <span class="comment">                                         * doing the next start split in the</span>
00584 <span class="comment">                                         * same frame for an ISOC out.</span>
00585 <span class="comment">                                         */</span>
00586                                         <span class="keywordflow">if</span> ((qh-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a> != UE_ISOCHRONOUS) ||
00587                                             (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o1">ep_is_in</a> != 0)) {
00588                                                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> =
00589                                                     <a class="code" href="dwc__otg__hcd_8h.html#a67">dwc_frame_num_inc</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a>, 1);
00590                                         }
00591                                 }
00592                         } <span class="keywordflow">else</span> {
00593                                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> =
00594                                     <a class="code" href="dwc__otg__hcd_8h.html#a67">dwc_frame_num_inc</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_3">start_split_frame</a>,
00595                                                       qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_1">interval</a>);
00596                                 <span class="keywordflow">if</span> (dwc_frame_num_le
00597                                     (qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a>, frame_number)) {
00598                                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> = frame_number;
00599                                 }
00600                                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> |= 0x7;
00601                                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_3">start_split_frame</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a>;
00602                         }
00603                 } <span class="keywordflow">else</span> {
00604                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> =
00605                             <a class="code" href="dwc__otg__hcd_8h.html#a67">dwc_frame_num_inc</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a>, qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_1">interval</a>);
00606                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd_8h.html#a65">dwc_frame_num_le</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a>, frame_number)) {
00607                                 qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> = frame_number;
00608                         }
00609                 }
00610 
00611                 <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>)) {
00612                         <a class="code" href="dwc__otg__hcd__queue_8c.html#a16">dwc_otg_hcd_qh_remove</a>(hcd, qh);
00613                 } <span class="keywordflow">else</span> {
00614                         <span class="comment">/*</span>
00615 <span class="comment">                         * Remove from periodic_sched_queued and move to</span>
00616 <span class="comment">                         * appropriate queue.</span>
00617 <span class="comment">                         */</span>
00618                         <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_2">sched_frame</a> == frame_number) {
00619                                 DWC_LIST_MOVE_HEAD(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o8">periodic_sched_ready</a>,
00620                                                    &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
00621                         } <span class="keywordflow">else</span> {
00622                                 DWC_LIST_MOVE_HEAD
00623                                     (&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o7">periodic_sched_inactive</a>,
00624                                      &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
00625                         }
00626                 }
00627         }
00628 }
00629 
<a name="l00638"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a18">00638</a> <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *<a class="code" href="dwc__otg__hcd__queue_8c.html#a18">dwc_otg_hcd_qtd_create</a>(dwc_otg_hcd_urb_t * urb, <span class="keywordtype">int</span> atomic_alloc)
00639 {
00640         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd;
00641 
00642         qtd = <a class="code" href="dwc__otg__hcd_8h.html#a56">dwc_otg_hcd_qtd_alloc</a>(atomic_alloc);
00643         <span class="keywordflow">if</span> (qtd == NULL) {
00644                 <span class="keywordflow">return</span> NULL;
00645         }
00646 
00647         <a class="code" href="dwc__otg__hcd__queue_8c.html#a19">dwc_otg_hcd_qtd_init</a>(qtd, urb);
00648         <span class="keywordflow">return</span> qtd;
00649 }
00650 
<a name="l00656"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a19">00656</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a19">dwc_otg_hcd_qtd_init</a>(<a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> * qtd, dwc_otg_hcd_urb_t * urb)
00657 {
00658         dwc_memset(qtd, 0, <span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a>));
00659         qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o8">urb</a> = urb;
00660         <span class="keywordflow">if</span> (dwc_otg_hcd_get_pipe_type(&amp;urb-&gt;pipe_info) == UE_CONTROL) {
00661                 <span class="comment">/*</span>
00662 <span class="comment">                 * The only time the QTD data toggle is used is on the data</span>
00663 <span class="comment">                 * phase of control transfers. This phase always starts with</span>
00664 <span class="comment">                 * DATA1.</span>
00665 <span class="comment">                 */</span>
00666                 qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o0">data_toggle</a> = DWC_OTG_HC_PID_DATA1;
00667                 qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o1">control_phase</a> = DWC_OTG_CONTROL_SETUP;
00668         }
00669 
00670         <span class="comment">/* start split */</span>
00671         qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o2">complete_split</a> = 0;
00672         qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o6">isoc_split_pos</a> = DWC_HCSPLIT_XACTPOS_ALL;
00673         qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o7">isoc_split_offset</a> = 0;
00674         qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o10">in_process</a> = 0;
00675 
00676         <span class="comment">/* Store the qtd ptr in the urb to reference what QTD. */</span>
00677         urb-&gt;qtd = qtd;
00678         <span class="keywordflow">return</span>;
00679 }
00680 
<a name="l00694"></a><a class="code" href="dwc__otg__hcd__queue_8c.html#a20">00694</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__queue_8c.html#a20">dwc_otg_hcd_qtd_add</a>(<a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> * qtd,
00695                         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> ** qh, <span class="keywordtype">int</span> atomic_alloc)
00696 {
00697         <span class="keywordtype">int</span> retval = 0;
00698         dwc_irqflags_t flags;
00699 
00700         dwc_otg_hcd_urb_t *urb = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o8">urb</a>;
00701 
00702         <span class="comment">/*</span>
00703 <span class="comment">         * Get the QH which holds the QTD-list to insert to. Create QH if it</span>
00704 <span class="comment">         * doesn't exist.</span>
00705 <span class="comment">         */</span>
00706         <span class="keywordflow">if</span> (*qh == NULL) {
00707                 *qh = <a class="code" href="dwc__otg__hcd__queue_8c.html#a9">dwc_otg_hcd_qh_create</a>(hcd, urb, atomic_alloc);
00708                 <span class="keywordflow">if</span> (*qh == NULL) {
00709                         retval = -1;
00710                         <span class="keywordflow">goto</span> done;
00711                 }
00712         }
00713         DWC_SPINLOCK_IRQSAVE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, &amp;flags);
00714         retval = <a class="code" href="dwc__otg__hcd__queue_8c.html#a14">dwc_otg_hcd_qh_add</a>(hcd, *qh);
00715         <span class="keywordflow">if</span> (retval == 0) {
00716                 DWC_CIRCLEQ_INSERT_TAIL(&amp;((*qh)-&gt;qtd_list), qtd,
00717                                         qtd_list_entry);
00718         }
00719         DWC_SPINUNLOCK_IRQRESTORE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, flags);
00720 
00721 done:
00722 
00723         <span class="keywordflow">return</span> retval;
00724 }
00725 
00726 <span class="preprocessor">#endif </span><span class="comment">/* DWC_DEVICE_ONLY */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 27 03:56:37 2011 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
