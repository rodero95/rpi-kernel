<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_adp.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>dwc_otg_adp.c</h1><a href="dwc__otg__adp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/* ==========================================================================</span>
00002 <span class="comment"> * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_adp.c $</span>
00003 <span class="comment"> * $Revision: #12 $</span>
00004 <span class="comment"> * $Date: 2011/10/26 $</span>
00005 <span class="comment"> * $Change: 1873028 $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
00008 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
00009 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
00012 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
00013 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
00014 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
00015 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
00016 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
00017 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
00018 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
00019 <span class="comment"> * below, then you are not authorized to use the Software.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
00022 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
00025 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
00026 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
00027 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
00028 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
00031 <span class="comment"> * DAMAGE.</span>
00032 <span class="comment"> * ========================================================================== */</span>
00033 
00034 <span class="preprocessor">#include "dwc_os.h"</span>
00035 <span class="preprocessor">#include "<a class="code" href="dwc__otg__regs_8h.html">dwc_otg_regs.h</a>"</span>
00036 <span class="preprocessor">#include "<a class="code" href="dwc__otg__cil_8h.html">dwc_otg_cil.h</a>"</span>
00037 <span class="preprocessor">#include "<a class="code" href="dwc__otg__adp_8h.html">dwc_otg_adp.h</a>"</span>
00038 
<a name="l00046"></a><a class="code" href="dwc__otg__adp_8h.html#a4">00046</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, uint32_t value)
00047 {
00048         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl;
00049 
00050         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = value;
00051         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o15">ar</a> = 0x2;
00052 
00053         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o24">adpctl</a>, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00054 
00055         <span class="keywordflow">while</span> (adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o15">ar</a>) {
00056                 adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o24">adpctl</a>);
00057         }
00058 
00059 }
00060 
<a name="l00064"></a><a class="code" href="dwc__otg__adp_8h.html#a5">00064</a> uint32_t <a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00065 {
00066         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl;
00067 
00068         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = 0;
00069         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o15">ar</a> = 0x1;
00070 
00071         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o24">adpctl</a>, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00072 
00073         <span class="keywordflow">while</span> (adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o15">ar</a>) {
00074                 adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o24">adpctl</a>);
00075         }
00076 
00077         <span class="keywordflow">return</span> adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>;
00078 }
00079 
<a name="l00083"></a><a class="code" href="dwc__otg__adp_8c.html#a2">00083</a> uint32_t <a class="code" href="dwc__otg__adp_8c.html#a2">dwc_otg_adp_read_reg_filter</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00084 {
00085         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl;
00086 
00087         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(core_if);
00088         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o11">adp_tmout_int</a> = 0;
00089         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o9">adp_prb_int</a> = 0;
00090         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o11">adp_tmout_int</a> = 0;
00091                 
00092         <span class="keywordflow">return</span> adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>;
00093 }
00094 
<a name="l00098"></a><a class="code" href="dwc__otg__adp_8c.html#a3">00098</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__adp_8c.html#a3">dwc_otg_adp_modify_reg</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, uint32_t clr,
00099                             uint32_t set)
00100 {
00101         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if,
00102                               (<a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(core_if) &amp; (~clr)) | set);
00103 }
00104 
00105 <span class="keyword">static</span> <span class="keywordtype">void</span> adp_sense_timeout(<span class="keywordtype">void</span> *ptr)
00106 {
00107         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = (<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *) ptr;
00108         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer_started = 0;
00109         DWC_PRINTF(<span class="stringliteral">"ADP SENSE TIMEOUT\n"</span>);
00110         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a>) {
00111                 <a class="code" href="dwc__otg__adp_8h.html#a9">dwc_otg_adp_sense_stop</a>(core_if);
00112                 <a class="code" href="dwc__otg__adp_8h.html#a6">dwc_otg_adp_probe_start</a>(core_if);
00113         }
00114 }
00115 
<a name="l00119"></a><a class="code" href="dwc__otg__adp_8c.html#a5">00119</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__adp_8c.html#a5">adp_vbuson_timeout</a>(<span class="keywordtype">void</span> *ptr)
00120 {
00121         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn;
00122         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = (<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *) ptr;
00123         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0 = {.d32 = 0 };
00124         <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.d32 = 0 };
00125         DWC_PRINTF(<span class="stringliteral">"%s: 1.1 seconds expire after turning on VBUS\n"</span>,__FUNCTION__);
00126         <span class="keywordflow">if</span> (core_if) {
00127                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer_started = 0;
00128                 <span class="comment">/* Turn off vbus */</span>
00129                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 1;
00130                 DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>, 0);
00131                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00132 
00133                 <span class="comment">/* Power off the core */</span>
00134                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00135                         <span class="comment">/* Enable Wakeup Logic */</span>
00136 <span class="comment">//                      gpwrdn.b.wkupactiv = 1;</span>
00137                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 0;
00138                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00139                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o4">pwrdnclmp</a> = 1;
00140                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0,
00141                                          gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00142 
00143                         <span class="comment">/* Suspend the Phy Clock */</span>
00144                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
00145                         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0, pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
00146 
00147                         <span class="comment">/* Switch on VDD */</span>
00148 <span class="comment">//                      gpwrdn.b.wkupactiv = 1;</span>
00149                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00150                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00151                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o4">pwrdnclmp</a> = 1;
00152                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0,
00153                                          gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00154                 } <span class="keywordflow">else</span> {
00155                         <span class="comment">/* Enable Power Down Logic */</span>
00156                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00157                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00158                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00159                 }
00160 
00161                 <span class="comment">/* Power off the core */</span>
00162                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00163                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00164                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00165                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>,
00166                                          gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00167                 }
00168 
00169                 <span class="comment">/* Unmask SRP detected interrupt from Power Down Logic */</span>
00170                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00171                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o17">srp_det_msk</a> = 1;
00172                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00173 
00174                 <a class="code" href="dwc__otg__adp_8h.html#a6">dwc_otg_adp_probe_start</a>(core_if);
00175                 <a class="code" href="dwc__otg__core__if_8h.html#a161">dwc_otg_dump_global_registers</a>(core_if);
00176                 <a class="code" href="dwc__otg__core__if_8h.html#a160">dwc_otg_dump_host_registers</a>(core_if);
00177         }
00178 
00179 }
00180 
<a name="l00187"></a><a class="code" href="dwc__otg__adp_8c.html#a6">00187</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__adp_8c.html#a6">dwc_otg_adp_vbuson_timer_start</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00188 {
00189         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer_started = 1;
00190         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer)
00191         {
00192                 DWC_PRINTF(<span class="stringliteral">"SCHEDULING VBUSON TIMER\n"</span>);
00193                 <span class="comment">/* 1.1 secs + 60ms necessary for cil_hcd_start*/</span>
00194                 DWC_TIMER_SCHEDULE(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer, 1160);
00195         } <span class="keywordflow">else</span> {
00196                 DWC_WARN(<span class="stringliteral">"VBUSON_TIMER = %p\n"</span>,core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer);
00197         }
00198 }
00199 
00200 <span class="preprocessor">#if 0</span>
00201 <span class="preprocessor"></span>
00205 <span class="keyword">static</span> <span class="keywordtype">void</span> mask_all_interrupts(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00206 {
00207         <span class="keywordtype">int</span> i;
00208         <a class="code" href="uniongahbcfg__data.html">gahbcfg_data_t</a> ahbcfg = {.d32 = 0 };
00209 
00210         <span class="comment">/* Mask Host Interrupts */</span>
00211 
00212         <span class="comment">/* Clear and disable HCINTs */</span>
00213         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o18">host_channels</a>; i++) {
00214                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o2">hc_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o3">hcintmsk</a>, 0);
00215                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o2">hc_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, 0xFFFFFFFF);
00216 
00217         }
00218 
00219         <span class="comment">/* Clear and disable HAINT */</span>
00220         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o0">host_global_regs</a>-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o6">haintmsk</a>, 0x0000);
00221         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o0">host_global_regs</a>-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, 0xFFFFFFFF);
00222 
00223         <span class="comment">/* Mask Device Interrupts */</span>
00224         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
00225                 <span class="comment">/* Clear and disable IN Endpoint interrupts */</span>
00226                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o4">diepmsk</a>, 0);
00227                 <span class="keywordflow">for</span> (i = 0; i &lt;= core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
00228                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;
00229                                         diepint, 0xFFFFFFFF);
00230                 }
00231 
00232                 <span class="comment">/* Clear and disable OUT Endpoint interrupts */</span>
00233                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o5">doepmsk</a>, 0);
00234                 <span class="keywordflow">for</span> (i = 0; i &lt;= core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o5">num_out_eps</a>; i++) {
00235                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[i]-&gt;
00236                                         doepint, 0xFFFFFFFF);
00237                 }
00238 
00239                 <span class="comment">/* Clear and disable DAINT */</span>
00240                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o6">daint</a>,
00241                                 0xFFFFFFFF);
00242                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o7">daintmsk</a>, 0);
00243         } <span class="keywordflow">else</span> {
00244                 <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; ++i) {
00245                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;
00246                                         diepeachintmsk[i], 0);
00247                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;
00248                                         diepint, 0xFFFFFFFF);
00249                 }
00250 
00251                 <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o5">num_out_eps</a>; ++i) {
00252                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;
00253                                         doepeachintmsk[i], 0);
00254                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[i]-&gt;
00255                                         doepint, 0xFFFFFFFF);
00256                 }
00257 
00258                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o15">deachintmsk</a>,
00259                                 0);
00260                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o14">deachint</a>,
00261                                 0xFFFFFFFF);
00262 
00263         }
00264 
00265         <span class="comment">/* Disable interrupts */</span>
00266         ahbcfg.<a class="code" href="uniongahbcfg__data.html#o12">b</a>.<a class="code" href="uniongahbcfg__data.html#o1">glblintrmsk</a> = 1;
00267         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o2">gahbcfg</a>, ahbcfg.<a class="code" href="uniongahbcfg__data.html#o0">d32</a>, 0);
00268 
00269         <span class="comment">/* Disable all interrupts. */</span>
00270         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0);
00271 
00272         <span class="comment">/* Clear any pending interrupts */</span>
00273         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, 0xFFFFFFFF);
00274 
00275         <span class="comment">/* Clear any pending OTG Interrupts */</span>
00276         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o1">gotgint</a>, 0xFFFFFFFF);
00277 }
00278 
00283 <span class="keyword">static</span> <span class="keywordtype">void</span> unmask_conn_det_intr(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00284 {
00285         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk = {.<a class="code" href="uniongahbcfg__data.html#o0">d32</a> = 0,.<a class="code" href="uniongahbcfg__data.html#o12">b</a>.portintr = 1 };
00286 
00287         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
00288 }
00289 <span class="preprocessor">#endif</span>
00290 <span class="preprocessor"></span>
<a name="l00296"></a><a class="code" href="dwc__otg__adp_8h.html#a6">00296</a> uint32_t <a class="code" href="dwc__otg__adp_8h.html#a6">dwc_otg_adp_probe_start</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00297 {
00298 
00299         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl = {.<a class="code" href="uniongahbcfg__data.html#o0">d32</a> = 0};
00300         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn;
00301 <span class="preprocessor">#if 0</span>
00302 <span class="preprocessor"></span>        <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl_int = {.<a class="code" href="uniongahbcfg__data.html#o0">d32</a> = 0, .<a class="code" href="uniongahbcfg__data.html#o12">b</a>.adp_prb_int = 1,
00303                                                                 .<a class="code" href="uniongahbcfg__data.html#o12">b</a>.adp_sns_int = 1, b.adp_tmout_int};
00304 <span class="preprocessor">#endif</span>
00305 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__core__if_8h.html#a65">dwc_otg_disable_global_interrupts</a>(core_if);
00306         DWC_PRINTF(<span class="stringliteral">"ADP Probe Start\n"</span>);
00307         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_enabled = 1;
00308 
00309         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o7">adpres</a> = 1;
00310         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00311 
00312         <span class="keywordflow">while</span> (adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o7">adpres</a>) {
00313                 adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(core_if);
00314         }
00315 
00316         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = 0;
00317         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00318 
00319         <span class="comment">/* In Host mode unmask SRP detected interrupt */</span>
00320         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00321         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o19">sts_chngint_msk</a> = 1;
00322         <span class="keywordflow">if</span> (!gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>) {
00323                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o17">srp_det_msk</a> = 1;
00324         }
00325         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00326 
00327         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o14">adp_tmout_int_msk</a> = 1;
00328         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o12">adp_prb_int_msk</a> = 1;
00329         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o1">prb_dschg</a> = 1;
00330         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o2">prb_delta</a> = 1;
00331         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o3">prb_per</a> = 1;
00332         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o8">adpen</a> = 1;
00333         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o5">enaprb</a> = 1;
00334 
00335         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00336         DWC_PRINTF(<span class="stringliteral">"ADP Probe Finish\n"</span>);
00337         <span class="keywordflow">return</span> 0;
00338 }
00339 
<a name="l00346"></a><a class="code" href="dwc__otg__adp_8c.html#a8">00346</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__adp_8c.html#a8">dwc_otg_adp_sense_timer_start</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00347 {
00348         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer_started = 1;
00349         DWC_TIMER_SCHEDULE(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer, 3000 <span class="comment">/* 3 secs */</span> );
00350 }
00351 
<a name="l00357"></a><a class="code" href="dwc__otg__adp_8h.html#a7">00357</a> uint32_t <a class="code" href="dwc__otg__adp_8h.html#a7">dwc_otg_adp_sense_start</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00358 {
00359         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl;
00360 
00361         DWC_PRINTF(<span class="stringliteral">"ADP Sense Start\n"</span>);
00362 
00363         <span class="comment">/* Unmask ADP sense interrupt and mask all other from the core */</span>
00364         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8c.html#a2">dwc_otg_adp_read_reg_filter</a>(core_if);
00365         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o13">adp_sns_int_msk</a> = 1;
00366         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00367         <a class="code" href="dwc__otg__core__if_8h.html#a65">dwc_otg_disable_global_interrupts</a>(core_if); <span class="comment">// vahrama </span>
00368 
00369         <span class="comment">/* Set ADP reset bit*/</span>
00370         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8c.html#a2">dwc_otg_adp_read_reg_filter</a>(core_if);
00371         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o7">adpres</a> = 1;
00372         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00373 
00374         <span class="keywordflow">while</span> (adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o7">adpres</a>) {
00375                 adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(core_if);
00376         }
00377 
00378         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o7">adpres</a> = 0;
00379         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o8">adpen</a> = 1;
00380         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o6">enasns</a> = 1;
00381         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00382 
00383         <a class="code" href="dwc__otg__adp_8c.html#a8">dwc_otg_adp_sense_timer_start</a>(core_if);
00384 
00385         <span class="keywordflow">return</span> 0;
00386 }
00387 
<a name="l00393"></a><a class="code" href="dwc__otg__adp_8h.html#a8">00393</a> uint32_t <a class="code" href="dwc__otg__adp_8h.html#a8">dwc_otg_adp_probe_stop</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00394 {
00395 
00396         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl;
00397         DWC_PRINTF(<span class="stringliteral">"Stop ADP probe\n"</span>);
00398         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_enabled = 0;
00399         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_counter = 0;
00400         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(core_if);
00401 
00402         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o8">adpen</a> = 0;
00403         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o9">adp_prb_int</a> = 1;
00404         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o11">adp_tmout_int</a> = 1;
00405         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o10">adp_sns_int</a> = 1;
00406         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00407 
00408         <span class="keywordflow">return</span> 0;
00409 }
00410 
<a name="l00416"></a><a class="code" href="dwc__otg__adp_8h.html#a9">00416</a> uint32_t <a class="code" href="dwc__otg__adp_8h.html#a9">dwc_otg_adp_sense_stop</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00417 {
00418         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl;
00419 
00420         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_enabled = 0;
00421 
00422         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8c.html#a2">dwc_otg_adp_read_reg_filter</a>(core_if);
00423         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o6">enasns</a> = 0;
00424         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o10">adp_sns_int</a> = 1;
00425         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00426 
00427         <span class="keywordflow">return</span> 0;
00428 }
00429 
<a name="l00437"></a><a class="code" href="dwc__otg__adp_8c.html#a12">00437</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__adp_8c.html#a12">dwc_otg_adp_turnon_vbus</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00438 {
00439         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0 = {.<a class="code" href="unionadpctl__data.html#o0">d32</a> = 0 };
00440         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
00441         DWC_PRINTF(<span class="stringliteral">"Turn on VBUS for 1.1s, port power is %d\n"</span>, hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a>);
00442 
00443         <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> == 0) {
00444                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 1;
00445                 <span class="comment">//DWC_WRITE_REG32(core_if-&gt;host_if-&gt;hprt0, hprt0.d32);</span>
00446         }
00447         
00448         <a class="code" href="dwc__otg__adp_8c.html#a6">dwc_otg_adp_vbuson_timer_start</a>(core_if);
00449 }
00450 
<a name="l00458"></a><a class="code" href="dwc__otg__driver_8c.html#a9">00458</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__driver_8c.html#a9">dwc_otg_adp_start</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, uint8_t is_host)
00459 {
00460         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn;
00461 
00462         DWC_PRINTF(<span class="stringliteral">"ADP Initial Start\n"</span>);
00463         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.adp_started = 1;
00464 
00465         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, 0xFFFFFFFF);
00466         <a class="code" href="dwc__otg__core__if_8h.html#a65">dwc_otg_disable_global_interrupts</a>(core_if);
00467         <span class="keywordflow">if</span> (is_host) {
00468                 DWC_PRINTF(<span class="stringliteral">"HOST MODE\n"</span>);
00469                 <span class="comment">/* Enable Power Down Logic Interrupt*/</span>
00470                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00471                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00472                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00473                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00474                 <span class="comment">/* Initialize first ADP probe to obtain Ramp Time value */</span>
00475                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.initial_probe = 1;
00476                 <a class="code" href="dwc__otg__adp_8h.html#a6">dwc_otg_adp_probe_start</a>(core_if);
00477         } <span class="keywordflow">else</span> {
00478                 <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl;
00479                 gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>);
00480                 DWC_PRINTF(<span class="stringliteral">"DEVICE MODE\n"</span>);
00481                 <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o17">bsesvld</a> == 0) {
00482                         <span class="comment">/* Enable Power Down Logic Interrupt*/</span>
00483                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00484                         DWC_PRINTF(<span class="stringliteral">"VBUS is not valid - start ADP probe\n"</span>);
00485                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00486                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00487                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00488                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.initial_probe = 1;
00489                         <a class="code" href="dwc__otg__adp_8h.html#a6">dwc_otg_adp_probe_start</a>(core_if);
00490                 } <span class="keywordflow">else</span> {
00491                         DWC_PRINTF(<span class="stringliteral">"VBUS is valid - initialize core as a Device\n"</span>);
00492                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00493                         <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00494                         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00495                         <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00496                         <a class="code" href="dwc__otg__core__if_8h.html#a161">dwc_otg_dump_global_registers</a>(core_if);
00497                         <a class="code" href="dwc__otg__core__if_8h.html#a158">dwc_otg_dump_dev_registers</a>(core_if);
00498                 }
00499         }
00500 }
00501 
00502 <span class="keywordtype">void</span> dwc_otg_adp_init(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00503 {
00504         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.adp_started = 0;
00505         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.initial_probe = 0;
00506         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[0] = -1;
00507         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[1] = -1;
00508         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_enabled = 0;
00509         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_enabled = 0;
00510         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer_started = 0;
00511         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer_started = 0;
00512         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_counter = 0;
00513         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.gpwrdn = 0;
00514         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.attached = DWC_OTG_ADP_UNKOWN;
00515         <span class="comment">/* Initialize timers */</span>
00516         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer =
00517             DWC_TIMER_ALLOC(<span class="stringliteral">"ADP SENSE TIMER"</span>, adp_sense_timeout, core_if);
00518         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer =
00519             DWC_TIMER_ALLOC(<span class="stringliteral">"ADP VBUS ON TIMER"</span>, adp_vbuson_timeout, core_if);
00520         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer || !core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer)
00521         {
00522                 DWC_ERROR(<span class="stringliteral">"Could not allocate memory for ADP timers\n"</span>);
00523         }
00524 }
00525 
00526 <span class="keywordtype">void</span> dwc_otg_adp_remove(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00527 {
00528         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = { .d32 = 0 };
00529         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00530         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00531         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00532 
00533         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_enabled)         
00534                 <a class="code" href="dwc__otg__adp_8h.html#a8">dwc_otg_adp_probe_stop</a>(core_if);
00535         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_enabled)         
00536                 <a class="code" href="dwc__otg__adp_8h.html#a9">dwc_otg_adp_sense_stop</a>(core_if);
00537         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer_started)           
00538                 DWC_TIMER_CANCEL(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer);
00539         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer_started)          
00540                 DWC_TIMER_CANCEL(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer);
00541         DWC_TIMER_FREE(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer);
00542         DWC_TIMER_FREE(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer);
00543 }
00544 
00548 
<a name="l00551"></a><a class="code" href="dwc__otg__adp_8c.html#a16">00551</a> <span class="keyword">static</span> uint32_t <a class="code" href="dwc__otg__adp_8c.html#a16">set_timer_value</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, uint32_t val)
00552 {
00553         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[0] == -1) {
00554                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[0] = val;
00555                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[1] = -1;
00556                 <span class="keywordflow">return</span> 1;
00557         } <span class="keywordflow">else</span> {
00558                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[1] =
00559                     core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[0];
00560                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[0] = val;
00561                 <span class="keywordflow">return</span> 0;
00562         }
00563 }
00564 
<a name="l00568"></a><a class="code" href="dwc__otg__adp_8c.html#a17">00568</a> <span class="keyword">static</span> uint32_t <a class="code" href="dwc__otg__adp_8c.html#a17">compare_timer_values</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00569 {
00570         uint32_t diff;
00571         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[0]&gt;=core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[1])
00572                         diff = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[0]-core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[1];
00573         <span class="keywordflow">else</span>
00574                         diff = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[1]-core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[0];           
00575         <span class="keywordflow">if</span>(diff &lt; 2) {
00576                 <span class="keywordflow">return</span> 0;
00577         } <span class="keywordflow">else</span> {
00578                 <span class="keywordflow">return</span> 1;
00579         }
00580 }
00581 
<a name="l00585"></a><a class="code" href="dwc__otg__adp_8c.html#a18">00585</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__adp_8c.html#a18">dwc_otg_adp_handle_prb_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
00586                                                  uint32_t val)
00587 {
00588         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl = {.d32 = 0 };
00589         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn, temp;
00590         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = val;
00591 
00592         temp.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00593         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_counter++;
00594         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.gpwrdn = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00595         <span class="keywordflow">if</span> (adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o4">rtim</a> == 0 &amp;&amp; !temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>){
00596                 DWC_PRINTF(<span class="stringliteral">"RTIM value is 0\n"</span>);        
00597                 <span class="keywordflow">goto</span> exit;
00598         }
00599         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__adp_8c.html#a16">set_timer_value</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o4">rtim</a>) &amp;&amp;
00600             core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.initial_probe) {
00601                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.initial_probe = 0;
00602                 <a class="code" href="dwc__otg__adp_8h.html#a8">dwc_otg_adp_probe_stop</a>(core_if);
00603                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00604                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00605                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00606                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00607                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, 0xFFFFFFFF);
00608 
00609                 <span class="comment">/* check which value is for device mode and which for Host mode */</span>
00610                 <span class="keywordflow">if</span> (!temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>) {    <span class="comment">/* considered host mode value is 0 */</span>
00611                         <span class="comment">/*</span>
00612 <span class="comment">                         * Turn on VBUS after initial ADP probe.</span>
00613 <span class="comment">                         */</span>
00614                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
00615                         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00616                         DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00617                         <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00618                         <a class="code" href="dwc__otg__adp_8c.html#a12">dwc_otg_adp_turnon_vbus</a>(core_if);
00619                         DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00620                 } <span class="keywordflow">else</span> {
00621                         <span class="comment">/*</span>
00622 <span class="comment">                         * Initiate SRP after initial ADP probe.</span>
00623 <span class="comment">                         */</span>
00624                         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00625                         dwc_otg_initiate_srp(core_if);
00626                 }
00627         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_counter &gt; 2){
00628                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00629                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__adp_8c.html#a17">compare_timer_values</a>(core_if)) {
00630                         DWC_PRINTF(<span class="stringliteral">"Difference in timer values !!! \n"</span>);
00631 <span class="comment">//                      core_if-&gt;adp.attached = DWC_OTG_ADP_ATTACHED;</span>
00632                         <a class="code" href="dwc__otg__adp_8h.html#a8">dwc_otg_adp_probe_stop</a>(core_if);
00633 
00634                         <span class="comment">/* Power on the core */</span>
00635                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00636                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00637                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
00638                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00639                         }
00640 
00641                         <span class="comment">/* check which value is for device mode and which for Host mode */</span>
00642                         <span class="keywordflow">if</span> (!temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>) {    <span class="comment">/* considered host mode value is 0 */</span>
00643                                 <span class="comment">/* Disable Interrupt from Power Down Logic */</span>
00644                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00645                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00646                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00647                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
00648                                                  gpwrdn, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00649 
00650                                 <span class="comment">/*</span>
00651 <span class="comment">                                 * Initialize the Core for Host mode.</span>
00652 <span class="comment">                                 */</span>
00653                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
00654                                 <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00655                                 <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00656                                 <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00657                         } <span class="keywordflow">else</span> {
00658                                 <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl;
00659                                 <span class="comment">/* Mask SRP detected interrupt from Power Down Logic */</span>
00660                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00661                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o17">srp_det_msk</a> = 1;
00662                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
00663                                                  gpwrdn, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00664 
00665                                 <span class="comment">/* Disable Power Down Logic */</span>
00666                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00667                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00668                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00669                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
00670                                                  gpwrdn, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00671 
00672                                 <span class="comment">/*</span>
00673 <span class="comment">                                 * Initialize the Core for Device mode.</span>
00674 <span class="comment">                                 */</span>
00675                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00676                                 <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00677                                 <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00678                                 <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00679 
00680                                 gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>);
00681                                 <span class="keywordflow">if</span> (!gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o17">bsesvld</a>) {
00682                                         dwc_otg_initiate_srp(core_if);
00683                                 }
00684                         }
00685                 }
00686                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00687                         <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o22">bsessvld</a>) {
00688                                 <span class="comment">/* Mask SRP detected interrupt from Power Down Logic */</span>
00689                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00690                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o17">srp_det_msk</a> = 1;
00691                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00692                                 
00693                                 <span class="comment">/* Disable Power Down Logic */</span>
00694                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00695                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00696                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00697 
00698                                 <span class="comment">/*</span>
00699 <span class="comment">                                 * Initialize the Core for Device mode.</span>
00700 <span class="comment">                                 */</span>
00701                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00702                                 <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00703                                 <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00704                                 <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00705                         }
00706                 }
00707         }
00708 exit:
00709         <span class="comment">/* Clear interrupt */</span>
00710         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(core_if);
00711         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o9">adp_prb_int</a> = 1;
00712         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00713 
00714         <span class="keywordflow">return</span> 0;
00715 }
00716 
<a name="l00720"></a><a class="code" href="dwc__otg__adp_8c.html#a19">00720</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__adp_8c.html#a19">dwc_otg_adp_handle_sns_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00721 {
00722         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl;
00723         <span class="comment">/* Stop ADP Sense timer */</span>
00724         DWC_TIMER_CANCEL(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer);
00725 
00726         <span class="comment">/* Restart ADP Sense timer */</span>
00727         <a class="code" href="dwc__otg__adp_8c.html#a8">dwc_otg_adp_sense_timer_start</a>(core_if);
00728         
00729         <span class="comment">/* Clear interrupt */</span>
00730         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(core_if);
00731         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o10">adp_sns_int</a> = 1;
00732         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00733 
00734         <span class="keywordflow">return</span> 0;
00735 }
00736 
<a name="l00740"></a><a class="code" href="dwc__otg__adp_8c.html#a20">00740</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__adp_8c.html#a20">dwc_otg_adp_handle_prb_tmout_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
00741                                                  uint32_t val)
00742 {
00743         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl = {.<a class="code" href="unionadpctl__data.html#o0">d32</a> = 0 };
00744         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = val;
00745         <a class="code" href="dwc__otg__adp_8c.html#a16">set_timer_value</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o4">rtim</a>);
00746         
00747         <span class="comment">/* Clear interrupt */</span>
00748         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(core_if);
00749         adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o11">adp_tmout_int</a> = 1;
00750         <a class="code" href="dwc__otg__adp_8h.html#a4">dwc_otg_adp_write_reg</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00751 
00752         <span class="keywordflow">return</span> 0;
00753 }
00754 
<a name="l00759"></a><a class="code" href="dwc__otg__adp_8h.html#a13">00759</a> int32_t <a class="code" href="dwc__otg__adp_8h.html#a13">dwc_otg_adp_handle_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00760 {
00761         <span class="keywordtype">int</span> retval = 0;
00762         <a class="code" href="unionadpctl__data.html">adpctl_data_t</a> adpctl = {.<a class="code" href="unionadpctl__data.html#o0">d32</a> = 0};
00763 
00764         adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a> = <a class="code" href="dwc__otg__adp_8h.html#a5">dwc_otg_adp_read_reg</a>(core_if);
00765         DWC_PRINTF(<span class="stringliteral">"ADPCTL = %08x\n"</span>,adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00766 
00767         <span class="keywordflow">if</span> (adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o10">adp_sns_int</a> &amp; adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o13">adp_sns_int_msk</a>) {
00768                 DWC_PRINTF(<span class="stringliteral">"ADP Sense interrupt\n"</span>);
00769                 retval |= <a class="code" href="dwc__otg__adp_8c.html#a19">dwc_otg_adp_handle_sns_intr</a>(core_if);
00770         }
00771         <span class="keywordflow">if</span> (adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o11">adp_tmout_int</a> &amp; adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o14">adp_tmout_int_msk</a>) {
00772                 DWC_PRINTF(<span class="stringliteral">"ADP timeout interrupt\n"</span>);
00773                 retval |= <a class="code" href="dwc__otg__adp_8c.html#a20">dwc_otg_adp_handle_prb_tmout_intr</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00774         }
00775         <span class="keywordflow">if</span> (adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o9">adp_prb_int</a> &amp; adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o12">adp_prb_int_msk</a>) {
00776                 DWC_PRINTF(<span class="stringliteral">"ADP Probe interrupt\n"</span>);
00777                 adpctl.<a class="code" href="unionadpctl__data.html#o17">b</a>.<a class="code" href="unionadpctl__data.html#o9">adp_prb_int</a> = 1;       
00778                 retval |= <a class="code" href="dwc__otg__adp_8c.html#a18">dwc_otg_adp_handle_prb_intr</a>(core_if, adpctl.<a class="code" href="unionadpctl__data.html#o0">d32</a>);
00779         }
00780 
00781 <span class="comment">//      dwc_otg_adp_modify_reg(core_if, adpctl.d32, 0);</span>
00782         <span class="comment">//dwc_otg_adp_write_reg(core_if, adpctl.d32);</span>
00783         DWC_PRINTF(<span class="stringliteral">"RETURN FROM ADP ISR\n"</span>);
00784 
00785         <span class="keywordflow">return</span> retval;
00786 }
00787 
<a name="l00792"></a><a class="code" href="dwc__otg__adp_8h.html#a14">00792</a> int32_t <a class="code" href="dwc__otg__adp_8h.html#a14">dwc_otg_adp_handle_srp_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00793 {
00794 
00795 <span class="preprocessor">#ifndef DWC_HOST_ONLY</span>
00796 <span class="preprocessor"></span>        <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0;
00797         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn;
00798         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"++ Power Down Logic Session Request Interrupt++\n"</span>);
00799 
00800         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00801         <span class="comment">/* check which value is for device mode and which for Host mode */</span>
00802         <span class="keywordflow">if</span> (!gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>) {  <span class="comment">/* considered host mode value is 0 */</span>
00803                 DWC_PRINTF(<span class="stringliteral">"SRP: Host mode\n"</span>);
00804 
00805                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a>) {
00806                         <a class="code" href="dwc__otg__adp_8h.html#a8">dwc_otg_adp_probe_stop</a>(core_if);
00807 
00808                         <span class="comment">/* Power on the core */</span>
00809                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00810                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00811                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
00812                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00813                         }
00814 
00815                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
00816                         <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00817                         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00818                         <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00819                 }
00820 
00821                 <span class="comment">/* Turn on the port power bit. */</span>
00822                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
00823                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 1;
00824                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
00825 
00826                 <span class="comment">/* Start the Connection timer. So a message can be displayed</span>
00827 <span class="comment">                 * if connect does not occur within 10 seconds. */</span>
00828                 <a class="code" href="dwc__otg__cil_8h.html#a122">cil_hcd_session_start</a>(core_if);
00829         } <span class="keywordflow">else</span> {
00830                 DWC_PRINTF(<span class="stringliteral">"SRP: Device mode %s\n"</span>, __FUNCTION__);
00831                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a>) {
00832                         <a class="code" href="dwc__otg__adp_8h.html#a8">dwc_otg_adp_probe_stop</a>(core_if);
00833 
00834                         <span class="comment">/* Power on the core */</span>
00835                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00836                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00837                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
00838                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00839                         }
00840 
00841                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00842                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 0;
00843                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0,
00844                                          gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00845 
00846                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00847                         <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00848                         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00849                         <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00850                 }
00851         }
00852 <span class="preprocessor">#endif</span>
00853 <span class="preprocessor"></span>        <span class="keywordflow">return</span> 1;
00854 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 27 03:56:37 2011 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
