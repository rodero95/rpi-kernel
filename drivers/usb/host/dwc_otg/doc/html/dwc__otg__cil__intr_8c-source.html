<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_cil_intr.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>dwc_otg_cil_intr.c</h1><a href="dwc__otg__cil__intr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/* ==========================================================================</span>
00002 <span class="comment"> * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_cil_intr.c $</span>
00003 <span class="comment"> * $Revision: #31 $</span>
00004 <span class="comment"> * $Date: 2011/10/24 $</span>
00005 <span class="comment"> * $Change: 1871286 $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
00008 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
00009 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
00012 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
00013 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
00014 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
00015 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
00016 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
00017 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
00018 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
00019 <span class="comment"> * below, then you are not authorized to use the Software.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
00022 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
00025 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
00026 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
00027 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
00028 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
00031 <span class="comment"> * DAMAGE.</span>
00032 <span class="comment"> * ========================================================================== */</span>
00033 
00042 <span class="preprocessor">#include "dwc_os.h"</span>
00043 <span class="preprocessor">#include "<a class="code" href="dwc__otg__regs_8h.html">dwc_otg_regs.h</a>"</span>
00044 <span class="preprocessor">#include "<a class="code" href="dwc__otg__cil_8h.html">dwc_otg_cil.h</a>"</span>
00045 <span class="preprocessor">#include "<a class="code" href="dwc__otg__driver_8h.html">dwc_otg_driver.h</a>"</span>
00046 <span class="preprocessor">#include "<a class="code" href="dwc__otg__pcd_8h.html">dwc_otg_pcd.h</a>"</span>
00047 <span class="preprocessor">#include "<a class="code" href="dwc__otg__hcd_8h.html">dwc_otg_hcd.h</a>"</span>
00048 
00049 <span class="preprocessor">#ifdef DEBUG</span>
00050 <span class="preprocessor"></span><span class="keyword">inline</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *op_state_str(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00051 {
00052         <span class="keywordflow">return</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == <a class="code" href="dwc__otg__cil_8h.html#a27">A_HOST</a> ? <span class="stringliteral">"a_host"</span> :
00053                 (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == <a class="code" href="dwc__otg__cil_8h.html#a28">A_SUSPEND</a> ? <span class="stringliteral">"a_suspend"</span> :
00054                  (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == <a class="code" href="dwc__otg__cil_8h.html#a29">A_PERIPHERAL</a> ? <span class="stringliteral">"a_peripheral"</span> :
00055                   (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == <a class="code" href="dwc__otg__cil_8h.html#a30">B_PERIPHERAL</a> ? <span class="stringliteral">"b_peripheral"</span> :
00056                    (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == <a class="code" href="dwc__otg__cil_8h.html#a31">B_HOST</a> ? <span class="stringliteral">"b_host"</span> : <span class="stringliteral">"unknown"</span>)))));
00057 }
00058 <span class="preprocessor">#endif</span>
00059 <span class="preprocessor"></span>
<a name="l00064"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a1">00064</a> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a1">dwc_otg_handle_mode_mismatch_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00065 {
00066         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00067         DWC_WARN(<span class="stringliteral">"Mode Mismatch Interrupt: currently in %s mode\n"</span>,
00068                  <a class="code" href="dwc__otg__cil_8h.html#a115">dwc_otg_mode</a>(core_if) ? <span class="stringliteral">"Host"</span> : <span class="stringliteral">"Device"</span>);
00069 
00070         <span class="comment">/* Clear interrupt */</span>
00071         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00072         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o2">modemismatch</a> = 1;
00073         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00074         <span class="keywordflow">return</span> 1;
00075 }
00076 
<a name="l00084"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a2">00084</a> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a2">dwc_otg_handle_otg_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00085 {
00086         <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>;
00087         <a class="code" href="uniongotgint__data.html">gotgint_data_t</a> gotgint;
00088         <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl;
00089         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk;
00090         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn;
00091 
00092         gotgint.<a class="code" href="uniongotgint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o1">gotgint</a>);
00093         gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>);
00094         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a0">DBG_CIL</a>, <span class="stringliteral">"++OTG Interrupt gotgint=%0x [%s]\n"</span>, gotgint.<a class="code" href="uniongotgint__data.html#o0">d32</a>,
00095                     op_state_str(core_if));
00096 
00097         <span class="keywordflow">if</span> (gotgint.<a class="code" href="uniongotgint__data.html#o12">b</a>.<a class="code" href="uniongotgint__data.html#o2">sesenddet</a>) {
00098                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">" ++OTG Interrupt: "</span>
00099                             <span class="stringliteral">"Session End Detected++ (%s)\n"</span>,
00100                             op_state_str(core_if));
00101                 gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>);
00102 
00103                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == B_HOST) {
00104                         <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00105                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00106                 } <span class="keywordflow">else</span> {
00107                         <span class="comment">/* If not B_HOST and Device HNP still set. HNP</span>
00108 <span class="comment">                         * Did not succeed!*/</span>
00109                         <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o12">devhnpen</a>) {
00110                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"Session End Detected\n"</span>);
00111                                 __DWC_ERROR(<span class="stringliteral">"Device Not Connected/Responding!\n"</span>);
00112                         }
00113 
00114                         <span class="comment">/* If Session End Detected the B-Cable has</span>
00115 <span class="comment">                         * been disconnected. */</span>
00116                         <span class="comment">/* Reset PCD and Gadget driver to a</span>
00117 <span class="comment">                         * clean state. */</span>
00118                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L0;
00119                         DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00120                         <a class="code" href="dwc__otg__cil_8h.html#a125">cil_pcd_stop</a>(core_if);
00121                         DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00122 
00123                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a>) {
00124                                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00125                                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00126                                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00127                                         DWC_MODIFY_REG32(&amp;core_if-&gt;
00128                                                          core_global_regs-&gt;
00129                                                          gpwrdn, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00130                                 }
00131 
00132                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00133                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00134                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00135                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
00136                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00137 
00138                                 <a class="code" href="dwc__otg__adp_8h.html#a7">dwc_otg_adp_sense_start</a>(core_if);
00139                         }
00140                 }
00141 
00142                 gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = 0;
00143                 gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o12">devhnpen</a> = 1;
00144                 DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>, gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>, 0);
00145         }
00146         <span class="keywordflow">if</span> (gotgint.<a class="code" href="uniongotgint__data.html#o12">b</a>.<a class="code" href="uniongotgint__data.html#o4">sesreqsucstschng</a>) {
00147                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">" ++OTG Interrupt: "</span>
00148                             <span class="stringliteral">"Session Reqeust Success Status Change++\n"</span>);
00149                 gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>);
00150                 <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o1">sesreqscs</a>) {
00151 
00152                         <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o20">phy_type</a> ==
00153                              DWC_PHY_TYPE_PARAM_FS) &amp;&amp; (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o24">i2c_enable</a>)) {
00154                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o6">srp_success</a> = 1;
00155                         } <span class="keywordflow">else</span> {
00156                                 DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00157                                 <a class="code" href="dwc__otg__cil_8h.html#a127">cil_pcd_resume</a>(core_if);
00158                                 DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00159                                 <span class="comment">/* Clear Session Request */</span>
00160                                 gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = 0;
00161                                 gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o2">sesreq</a> = 1;
00162                                 DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>,
00163                                                  gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>, 0);
00164                         }
00165                 }
00166         }
00167         <span class="keywordflow">if</span> (gotgint.<a class="code" href="uniongotgint__data.html#o12">b</a>.<a class="code" href="uniongotgint__data.html#o5">hstnegsucstschng</a>) {
00168                 <span class="comment">/* Print statements during the HNP interrupt handling</span>
00169 <span class="comment">                 * can cause it to fail.*/</span>
00170                 gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>);
00171                 <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o9">hstnegscs</a>) {
00172                         <span class="keywordflow">if</span> (dwc_otg_is_host_mode(core_if)) {
00173                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_HOST;
00174                                 <span class="comment">/*</span>
00175 <span class="comment">                                 * Need to disable SOF interrupt immediately.</span>
00176 <span class="comment">                                 * When switching from device to host, the PCD</span>
00177 <span class="comment">                                 * interrupt handler won't handle the</span>
00178 <span class="comment">                                 * interrupt if host mode is already set. The</span>
00179 <span class="comment">                                 * HCD interrupt handler won't get called if</span>
00180 <span class="comment">                                 * the HCD state is HALT. This means that the</span>
00181 <span class="comment">                                 * interrupt does not get handled and Linux</span>
00182 <span class="comment">                                 * complains loudly.</span>
00183 <span class="comment">                                 */</span>
00184                                 gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = 0;
00185                                 gintmsk.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o4">sofintr</a> = 1;
00186                                 DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>,
00187                                                  gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
00188                                 <span class="comment">/* Call callback function with spin lock released */</span>
00189                                 DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00190                                 <a class="code" href="dwc__otg__cil_8h.html#a125">cil_pcd_stop</a>(core_if);
00191                                 <span class="comment">/*</span>
00192 <span class="comment">                                 * Initialize the Core for Host mode.</span>
00193 <span class="comment">                                 */</span>
00194                                 <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00195                                 DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00196                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_HOST;
00197                         }
00198                 } <span class="keywordflow">else</span> {
00199                         gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = 0;
00200                         gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o10">hnpreq</a> = 1;
00201                         gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o12">devhnpen</a> = 1;
00202                         DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>, gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>, 0);
00203                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"HNP Failed\n"</span>);
00204                         __DWC_ERROR(<span class="stringliteral">"Device Not Connected/Responding\n"</span>);
00205                 }
00206         }
00207         <span class="keywordflow">if</span> (gotgint.<a class="code" href="uniongotgint__data.html#o12">b</a>.<a class="code" href="uniongotgint__data.html#o7">hstnegdet</a>) {
00208                 <span class="comment">/* The disconnect interrupt is set at the same time as</span>
00209 <span class="comment">                 * Host Negotiation Detected.  During the mode</span>
00210 <span class="comment">                 * switch all interrupts are cleared so the disconnect</span>
00211 <span class="comment">                 * interrupt handler will not get executed.</span>
00212 <span class="comment">                 */</span>
00213                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">" ++OTG Interrupt: "</span>
00214                             <span class="stringliteral">"Host Negotiation Detected++ (%s)\n"</span>,
00215                             (dwc_otg_is_host_mode(core_if) ? <span class="stringliteral">"Host"</span> :
00216                              <span class="stringliteral">"Device"</span>));
00217                 <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if)) {
00218                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"a_suspend-&gt;a_peripheral (%d)\n"</span>,
00219                                     core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a>);
00220                         DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00221                         <a class="code" href="dwc__otg__cil_8h.html#a121">cil_hcd_disconnect</a>(core_if);
00222                         <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00223                         DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00224                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_PERIPHERAL;
00225                 } <span class="keywordflow">else</span> {
00226                         <span class="comment">/*</span>
00227 <span class="comment">                         * Need to disable SOF interrupt immediately. When</span>
00228 <span class="comment">                         * switching from device to host, the PCD interrupt</span>
00229 <span class="comment">                         * handler won't handle the interrupt if host mode is</span>
00230 <span class="comment">                         * already set. The HCD interrupt handler won't get</span>
00231 <span class="comment">                         * called if the HCD state is HALT. This means that</span>
00232 <span class="comment">                         * the interrupt does not get handled and Linux</span>
00233 <span class="comment">                         * complains loudly.</span>
00234 <span class="comment">                         */</span>
00235                         gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = 0;
00236                         gintmsk.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o4">sofintr</a> = 1;
00237                         DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
00238                         DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00239                         <a class="code" href="dwc__otg__cil_8h.html#a125">cil_pcd_stop</a>(core_if);
00240                         <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00241                         DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00242                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
00243                 }
00244         }
00245         <span class="keywordflow">if</span> (gotgint.<a class="code" href="uniongotgint__data.html#o12">b</a>.<a class="code" href="uniongotgint__data.html#o8">adevtoutchng</a>) {
00246                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">" ++OTG Interrupt: "</span>
00247                             <span class="stringliteral">"A-Device Timeout Change++\n"</span>);
00248         }
00249         <span class="keywordflow">if</span> (gotgint.<a class="code" href="uniongotgint__data.html#o12">b</a>.<a class="code" href="uniongotgint__data.html#o9">debdone</a>) {
00250                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">" ++OTG Interrupt: "</span> <span class="stringliteral">"Debounce Done++\n"</span>);
00251         }
00252 
00253         <span class="comment">/* Clear GOTGINT */</span>
00254         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o1">gotgint</a>, gotgint.<a class="code" href="uniongotgint__data.html#o0">d32</a>);
00255 
00256         <span class="keywordflow">return</span> 1;
00257 }
00258 
00259 <span class="keywordtype">void</span> w_conn_id_status_change(<span class="keywordtype">void</span> *p)
00260 {
00261         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = p;
00262         uint32_t count = 0;
00263         <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl = {.d32 = 0 };
00264 
00265         gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>);
00266         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_CIL, <span class="stringliteral">"gotgctl=%0x\n"</span>, gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>);
00267         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_CIL, <span class="stringliteral">"gotgctl.b.conidsts=%d\n"</span>, gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o14">conidsts</a>);
00268 
00269         <span class="comment">/* B-Device connector (Device Mode) */</span>
00270         <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o14">conidsts</a>) {
00271                 <span class="comment">/* Wait for switch to device mode. */</span>
00272                 <span class="keywordflow">while</span> (!dwc_otg_is_device_mode(core_if)) {
00273                         DWC_PRINTF(<span class="stringliteral">"Waiting for Peripheral Mode, Mode=%s\n"</span>,
00274                                    (dwc_otg_is_host_mode(core_if) ? <span class="stringliteral">"Host"</span> :
00275                                     <span class="stringliteral">"Peripheral"</span>));
00276                         dwc_mdelay(100);
00277                         <span class="keywordflow">if</span> (++count &gt; 10000)
00278                                 <span class="keywordflow">break</span>;
00279                 }
00280                 DWC_ASSERT(++count &lt; 10000,
00281                            <span class="stringliteral">"Connection id status change timed out"</span>);
00282                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00283                 <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00284                 <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00285                 <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00286         } <span class="keywordflow">else</span> {
00287                 <span class="comment">/* A-Device connector (Host Mode) */</span>
00288                 <span class="keywordflow">while</span> (!dwc_otg_is_host_mode(core_if)) {
00289                         DWC_PRINTF(<span class="stringliteral">"Waiting for Host Mode, Mode=%s\n"</span>,
00290                                    (dwc_otg_is_host_mode(core_if) ? <span class="stringliteral">"Host"</span> :
00291                                     <span class="stringliteral">"Peripheral"</span>));
00292                         dwc_mdelay(100);
00293                         <span class="keywordflow">if</span> (++count &gt; 10000)
00294                                 <span class="keywordflow">break</span>;
00295                 }
00296                 DWC_ASSERT(++count &lt; 10000,
00297                            <span class="stringliteral">"Connection id status change timed out"</span>);
00298                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
00299                 <span class="comment">/*</span>
00300 <span class="comment">                 * Initialize the Core for Host mode.</span>
00301 <span class="comment">                 */</span>
00302                 <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00303                 <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00304                 <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00305         }
00306 }
00307 
<a name="l00319"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a4">00319</a> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a4">dwc_otg_handle_conn_id_status_change_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00320 {
00321 
00322         <span class="comment">/*</span>
00323 <span class="comment">         * Need to disable SOF interrupt immediately. If switching from device</span>
00324 <span class="comment">         * to host, the PCD interrupt handler won't handle the interrupt if</span>
00325 <span class="comment">         * host mode is already set. The HCD interrupt handler won't get</span>
00326 <span class="comment">         * called if the HCD state is HALT. This means that the interrupt does</span>
00327 <span class="comment">         * not get handled and Linux complains loudly.</span>
00328 <span class="comment">         */</span>
00329         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk = {.d32 = 0 };
00330         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts = {.d32 = 0 };
00331 
00332         gintmsk.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o4">sofintr</a> = 1;
00333         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
00334 
00335         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a0">DBG_CIL</a>,
00336                     <span class="stringliteral">" ++Connector ID Status Change Interrupt++  (%s)\n"</span>,
00337                     (dwc_otg_is_host_mode(core_if) ? <span class="stringliteral">"Host"</span> : <span class="stringliteral">"Device"</span>));
00338         
00339         DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00340 
00341         <span class="comment">/*</span>
00342 <span class="comment">         * Need to schedule a work, as there are possible DELAY function calls</span>
00343 <span class="comment">         * Release lock before scheduling workq as it holds spinlock during scheduling</span>
00344 <span class="comment">         */</span>
00345 
00346         DWC_WORKQ_SCHEDULE(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o33">wq_otg</a>, w_conn_id_status_change,
00347                            core_if, <span class="stringliteral">"connection id status change"</span>);
00348         DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00349 
00350         <span class="comment">/* Set flag and clear interrupt */</span>
00351         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o29">conidstschng</a> = 1;
00352         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00353 
00354         <span class="keywordflow">return</span> 1;
00355 }
00356 
<a name="l00366"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a5">00366</a> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a5">dwc_otg_handle_session_req_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00367 {
00368         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00369 
00370 <span class="preprocessor">#ifndef DWC_HOST_ONLY</span>
00371 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"++Session Request Interrupt++\n"</span>);
00372 
00373         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if)) {
00374                 DWC_PRINTF(<span class="stringliteral">"SRP: Device mode\n"</span>);
00375         } <span class="keywordflow">else</span> {
00376                 <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0;
00377                 DWC_PRINTF(<span class="stringliteral">"SRP: Host mode\n"</span>);
00378 
00379                 <span class="comment">/* Turn on the port power bit. */</span>
00380                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
00381                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 1;
00382                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
00383 
00384                 <span class="comment">/* Start the Connection timer. So a message can be displayed</span>
00385 <span class="comment">                 * if connect does not occur within 10 seconds. */</span>
00386                 <a class="code" href="dwc__otg__cil_8h.html#a122">cil_hcd_session_start</a>(core_if);
00387         }
00388 <span class="preprocessor">#endif</span>
00389 <span class="preprocessor"></span>
00390         <span class="comment">/* Clear interrupt */</span>
00391         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00392         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o31">sessreqintr</a> = 1;
00393         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00394 
00395         <span class="keywordflow">return</span> 1;
00396 }
00397 
<a name="l00398"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a6">00398</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__cil__intr_8c.html#a6">w_wakeup_detected</a>(<span class="keywordtype">void</span> *p)
00399 {
00400         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = (<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *) p;
00401         <span class="comment">/*</span>
00402 <span class="comment">         * Clear the Resume after 70ms. (Need 20 ms minimum. Use 70 ms</span>
00403 <span class="comment">         * so that OPT tests pass with all PHYs).</span>
00404 <span class="comment">         */</span>
00405         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0 = {.d32 = 0 };
00406 <span class="preprocessor">#if 0</span>
00407 <span class="preprocessor"></span>        <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.d32 = 0 };
00408         <span class="comment">/* Restart the Phy Clock */</span>
00409         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
00410         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>, 0);
00411         dwc_udelay(10);
00412 <span class="preprocessor">#endif //0</span>
00413 <span class="preprocessor"></span>        hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
00414         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"Resume: HPRT0=%0x\n"</span>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
00415 <span class="comment">//      dwc_mdelay(70);</span>
00416         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o7">prtres</a> = 0;     <span class="comment">/* Resume */</span>
00417         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
00418         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"Clear Resume: HPRT0=%0x\n"</span>,
00419                     DWC_READ_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>));
00420 
00421         <a class="code" href="dwc__otg__cil_8h.html#a123">cil_hcd_resume</a>(core_if);
00422 
00424         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L0;
00425 }
00426 
<a name="l00434"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a7">00434</a> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a7">dwc_otg_handle_wakeup_detected_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00435 {
00436         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00437 
00438         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>,
00439                     <span class="stringliteral">"++Resume and Remote Wakeup Detected Interrupt++\n"</span>);
00440 
00441         DWC_PRINTF(<span class="stringliteral">"%s lxstate = %d\n"</span>, __func__, core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a>);
00442 
00443         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if)) {
00444                 <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = {.d32 = 0 };
00445                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"DSTS=0x%0x\n"</span>,
00446                             DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
00447                                            dev_global_regs-&gt;dsts));
00448                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> == DWC_OTG_L2) {
00449 <span class="preprocessor">#ifdef PARTIAL_POWER_DOWN</span>
00450 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o2">power_optimiz</a>) {
00451                                 <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> power = {.d32 = 0 };
00452 
00453                                 power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a> = DWC_READ_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>);
00454                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a0">DBG_CIL</a>, <span class="stringliteral">"PCGCCTL=%0x\n"</span>,
00455                                             power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
00456 
00457                                 power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 0;
00458                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
00459 
00460                                 power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o3">pwrclmp</a> = 0;
00461                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
00462 
00463                                 power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o4">rstpdwnmodule</a> = 0;
00464                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
00465                         }
00466 <span class="preprocessor">#endif</span>
00467 <span class="preprocessor"></span>                        <span class="comment">/* Clear the Remote Wakeup Signaling */</span>
00468                         dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o1">rmtwkupsig</a> = 1;
00469                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
00470                                          dev_global_regs-&gt;dctl, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>, 0);
00471 
00472                         DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00473                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o30">pcd_cb</a> &amp;&amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o30">pcd_cb</a>-&gt;<a class="code" href="structdwc__otg__cil__callbacks.html#o3">resume_wakeup</a>) {
00474                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o30">pcd_cb</a>-&gt;<a class="code" href="structdwc__otg__cil__callbacks.html#o3">resume_wakeup</a>(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o30">pcd_cb</a>-&gt;<a class="code" href="structdwc__otg__cil__callbacks.html#o6">p</a>);
00475                         }
00476                         DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00477                 } <span class="keywordflow">else</span> {
00478                         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
00479                         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> =
00480                             DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
00481                         lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o6">hird_thres</a> &amp;= (~(1 &lt;&lt; 4));
00482                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>,
00483                                         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a>);
00484                 }
00486                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L0;
00487         } <span class="keywordflow">else</span> {
00488                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> != DWC_OTG_L1) {
00489                         <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.d32 = 0 };
00490 
00491                         <span class="comment">/* Restart the Phy Clock */</span>
00492                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
00493                         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>, 0);
00494                         DWC_TIMER_SCHEDULE(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o34">wkp_timer</a>, 71);
00495                 } <span class="keywordflow">else</span> {
00497                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L0;
00498                 }
00499         }
00500 
00501         <span class="comment">/* Clear interrupt */</span>
00502         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00503         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o32">wkupintr</a> = 1;
00504         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00505 
00506         <span class="keywordflow">return</span> 1;
00507 }
00508 
<a name="l00513"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a8">00513</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a8">dwc_otg_handle_pwrdn_disconnect_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if)
00514 {
00515         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = { .<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
00516         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn_temp = { .<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
00517         gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00518 
00519         DWC_PRINTF(<span class="stringliteral">"%s called\n"</span>, __FUNCTION__);
00520 
00521         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a>) {
00522                 DWC_PRINTF(<span class="stringliteral">"Already exited from Hibernation\n"</span>);
00523                 <span class="keywordflow">return</span> 1;
00524         }
00525 
00526         <span class="comment">/* Switch on the voltage to the core */</span>
00527         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00528         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00529         dwc_udelay(10);
00530 
00531         <span class="comment">/* Reset the core */</span>
00532         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00533         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00534         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00535         dwc_udelay(10);
00536 
00537         <span class="comment">/* Disable power clamps*/</span>
00538         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00539         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o4">pwrdnclmp</a> = 1;
00540         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00541 
00542         <span class="comment">/* Remove reset the core signal */</span>
00543         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00544         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00545         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00546         dwc_udelay(10);
00547 
00548         <span class="comment">/* Disable PMU interrupt */</span>
00549         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00550         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00551         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00552 
00553         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> = 0;
00554 
00555         <span class="comment">/* Disable PMU */</span>
00556         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00557         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00558         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00559         dwc_udelay(10);
00560 
00561         <span class="keywordflow">if</span> (gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>) {
00562                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00563                 <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00564                 <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00565                 <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00566         } <span class="keywordflow">else</span> {
00567                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
00568                 <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00569                 <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00570                 <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00571         }
00572 
00573         <span class="keywordflow">return</span> 1;
00574 }
00575 
<a name="l00580"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a9">00580</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a9">dwc_otg_handle_pwrdn_wakeup_detected_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00581 {
00582         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.d32 = 0 };
00583         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>,
00584                     <span class="stringliteral">"++Powerdown Remote Wakeup Detected Interrupt++\n"</span>);
00585 
00586         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a>) {
00587                 DWC_PRINTF(<span class="stringliteral">"Already exited from Hibernation\n"</span>);
00588                 <span class="keywordflow">return</span> 1;
00589         }
00590 
00591         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00592         <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>) {   <span class="comment">// Device Mode</span>
00593                 <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2)
00594                     &amp;&amp; (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> == 1)) {
00595                         dwc_otg_device_hibernation_restore(core_if, 0, 0);
00596                 }
00597         } <span class="keywordflow">else</span> {
00598                 <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2)
00599                     &amp;&amp; (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> == 1)) {
00600                         dwc_otg_host_hibernation_restore(core_if, 1, 0);
00601                 }
00602         }
00603         <span class="keywordflow">return</span> 1;
00604 }
00605 
00606 <span class="keyword">static</span> int32_t dwc_otg_handle_pwrdn_idsts_change(<a class="code" href="structdwc__otg__device.html">dwc_otg_device_t</a> *otg_dev)
00607 {
00608         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0 };
00609         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn_temp = {.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0 };
00610         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#o1">core_if</a>;
00611 
00612         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_ANY, <span class="stringliteral">"%s called\n"</span>, __FUNCTION__);
00613         gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00614         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2)
00615         {               
00616                 <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a>) {
00617                         DWC_PRINTF(<span class="stringliteral">"Already exited from Hibernation\n"</span>);
00618                         <span class="keywordflow">return</span> 1;
00619                 }
00620                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_ANY, <span class="stringliteral">"Exit from hibernation on ID sts change\n"</span>);
00621                 <span class="comment">/* Switch on the voltage to the core */</span>
00622                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00623                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00624                 dwc_udelay(10);
00625 
00626                 <span class="comment">/* Reset the core */</span>
00627                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00628                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00629                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00630                 dwc_udelay(10);
00631 
00632                 <span class="comment">/* Disable power clamps */</span>
00633                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00634                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o4">pwrdnclmp</a> = 1;
00635                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00636 
00637                 <span class="comment">/* Remove reset the core signal */</span>
00638                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00639                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00640                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00641                 dwc_udelay(10);
00642 
00643                 <span class="comment">/* Disable PMU interrupt */</span>
00644                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00645                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00646                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00647 
00648                 <span class="comment">/*Indicates that we are exiting from hibernation */</span>
00649                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> = 0;
00650 
00651                 <span class="comment">/* Disable PMU */</span>
00652                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00653                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00654                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00655                 dwc_udelay(10);
00656 
00657                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o39">gr_backup</a>-&gt;gpwrdn_local;
00658                 <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o7">dis_vbus</a> == 1) {
00659                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00660                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o7">dis_vbus</a> = 1;
00661                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00662                 }
00663 
00664                 <span class="keywordflow">if</span> (gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>) {
00665                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00666                         <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00667                         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00668                         <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00669                 } <span class="keywordflow">else</span> {
00670                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
00671                         <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00672                         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00673                         <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00674                 }
00675         }
00676 
00677         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a>)
00678         {
00679                 uint8_t is_host = 0;
00680                 DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00681                 <span class="comment">/* Change the core_if's lock to hcd/pcd lock depend on mode? */</span>
00682 <span class="preprocessor">#ifndef DWC_HOST_ONLY           </span>
00683 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>)
00684                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a> = otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#o2">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>;
00685 <span class="preprocessor">#endif</span>
00686 <span class="preprocessor"></span><span class="preprocessor">#ifndef DWC_DEVICE_ONLY</span>
00687 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>) {
00688                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a> = otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#o3">hcd</a>-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>;     
00689                                 is_host = 1;
00690                 }
00691 <span class="preprocessor">#endif</span>
00692 <span class="preprocessor"></span>                DWC_PRINTF(<span class="stringliteral">"RESTART ADP\n"</span>);
00693                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_enabled)         
00694                         <a class="code" href="dwc__otg__adp_8h.html#a8">dwc_otg_adp_probe_stop</a>(core_if);
00695                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_enabled)         
00696                         <a class="code" href="dwc__otg__adp_8h.html#a9">dwc_otg_adp_sense_stop</a>(core_if);
00697                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer_started)           
00698                         DWC_TIMER_CANCEL(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer);
00699                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer_started)          
00700                         DWC_TIMER_CANCEL(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer);
00701                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[0] = -1;
00702                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_timer_values[1] = -1;
00703                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.sense_timer_started = 0;
00704                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.vbuson_timer_started = 0;
00705                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.probe_counter = 0;
00706                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.gpwrdn = 0;
00707                 
00708                 <span class="comment">/* Disable PMU and restart ADP */</span>
00709                 gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00710                 gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00711                 gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00712                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00713                 DWC_PRINTF(<span class="stringliteral">"Check point 1\n"</span>);
00714                 dwc_mdelay(110);
00715                 <a class="code" href="dwc__otg__driver_8c.html#a9">dwc_otg_adp_start</a>(core_if, is_host);
00716                 DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00717         }
00718         
00719 
00720         <span class="keywordflow">return</span> 1;
00721 }
00722 
00723 <span class="keyword">static</span> int32_t dwc_otg_handle_pwrdn_session_change(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00724 {
00725         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0 };
00726         int32_t otg_cap_param = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o1">otg_cap</a>;
00727         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_ANY, <span class="stringliteral">"%s called\n"</span>, __FUNCTION__);
00728 
00729         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00730         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00731                 <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a>) {
00732                         DWC_PRINTF(<span class="stringliteral">"Already exited from Hibernation\n"</span>);
00733                         <span class="keywordflow">return</span> 1;
00734                 }
00735 
00736                 <span class="keywordflow">if</span> ((otg_cap_param != DWC_OTG_CAP_PARAM_HNP_SRP_CAPABLE ||
00737                          otg_cap_param != DWC_OTG_CAP_PARAM_SRP_ONLY_CAPABLE) &amp;&amp;
00738                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o22">bsessvld</a> == 0) {
00739                         <span class="comment">/* Save gpwrdn register for further usage if stschng interrupt */</span>
00740                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o39">gr_backup</a>-&gt;gpwrdn_local =
00741                                 DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00742                         <span class="comment">/*Exit from ISR and wait for stschng interrupt with bsessvld = 1 */</span>
00743                         <span class="keywordflow">return</span> 1;
00744                 }
00745 
00746                 <span class="comment">/* Switch on the voltage to the core */</span>
00747                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00748                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00749                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00750                 dwc_udelay(10);
00751 
00752                 <span class="comment">/* Reset the core */</span>
00753                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00754                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00755                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00756                 dwc_udelay(10);
00757 
00758                 <span class="comment">/* Disable power clamps */</span>
00759                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00760                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o4">pwrdnclmp</a> = 1;
00761                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00762 
00763                 <span class="comment">/* Remove reset the core signal */</span>
00764                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00765                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00766                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00767                 dwc_udelay(10);
00768 
00769                 <span class="comment">/* Disable PMU interrupt */</span>
00770                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00771                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00772                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00773                 dwc_udelay(10);
00774 
00775                 <span class="comment">/*Indicates that we are exiting from hibernation */</span>
00776                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> = 0;
00777 
00778                 <span class="comment">/* Disable PMU */</span>
00779                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00780                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00781                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00782                 dwc_udelay(10);
00783 
00784                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00785                 <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00786                 <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00787                 <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00788 
00789                 <span class="keywordflow">if</span> (otg_cap_param == DWC_OTG_CAP_PARAM_HNP_SRP_CAPABLE ||
00790                         otg_cap_param == DWC_OTG_CAP_PARAM_SRP_ONLY_CAPABLE) {
00791                         <span class="comment">/*</span>
00792 <span class="comment">                         * Initiate SRP after initial ADP probe.</span>
00793 <span class="comment">                         */</span>
00794                         dwc_otg_initiate_srp(core_if);  
00795                 }
00796         }
00797 
00798         <span class="keywordflow">return</span> 1;
00799 }
<a name="l00804"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a12">00804</a> <span class="keyword">static</span> uint32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a12">dwc_otg_handle_pwrdn_stschng_intr</a>(<a class="code" href="structdwc__otg__device.html">dwc_otg_device_t</a> *otg_dev)
00805 {
00806         <span class="keywordtype">int</span> retval;
00807         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.d32 = 0 };
00808         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn_temp = {.d32 = 0 };
00809         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#o1">core_if</a>;
00810 
00811         DWC_PRINTF(<span class="stringliteral">"%s called\n"</span>, __FUNCTION__);
00812         
00813         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00814                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> &lt;= 0) {
00815                         DWC_PRINTF(<span class="stringliteral">"Already exited from Hibernation\n"</span>);
00816                         <span class="keywordflow">return</span> 1;
00817                 } <span class="keywordflow">else</span>
00818                         gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o39">gr_backup</a>-&gt;gpwrdn_local;
00819 
00820         } <span class="keywordflow">else</span> {
00821                 gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.gpwrdn;
00822         }
00823 
00824         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
00825         
00826         <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a> ^ gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o21">idsts</a>) {
00827                 retval = dwc_otg_handle_pwrdn_idsts_change(otg_dev);
00828         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o22">bsessvld</a> ^ gpwrdn_temp.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o22">bsessvld</a>) {
00829                 retval = dwc_otg_handle_pwrdn_session_change(core_if);
00830         }
00831 
00832         <span class="keywordflow">return</span> retval;
00833 }
00834 
<a name="l00839"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a13">00839</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a13">dwc_otg_handle_pwrdn_srp_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00840 {
00841         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0 };
00842 
00843         DWC_PRINTF(<span class="stringliteral">"%s called\n"</span>, __FUNCTION__);
00844 
00845         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a>) {
00846                 DWC_PRINTF(<span class="stringliteral">"Already exited from Hibernation\n"</span>);
00847                 <span class="keywordflow">return</span> 1;
00848         }
00849 <span class="preprocessor">#ifdef DWC_DEV_SRPCAP</span>
00850 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (core_if-&gt;pwron_timer_started) {
00851                 core_if-&gt;pwron_timer_started = 0;
00852                 DWC_TIMER_CANCEL(core_if-&gt;pwron_timer);
00853         }
00854 <span class="preprocessor">#endif</span>
00855 <span class="preprocessor"></span>
00856         <span class="comment">/* Switch on the voltage to the core */</span>
00857         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00858         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00859         dwc_udelay(10);
00860 
00861         <span class="comment">/* Reset the core */</span>
00862         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00863         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00864         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00865         dwc_udelay(10);
00866 
00867         <span class="comment">/* Disable power clamps */</span>
00868         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00869         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o4">pwrdnclmp</a> = 1;
00870         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00871 
00872         <span class="comment">/* Remove reset the core signal */</span>
00873         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00874         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00875         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00876         dwc_udelay(10);
00877 
00878         <span class="comment">/* Disable PMU interrupt */</span>
00879         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00880         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00881         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00882 
00883         <span class="comment">/* Indicates that we are exiting from hibernation */</span>
00884         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> = 0;
00885 
00886         <span class="comment">/* Disable PMU */</span>
00887         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00888         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00889         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00890         dwc_udelay(10);
00891 
00892         <span class="comment">/* Programm Disable VBUS to 0 */</span>
00893         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00894         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o7">dis_vbus</a> = 1;
00895         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00896 
00897         <span class="comment">/*Initialize the core as Host */</span>
00898         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
00899         <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00900         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00901         <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00902 
00903         <span class="keywordflow">return</span> 1;
00904 }
00905 
<a name="l00908"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a14">00908</a> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a14">dwc_otg_handle_restore_done_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00909 {
00910         <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl;
00911         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"++Restore Done Interrupt++\n"</span>);
00912 
00913         <span class="comment">//TODO De-assert restore signal. 8.a</span>
00914         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a> = DWC_READ_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>);
00915         <span class="keywordflow">if</span> (pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o10">restoremode</a> == 1) {
00916                 <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk = {.<a class="code" href="unionpcgcctl__data.html#o0">d32</a> = 0 };
00917                 <span class="comment">/*</span>
00918 <span class="comment">                 * If restore mode is Remote Wakeup,</span>
00919 <span class="comment">                 * unmask Remote Wakeup interrupt.</span>
00920 <span class="comment">                 */</span>
00921                 gintmsk.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o32">wkupintr</a> = 1;
00922                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>,
00923                                  0, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
00924         }
00925 
00926         <span class="keywordflow">return</span> 1;
00927 }
00928 
<a name="l00933"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a15">00933</a> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a15">dwc_otg_handle_disconnect_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00934 {
00935         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00936 
00937         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"++Disconnect Detected Interrupt++ (%s) %s\n"</span>,
00938                     (dwc_otg_is_host_mode(core_if) ? <span class="stringliteral">"Host"</span> : <span class="stringliteral">"Device"</span>),
00939                     op_state_str(core_if));
00940 
00942 <span class="preprocessor">#ifndef DWC_HOST_ONLY</span>
00943 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == B_HOST) {
00944                 <span class="comment">/* If in device mode Disconnect and stop the HCD, then</span>
00945 <span class="comment">                 * start the PCD. */</span>
00946                 DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00947                 <a class="code" href="dwc__otg__cil_8h.html#a121">cil_hcd_disconnect</a>(core_if);
00948                 <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00949                 DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00950                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00951         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if)) {
00952                 <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl = {.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = 0 };
00953                 gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> =
00954                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>);
00955                 <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o11">hstsethnpen</a> == 1) {
00956                         <span class="comment">/* Do nothing, if HNP in process the OTG</span>
00957 <span class="comment">                         * interrupt "Host Negotiation Detected"</span>
00958 <span class="comment">                         * interrupt will do the mode switch.</span>
00959 <span class="comment">                         */</span>
00960                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o12">devhnpen</a> == 0) {
00961                         <span class="comment">/* If in device mode Disconnect and stop the HCD, then</span>
00962 <span class="comment">                         * start the PCD. */</span>
00963                         DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00964                         <a class="code" href="dwc__otg__cil_8h.html#a121">cil_hcd_disconnect</a>(core_if);
00965                         <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
00966                         DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
00967                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
00968                 } <span class="keywordflow">else</span> {
00969                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"!a_peripheral &amp;&amp; !devhnpen\n"</span>);
00970                 }
00971         } <span class="keywordflow">else</span> {
00972                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == A_HOST) {
00973                         <span class="comment">/* A-Cable still connected but device disconnected. */</span>
00974                         <a class="code" href="dwc__otg__cil_8h.html#a121">cil_hcd_disconnect</a>(core_if);
00975                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a>) {
00976                                 <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = { .d32 = 0 };
00977                                 <a class="code" href="dwc__otg__cil_8h.html#a120">cil_hcd_stop</a>(core_if);
00978                                 <span class="comment">/* Enable Power Down Logic */</span>
00979                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00980                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00981                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00982                                 <a class="code" href="dwc__otg__adp_8h.html#a6">dwc_otg_adp_probe_start</a>(core_if);
00983 
00984                                 <span class="comment">/* Power off the core */</span>
00985                                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00986                                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00987                                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00988                                         DWC_MODIFY_REG32(&amp;core_if-&gt;
00989                                                          core_global_regs-&gt;
00990                                                          gpwrdn, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00991                                 }
00992                         }
00993                 }
00994         }
00995 <span class="preprocessor">#endif</span>
00996 <span class="preprocessor"></span>        <span class="comment">/* Change to L3(OFF) state */</span>
00997         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L3;
00998 
00999         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01000         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o30">disconnect</a> = 1;
01001         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01002         <span class="keywordflow">return</span> 1;
01003 }
01004 
<a name="l01015"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a16">01015</a> int32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a16">dwc_otg_handle_usb_suspend_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01016 {
01017         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts;
01018         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01019         <a class="code" href="uniondcfg__data.html">dcfg_data_t</a> dcfg;
01020 
01021         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"USB SUSPEND\n"</span>);
01022 
01023         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if)) {
01024                 <span class="comment">/* Check the Device status register to determine if the Suspend</span>
01025 <span class="comment">                 * state is active. */</span>
01026                 dsts.<a class="code" href="uniondsts__data.html#o0">d32</a> =
01027                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o2">dsts</a>);
01028                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"DSTS=0x%0x\n"</span>, dsts.<a class="code" href="uniondsts__data.html#o0">d32</a>);
01029                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"DSTS.Suspend Status=%d "</span>
01030                             <span class="stringliteral">"HWCFG4.power Optimize=%d\n"</span>,
01031                             dsts.<a class="code" href="uniondsts__data.html#o7">b</a>.<a class="code" href="uniondsts__data.html#o1">suspsts</a>, core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o2">power_optimiz</a>);
01032 
01033 <span class="preprocessor">#ifdef PARTIAL_POWER_DOWN</span>
01034 <span class="preprocessor"></span>
01036                 <span class="keywordflow">if</span> (dsts.<a class="code" href="uniondsts__data.html#o7">b</a>.<a class="code" href="uniondsts__data.html#o1">suspsts</a> &amp;&amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o2">power_optimiz</a>) {
01037                         <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> power = {.<a class="code" href="uniondsts__data.html#o0">d32</a> = 0 };
01038                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a0">DBG_CIL</a>, <span class="stringliteral">"suspend\n"</span>);
01039 
01040                         power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o3">pwrclmp</a> = 1;
01041                         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
01042 
01043                         power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o4">rstpdwnmodule</a> = 1;
01044                         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0, power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
01045 
01046                         power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
01047                         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0, power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
01048 
01049                 } <span class="keywordflow">else</span> {
01050                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"disconnect?\n"</span>);
01051                 }
01052 <span class="preprocessor">#endif</span>
01053 <span class="preprocessor"></span>                <span class="comment">/* PCD callback for suspend. Release the lock inside of callback function */</span>
01054                 <a class="code" href="dwc__otg__cil_8h.html#a126">cil_pcd_suspend</a>(core_if);
01055                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2)
01056                 {
01057                         dcfg.<a class="code" href="uniondcfg__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o0">dcfg</a>);
01058                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>,<span class="stringliteral">"lx_state = %08x\n"</span>,core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a>);
01059                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>,<span class="stringliteral">" device address = %08d\n"</span>,dcfg.<a class="code" href="uniondcfg__data.html#o12">b</a>.<a class="code" href="uniondcfg__data.html#o4">devaddr</a>);
01060 
01061                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> != <a class="code" href="dwc__otg__cil_8h.html#a129a59">DWC_OTG_L3</a> &amp;&amp; dcfg.<a class="code" href="uniondcfg__data.html#o12">b</a>.<a class="code" href="uniondcfg__data.html#o4">devaddr</a>) {
01062                                 <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.<a class="code" href="uniondcfg__data.html#o0">d32</a> = 0 };
01063                                 <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.<a class="code" href="uniondcfg__data.html#o0">d32</a> = 0 };
01064                                 <a class="code" href="uniongusbcfg__data.html">gusbcfg_data_t</a> gusbcfg = {.<a class="code" href="uniondcfg__data.html#o0">d32</a> = 0 };
01065 
01066                                 <span class="comment">/* Change to L2(suspend) state */</span>
01067                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L2;
01068 
01069                                 <span class="comment">/* Clear interrupt in gintsts */</span>
01070                                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01071                                 gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o12">usbsuspend</a> = 1;
01072                                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
01073                                                 gintsts, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01074                                 DWC_PRINTF(<span class="stringliteral">"Start of hibernation completed\n"</span>);
01075                                 <a class="code" href="dwc__otg__cil_8h.html#a63">dwc_otg_save_global_regs</a>(core_if);
01076                                 <a class="code" href="dwc__otg__cil_8h.html#a64">dwc_otg_save_dev_regs</a>(core_if);
01077 
01078                                 gusbcfg.<a class="code" href="uniongusbcfg__data.html#o0">d32</a> =
01079                                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
01080                                                    gusbcfg);
01081                                 <span class="keywordflow">if</span> (gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o3">ulpi_utmi_sel</a> == 1) {
01082                                         <span class="comment">/* ULPI interface */</span>
01083                                         <span class="comment">/* Suspend the Phy Clock */</span>
01084                                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a> = 0;
01085                                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
01086                                         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0,
01087                                                          pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
01088                                         dwc_udelay(10);
01089                                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
01090                                         DWC_MODIFY_REG32(&amp;core_if-&gt;
01091                                                          core_global_regs-&gt;
01092                                                          gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
01093                                 } <span class="keywordflow">else</span> {
01094                                         <span class="comment">/* UTMI+ Interface */</span>
01095                                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
01096                                         DWC_MODIFY_REG32(&amp;core_if-&gt;
01097                                                          core_global_regs-&gt;
01098                                                          gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
01099                                         dwc_udelay(10);
01100                                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
01101                                         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0,
01102                                                          pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
01103                                         dwc_udelay(10);
01104                                 }
01105 
01106                                 <span class="comment">/* Set flag to indicate that we are in hibernation */</span>
01107                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> = 1;
01108                                 <span class="comment">/* Enable interrupts from wake up logic */</span>
01109                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
01110                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
01111                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
01112                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
01113                                 dwc_udelay(10);
01114 
01115                                 <span class="comment">/* Unmask device mode interrupts in GPWRDN */</span>
01116                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
01117                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o11">rst_det_msk</a> = 1;
01118                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o9">lnstchng_msk</a> = 1;
01119                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o19">sts_chngint_msk</a> = 1;
01120                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
01121                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
01122                                 dwc_udelay(10);
01123 
01124                                 <span class="comment">/* Enable Power Down Clamp */</span>
01125                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
01126                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o4">pwrdnclmp</a> = 1;
01127                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
01128                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
01129                                 dwc_udelay(10);
01130 
01131                                 <span class="comment">/* Switch off VDD */</span>
01132                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
01133                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
01134                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
01135                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
01136 
01137                                 <span class="comment">/* Save gpwrdn register for further usage if stschng interrupt */</span>
01138                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o39">gr_backup</a>-&gt;gpwrdn_local =
01139                                                         DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
01140                                 DWC_PRINTF(<span class="stringliteral">"Hibernation completed\n"</span>);
01141 
01142                                 <span class="keywordflow">return</span> 1;
01143                         }
01144                 }
01145         } <span class="keywordflow">else</span> {
01146                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == A_PERIPHERAL) {
01147                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"a_peripheral-&gt;a_host\n"</span>);
01148                         <span class="comment">/* Clear the a_peripheral flag, back to a_host. */</span>
01149                         DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
01150                         <a class="code" href="dwc__otg__cil_8h.html#a125">cil_pcd_stop</a>(core_if);
01151                         <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
01152                         DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
01153                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
01154                 }
01155         }
01156 
01157         <span class="comment">/* Change to L2(suspend) state */</span>
01158         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L2;
01159 
01160         <span class="comment">/* Clear interrupt */</span>
01161         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01162         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o12">usbsuspend</a> = 1;
01163         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01164 
01165         <span class="keywordflow">return</span> 1;
01166 }
01167 
01168 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
01169 <span class="preprocessor"></span>
01172 <span class="keyword">static</span> int32_t dwc_otg_handle_lpm_intr(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01173 {
01174         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
01175         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01176 
01177         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o32">lpm_enable</a>) {
01178                 DWC_PRINTF(<span class="stringliteral">"Unexpected LPM interrupt\n"</span>);
01179         }
01180 
01181         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
01182         DWC_PRINTF(<span class="stringliteral">"LPM config register = 0x%08x\n"</span>, lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a>);
01183 
01184         <span class="keywordflow">if</span> (dwc_otg_is_host_mode(core_if)) {
01185                 cil_hcd_sleep(core_if);
01186         } <span class="keywordflow">else</span> {
01187                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o6">hird_thres</a> |= (1 &lt;&lt; 4);
01188                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>,
01189                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a>);
01190         }
01191 
01192         <span class="comment">/* Examine prt_sleep_sts after TL1TokenTetry period max (10 us) */</span>
01193         dwc_udelay(10);
01194         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
01195         <span class="keywordflow">if</span> (lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o8">prt_sleep_sts</a>) {
01196                 <span class="comment">/* Save the current state */</span>
01197                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L1;
01198         }
01199 
01200         <span class="comment">/* Clear interrupt  */</span>
01201         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01202         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o28">lpmtranrcvd</a> = 1;
01203         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01204         <span class="keywordflow">return</span> 1;
01205 }
01206 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_USB_DWC_OTG_LPM */</span>
01207 
<a name="l01211"></a><a class="code" href="dwc__otg__cil__intr_8c.html#a17">01211</a> <span class="keyword">static</span> <span class="keyword">inline</span> uint32_t <a class="code" href="dwc__otg__cil__intr_8c.html#a17">dwc_otg_read_common_intr</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01212 {
01213         <a class="code" href="uniongahbcfg__data.html">gahbcfg_data_t</a> gahbcfg = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
01214         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01215         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk;
01216         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk_common = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
01217         gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o32">wkupintr</a> = 1;
01218         gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o31">sessreqintr</a> = 1;
01219         gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o29">conidstschng</a> = 1;
01220         gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o3">otgintr</a> = 1;
01221         gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o2">modemismatch</a> = 1;
01222         gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o30">disconnect</a> = 1;
01223         gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o12">usbsuspend</a> = 1;
01224 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
01225 <span class="preprocessor"></span>        gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o28">lpmtranrcvd</a> = 1;
01226 <span class="preprocessor">#endif</span>
01227 <span class="preprocessor"></span>        gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o17">restoredone</a> = 1;
01231         gintmsk_common.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o25">portintr</a> = 1;
01232 
01233         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01234         gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>);
01235         gahbcfg.<a class="code" href="uniongahbcfg__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o2">gahbcfg</a>);
01236 
01237 <span class="preprocessor">#ifdef DEBUG</span>
01238 <span class="preprocessor"></span>        <span class="comment">/* if any common interrupts set */</span>
01239         <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> &amp; gintmsk_common.<a class="code" href="uniongintmsk__data.html#o0">d32</a>) {
01240                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"gintsts=%08x  gintmsk=%08x\n"</span>,
01241                             gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
01242         }
01243 <span class="preprocessor">#endif</span>
01244 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (gahbcfg.<a class="code" href="uniongahbcfg__data.html#o12">b</a>.<a class="code" href="uniongahbcfg__data.html#o1">glblintrmsk</a>)      
01245                 <span class="keywordflow">return</span> ((gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> &amp; gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>) &amp; gintmsk_common.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
01246         <span class="keywordflow">else</span>
01247                 <span class="keywordflow">return</span> 0;
01248 
01249 }
01250 
01251 <span class="comment">/* MACRO for clearing interupt bits in GPWRDN register */</span>
01252 <span class="preprocessor">#define CLEAR_GPWRDN_INTR(__core_if,__intr) \</span>
01253 <span class="preprocessor">do { \</span>
01254 <span class="preprocessor">                gpwrdn_data_t gpwrdn = {.d32=0}; \</span>
01255 <span class="preprocessor">                gpwrdn.b.__intr = 1; \</span>
01256 <span class="preprocessor">                DWC_MODIFY_REG32(&amp;__core_if-&gt;core_global_regs-&gt;gpwrdn, \</span>
01257 <span class="preprocessor">                0, gpwrdn.d32); \</span>
01258 <span class="preprocessor">} while (0)</span>
01259 <span class="preprocessor"></span>
<a name="l01275"></a><a class="code" href="dwc__otg__core__if_8h.html#a69">01275</a> int32_t <a class="code" href="dwc__otg__core__if_8h.html#a69">dwc_otg_handle_common_intr</a>(<span class="keywordtype">void</span> *dev)
01276 {
01277         <span class="keywordtype">int</span> retval = 0;
01278         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01279         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.<a class="code" href="uniongahbcfg__data.html#o0">d32</a> = 0 };
01280         <a class="code" href="structdwc__otg__device.html">dwc_otg_device_t</a> *otg_dev = dev;
01281         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#o1">core_if</a>;
01282         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
01283         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if))
01284                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o52">frame_num</a> = <a class="code" href="dwc__otg__cil_8h.html#a77">dwc_otg_get_frame_number</a>(core_if);
01285                 
01286         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>)
01287                 DWC_SPINLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
01288 
01289         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> &lt;= 0) {
01290                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil__intr_8c.html#a17">dwc_otg_read_common_intr</a>(core_if);
01291 
01292                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o2">modemismatch</a>) {
01293                         retval |= <a class="code" href="dwc__otg__cil__intr_8c.html#a1">dwc_otg_handle_mode_mismatch_intr</a>(core_if);
01294                 }
01295                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o3">otgintr</a>) {
01296                         retval |= <a class="code" href="dwc__otg__cil__intr_8c.html#a2">dwc_otg_handle_otg_intr</a>(core_if);
01297                 }
01298                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o29">conidstschng</a>) {
01299                         retval |= <a class="code" href="dwc__otg__cil__intr_8c.html#a4">dwc_otg_handle_conn_id_status_change_intr</a>(core_if);
01300                 }
01301                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o30">disconnect</a>) {
01302                         retval |= <a class="code" href="dwc__otg__cil__intr_8c.html#a15">dwc_otg_handle_disconnect_intr</a>(core_if);
01303                 }
01304                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o31">sessreqintr</a>) {
01305                         retval |= <a class="code" href="dwc__otg__cil__intr_8c.html#a5">dwc_otg_handle_session_req_intr</a>(core_if);
01306                 }
01307                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o32">wkupintr</a>) {
01308                         retval |= <a class="code" href="dwc__otg__cil__intr_8c.html#a7">dwc_otg_handle_wakeup_detected_intr</a>(core_if);
01309                 }
01310                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o12">usbsuspend</a>) {
01311                         retval |= <a class="code" href="dwc__otg__cil__intr_8c.html#a16">dwc_otg_handle_usb_suspend_intr</a>(core_if);
01312                 }
01313 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
01314 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o28">lpmtranrcvd</a>) {
01315                         retval |= dwc_otg_handle_lpm_intr(core_if);
01316                 }
01317 <span class="preprocessor">#endif</span>
01318 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o17">restoredone</a>) {
01319                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01320                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2)
01321                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> = -1;
01322                         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o17">restoredone</a> = 1;
01323                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>,gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01324                         DWC_PRINTF(<span class="stringliteral">" --Restore done interrupt received-- \n"</span>);
01325                         retval |= 1;
01326                 }
01327                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o25">portintr</a> &amp;&amp; dwc_otg_is_device_mode(core_if)) {
01328                         <span class="comment">/* The port interrupt occurs while in device mode with HPRT0</span>
01329 <span class="comment">                         * Port Enable/Disable.</span>
01330 <span class="comment">                         */</span>
01331                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01332                         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o25">portintr</a> = 1;
01333                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>,gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01334                         retval |= 1;
01335 
01336                 }
01337         } <span class="keywordflow">else</span> {
01338                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"gpwrdn=%08x\n"</span>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
01339 
01340                 <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o12">disconn_det</a> &amp;&amp; gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o13">disconn_det_msk</a>) {
01341                         CLEAR_GPWRDN_INTR(core_if, disconn_det);
01342                         <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o20">linestate</a> == 0) {
01343                                 <a class="code" href="dwc__otg__cil__intr_8c.html#a8">dwc_otg_handle_pwrdn_disconnect_intr</a>(core_if);
01344                         } <span class="keywordflow">else</span> {
01345                                 DWC_PRINTF(<span class="stringliteral">"Disconnect detected while linestate is not 0\n"</span>);
01346                         }
01347 
01348                         retval |= 1;
01349                 }
01350                 <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o8">lnstschng</a> &amp;&amp; gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o9">lnstchng_msk</a>) {
01351                         CLEAR_GPWRDN_INTR(core_if, lnstschng);
01352                         <span class="comment">/* remote wakeup from hibernation */</span>
01353                         <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o20">linestate</a> == 2 || gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o20">linestate</a> == 1) {
01354                                 <a class="code" href="dwc__otg__cil__intr_8c.html#a9">dwc_otg_handle_pwrdn_wakeup_detected_intr</a>(core_if);
01355                         } <span class="keywordflow">else</span> {
01356                                 DWC_PRINTF(<span class="stringliteral">"gpwrdn.linestate = %d\n"</span>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o20">linestate</a>);
01357                         }
01358                         retval |= 1;
01359                 }
01360                 <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o10">rst_det</a> &amp;&amp; gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o11">rst_det_msk</a>) {
01361                         CLEAR_GPWRDN_INTR(core_if, rst_det);
01362                         <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o20">linestate</a> == 0) {
01363                                 DWC_PRINTF(<span class="stringliteral">"Reset detected\n"</span>);
01364                                 retval |= dwc_otg_device_hibernation_restore(core_if, 0, 1);
01365                         }
01366                 }
01367                 <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o16">srp_det</a> &amp;&amp; gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o17">srp_det_msk</a>) {
01368                         CLEAR_GPWRDN_INTR(core_if, srp_det);
01369                         <a class="code" href="dwc__otg__cil__intr_8c.html#a13">dwc_otg_handle_pwrdn_srp_intr</a>(core_if);
01370                         retval |= 1;
01371                 }
01372         }
01373         <span class="comment">/* Handle ADP interrupt here */</span>
01374         <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o23">adp_int</a>) {
01375                 DWC_PRINTF(<span class="stringliteral">"ADP interrupt\n"</span>);
01376                 CLEAR_GPWRDN_INTR(core_if, adp_int);
01377                 <a class="code" href="dwc__otg__adp_8h.html#a13">dwc_otg_adp_handle_intr</a>(core_if);
01378                 retval |= 1;
01379         }
01380         <span class="keywordflow">if</span> (gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o18">sts_chngint</a> &amp;&amp; gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o19">sts_chngint_msk</a>) {
01381                 DWC_PRINTF(<span class="stringliteral">"STS CHNG interrupt asserted\n"</span>);
01382                 CLEAR_GPWRDN_INTR(core_if, sts_chngint);
01383                 <a class="code" href="dwc__otg__cil__intr_8c.html#a12">dwc_otg_handle_pwrdn_stschng_intr</a>(otg_dev);
01384 
01385                 retval |= 1;
01386         }
01387         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>)
01388                 DWC_SPINUNLOCK(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a>);
01389 
01390         <span class="keywordflow">return</span> retval;
01391 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 27 03:56:37 2011 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
