<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_cfi.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>dwc_otg_cfi.h</h1><a href="dwc__otg__cfi_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/* ==========================================================================</span>
00002 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
00003 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
00004 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
00007 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
00008 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
00009 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
00010 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
00011 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
00012 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
00013 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
00014 <span class="comment"> * below, then you are not authorized to use the Software.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
00017 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00018 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00019 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
00020 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
00021 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
00022 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
00023 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00024 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00025 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
00026 <span class="comment"> * DAMAGE.</span>
00027 <span class="comment"> * ========================================================================== */</span>
00028 
00029 <span class="preprocessor">#if !defined(__DWC_OTG_CFI_H__)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#define __DWC_OTG_CFI_H__</span>
00031 <span class="preprocessor"></span>
00032 <span class="preprocessor">#include "<a class="code" href="dwc__otg__pcd_8h.html">dwc_otg_pcd.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="dwc__cfi__common_8h.html">dwc_cfi_common.h</a>"</span>
00034 
00044 <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a>;
00045 <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a>;
00046 
<a name="l00049"></a><a class="code" href="dwc__otg__cfi_8h.html#a1">00049</a> <span class="preprocessor">#define FT_ID_DMA_MODE                                  0x0001</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#define FT_ID_DMA_BUFFER_SETUP                  0x0002</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#define FT_ID_DMA_BUFF_ALIGN                    0x0003</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#define FT_ID_DMA_CONCAT_SETUP                  0x0004</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#define FT_ID_DMA_CIRCULAR                              0x0005</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#define FT_ID_THRESHOLD_SETUP                   0x0006</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#define FT_ID_DFIFO_DEPTH                               0x0007</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#define FT_ID_TX_FIFO_DEPTH                             0x0008</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#define FT_ID_RX_FIFO_DEPTH                             0x0009</span>
00058 <span class="preprocessor"></span>
00059 <span class="comment">/**********************************************************/</span>
00060 <span class="preprocessor">#define CFI_INFO_DEF</span>
00061 <span class="preprocessor"></span>
00062 <span class="preprocessor">#ifdef CFI_INFO_DEF</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#define CFI_INFO(fmt...)        DWC_PRINTF("CFI: " fmt);</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00065 <span class="preprocessor"></span><span class="preprocessor">#define CFI_INFO(fmt...)</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00067 <span class="preprocessor"></span>
00068 <span class="preprocessor">#define min(x,y) ({ \</span>
00069 <span class="preprocessor">        x &lt; y ? x : y; })</span>
00070 <span class="preprocessor"></span>
00071 <span class="preprocessor">#define max(x,y) ({ \</span>
00072 <span class="preprocessor">        x &gt; y ? x : y; })</span>
00073 <span class="preprocessor"></span>
<a name="l00078"></a><a class="code" href="struct__ddma__sg__buffer__setup.html">00078</a> <span class="keyword">struct </span><a class="code" href="struct__ddma__sg__buffer__setup.html">_ddma_sg_buffer_setup</a> {
00079 <span class="preprocessor">#define BS_SG_VAL_DESC_LEN      6</span>
00080 <span class="preprocessor"></span>        <span class="comment">/* The OUT EP address */</span>
00081         uint8_t bOutEndpointAddress;
00082         <span class="comment">/* The IN EP address */</span>
00083         uint8_t bInEndpointAddress;
00084         <span class="comment">/* Number of bytes to put between transfer segments (must be DWORD boundaries) */</span>
00085         uint8_t bOffset;
00086         <span class="comment">/* The number of transfer segments (a DMA descriptors per each segment) */</span>
00087         uint8_t bCount;
00088         <span class="comment">/* Size (in byte) of each transfer segment */</span>
00089         uint16_t wSize;
00090 } __attribute__ ((packed));
00091 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__ddma__sg__buffer__setup.html">_ddma_sg_buffer_setup</a> ddma_sg_buffer_setup_t;
00092 
<a name="l00094"></a><a class="code" href="struct__ddma__concat__buffer__setup__hdr.html">00094</a> <span class="keyword">struct </span><a class="code" href="struct__ddma__concat__buffer__setup__hdr.html">_ddma_concat_buffer_setup_hdr</a> {
00095 <span class="preprocessor">#define BS_CONCAT_VAL_HDR_LEN   4</span>
00096 <span class="preprocessor"></span>        <span class="comment">/* The endpoint for which the buffer is to be set up */</span>
00097         uint8_t bEndpointAddress;
00098         <span class="comment">/* The count of descriptors to be used */</span>
00099         uint8_t bDescCount;
00100         <span class="comment">/* The total size of the transfer */</span>
00101         uint16_t wSize;
00102 } __attribute__ ((packed));
00103 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__ddma__concat__buffer__setup__hdr.html">_ddma_concat_buffer_setup_hdr</a> ddma_concat_buffer_setup_hdr_t;
00104 
<a name="l00106"></a><a class="code" href="struct__ddma__concat__buffer__setup.html">00106</a> <span class="keyword">struct </span><a class="code" href="struct__ddma__concat__buffer__setup.html">_ddma_concat_buffer_setup</a> {
00107         <span class="comment">/* The SG header */</span>
00108         ddma_concat_buffer_setup_hdr_t hdr;
00109 
00110         <span class="comment">/* The XFER sizes pointer (allocated dynamically) */</span>
00111         uint16_t *wTxBytes;
00112 } __attribute__ ((packed));
00113 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__ddma__concat__buffer__setup.html">_ddma_concat_buffer_setup</a> ddma_concat_buffer_setup_t;
00114 
<a name="l00116"></a><a class="code" href="struct__ddma__align__buffer__setup.html">00116</a> <span class="keyword">struct </span><a class="code" href="struct__ddma__align__buffer__setup.html">_ddma_align_buffer_setup</a> {
00117 <span class="preprocessor">#define BS_ALIGN_VAL_HDR_LEN    2</span>
00118 <span class="preprocessor"></span>        uint8_t bEndpointAddress;
00119         uint8_t bAlign;
00120 } __attribute__ ((packed));
00121 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__ddma__align__buffer__setup.html">_ddma_align_buffer_setup</a> ddma_align_buffer_setup_t;
00122 
<a name="l00124"></a><a class="code" href="struct__tx__fifo__size__setup.html">00124</a> <span class="keyword">struct </span><a class="code" href="struct__tx__fifo__size__setup.html">_tx_fifo_size_setup</a> {
00125         uint8_t bEndpointAddress;
00126         uint16_t wDepth;
00127 } __attribute__ ((packed));
00128 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__tx__fifo__size__setup.html">_tx_fifo_size_setup</a> tx_fifo_size_setup_t;
00129 
<a name="l00131"></a><a class="code" href="struct__rx__fifo__size__setup.html">00131</a> <span class="keyword">struct </span><a class="code" href="struct__rx__fifo__size__setup.html">_rx_fifo_size_setup</a> {
00132         uint16_t wDepth;
00133 } __attribute__ ((packed));
00134 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__rx__fifo__size__setup.html">_rx_fifo_size_setup</a> rx_fifo_size_setup_t;
00135 
<a name="l00141"></a><a class="code" href="structcfi__usb__ctrlrequest.html">00141</a> <span class="keyword">struct </span><a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> {
00142         uint8_t bRequestType;
00143         uint8_t bRequest;
00144         uint16_t wValue;
00145         uint16_t wIndex;
00146         uint16_t wLength;
00147         uint8_t *data;
00148 } UPACKED;
00149 
00150 <span class="comment">/*---------------------------------------------------------------------------*/</span>
00151 
<a name="l00157"></a><a class="code" href="structcfi__ep.html">00157</a> <span class="keyword">struct </span><a class="code" href="structcfi__ep.html">cfi_ep</a> {
00158         <span class="comment">/* Entry for the list container */</span>
00159         dwc_list_link_t lh;
00160         <span class="comment">/* Pointer to the active PCD endpoint structure */</span>
00161         <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> *ep;
00162         <span class="comment">/* The last descriptor in the chain of DMA descriptors of the endpoint */</span>
00163         <span class="keyword">struct </span>dwc_otg_dma_desc *dma_desc_last;
00164         <span class="comment">/* The SG feature value */</span>
00165         ddma_sg_buffer_setup_t *bm_sg;
00166         <span class="comment">/* The Circular feature value */</span>
00167         ddma_sg_buffer_setup_t *bm_circ;
00168         <span class="comment">/* The Concatenation feature value */</span>
00169         ddma_concat_buffer_setup_t *bm_concat;
00170         <span class="comment">/* The Alignment feature value */</span>
00171         ddma_align_buffer_setup_t *bm_align;
00172         <span class="comment">/* XFER length */</span>
00173         uint32_t xfer_len;
00174         <span class="comment">/*</span>
00175 <span class="comment">         * Count of DMA descriptors currently used.</span>
00176 <span class="comment">         * The total should not exceed the MAX_DMA_DESCS_PER_EP value</span>
00177 <span class="comment">         * defined in the dwc_otg_cil.h</span>
00178 <span class="comment">         */</span>
00179         uint32_t desc_count;
00180 };
00181 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structcfi__ep.html">cfi_ep</a> cfi_ep_t;
00182 
00183 <span class="keyword">typedef</span> <span class="keyword">struct </span>cfi_dma_buff {
00184 <span class="preprocessor">#define CFI_IN_BUF_LEN  1024</span>
00185 <span class="preprocessor"></span><span class="preprocessor">#define CFI_OUT_BUF_LEN 1024</span>
00186 <span class="preprocessor"></span>        dma_addr_t addr;
00187         uint8_t *buf;
00188 } cfi_dma_buff_t;
00189 
00190 <span class="keyword">struct </span>cfiobject;
00191 
<a name="l00200"></a><a class="code" href="structcfi__ops.html">00200</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structcfi__ops.html">cfi_ops</a> {
00201         int (*ep_enable) (<span class="keyword">struct </span>cfiobject * cfi, <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> * pcd,
00202                           <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> * ep);
00203         <span class="keywordtype">void</span> *(*ep_alloc_buf) (<span class="keyword">struct </span>cfiobject * cfi, <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> * pcd,
00204                                <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> * ep, dma_addr_t * dma,
00205                                <span class="keywordtype">unsigned</span> size, gfp_t flags);
00206         void (*release) (<span class="keyword">struct </span>cfiobject * cfi);
00207         int (*ctrl_write_complete) (<span class="keyword">struct </span>cfiobject * cfi,
00208                                     <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> * pcd);
00209         void (*build_descriptors) (<span class="keyword">struct </span>cfiobject * cfi,
00210                                    <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> * pcd,
00211                                    <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> * ep,
00212                                    <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req);
00213 } <a class="code" href="structcfi__ops.html">cfi_ops_t</a>;
00214 
00215 <span class="keyword">struct </span>cfiobject {
00216         <a class="code" href="structcfi__ops.html">cfi_ops_t</a> ops;
00217         <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd;
00218         <span class="keyword">struct </span>usb_gadget *gadget;
00219 
00220         <span class="comment">/* Buffers used to send/receive CFI-related request data */</span>
00221         cfi_dma_buff_t buf_in;
00222         cfi_dma_buff_t buf_out;
00223 
00224         <span class="comment">/* CFI specific Control request wrapper */</span>
00225         <span class="keyword">struct </span><a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> ctrl_req;
00226 
00227         <span class="comment">/* The list of active EP's in the PCD of type cfi_ep_t */</span>
00228         dwc_list_link_t active_eps;
00229 
00230         <span class="comment">/* This flag shall control the propagation of a specific request</span>
00231 <span class="comment">         * to the gadget's processing routines.</span>
00232 <span class="comment">         * 0 - no gadget handling</span>
00233 <span class="comment">         * 1 - the gadget needs to know about this request (w/o completing a status</span>
00234 <span class="comment">         * phase - just return a 0 to the _setup callback)</span>
00235 <span class="comment">         */</span>
00236         uint8_t need_gadget_att;
00237 
00238         <span class="comment">/* Flag indicating whether the status IN phase needs to be</span>
00239 <span class="comment">         * completed by the PCD</span>
00240 <span class="comment">         */</span>
00241         uint8_t need_status_in_complete;
00242 };
00243 <span class="keyword">typedef</span> <span class="keyword">struct </span>cfiobject cfiobject_t;
00244 
00245 <span class="preprocessor">#define DUMP_MSG</span>
00246 <span class="preprocessor"></span>
00247 <span class="preprocessor">#if defined(DUMP_MSG)</span>
00248 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> dump_msg(<span class="keyword">const</span> u8 * buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length)
00249 {
00250         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> start, num, i;
00251         <span class="keywordtype">char</span> line[52], *p;
00252 
00253         <span class="keywordflow">if</span> (length &gt;= 512)
00254                 <span class="keywordflow">return</span>;
00255 
00256         start = 0;
00257         <span class="keywordflow">while</span> (length &gt; 0) {
00258                 num = min(length, 16u);
00259                 p = line;
00260                 <span class="keywordflow">for</span> (i = 0; i &lt; num; ++i) {
00261                         <span class="keywordflow">if</span> (i == 8)
00262                                 *p++ = <span class="charliteral">' '</span>;
00263                         DWC_SPRINTF(p, <span class="stringliteral">" %02x"</span>, buf[i]);
00264                         p += 3;
00265                 }
00266                 *p = 0;
00267                 DWC_DEBUG(<span class="stringliteral">"%6x: %s\n"</span>, start, line);
00268                 buf += num;
00269                 start += num;
00270                 length -= num;
00271         }
00272 }
00273 <span class="preprocessor">#else</span>
00274 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> dump_msg(<span class="keyword">const</span> u8 * buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length)
00275 {
00276 }
00277 <span class="preprocessor">#endif</span>
00278 <span class="preprocessor"></span>
<a name="l00282"></a><a class="code" href="dwc__otg__cfi_8h.html#a33">00282</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structcfi__ep.html">cfi_ep</a> *<a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(<span class="keyword">struct</span> cfiobject *cfi,
00283                                                 uint8_t addr)
00284 {
00285         <span class="keyword">struct </span><a class="code" href="structcfi__ep.html">cfi_ep</a> *pcfiep;
00286         dwc_list_link_t *tmp;
00287 
00288         DWC_LIST_FOREACH(tmp, &amp;cfi-&gt;active_eps) {
00289                 pcfiep = DWC_LIST_ENTRY(tmp, <span class="keyword">struct</span> <a class="code" href="structcfi__ep.html">cfi_ep</a>, lh);
00290 
00291                 <span class="keywordflow">if</span> (pcfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>-&gt;bEndpointAddress == addr) {
00292                         <span class="keywordflow">return</span> pcfiep;
00293                 }
00294         }
00295 
00296         <span class="keywordflow">return</span> NULL;
00297 }
00298 
<a name="l00303"></a><a class="code" href="dwc__otg__cfi_8h.html#a34">00303</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structcfi__ep.html">cfi_ep</a> *<a class="code" href="dwc__otg__cfi_8h.html#a34">get_cfi_ep_by_pcd_ep</a>(<span class="keyword">struct</span> cfiobject *cfi,
00304                                                   <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> *ep)
00305 {
00306         <span class="keyword">struct </span><a class="code" href="structcfi__ep.html">cfi_ep</a> *pcfiep = NULL;
00307         dwc_list_link_t *tmp;
00308 
00309         DWC_LIST_FOREACH(tmp, &amp;cfi-&gt;active_eps) {
00310                 pcfiep = DWC_LIST_ENTRY(tmp, <span class="keyword">struct</span> <a class="code" href="structcfi__ep.html">cfi_ep</a>, lh);
00311                 <span class="keywordflow">if</span> (pcfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a> == ep) {
00312                         <span class="keywordflow">return</span> pcfiep;
00313                 }
00314         }
00315         <span class="keywordflow">return</span> NULL;
00316 }
00317 
00318 <span class="keywordtype">int</span> cfi_setup(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd, <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *ctrl);
00319 
00320 <span class="preprocessor">#endif </span><span class="comment">/* (__DWC_OTG_CFI_H__) */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 27 03:56:37 2011 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
