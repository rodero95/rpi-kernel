<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_pcd.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>dwc_otg_pcd.c</h1><a href="dwc__otg__pcd_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/* ==========================================================================</span>
00002 <span class="comment"> * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_pcd.c $</span>
00003 <span class="comment"> * $Revision: #99 $</span>
00004 <span class="comment"> * $Date: 2011/10/24 $</span>
00005 <span class="comment"> * $Change: 1871160 $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
00008 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
00009 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
00012 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
00013 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
00014 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
00015 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
00016 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
00017 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
00018 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
00019 <span class="comment"> * below, then you are not authorized to use the Software.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
00022 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
00025 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
00026 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
00027 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
00028 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
00031 <span class="comment"> * DAMAGE.</span>
00032 <span class="comment"> * ========================================================================== */</span>
00033 <span class="preprocessor">#ifndef DWC_HOST_ONLY</span>
00034 <span class="preprocessor"></span>
00051 <span class="preprocessor">#include "<a class="code" href="dwc__otg__pcd_8h.html">dwc_otg_pcd.h</a>"</span>
00052 
00053 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="dwc__otg__cfi_8h.html">dwc_otg_cfi.h</a>"</span>
00055 
00056 <span class="keyword">extern</span> <span class="keywordtype">int</span> init_cfi(cfiobject_t * cfiobj);
00057 <span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span>
<a name="l00062"></a><a class="code" href="dwc__otg__pcd_8c.html#a1">00062</a> <span class="keyword">static</span> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *<a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *handle)
00063 {
00064         <span class="keywordtype">int</span> i;
00065         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#o9">priv</a> == handle) {
00066                 <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00067         }
00068         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dwc__otg__core__if_8h.html#a3">MAX_EPS_CHANNELS</a> - 1; i++) {
00069                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o9">priv</a> == handle)
00070                         <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i];
00071                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o9">priv</a> == handle)
00072                         <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i];
00073         }
00074 
00075         <span class="keywordflow">return</span> NULL;
00076 }
00077 
<a name="l00081"></a><a class="code" href="dwc__otg__pcd_8h.html#a17">00081</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8h.html#a17">dwc_otg_request_done</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep, <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req,
00082                           int32_t status)
00083 {
00084         <span class="keywordtype">unsigned</span> stopped = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>;
00085         
00086         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s(ep %p req %p)\n"</span>, __func__, ep, req);
00087         DWC_CIRCLEQ_REMOVE_INIT(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>, req, queue_entry);
00088 
00089         <span class="comment">/* don't modify queue heads during completion callback */</span>
00090         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
00091         <span class="comment">/* spin_unlock/spin_lock now done in fops-&gt;complete() */</span>
00092         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o3">complete</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o9">priv</a>, req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o0">priv</a>, status,
00093                                 req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o4">actual</a>);
00094 
00095         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o10">request_pending</a> &gt; 0) {
00096                 --ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o10">request_pending</a>;
00097         }
00098 
00099         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = stopped;
00100         DWC_FREE(req);
00101 }
00102 
<a name="l00106"></a><a class="code" href="dwc__otg__pcd_8h.html#a16">00106</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8h.html#a16">dwc_otg_request_nuke</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
00107 {
00108         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req;
00109 
00110         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
00111 
00112         <span class="comment">/* called with irqs blocked?? */</span>
00113         <span class="keywordflow">while</span> (!DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>)) {
00114                 req = DWC_CIRCLEQ_FIRST(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
00115                 <a class="code" href="dwc__otg__pcd_8h.html#a17">dwc_otg_request_done</a>(ep, req, -DWC_E_SHUTDOWN);
00116         }
00117 }
00118 
<a name="l00119"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a18">00119</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a18">dwc_otg_pcd_start</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
00120                        <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd__function__ops.html">dwc_otg_pcd_function_ops</a> *fops)
00121 {
00122         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a> = fops;
00123 }
00124 
<a name="l00131"></a><a class="code" href="dwc__otg__pcd_8c.html#a5">00131</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd_8c.html#a5">dwc_otg_pcd_start_cb</a>(<span class="keywordtype">void</span> *p)
00132 {
00133         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) p;
00134         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00135 
00136         <span class="comment">/*</span>
00137 <span class="comment">         * Initialized the Core for Device mode.</span>
00138 <span class="comment">         */</span>
00139         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if)) {
00140                 <a class="code" href="dwc__otg__cil_8h.html#a74">dwc_otg_core_dev_init</a>(core_if);
00141                 <span class="comment">/* Set core_if's lock pointer to the pcd-&gt;lock */</span>
00142                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a> = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>;
00143         }
00144         <span class="keywordflow">return</span> 1;
00145 }
00146 
00148 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
00149 <span class="preprocessor"></span>uint8_t *<a class="code" href="dwc__otg__pcd__if_8h.html#a41">cfiw_ep_alloc_buffer</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *pep, dwc_dma_t * addr,
00150                               size_t buflen, <span class="keywordtype">int</span> flags)
00151 {
00152         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00153         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, pep);
00154         <span class="keywordflow">if</span> (!ep) {
00155                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
00156                 <span class="keywordflow">return</span> -DWC_E_INVALID;
00157         }
00158 
00159         <span class="keywordflow">return</span> pcd-&gt;cfi-&gt;ops.ep_alloc_buf(pcd-&gt;cfi, pcd, ep, addr, buflen,
00160                                           flags);
00161 }
00162 <span class="preprocessor">#else</span>
00163 <span class="preprocessor"></span>uint8_t *<a class="code" href="dwc__otg__pcd__if_8h.html#a41">cfiw_ep_alloc_buffer</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *pep, dwc_dma_t * addr,
00164                               size_t buflen, <span class="keywordtype">int</span> flags);
00165 <span class="preprocessor">#endif</span>
00166 <span class="preprocessor"></span>
<a name="l00173"></a><a class="code" href="dwc__otg__pcd_8c.html#a7">00173</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd_8c.html#a7">dwc_otg_pcd_resume_cb</a>(<span class="keywordtype">void</span> *p)
00174 {
00175         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) p;
00176 
00177         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o7">resume</a>) {
00178                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o7">resume</a>(pcd);
00179         }
00180 
00181         <span class="comment">/* Stop the SRP timeout timer. */</span>
00182         <span class="keywordflow">if</span> ((<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_params-&gt;phy_type != DWC_PHY_TYPE_PARAM_FS)
00183             || (!<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_params-&gt;i2c_enable)) {
00184                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;srp_timer_started) {
00185                         <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;srp_timer_started = 0;
00186                         DWC_TIMER_CANCEL(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;srp_timer);
00187                 }
00188         }
00189         <span class="keywordflow">return</span> 1;
00190 }
00191 
<a name="l00197"></a><a class="code" href="dwc__otg__pcd_8c.html#a8">00197</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd_8c.html#a8">dwc_otg_pcd_suspend_cb</a>(<span class="keywordtype">void</span> *p)
00198 {
00199         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) p;
00200 
00201         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o5">suspend</a>) {
00202                 DWC_SPINUNLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
00203                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o5">suspend</a>(pcd);
00204                 DWC_SPINLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
00205         }
00206 
00207         <span class="keywordflow">return</span> 1;
00208 }
00209 
<a name="l00216"></a><a class="code" href="dwc__otg__pcd_8c.html#a9">00216</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd_8c.html#a9">dwc_otg_pcd_stop_cb</a>(<span class="keywordtype">void</span> *p)
00217 {
00218         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) p;
00219         <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a15">dwc_otg_pcd_stop</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * _pcd);
00220 
00221         <a class="code" href="dwc__otg__pcd__intr_8c.html#a15">dwc_otg_pcd_stop</a>(pcd);
00222         <span class="keywordflow">return</span> 1;
00223 }
00224 
<a name="l00228"></a><a class="code" href="dwc__otg__pcd_8c.html#a0">00228</a> <span class="keyword">static</span> <a class="code" href="structdwc__otg__cil__callbacks.html">dwc_otg_cil_callbacks_t</a> <a class="code" href="dwc__otg__pcd_8c.html#a0">pcd_callbacks</a> = {
00229         .<a class="code" href="structdwc__otg__cil__callbacks.html#o0">start</a> = dwc_otg_pcd_start_cb,
00230         .<a class="code" href="structdwc__otg__cil__callbacks.html#o1">stop</a> = dwc_otg_pcd_stop_cb,
00231         .<a class="code" href="structdwc__otg__cil__callbacks.html#o4">suspend</a> = dwc_otg_pcd_suspend_cb,
00232         .<a class="code" href="structdwc__otg__cil__callbacks.html#o3">resume_wakeup</a> = dwc_otg_pcd_resume_cb,
00233         .<a class="code" href="structdwc__otg__cil__callbacks.html#o6">p</a> = 0,                 <span class="comment">/* Set at registration */</span>
00234 };
00235 
<a name="l00240"></a><a class="code" href="dwc__otg__pcd_8c.html#a10">00240</a> <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *<a class="code" href="dwc__otg__pcd_8c.html#a10">dwc_otg_ep_alloc_desc_chain</a>(dwc_dma_t * dma_desc_addr,
00241                                                     uint32_t count)
00242 {
00243         <span class="keywordflow">return</span> DWC_DMA_ALLOC_ATOMIC(count * <span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a>), 
00244                                                         dma_desc_addr);
00245 }
00246 
<a name="l00250"></a><a class="code" href="dwc__otg__pcd_8c.html#a11">00250</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(<a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> * desc_addr,
00251                                 uint32_t dma_desc_addr, uint32_t count)
00252 {
00253         DWC_DMA_FREE(count * <span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a>), desc_addr,
00254                      dma_desc_addr);
00255 }
00256 
00257 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
00258 <span class="preprocessor"></span>
<a name="l00266"></a><a class="code" href="dwc__otg__pcd_8c.html#a12">00266</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a12">dwc_otg_iso_ep_start_ddma_transfer</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
00267                                         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * <a class="code" href="structdwc__ep.html">dwc_ep</a>)
00268 {
00269 
00270         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts = {.d32 = 0 };
00271         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = 0 };
00272         <span class="keyword">volatile</span> uint32_t *addr;
00273         <span class="keywordtype">int</span> i, j;
00274         uint32_t len;
00275 
00276         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>)
00277                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_21">buf_proc_intrvl</a> / dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
00278         <span class="keywordflow">else</span>
00279                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> =
00280                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_21">buf_proc_intrvl</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> /
00281                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
00282 
00284         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a> =
00285             <a class="code" href="dwc__otg__pcd_8c.html#a10">dwc_otg_ep_alloc_desc_chain</a>(&amp;dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_16">iso_dma_desc_addr</a>,
00286                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> * 2);
00287         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>) {
00288                 DWC_WARN(<span class="stringliteral">"%s, can't allocate DMA descriptor chain\n"</span>, __func__);
00289                 <span class="keywordflow">return</span>;
00290         }
00291 
00292         dsts.<a class="code" href="uniondsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o2">dsts</a>);
00293 
00295         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> == 0) {
00296                 <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> sts = {.<a class="code" href="uniondsts__data.html#o0">d32</a> = 0 };
00297                 <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a>;
00298                 dma_addr_t dma_ad;
00299                 uint32_t data_per_desc;
00300                 <a class="code" href="structdwc__otg__dev__out__ep__regs.html">dwc_otg_dev_out_ep_regs_t</a> *out_regs =
00301                     core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>];
00302                 <span class="keywordtype">int</span> offset;
00303 
00304                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>;
00305                 dma_ad = (dma_addr_t) DWC_READ_REG32(&amp;(out_regs-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o5">doepdma</a>));
00306 
00308                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
00309 
00310                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> = BS_HOST_READY;
00311                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o16">rxsts</a> = 0;
00312                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 0;
00313                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o7">sp</a> = 0;
00314                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 0;
00315                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o15">pid</a> = 0;
00316                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> = 0;
00317 
00318                 offset = 0;
00319                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>;
00320                      i += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>) {
00321 
00322                         <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>; ++j) {
00323                                 uint32_t len = (j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00324                                 <span class="keywordflow">if</span> (len &gt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>)
00325                                         data_per_desc =
00326                                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
00327                                             j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00328                                 <span class="keywordflow">else</span>
00329                                         data_per_desc = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00330                                 len = data_per_desc % 4;
00331                                 <span class="keywordflow">if</span> (len)
00332                                         data_per_desc += 4 - len;
00333 
00334                                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> = data_per_desc;
00335                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00336                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00337 
00338                                 offset += data_per_desc;
00339                                 dma_desc++;
00340                                 dma_ad += data_per_desc;
00341                         }
00342                 }
00343 
00344                 <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> - 1; ++j) {
00345                         uint32_t len = (j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00346                         <span class="keywordflow">if</span> (len &gt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>)
00347                                 data_per_desc =
00348                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
00349                                     j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00350                         <span class="keywordflow">else</span>
00351                                 data_per_desc = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00352                         len = data_per_desc % 4;
00353                         <span class="keywordflow">if</span> (len)
00354                                 data_per_desc += 4 - len;
00355                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> = data_per_desc;
00356                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00357                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00358 
00359                         offset += data_per_desc;
00360                         dma_desc++;
00361                         dma_ad += data_per_desc;
00362                 }
00363 
00364                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 1;
00365                 len = (j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00366                 <span class="keywordflow">if</span> (len &gt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>)
00367                         data_per_desc =
00368                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> - j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00369                 <span class="keywordflow">else</span>
00370                         data_per_desc = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00371                 len = data_per_desc % 4;
00372                 <span class="keywordflow">if</span> (len)
00373                         data_per_desc += 4 - len;
00374                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> = data_per_desc;
00375 
00376                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00377                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00378                 dma_desc++;
00379 
00381                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 0;
00382                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a>;
00383 
00384                 offset = 0;
00385                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>;
00386                      i += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>) {
00387                         <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>; ++j) {
00388                                 uint32_t len = (j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00389                                 <span class="keywordflow">if</span> (len &gt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>)
00390                                         data_per_desc =
00391                                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
00392                                             j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00393                                 <span class="keywordflow">else</span>
00394                                         data_per_desc = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00395                                 len = data_per_desc % 4;
00396                                 <span class="keywordflow">if</span> (len)
00397                                         data_per_desc += 4 - len;
00398 
00399                                 data_per_desc =
00400                                     sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> = data_per_desc;
00401                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00402                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00403 
00404                                 offset += data_per_desc;
00405                                 dma_desc++;
00406                                 dma_ad += data_per_desc;
00407                         }
00408                 }
00409                 <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> - 1; ++j) {
00410                         data_per_desc =
00411                             ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> &gt;
00412                              dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
00413                             j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00414                         data_per_desc +=
00415                             (data_per_desc % 4) ? (4 - data_per_desc % 4) : 0;
00416                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> = data_per_desc;
00417                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00418                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00419 
00420                         offset += data_per_desc;
00421                         dma_desc++;
00422                         dma_ad += data_per_desc;
00423                 }
00424 
00425                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 1;
00426                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 1;
00427                 data_per_desc =
00428                     ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> &gt;
00429                      dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
00430                     j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00431                 data_per_desc +=
00432                     (data_per_desc % 4) ? (4 - data_per_desc % 4) : 0;
00433                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> = data_per_desc;
00434 
00435                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00436                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00437 
00438                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> = 0;
00439 
00441                 DWC_WRITE_REG32(&amp;(out_regs-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o5">doepdma</a>),
00442                                 (uint32_t) dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_16">iso_dma_desc_addr</a>);
00443 
00444         }
00446         <span class="keywordflow">else</span> {
00447                 <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> sts = {.d32 = 0 };
00448                 <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a>;
00449                 dma_addr_t dma_ad;
00450                 <a class="code" href="structdwc__otg__dev__in__ep__regs.html">dwc_otg_dev_in_ep_regs_t</a> *in_regs =
00451                     core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>];
00452                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frmnumber;
00453                 <a class="code" href="unionfifosize__data.html">fifosize_data_t</a> txfifosize, rxfifosize;
00454 
00455                 txfifosize.<a class="code" href="unionfifosize__data.html#o0">d32</a> =
00456                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
00457                                    in_ep_regs[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;dtxfsts);
00458                 rxfifosize.<a class="code" href="unionfifosize__data.html#o0">d32</a> =
00459                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o9">grxfsiz</a>);
00460 
00461                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>;
00462 
00463                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
00464 
00465                 dsts.<a class="code" href="uniondsts__data.html#o0">d32</a> =
00466                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o2">dsts</a>);
00467 
00468                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> = BS_HOST_READY;
00469                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o19">txsts</a> = 0;
00470                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o7">sp</a> =
00471                     (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> % dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) ? 1 : 0;
00472                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 0;
00473                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o15">pid</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>;
00474 
00475                 frmnumber = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a>;
00476 
00477                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> = frmnumber;
00478                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o18">txbytes</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
00479                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 0;
00480 
00482                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> - 1; i++) {
00483                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00484                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00485                         dma_desc++;
00486 
00487                         dma_ad += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
00488                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
00489                 }
00490 
00491                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 1;
00492                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00493                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00494                 ++dma_desc;
00495 
00497                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 0;
00498                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a>;
00499 
00500                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>;
00501                      i += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>) {
00502                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00503                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00504                         dma_desc++;
00505 
00506                         dma_ad += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
00507                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
00508 
00509                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 0;
00510                 }
00511                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 1;
00512                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 1;
00513 
00514                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
00515                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
00516 
00517                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> + dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
00518 
00520                 DWC_WRITE_REG32(&amp;(in_regs-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o5">diepdma</a>),
00521                                 (uint32_t) dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_16">iso_dma_desc_addr</a>);
00522         }
00524         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0;
00525         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> = 1;
00526         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o3">usbactep</a> = 1;
00527         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o10">cnak</a> = 1;
00528 
00529         DWC_MODIFY_REG32(addr, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
00530         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(addr);
00531 }
00532 
<a name="l00540"></a><a class="code" href="dwc__otg__pcd_8c.html#a13">00540</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a13">dwc_otg_iso_ep_start_buf_transfer</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
00541                                        <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * ep)
00542 {
00543         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0 };
00544         <span class="keyword">volatile</span> uint32_t *addr;
00545 
00546         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
00547                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>;
00548         } <span class="keywordflow">else</span> {
00549                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>;
00550         }
00551 
00552         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a> == 0 || core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> != 0) {
00553                 <span class="keywordflow">return</span>;
00554         } <span class="keywordflow">else</span> {
00555                 <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz = {.d32 = 0 };
00556 
00557                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> =
00558                     ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> * ep-&gt;<a class="code" href="structdwc__ep.html#z32_21">buf_proc_intrvl</a> / ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
00559                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a> =
00560                     (ep-&gt;<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> - 1 + ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) / ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00561                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
00562                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> =
00563                     (ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#z32_19">xfer_buff1</a> : ep-&gt;<a class="code" href="structdwc__ep.html#z32_18">xfer_buff0</a>;
00564                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> =
00565                     (ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a> : ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
00566 
00567                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
00568                         <span class="comment">/* Program the transfer size and packet count</span>
00569 <span class="comment">                         *      as follows: xfersize = N * maxpacket +</span>
00570 <span class="comment">                         *      short_packet pktcnt = N + (short_packet</span>
00571 <span class="comment">                         *      exist ? 1 : 0) </span>
00572 <span class="comment">                         */</span>
00573                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o3">mc</a> = ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>;
00574                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> = ep-&gt;<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>;
00575                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> =
00576                             (ep-&gt;<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> - 1 + ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) / ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00577                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
00578                                         in_ep_regs[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;dieptsiz,
00579                                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a>);
00580 
00581                         <span class="comment">/* Write the DMA register */</span>
00582                         DWC_WRITE_REG32(&amp;
00583                                         (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
00584                                          in_ep_regs[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;diepdma),
00585                                         (uint32_t) ep-&gt;<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a>);
00586 
00587                 } <span class="keywordflow">else</span> {
00588                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> =
00589                             (ep-&gt;<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> + (ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> - 1)) /
00590                             ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00591                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> = deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> * ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00592 
00593                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
00594                                         out_ep_regs[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doeptsiz,
00595                                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a>);
00596 
00597                         <span class="comment">/* Write the DMA register */</span>
00598                         DWC_WRITE_REG32(&amp;
00599                                         (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
00600                                          out_ep_regs[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doepdma),
00601                                         (uint32_t) ep-&gt;<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a>);
00602 
00603                 }
00605                 depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0;
00606                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> = 1;
00607                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o10">cnak</a> = 1;
00608 
00609                 DWC_MODIFY_REG32(addr, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
00610         }
00611 }
00612 
<a name="l00623"></a><a class="code" href="dwc__otg__pcd_8c.html#a14">00623</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a14">dwc_otg_iso_ep_start_transfer</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
00624                                           <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * ep)
00625 {
00626         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
00627                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
00628                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
00629                                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> = ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a> / ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>;
00630                         } <span class="keywordflow">else</span> {
00631                                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> = ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>;
00632                         }
00633                         <a class="code" href="dwc__otg__pcd_8c.html#a12">dwc_otg_iso_ep_start_ddma_transfer</a>(core_if, ep);
00634                 } <span class="keywordflow">else</span> {
00635                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o16">pti_enh_enable</a>) {
00636                                 <a class="code" href="dwc__otg__pcd_8c.html#a13">dwc_otg_iso_ep_start_buf_transfer</a>(core_if, ep);
00637                         } <span class="keywordflow">else</span> {
00638                                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> =
00639                                     (ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) ? ep-&gt;
00640                                     xfer_buff1 : ep-&gt;<a class="code" href="structdwc__ep.html#z32_18">xfer_buff0</a>;
00641                                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> =
00642                                     (ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) ? ep-&gt;
00643                                     dma_addr1 : ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
00644                                 <a class="code" href="dwc__otg__cil_8h.html#a89">dwc_otg_iso_ep_start_frm_transfer</a>(core_if, ep);
00645                         }
00646                 }
00647         } <span class="keywordflow">else</span> {
00648                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> =
00649                     (ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#z32_19">xfer_buff1</a> : ep-&gt;<a class="code" href="structdwc__ep.html#z32_18">xfer_buff0</a>;
00650                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> =
00651                     (ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a> : ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
00652                 <a class="code" href="dwc__otg__cil_8h.html#a89">dwc_otg_iso_ep_start_frm_transfer</a>(core_if, ep);
00653         }
00654 }
00655 
<a name="l00664"></a><a class="code" href="dwc__otg__pcd_8c.html#a15">00664</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a15">dwc_otg_iso_ep_stop_transfer</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * ep)
00665 {
00666         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = 0 };
00667         <span class="keyword">volatile</span> uint32_t *addr;
00668 
00669         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> == 1) {
00670                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>;
00671         } <span class="keywordflow">else</span> {
00672                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>;
00673         }
00674 
00675         <span class="comment">/* disable the ep */</span>
00676         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(addr);
00677 
00678         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> = 1;
00679         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o11">snak</a> = 1;
00680 
00681         DWC_WRITE_REG32(addr, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
00682 
00683         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> &amp;&amp;
00684             ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a> &amp;&amp; ep-&gt;<a class="code" href="structdwc__ep.html#z32_16">iso_dma_desc_addr</a>) {
00685                 <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a>,
00686                                            ep-&gt;<a class="code" href="structdwc__ep.html#z32_16">iso_dma_desc_addr</a>,
00687                                            ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> * 2);
00688         }
00689 
00690         <span class="comment">/* reset varibales */</span>
00691         ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a> = 0;
00692         ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a> = 0;
00693         ep-&gt;<a class="code" href="structdwc__ep.html#z32_18">xfer_buff0</a> = 0;
00694         ep-&gt;<a class="code" href="structdwc__ep.html#z32_19">xfer_buff1</a> = 0;
00695         ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> = 0;
00696         ep-&gt;<a class="code" href="structdwc__ep.html#z32_23">data_pattern_frame</a> = 0;
00697         ep-&gt;<a class="code" href="structdwc__ep.html#z32_24">sync_frame</a> = 0;
00698         ep-&gt;<a class="code" href="structdwc__ep.html#z32_21">buf_proc_intrvl</a> = 0;
00699         ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a> = 0;
00700         ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> = 0;
00701         ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> = 0;
00702         ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> = 0;
00703         ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> = 0;
00704         ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a> = 0;
00705         ep-&gt;<a class="code" href="structdwc__ep.html#z32_16">iso_dma_desc_addr</a> = 0;
00706 }
00707 
<a name="l00708"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a26">00708</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a26">dwc_otg_pcd_iso_ep_start</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
00709                              uint8_t * buf0, uint8_t * buf1, dwc_dma_t dma0,
00710                              dwc_dma_t dma1, <span class="keywordtype">int</span> sync_frame, <span class="keywordtype">int</span> dp_frame,
00711                              <span class="keywordtype">int</span> data_per_frame, <span class="keywordtype">int</span> start_frame,
00712                              <span class="keywordtype">int</span> buf_proc_intrvl, <span class="keywordtype">void</span> *req_handle,
00713                              <span class="keywordtype">int</span> atomic_alloc)
00714 {
00715         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00716         dwc_irqflags_t flags = 0;
00717         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
00718         int32_t frm_data;
00719         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts;
00720         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if;
00721 
00722         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, ep_handle);
00723 
00724         <span class="keywordflow">if</span> (!ep || !ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> || ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> == 0) {
00725                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
00726                 <span class="keywordflow">return</span> -DWC_E_INVALID;
00727         }
00728 
00729         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
00730         core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00731         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
00732 
00733         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o6">iso_req_handle</a>) {
00734                 DWC_WARN(<span class="stringliteral">"ISO request in progress\n"</span>);
00735         }
00736 
00737         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a> = dma0;
00738         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a> = dma1;
00739 
00740         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_18">xfer_buff0</a> = buf0;
00741         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_19">xfer_buff1</a> = buf1;
00742 
00743         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> = data_per_frame;
00744 
00746         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_23">data_pattern_frame</a> = dp_frame;
00747         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_24">sync_frame</a> = sync_frame;
00748 
00749         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_21">buf_proc_intrvl</a> = buf_proc_intrvl;
00750 
00751         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a> = 1 &lt;&lt; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>-&gt;bInterval - 1);
00752 
00753         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> = 0;
00754 
00755         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> = 0;
00756         frm_data = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
00757         <span class="keywordflow">while</span> (frm_data &gt; 0) {
00758                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>++;
00759                 frm_data -= ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00760         }
00761 
00762         dsts.<a class="code" href="uniondsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o2">dsts</a>);
00763 
00764         <span class="keywordflow">if</span> (start_frame == -1) {
00765                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> = dsts.<a class="code" href="uniondsts__data.html#o7">b</a>.<a class="code" href="uniondsts__data.html#o5">soffn</a> + 1;
00766                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a> != 1) {
00767                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> =
00768                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> + (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a> - 1 -
00769                                                   dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> %
00770                                                   dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>);
00771                 }
00772         } <span class="keywordflow">else</span> {
00773                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> = start_frame;
00774         }
00775 
00776         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o16">pti_enh_enable</a>) {
00777                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a> =
00778                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_21">buf_proc_intrvl</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> /
00779                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
00780         } <span class="keywordflow">else</span> {
00781                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a> =
00782                     (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> *
00783                      (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_21">buf_proc_intrvl</a> / dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>)
00784                      - 1 + dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) / dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00785         }
00786 
00787         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
00788                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> =
00789                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_21">buf_proc_intrvl</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> /
00790                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
00791         }
00792 
00793         <span class="keywordflow">if</span> (atomic_alloc) {
00794                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a> =
00795                     DWC_ALLOC_ATOMIC(<span class="keyword">sizeof</span>(<a class="code" href="structiso__pkt__info.html">iso_pkt_info_t</a>) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>);
00796         } <span class="keywordflow">else</span> {
00797                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a> =
00798                     DWC_ALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structiso__pkt__info.html">iso_pkt_info_t</a>) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>);
00799         }
00800         <span class="keywordflow">if</span> (!dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>) {
00801                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
00802                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
00803         }
00804         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o16">pti_enh_enable</a>) {
00805                 dwc_memset(dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>, 0,
00806                            <span class="keyword">sizeof</span>(<a class="code" href="structiso__pkt__info.html">iso_pkt_info_t</a>) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>);
00807         }
00808 
00809         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a> = 0;
00810         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o6">iso_req_handle</a> = req_handle;
00811 
00812         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
00813         <a class="code" href="dwc__otg__pcd_8c.html#a14">dwc_otg_iso_ep_start_transfer</a>(core_if, dwc_ep);
00814         <span class="keywordflow">return</span> 0;
00815 }
00816 
<a name="l00817"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a27">00817</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a27">dwc_otg_pcd_iso_ep_stop</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
00818                             <span class="keywordtype">void</span> *req_handle)
00819 {
00820         dwc_irqflags_t flags = 0;
00821         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00822         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
00823 
00824         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, ep_handle);
00825         <span class="keywordflow">if</span> (!ep || !ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> || ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> == 0) {
00826                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
00827                 <span class="keywordflow">return</span> -DWC_E_INVALID;
00828         }
00829         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
00830 
00831         <a class="code" href="dwc__otg__pcd_8c.html#a15">dwc_otg_iso_ep_stop_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), dwc_ep);
00832 
00833         DWC_FREE(dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>);
00834         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
00835         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o6">iso_req_handle</a> != req_handle) {
00836                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
00837                 <span class="keywordflow">return</span> -DWC_E_INVALID;
00838         }
00839 
00840         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
00841 
00842         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o6">iso_req_handle</a> = 0;
00843         <span class="keywordflow">return</span> 0;
00844 }
00845 
<a name="l00853"></a><a class="code" href="dwc__otg__pcd_8h.html#a18">00853</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8h.html#a18">dwc_otg_iso_buffer_done</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep,
00854                              <span class="keywordtype">void</span> *req_handle)
00855 {
00856         <span class="keywordtype">int</span> i;
00857         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
00858 
00859         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
00860 
00861         DWC_SPINUNLOCK(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
00862         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o4">isoc_complete</a>(pcd, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o9">priv</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o6">iso_req_handle</a>,
00863                                  dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> ^ 0x1);
00864         DWC_SPINLOCK(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
00865 
00866         <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>; ++i) {
00867                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[i].<a class="code" href="structiso__pkt__info.html#o2">status</a> = 0;
00868                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[i].<a class="code" href="structiso__pkt__info.html#o0">offset</a> = 0;
00869                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[i].<a class="code" href="structiso__pkt__info.html#o1">length</a> = 0;
00870         }
00871 }
00872 
<a name="l00873"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a29">00873</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a29">dwc_otg_pcd_get_iso_packet_count</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
00874                                      <span class="keywordtype">void</span> *iso_req_handle)
00875 {
00876         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00877         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
00878 
00879         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, ep_handle);
00880         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> || ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> == 0) {
00881                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
00882                 <span class="keywordflow">return</span> -DWC_E_INVALID;
00883         }
00884         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
00885 
00886         <span class="keywordflow">return</span> dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>;
00887 }
00888 
<a name="l00889"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a28">00889</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a28">dwc_otg_pcd_get_iso_packet_params</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
00890                                        <span class="keywordtype">void</span> *iso_req_handle, <span class="keywordtype">int</span> packet,
00891                                        <span class="keywordtype">int</span> *status, <span class="keywordtype">int</span> *actual, <span class="keywordtype">int</span> *offset)
00892 {
00893         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00894         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
00895 
00896         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, ep_handle);
00897         <span class="keywordflow">if</span> (!ep)
00898                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
00899 
00900         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
00901 
00902         *status = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[packet].<a class="code" href="structiso__pkt__info.html#o2">status</a>;
00903         *actual = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[packet].<a class="code" href="structiso__pkt__info.html#o1">length</a>;
00904         *offset = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[packet].<a class="code" href="structiso__pkt__info.html#o0">offset</a>;
00905 }
00906 
00907 <span class="preprocessor">#endif </span><span class="comment">/* DWC_EN_ISOC */</span>
00908 
00909 <span class="keyword">static</span> <span class="keywordtype">void</span> dwc_otg_pcd_init_ep(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * pcd_ep,
00910                                 uint32_t is_in, uint32_t ep_num)
00911 {
00912         <span class="comment">/* Init EP structure */</span>
00913         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> = 0;
00914         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a> = pcd;
00915         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
00916         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o5">queue_sof</a> = 0;
00917 
00918         <span class="comment">/* Init DWC ep structure */</span>
00919         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = is_in;
00920         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> = ep_num;
00921         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o2">active</a> = 0;
00922         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> = 0;
00923         <span class="comment">/* Control until ep is actvated */</span>
00924         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> = DWC_OTG_EP_TYPE_CONTROL;
00925         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> = MAX_PACKET_SIZE;
00926         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = 0;
00927         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = 0;
00928         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = 0;
00929         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 0;
00930         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
00931         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
00932         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = 0;
00933         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a> = 0;
00934         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_1">dma_desc_addr</a> = 0;
00935         DWC_CIRCLEQ_INIT(&amp;pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
00936 }
00937 
<a name="l00941"></a><a class="code" href="dwc__otg__pcd_8c.html#a22">00941</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a22">dwc_otg_pcd_reinit</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00942 {
00943         <span class="keywordtype">int</span> i;
00944         uint32_t hwcfg1;
00945         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00946         <span class="keywordtype">int</span> in_ep_cntr, out_ep_cntr;
00947         uint32_t num_in_eps = (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd))-&gt;dev_if-&gt;num_in_eps;
00948         uint32_t num_out_eps = (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd))-&gt;dev_if-&gt;num_out_eps;
00949 
00953         ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00954         dwc_otg_pcd_init_ep(pcd, ep, 0, 0);
00955 
00956         in_ep_cntr = 0;
00957         hwcfg1 = (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd))-&gt;hwcfg1.d32 &gt;&gt; 3;
00958         <span class="keywordflow">for</span> (i = 1; in_ep_cntr &lt; num_in_eps; i++) {
00959                 <span class="keywordflow">if</span> ((hwcfg1 &amp; 0x1) == 0) {
00960                         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[in_ep_cntr];
00961                         in_ep_cntr++;
00967                         dwc_otg_pcd_init_ep(pcd, ep, 1 <span class="comment">/* IN */</span> , i);
00968 
00969                         DWC_CIRCLEQ_INIT(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
00970                 }
00971                 hwcfg1 &gt;&gt;= 2;
00972         }
00973 
00974         out_ep_cntr = 0;
00975         hwcfg1 = (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd))-&gt;hwcfg1.d32 &gt;&gt; 2;
00976         <span class="keywordflow">for</span> (i = 1; out_ep_cntr &lt; num_out_eps; i++) {
00977                 <span class="keywordflow">if</span> ((hwcfg1 &amp; 0x1) == 0) {
00978                         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[out_ep_cntr];
00979                         out_ep_cntr++;
00985                         dwc_otg_pcd_init_ep(pcd, ep, 0 <span class="comment">/* OUT */</span> , i);
00986                         DWC_CIRCLEQ_INIT(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
00987                 }
00988                 hwcfg1 &gt;&gt;= 2;
00989         }
00990 
00991         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_DISCONNECT;
00992         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> = MAX_EP0_SIZE;
00993         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> = DWC_OTG_EP_TYPE_CONTROL;
00994 }
00995 
<a name="l01000"></a><a class="code" href="dwc__otg__pcd_8c.html#a23">01000</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a23">srp_timeout</a>(<span class="keywordtype">void</span> *ptr)
01001 {
01002         <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl;
01003         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = (<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *) ptr;
01004         <span class="keyword">volatile</span> uint32_t *addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>;
01005 
01006         gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = DWC_READ_REG32(addr);
01007 
01008         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o7">srp_timer_started</a> = 0;
01009         
01010         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a>) {
01011                 <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o17">bsesvld</a> == 0) {
01012                         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.d32 = 0 };
01013                         DWC_PRINTF(<span class="stringliteral">"SRP Timeout BSESSVLD = 0\n"</span>);
01014                         <span class="comment">/* Power off the core */</span>
01015                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
01016                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
01017                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
01018                                         gpwrdn, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
01019                         }
01020 
01021                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
01022                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
01023                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
01024                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
01025                         <a class="code" href="dwc__otg__adp_8h.html#a6">dwc_otg_adp_probe_start</a>(core_if);
01026                 } <span class="keywordflow">else</span> {
01027                         DWC_PRINTF(<span class="stringliteral">"SRP Timeout BSESSVLD = 1\n"</span>);
01028                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
01029                         <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
01030                         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
01031                         <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
01032                 }
01033         }
01034 
01035         <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o20">phy_type</a> == DWC_PHY_TYPE_PARAM_FS) &amp;&amp;
01036             (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o24">i2c_enable</a>)) {
01037                 DWC_PRINTF(<span class="stringliteral">"SRP Timeout\n"</span>);
01038 
01039                 <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o6">srp_success</a>) &amp;&amp; (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o17">bsesvld</a>)) {
01040                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o30">pcd_cb</a> &amp;&amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o30">pcd_cb</a>-&gt;<a class="code" href="structdwc__otg__cil__callbacks.html#o3">resume_wakeup</a>) {
01041                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o30">pcd_cb</a>-&gt;<a class="code" href="structdwc__otg__cil__callbacks.html#o3">resume_wakeup</a>(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o30">pcd_cb</a>-&gt;<a class="code" href="structdwc__otg__cil__callbacks.html#o6">p</a>);
01042                         }
01043 
01044                         <span class="comment">/* Clear Session Request */</span>
01045                         gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> = 0;
01046                         gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o2">sesreq</a> = 1;
01047                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>,
01048                                          gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>, 0);
01049 
01050                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o6">srp_success</a> = 0;
01051                 } <span class="keywordflow">else</span> {
01052                         __DWC_ERROR(<span class="stringliteral">"Device not connected/responding\n"</span>);
01053                         gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o2">sesreq</a> = 0;
01054                         DWC_WRITE_REG32(addr, gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>);
01055                 }
01056         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o2">sesreq</a>) {
01057                 DWC_PRINTF(<span class="stringliteral">"SRP Timeout\n"</span>);
01058 
01059                 __DWC_ERROR(<span class="stringliteral">"Device not connected/responding\n"</span>);
01060                 gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o2">sesreq</a> = 0;
01061                 DWC_WRITE_REG32(addr, gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>);
01062         } <span class="keywordflow">else</span> {
01063                 DWC_PRINTF(<span class="stringliteral">" SRP GOTGCTL=%0x\n"</span>, gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>);
01064         }
01065 }
01066 
01071 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a9">start_next_request</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep);
01072 
01073 <span class="keyword">static</span> <span class="keywordtype">void</span> start_xfer_tasklet_func(<span class="keywordtype">void</span> *data)
01074 {
01075         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) data;
01076         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01077 
01078         <span class="keywordtype">int</span> i;
01079         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> diepctl;
01080 
01081         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCDV, <span class="stringliteral">"Start xfer tasklet\n"</span>);
01082 
01083         diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
01084 
01085         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#o5">queue_sof</a>) {
01086                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#o5">queue_sof</a> = 0;
01087                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a9">start_next_request</a>(&amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>);
01088                 <span class="comment">// break;</span>
01089         }
01090 
01091         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
01092                 <a class="code" href="uniondepctl__data.html">depctl_data_t</a> diepctl;
01093                 diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> =
01094                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
01095 
01096                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o5">queue_sof</a>) {
01097                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o5">queue_sof</a> = 0;
01098                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a9">start_next_request</a>(&amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i]);
01099                         <span class="comment">// break;</span>
01100                 }
01101         }
01102 
01103         <span class="keywordflow">return</span>;
01104 }
01105 
<a name="l01110"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a16">01110</a> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *<a class="code" href="dwc__otg__pcd__if_8h.html#a16">dwc_otg_pcd_init</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01111 {
01112         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = NULL;
01113         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if;
01114         <span class="keywordtype">int</span> i;
01115 
01116         <span class="comment">/*</span>
01117 <span class="comment">         * Allocate PCD structure</span>
01118 <span class="comment">         */</span>
01119         pcd = DWC_ALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a>));
01120 
01121         <span class="keywordflow">if</span> (pcd == NULL) {
01122                 <span class="keywordflow">return</span> NULL;
01123         }
01124 
01125         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a> = DWC_SPINLOCK_ALLOC();
01126         <span class="keywordflow">if</span> (!pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>) {
01127                 DWC_ERROR(<span class="stringliteral">"Could not allocate lock for pcd"</span>);
01128                 DWC_FREE(pcd);
01129                 <span class="keywordflow">return</span> NULL;
01130         }
01131         <span class="comment">/* Set core_if's lock pointer to hcd-&gt;lock */</span>
01132         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a> = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>;
01133         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a> = core_if;
01134 
01135         dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
01136         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o22">isoc_ep</a> = NULL;
01137 
01138         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o13">ded_fifo_en</a>) {
01139                 DWC_PRINTF(<span class="stringliteral">"Dedicated Tx FIFOs mode\n"</span>);
01140         } <span class="keywordflow">else</span> {
01141                 DWC_PRINTF(<span class="stringliteral">"Shared Tx FIFO mode\n"</span>);
01142         }
01143 
01144         <span class="comment">/*</span>
01145 <span class="comment">         * Initialized the Core for Device mode here if there is nod ADP support. </span>
01146 <span class="comment">         * Otherwise it will be done later in dwc_otg_adp_start routine.</span>
01147 <span class="comment">         */</span>                                                                                                                                                              
01148         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if) <span class="comment">/*&amp;&amp; !core_if-&gt;adp_enable*/</span>) {
01149                 <a class="code" href="dwc__otg__cil_8h.html#a74">dwc_otg_core_dev_init</a>(core_if);
01150         }
01151 
01152         <span class="comment">/*</span>
01153 <span class="comment">         * Register the PCD Callbacks.</span>
01154 <span class="comment">         */</span>
01155         <a class="code" href="dwc__otg__cil_8h.html#a116">dwc_otg_cil_register_pcd_callbacks</a>(core_if, &amp;<a class="code" href="dwc__otg__pcd_8c.html#a0">pcd_callbacks</a>, pcd);
01156 
01157         <span class="comment">/*</span>
01158 <span class="comment">         * Initialize the DMA buffer for SETUP packets</span>
01159 <span class="comment">         */</span>
01160         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_enable) {
01161                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a> =
01162                     DWC_DMA_ALLOC(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>) * 5,
01163                                   &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o14">setup_pkt_dma_handle</a>);
01164                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a> == NULL) {
01165                         DWC_FREE(pcd);
01166                         <span class="keywordflow">return</span> NULL;
01167                 }
01168 
01169                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a> =
01170                     DWC_DMA_ALLOC(<span class="keyword">sizeof</span>(uint16_t),
01171                                   &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o16">status_buf_dma_handle</a>);
01172                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a> == NULL) {
01173                         DWC_DMA_FREE(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>) * 5,
01174                                      pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>, pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o14">setup_pkt_dma_handle</a>);
01175                         DWC_FREE(pcd);
01176                         <span class="keywordflow">return</span> NULL;
01177                 }
01178 
01179                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
01180                         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o14">setup_desc_addr</a>[0] =
01181                             <a class="code" href="dwc__otg__pcd_8c.html#a10">dwc_otg_ep_alloc_desc_chain</a>(&amp;dev_if-&gt;
01182                                                         dma_setup_desc_addr[0],
01183                                                         1);
01184                         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o14">setup_desc_addr</a>[1] =
01185                             <a class="code" href="dwc__otg__pcd_8c.html#a10">dwc_otg_ep_alloc_desc_chain</a>(&amp;dev_if-&gt;
01186                                                         dma_setup_desc_addr[1],
01187                                                         1);
01188                         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o18">in_desc_addr</a> =
01189                             <a class="code" href="dwc__otg__pcd_8c.html#a10">dwc_otg_ep_alloc_desc_chain</a>(&amp;dev_if-&gt;
01190                                                         dma_in_desc_addr, 1);
01191                         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o20">out_desc_addr</a> =
01192                             <a class="code" href="dwc__otg__pcd_8c.html#a10">dwc_otg_ep_alloc_desc_chain</a>(&amp;dev_if-&gt;
01193                                                         dma_out_desc_addr, 1);
01194 
01195                         <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o14">setup_desc_addr</a>[0] == 0
01196                             || dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o14">setup_desc_addr</a>[1] == 0
01197                             || dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o18">in_desc_addr</a> == 0
01198                             || dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o20">out_desc_addr</a> == 0) {
01199 
01200                                 <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o20">out_desc_addr</a>)
01201                                         <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;
01202                                                                    out_desc_addr,
01203                                                                    dev_if-&gt;
01204                                                                    dma_out_desc_addr,
01205                                                                    1);
01206                                 <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o18">in_desc_addr</a>)
01207                                         <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;
01208                                                                    in_desc_addr,
01209                                                                    dev_if-&gt;
01210                                                                    dma_in_desc_addr,
01211                                                                    1);
01212                                 <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o14">setup_desc_addr</a>[1])
01213                                         <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;
01214                                                                    setup_desc_addr
01215                                                                    [1],
01216                                                                    dev_if-&gt;
01217                                                                    dma_setup_desc_addr
01218                                                                    [1], 1);
01219                                 <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o14">setup_desc_addr</a>[0])
01220                                         <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;
01221                                                                    setup_desc_addr
01222                                                                    [0],
01223                                                                    dev_if-&gt;
01224                                                                    dma_setup_desc_addr
01225                                                                    [0], 1);
01226 
01227                                 DWC_DMA_FREE(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>) * 5,
01228                                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>,
01229                                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o14">setup_pkt_dma_handle</a>);
01230                                 DWC_DMA_FREE(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a>),
01231                                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a>,
01232                                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o16">status_buf_dma_handle</a>);
01233 
01234                                 DWC_FREE(pcd);
01235 
01236                                 <span class="keywordflow">return</span> NULL;
01237                         }
01238                 }
01239         } <span class="keywordflow">else</span> {
01240                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a> = DWC_ALLOC(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>) * 5);
01241                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a> == NULL) {
01242                         DWC_FREE(pcd);
01243                         <span class="keywordflow">return</span> NULL;
01244                 }
01245 
01246                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a> = DWC_ALLOC(<span class="keyword">sizeof</span>(uint16_t));
01247                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a> == NULL) {
01248                         DWC_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>);
01249                         DWC_FREE(pcd);
01250                         <span class="keywordflow">return</span> NULL;
01251                 }
01252         }
01253 
01254         <a class="code" href="dwc__otg__pcd_8c.html#a22">dwc_otg_pcd_reinit</a>(pcd);
01255 
01256         <span class="comment">/* Allocate the cfi object for the PCD */</span>
01257 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01258 <span class="preprocessor"></span>        pcd-&gt;cfi = DWC_ALLOC(<span class="keyword">sizeof</span>(cfiobject_t));
01259         <span class="keywordflow">if</span> (NULL == pcd-&gt;cfi)
01260                 <span class="keywordflow">goto</span> fail;
01261         <span class="keywordflow">if</span> (init_cfi(pcd-&gt;cfi)) {
01262                 CFI_INFO(<span class="stringliteral">"%s: Failed to init the CFI object\n"</span>, __func__);
01263                 <span class="keywordflow">goto</span> fail;
01264         }
01265 <span class="preprocessor">#endif</span>
01266 <span class="preprocessor"></span>
01267         <span class="comment">/* Initialize tasklets */</span>
01268         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o22">start_xfer_tasklet</a> = DWC_TASK_ALLOC(<span class="stringliteral">"xfer_tasklet"</span>,
01269                                                  start_xfer_tasklet_func, pcd);
01270         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o21">test_mode_tasklet</a> = DWC_TASK_ALLOC(<span class="stringliteral">"test_mode_tasklet"</span>,
01271                                                 <a class="code" href="dwc__otg__pcd_8h.html#a19">do_test_mode</a>, pcd);
01272 
01273         <span class="comment">/* Initialize SRP timer */</span>
01274         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o8">srp_timer</a> = DWC_TIMER_ALLOC(<span class="stringliteral">"SRP TIMER"</span>, <a class="code" href="dwc__otg__pcd_8c.html#a23">srp_timeout</a>, core_if);
01275         
01276         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o39">dev_out_nak</a>) {
01281                 <span class="keywordflow">for</span>(i = 0; i &lt; MAX_EPS_CHANNELS; i++) {
01282                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o37">ep_xfer_timer</a>[i] =
01283                                 DWC_TIMER_ALLOC(<span class="stringliteral">"ep timer"</span>, ep_xfer_timeout,
01284                                 &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o36">ep_xfer_info</a>[i]);
01285                 }
01286         }
01287         
01288         <span class="keywordflow">return</span> pcd;
01289 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01290 <span class="preprocessor"></span>fail:
01291 <span class="preprocessor">#endif</span>
01292 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>)
01293                 DWC_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>);
01294         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a>)
01295                 DWC_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a>);
01296 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01297 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pcd-&gt;cfi)
01298                 DWC_FREE(pcd-&gt;cfi);
01299 <span class="preprocessor">#endif</span>
01300 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pcd)
01301                 DWC_FREE(pcd);
01302         <span class="keywordflow">return</span> NULL;
01303 
01304 }
01305 
<a name="l01309"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a17">01309</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a17">dwc_otg_pcd_remove</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01310 {
01311         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if;
01312         <span class="keywordtype">int</span> i;
01313         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o39">dev_out_nak</a>) {
01314                 <span class="keywordflow">for</span> (i = 0; i &lt; MAX_EPS_CHANNELS; i++) {
01315                         DWC_TIMER_CANCEL(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o37">ep_xfer_timer</a>[i]);
01316                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o36">ep_xfer_info</a>[i].state = 0;
01317                 }
01318         }
01319 
01320         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_enable) {
01321                 DWC_DMA_FREE(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>) * 5, pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>,
01322                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o14">setup_pkt_dma_handle</a>);
01323                 DWC_DMA_FREE(<span class="keyword">sizeof</span>(uint16_t), pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a>,
01324                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o16">status_buf_dma_handle</a>);
01325                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
01326                         <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o14">setup_desc_addr</a>[0],
01327                                                    dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o13">dma_setup_desc_addr</a>
01328                                                    [0], 1);
01329                         <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o14">setup_desc_addr</a>[1],
01330                                                    dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o13">dma_setup_desc_addr</a>
01331                                                    [1], 1);
01332                         <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o18">in_desc_addr</a>,
01333                                                    dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o17">dma_in_desc_addr</a>, 1);
01334                         <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o20">out_desc_addr</a>,
01335                                                    dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o19">dma_out_desc_addr</a>,
01336                                                    1);
01337                 }
01338         } <span class="keywordflow">else</span> {
01339                 DWC_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>);
01340                 DWC_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a>);
01341         }
01342         DWC_SPINLOCK_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
01343         <span class="comment">/* Set core_if's lock pointer to NULL */</span>
01344         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a> = NULL;
01345 
01346         DWC_TASK_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o22">start_xfer_tasklet</a>);
01347         DWC_TASK_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o21">test_mode_tasklet</a>);
01348         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o39">dev_out_nak</a>) {
01349                 <span class="keywordflow">for</span> (i = 0; i &lt; MAX_EPS_CHANNELS; i++) {
01350                         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o37">ep_xfer_timer</a>[i]) {
01351                                         DWC_TIMER_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o37">ep_xfer_timer</a>[i]);
01352                         }
01353                 }
01354         }
01355 
01356 <span class="comment">/* Release the CFI object's dynamic memory */</span>
01357 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01358 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pcd-&gt;cfi-&gt;ops.release) {
01359                 pcd-&gt;cfi-&gt;ops.release(pcd-&gt;cfi);
01360         }
01361 <span class="preprocessor">#endif</span>
01362 <span class="preprocessor"></span>
01363         DWC_FREE(pcd);
01364 }
01365 
<a name="l01369"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a36">01369</a> uint32_t <a class="code" href="dwc__otg__pcd__if_8h.html#a36">dwc_otg_pcd_is_dualspeed</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01370 {
01371         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01372 
01373         <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o5">speed</a> == DWC_SPEED_PARAM_FULL) ||
01374             ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o21">hwcfg2</a>.<a class="code" href="unionhwcfg2__data.html#o16">b</a>.<a class="code" href="unionhwcfg2__data.html#o4">hs_phy_type</a> == 2) &amp;&amp;
01375              (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o21">hwcfg2</a>.<a class="code" href="unionhwcfg2__data.html#o16">b</a>.<a class="code" href="unionhwcfg2__data.html#o5">fs_phy_type</a> == 1) &amp;&amp;
01376              (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o25">ulpi_fs_ls</a>))) {
01377                 <span class="keywordflow">return</span> 0;
01378         }
01379 
01380         <span class="keywordflow">return</span> 1;
01381 }
01382 
<a name="l01386"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a37">01386</a> uint32_t <a class="code" href="dwc__otg__pcd__if_8h.html#a37">dwc_otg_pcd_is_otg</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01387 {
01388         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01389         <a class="code" href="uniongusbcfg__data.html">gusbcfg_data_t</a> usbcfg = {.<a class="code" href="structdwc__otg__pcd.html#o12">d32</a> = 0 };
01390 
01391         usbcfg.<a class="code" href="uniongusbcfg__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o3">gusbcfg</a>);
01392         <span class="keywordflow">if</span> (!usbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o7">srpcap</a> || !usbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o8">hnpcap</a>) {
01393                 <span class="keywordflow">return</span> 0;
01394         }
01395 
01396         <span class="keywordflow">return</span> 1;
01397 }
01398 
<a name="l01403"></a><a class="code" href="dwc__otg__pcd_8c.html#a30">01403</a> <span class="keyword">static</span> uint32_t <a class="code" href="dwc__otg__pcd_8c.html#a30">assign_tx_fifo</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01404 {
01405         uint32_t TxMsk = 1;
01406         <span class="keywordtype">int</span> i;
01407 
01408         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>; ++i) {
01409                 <span class="keywordflow">if</span> ((TxMsk &amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o32">tx_msk</a>) == 0) {
01410                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o32">tx_msk</a> |= TxMsk;
01411                         <span class="keywordflow">return</span> i + 1;
01412                 }
01413                 TxMsk &lt;&lt;= 1;
01414         }
01415         <span class="keywordflow">return</span> 0;
01416 }
01417 
<a name="l01422"></a><a class="code" href="dwc__otg__pcd_8c.html#a31">01422</a> <span class="keyword">static</span> uint32_t <a class="code" href="dwc__otg__pcd_8c.html#a31">assign_perio_tx_fifo</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01423 {
01424         uint32_t PerTxMsk = 1;
01425         <span class="keywordtype">int</span> i;
01426         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o1">num_dev_perio_in_ep</a>; ++i) {
01427                 <span class="keywordflow">if</span> ((PerTxMsk &amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o31">p_tx_msk</a>) == 0) {
01428                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o31">p_tx_msk</a> |= PerTxMsk;
01429                         <span class="keywordflow">return</span> i + 1;
01430                 }
01431                 PerTxMsk &lt;&lt;= 1;
01432         }
01433         <span class="keywordflow">return</span> 0;
01434 }
01435 
<a name="l01440"></a><a class="code" href="dwc__otg__pcd_8c.html#a32">01440</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a32">release_perio_tx_fifo</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
01441                                   uint32_t fifo_num)
01442 {
01443         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o31">p_tx_msk</a> =
01444             (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o31">p_tx_msk</a> &amp; (1 &lt;&lt; (fifo_num - 1))) ^ core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o31">p_tx_msk</a>;
01445 }
01446 
<a name="l01451"></a><a class="code" href="dwc__otg__pcd_8c.html#a33">01451</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a33">release_tx_fifo</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, uint32_t fifo_num)
01452 {
01453         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o32">tx_msk</a> =
01454             (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o32">tx_msk</a> &amp; (1 &lt;&lt; (fifo_num - 1))) ^ core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o32">tx_msk</a>;
01455 }
01456 
<a name="l01461"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a19">01461</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a19">dwc_otg_pcd_ep_enable</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
01462                           <span class="keyword">const</span> uint8_t * ep_desc, <span class="keywordtype">void</span> *usb_ep)
01463 {
01464         <span class="keywordtype">int</span> num, dir;
01465         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = NULL;
01466         <span class="keyword">const</span> usb_endpoint_descriptor_t *desc;
01467         dwc_irqflags_t flags;
01468         <a class="code" href="unionfifosize__data.html">fifosize_data_t</a> dptxfsiz = {.d32 = 0 };
01469         <a class="code" href="uniongdfifocfg__data.html">gdfifocfg_data_t</a> gdfifocfg = {.d32 = 0 };
01470         <a class="code" href="uniongdfifocfg__data.html">gdfifocfg_data_t</a> gdfifocfgbase = {.d32 = 0 };
01471         <span class="keywordtype">int</span> retval = 0;
01472         <span class="keywordtype">int</span> i, epcount;
01473 
01474         desc = (<span class="keyword">const</span> usb_endpoint_descriptor_t *)ep_desc;
01475 
01476         <span class="keywordflow">if</span> (!desc) {
01477                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#o9">priv</a> = usb_ep;
01478                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
01479                 retval = -DWC_E_INVALID;
01480                 <span class="keywordflow">goto</span> out;
01481         }
01482 
01483         num = UE_GET_ADDR(desc-&gt;bEndpointAddress);
01484         dir = UE_GET_DIR(desc-&gt;bEndpointAddress);
01485 
01486         <span class="keywordflow">if</span> (!desc-&gt;wMaxPacketSize) {
01487                 DWC_WARN(<span class="stringliteral">"bad maxpacketsize\n"</span>);
01488                 retval = -DWC_E_INVALID;
01489                 <span class="keywordflow">goto</span> out;
01490         }
01491 
01492         <span class="keywordflow">if</span> (dir == UE_DIR_IN) {
01493                 epcount = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>;
01494                 <span class="keywordflow">for</span> (i = 0; i &lt; epcount; i++) {
01495                         <span class="keywordflow">if</span> (num == pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>) {
01496                                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i];
01497                                 <span class="keywordflow">break</span>;
01498                         }
01499                 }
01500         } <span class="keywordflow">else</span> {
01501                 epcount = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o5">num_out_eps</a>;
01502                 <span class="keywordflow">for</span> (i = 0; i &lt; epcount; i++) {
01503                         <span class="keywordflow">if</span> (num == pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>) {
01504                                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i];
01505                                 <span class="keywordflow">break</span>;
01506                         }
01507                 }
01508         }
01509 
01510         <span class="keywordflow">if</span> (!ep) {
01511                 DWC_WARN(<span class="stringliteral">"bad address\n"</span>);
01512                 retval = -DWC_E_INVALID;
01513                 <span class="keywordflow">goto</span> out;
01514         }
01515 
01516         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
01517 
01518         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> = desc;
01519         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o9">priv</a> = usb_ep;
01520 
01521         <span class="comment">/*</span>
01522 <span class="comment">         * Activate the EP</span>
01523 <span class="comment">         */</span>
01524         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 0;
01525 
01526         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = (dir == UE_DIR_IN);
01527         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> = UGETW(desc-&gt;wMaxPacketSize);
01528 
01529         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> = desc-&gt;bmAttributes &amp; UE_XFERTYPE;
01530 
01531         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
01532                 <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;en_multiple_tx_fifo) {
01533                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> = 0;
01534 
01535                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == UE_ISOCHRONOUS) {
01536                                 <span class="comment">/*</span>
01537 <span class="comment">                                 * if ISOC EP then assign a Periodic Tx FIFO.</span>
01538 <span class="comment">                                 */</span>
01539                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> =
01540                                     <a class="code" href="dwc__otg__pcd_8c.html#a31">assign_perio_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd));
01541                         }
01542                 } <span class="keywordflow">else</span> {
01543                         <span class="comment">/*</span>
01544 <span class="comment">                         * if Dedicated FIFOs mode is on then assign a Tx FIFO.</span>
01545 <span class="comment">                         */</span>
01546                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> =
01547                             <a class="code" href="dwc__otg__pcd_8c.html#a30">assign_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd));
01548                 }
01549 
01550                 <span class="comment">/* Calculating EP info controller base address */</span>
01551                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> &amp;&amp; <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;en_multiple_tx_fifo) {
01552                         gdfifocfg.<a class="code" href="uniongdfifocfg__data.html#o0">d32</a> =
01553                             DWC_READ_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;
01554                                            gdfifocfg);
01555                         gdfifocfgbase.<a class="code" href="uniongdfifocfg__data.html#o0">d32</a> = gdfifocfg.<a class="code" href="uniongdfifocfg__data.html#o0">d32</a> &gt;&gt; 16;
01556                         dptxfsiz.<a class="code" href="unionfifosize__data.html#o0">d32</a> =
01557                             (DWC_READ_REG32
01558                              (&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;
01559                               core_global_regs-&gt;dtxfsiz[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.
01560                                                         tx_fifo_num-1]) &gt;&gt; 16);
01561                         gdfifocfg.<a class="code" href="unionfifosize__data.html#o3">b</a>.epinfobase =
01562                             gdfifocfgbase.<a class="code" href="uniongdfifocfg__data.html#o0">d32</a> + dptxfsiz.<a class="code" href="unionfifosize__data.html#o0">d32</a>;
01563                         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;
01564                                         gdfifocfg, gdfifocfg.d32);
01565                 }
01566         }
01567         <span class="comment">/* Set initial data PID. */</span>
01568         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == UE_BULK) {
01569                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o5">data_pid_start</a> = 0;
01570         }
01571 
01572         <span class="comment">/* Alloc DMA Descriptors */</span>
01573         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
01574 <span class="preprocessor">#ifndef DWC_UTE_PER_IO</span>
01575 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> != UE_ISOCHRONOUS) {
01576 <span class="preprocessor">#endif</span>
01577 <span class="preprocessor"></span>                        ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a> =
01578                             <a class="code" href="dwc__otg__pcd_8c.html#a10">dwc_otg_ep_alloc_desc_chain</a>(&amp;ep-&gt;
01579                                                         <a class="code" href="structdwc__ep.html">dwc_ep</a>.dma_desc_addr,
01580                                                         <a class="code" href="dwc__otg__cil_8h.html#a15">MAX_DMA_DESC_CNT</a>);
01581                         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>) {
01582                                 DWC_WARN(<span class="stringliteral">"%s, can't allocate DMA descriptor\n"</span>,
01583                                          __func__);
01584                                 retval = -DWC_E_SHUTDOWN;
01585                                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
01586                                 <span class="keywordflow">goto</span> out;
01587                         }
01588 <span class="preprocessor">#ifndef DWC_UTE_PER_IO</span>
01589 <span class="preprocessor"></span>                }
01590 <span class="preprocessor">#endif</span>
01591 <span class="preprocessor"></span>        }
01592 
01593         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"Activate %s: type=%d, mps=%d desc=%p\n"</span>,
01594                     (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>),
01595                     ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>);
01596 <span class="preprocessor">#ifdef DWC_UTE_PER_IO</span>
01597 <span class="preprocessor"></span>        ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.xiso_bInterval = 1 &lt;&lt; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>-&gt;bInterval - 1);
01598 <span class="preprocessor">#endif</span>
01599 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
01600                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_11">bInterval</a> = 1 &lt;&lt; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>-&gt;bInterval - 1);
01601                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> = 0xFFFFFFFF;
01602         }               
01603 
01604         <a class="code" href="dwc__otg__cil_8h.html#a79">dwc_otg_ep_activate</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01605 
01606 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01607 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pcd-&gt;cfi-&gt;ops.ep_enable) {
01608                 pcd-&gt;cfi-&gt;ops.ep_enable(pcd-&gt;cfi, pcd, ep);
01609         }
01610 <span class="preprocessor">#endif</span>
01611 <span class="preprocessor"></span>
01612         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
01613 
01614 out:
01615         <span class="keywordflow">return</span> retval;
01616 }
01617 
<a name="l01622"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a20">01622</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a20">dwc_otg_pcd_ep_disable</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle)
01623 {
01624         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
01625         dwc_irqflags_t flags;
01626         <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *desc_addr;
01627         dwc_dma_t dma_desc_addr;
01628         <a class="code" href="uniongdfifocfg__data.html">gdfifocfg_data_t</a> gdfifocfgbase = {.<a class="code" href="structdwc__otg__pcd.html#o12">d32</a> = 0 };
01629         <a class="code" href="uniongdfifocfg__data.html">gdfifocfg_data_t</a> gdfifocfg = {.<a class="code" href="structdwc__otg__pcd.html#o12">d32</a> = 0 };
01630         <a class="code" href="unionfifosize__data.html">fifosize_data_t</a> dptxfsiz = {.<a class="code" href="structdwc__otg__pcd.html#o12">d32</a> = 0 };
01631 
01632         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, ep_handle);
01633 
01634         <span class="keywordflow">if</span> (!ep || !ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>) {
01635                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"bad ep address\n"</span>);
01636                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01637         }
01638 
01639         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
01640 
01641         <a class="code" href="dwc__otg__pcd_8h.html#a16">dwc_otg_request_nuke</a>(ep);
01642 
01643         <a class="code" href="dwc__otg__cil_8h.html#a80">dwc_otg_ep_deactivate</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01644         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o39">dev_out_nak</a>)
01645         {
01646                 DWC_TIMER_CANCEL(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o37">ep_xfer_timer</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>]);
01647                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o36">ep_xfer_info</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>].state = 0;
01648         }
01649         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> = NULL;
01650         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
01651 
01652         gdfifocfg.<a class="code" href="uniongdfifocfg__data.html#o0">d32</a> =
01653             DWC_READ_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gdfifocfg);
01654         gdfifocfgbase.<a class="code" href="uniongdfifocfg__data.html#o0">d32</a> = gdfifocfg.<a class="code" href="uniongdfifocfg__data.html#o0">d32</a> &gt;&gt; 16;
01655 
01656         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
01657                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;en_multiple_tx_fifo) {
01658                         <span class="comment">/* Flush the Tx FIFO */</span>
01659                         <a class="code" href="dwc__otg__cil_8h.html#a104">dwc_otg_flush_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a>);
01660                 }
01661                 <a class="code" href="dwc__otg__pcd_8c.html#a32">release_perio_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a>);
01662                 <a class="code" href="dwc__otg__pcd_8c.html#a33">release_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a>);
01663                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;en_multiple_tx_fifo) {
01664                         <span class="comment">/* Decreasing EPinfo Base Addr */</span>
01665                         dptxfsiz.<a class="code" href="unionfifosize__data.html#o0">d32</a> =
01666                             (DWC_READ_REG32
01667                              (&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;
01668                                 core_global_regs-&gt;dtxfsiz[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a>-1]) &gt;&gt; 16);
01669                         gdfifocfg.<a class="code" href="uniongdfifocfg__data.html#o3">b</a>.<a class="code" href="uniongdfifocfg__data.html#o2">epinfobase</a> = gdfifocfgbase.<a class="code" href="uniongdfifocfg__data.html#o0">d32</a> - dptxfsiz.<a class="code" href="unionfifosize__data.html#o0">d32</a>;
01670                         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gdfifocfg,
01671                                         gdfifocfg.<a class="code" href="uniongdfifocfg__data.html#o0">d32</a>);
01672                 }
01673         }
01674 
01675         <span class="comment">/* Free DMA Descriptors */</span>
01676         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
01677                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> != UE_ISOCHRONOUS) {
01678                         desc_addr = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>;
01679                         dma_desc_addr = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_1">dma_desc_addr</a>;
01680 
01681                         <span class="comment">/* Cannot call dma_free_coherent() with IRQs disabled */</span>
01682                         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
01683                         <a class="code" href="dwc__otg__pcd_8c.html#a11">dwc_otg_ep_free_desc_chain</a>(desc_addr, dma_desc_addr,
01684                                                    <a class="code" href="dwc__otg__cil_8h.html#a15">MAX_DMA_DESC_CNT</a>);
01685 
01686                         <span class="keywordflow">goto</span> out_unlocked;
01687                 }
01688         }
01689         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
01690 
01691 out_unlocked:
01692         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"%d %s disabled\n"</span>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>,
01693                     ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>);
01694         <span class="keywordflow">return</span> 0;
01695 
01696 }
01697 
01698 <span class="comment">/******************************************************************************/</span>
01699 <span class="preprocessor">#ifdef DWC_UTE_PER_IO</span>
01700 <span class="preprocessor"></span>
01705 <span class="keywordtype">void</span> dwc_pcd_xiso_ereq_free(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep, <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req)
01706 {
01707         DWC_FREE(req-&gt;ext_req.per_io_frame_descs);
01708         DWC_FREE(req);
01709 }
01710 
01715 <span class="keywordtype">int</span> dwc_otg_pcd_xiso_start_next_request(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
01716                                         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
01717 {
01718         <span class="keywordtype">int</span> i;
01719         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req = NULL;
01720         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *dwcep = NULL;
01721         <span class="keyword">struct </span>dwc_iso_xreq_port *ereq = NULL;
01722         <span class="keyword">struct </span>dwc_iso_pkt_desc_port *ddesc_iso;
01723         uint16_t nat;
01724         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> diepctl;
01725 
01726         dwcep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
01727 
01728         <span class="keywordflow">if</span> (dwcep-&gt;xiso_active_xfers &gt; 0) {
01729 <span class="preprocessor">#if 0   //Disable this to decrease s/w overhead that is crucial for Isoc transfers</span>
01730 <span class="preprocessor"></span>                DWC_WARN(<span class="stringliteral">"There are currently active transfers for EP%d \</span>
01731 <span class="stringliteral">                                (active=%d; queued=%d)"</span>, dwcep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>, dwcep-&gt;xiso_active_xfers, 
01732                                 dwcep-&gt;xiso_queued_xfers);
01733 <span class="preprocessor">#endif</span>
01734 <span class="preprocessor"></span>                <span class="keywordflow">return</span> 0;
01735         }
01736 
01737         nat = UGETW(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>-&gt;wMaxPacketSize);
01738         nat = (nat &gt;&gt; 11) &amp; 0x03;
01739 
01740         <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>)) {
01741                 req = DWC_CIRCLEQ_FIRST(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
01742                 ereq = &amp;req-&gt;ext_req;
01743                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 0;
01744 
01745                 <span class="comment">/* Get the frame number */</span>
01746                 dwcep-&gt;xiso_frame_num =
01747                     <a class="code" href="dwc__otg__cil_8h.html#a77">dwc_otg_get_frame_number</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd));
01748                 DWC_DEBUG(<span class="stringliteral">"FRM_NUM=%d"</span>, dwcep-&gt;xiso_frame_num);
01749 
01750                 ddesc_iso = ereq-&gt;per_io_frame_descs;
01751 
01752                 <span class="keywordflow">if</span> (dwcep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
01753                         <span class="comment">/* Setup DMA Descriptor chain for IN Isoc request */</span>
01754                         <span class="keywordflow">for</span> (i = 0; i &lt; ereq-&gt;pio_pkt_count; i++) {
01755                                 <span class="comment">//if ((i % (nat + 1)) == 0)</span>
01756                                 <span class="keywordflow">if</span> ( i &gt; 0 )
01757                                         dwcep-&gt;xiso_frame_num = (dwcep-&gt;xiso_bInterval +
01758                                                                                 dwcep-&gt;xiso_frame_num) &amp; 0x3FFF;
01759                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> =
01760                                     req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o2">dma</a> + ddesc_iso[i].offset;
01761                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o18">txbytes</a> =
01762                                     ddesc_iso[i].length;
01763                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> =
01764                                     dwcep-&gt;xiso_frame_num;
01765                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> =
01766                                     BS_HOST_READY;
01767                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o19">txsts</a> = 0;
01768                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o7">sp</a> =
01769                                     (ddesc_iso[i].length %
01770                                      dwcep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) ? 1 : 0;
01771                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 0;
01772                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o15">pid</a> = nat + 1;
01773                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 0;
01774 
01775                                 <span class="comment">/* Process the last descriptor */</span>
01776                                 <span class="keywordflow">if</span> (i == ereq-&gt;pio_pkt_count - 1) {
01777                                         dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 1;
01778                                         dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 1;
01779                                 }
01780                         }
01781 
01782                         <span class="comment">/* Setup and start the transfer for this endpoint */</span>
01783                         dwcep-&gt;xiso_active_xfers++;
01784                         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
01785                                         in_ep_regs[dwcep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;diepdma,
01786                                         dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_1">dma_desc_addr</a>);
01787                         diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0;
01788                         diepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> = 1;
01789                         diepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o10">cnak</a> = 1;
01790                         DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
01791                                          in_ep_regs[dwcep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;diepctl, 0,
01792                                          diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
01793                 } <span class="keywordflow">else</span> {
01794                         <span class="comment">/* Setup DMA Descriptor chain for OUT Isoc request */</span>
01795                         <span class="keywordflow">for</span> (i = 0; i &lt; ereq-&gt;pio_pkt_count; i++) {
01796                                 <span class="comment">//if ((i % (nat + 1)) == 0)</span>
01797                                 dwcep-&gt;xiso_frame_num = (dwcep-&gt;xiso_bInterval + 
01798                                                                                 dwcep-&gt;xiso_frame_num) &amp; 0x3FFF;
01799                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> =
01800                                     req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o2">dma</a> + ddesc_iso[i].offset;
01801                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> =
01802                                     ddesc_iso[i].length;
01803                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> =
01804                                     dwcep-&gt;xiso_frame_num;
01805                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> =
01806                                     BS_HOST_READY;
01807                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o16">rxsts</a> = 0;
01808                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o7">sp</a> =
01809                                     (ddesc_iso[i].length %
01810                                      dwcep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) ? 1 : 0;
01811                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 0;
01812                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o15">pid</a> = nat + 1;
01813                                 dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 0;
01814                                 
01815                                 <span class="comment">/* Process the last descriptor */</span>
01816                                 <span class="keywordflow">if</span> (i == ereq-&gt;pio_pkt_count - 1) {
01817                                         dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 1;
01818                                         dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 1;
01819                                 }                       
01820                         }
01821                         
01822                         <span class="comment">/* Setup and start the transfer for this endpoint */</span>
01823                         dwcep-&gt;xiso_active_xfers++;
01824                         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
01825                                         out_ep_regs[dwcep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doepdma,
01826                                         dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_1">dma_desc_addr</a>);
01827                         diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0;
01828                         diepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> = 1;
01829                         diepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o10">cnak</a> = 1;
01830                         DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
01831                                          out_ep_regs[dwcep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doepctl, 0,
01832                                          diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
01833                 }
01834 
01835         } <span class="keywordflow">else</span> {
01836                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
01837         }
01838 
01839         <span class="keywordflow">return</span> 0;
01840 }
01841 
01845 <span class="keywordtype">void</span> complete_xiso_ep(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
01846 {
01847         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req = NULL;
01848         <span class="keyword">struct </span>dwc_iso_xreq_port *ereq = NULL;
01849         <span class="keyword">struct </span>dwc_iso_pkt_desc_port *ddesc_iso = NULL;
01850         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *dwcep = NULL;
01851         <span class="keywordtype">int</span> i;
01852 
01853         <span class="comment">//DWC_DEBUG();</span>
01854         dwcep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
01855 
01856         <span class="comment">/* Get the first pending request from the queue */</span>
01857         <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>)) {
01858                 req = DWC_CIRCLEQ_FIRST(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
01859                 <span class="keywordflow">if</span> (!req) {
01860                         DWC_PRINTF(<span class="stringliteral">"complete_ep 0x%p, req = NULL!\n"</span>, ep);
01861                         <span class="keywordflow">return</span>;
01862                 }
01863                 dwcep-&gt;xiso_active_xfers--;
01864                 dwcep-&gt;xiso_queued_xfers--;
01865                 <span class="comment">/* Remove this request from the queue */</span>
01866                 DWC_CIRCLEQ_REMOVE_INIT(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>, req, queue_entry);
01867         } <span class="keywordflow">else</span> {
01868                 DWC_PRINTF(<span class="stringliteral">"complete_ep 0x%p, ep-&gt;queue empty!\n"</span>, ep);
01869                 <span class="keywordflow">return</span>;
01870         }
01871 
01872         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
01873         ereq = &amp;req-&gt;ext_req;
01874         ddesc_iso = ereq-&gt;per_io_frame_descs;
01875 
01876         <span class="keywordflow">if</span> (dwcep-&gt;xiso_active_xfers &lt; 0) {
01877                 DWC_WARN(<span class="stringliteral">"EP#%d (xiso_active_xfers=%d)"</span>, dwcep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>,
01878                          dwcep-&gt;xiso_active_xfers);
01879         }
01880 
01881         <span class="comment">/* Fill the Isoc descs of portable extended req from dma descriptors */</span>
01882         <span class="keywordflow">for</span> (i = 0; i &lt; ereq-&gt;pio_pkt_count; i++) {
01883                 <span class="keywordflow">if</span> (dwcep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>) {     <span class="comment">/* IN endpoints */</span>
01884                         ddesc_iso[i].actual_length = ddesc_iso[i].<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a> -
01885                             dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o18">txbytes</a>;
01886                         ddesc_iso[i].status =
01887                             dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o19">txsts</a>;
01888                 } <span class="keywordflow">else</span> {        <span class="comment">/* OUT endpoints */</span>
01889                         ddesc_iso[i].actual_length = ddesc_iso[i].length -
01890                             dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a>;
01891                         ddesc_iso[i].status =
01892                             dwcep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[i].<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o16">rxsts</a>;
01893                 }
01894         }
01895 
01896         DWC_SPINUNLOCK(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
01897 
01898         <span class="comment">/* Call the completion function in the non-portable logic */</span>
01899         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;xisoc_complete(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o9">priv</a>, req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o0">priv</a>, 0,
01900                                       &amp;req-&gt;ext_req);
01901 
01902         DWC_SPINLOCK(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
01903 
01904         <span class="comment">/* Free the request - specific freeing needed for extended request object */</span>
01905         dwc_pcd_xiso_ereq_free(ep, req);
01906 
01907         <span class="comment">/* Start the next request */</span>
01908         dwc_otg_pcd_xiso_start_next_request(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>, ep);
01909 
01910         <span class="keywordflow">return</span>;
01911 }
01912 
01917 <span class="keyword">static</span> <span class="keywordtype">int</span> dwc_otg_pcd_xiso_create_pkt_descs(<a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req,
01918                                              <span class="keywordtype">void</span> *ereq_nonport,
01919                                              <span class="keywordtype">int</span> atomic_alloc)
01920 {
01921         <span class="keyword">struct </span>dwc_iso_xreq_port *ereq = NULL;
01922         <span class="keyword">struct </span>dwc_iso_xreq_port *req_mapped = NULL;
01923         <span class="keyword">struct </span>dwc_iso_pkt_desc_port *ipds = NULL;      <span class="comment">/* To be created in this function */</span>
01924         uint32_t pkt_count;
01925         <span class="keywordtype">int</span> i;
01926 
01927         ereq = &amp;req-&gt;ext_req;
01928         req_mapped = (<span class="keyword">struct </span>dwc_iso_xreq_port *)ereq_nonport;
01929         pkt_count = req_mapped-&gt;pio_pkt_count;
01930 
01931         <span class="comment">/* Create the isoc descs */</span>
01932         <span class="keywordflow">if</span> (atomic_alloc) {
01933                 ipds = DWC_ALLOC_ATOMIC(<span class="keyword">sizeof</span>(*ipds) * pkt_count);
01934         } <span class="keywordflow">else</span> {
01935                 ipds = DWC_ALLOC(<span class="keyword">sizeof</span>(*ipds) * pkt_count);
01936         }
01937 
01938         <span class="keywordflow">if</span> (!ipds) {
01939                 DWC_ERROR(<span class="stringliteral">"Failed to allocate isoc descriptors"</span>);
01940                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
01941         }
01942 
01943         <span class="comment">/* Initialize the extended request fields */</span>
01944         ereq-&gt;per_io_frame_descs = ipds;
01945         ereq-&gt;error_count = 0;
01946         ereq-&gt;pio_alloc_pkt_count = pkt_count;
01947         ereq-&gt;pio_pkt_count = pkt_count;
01948         ereq-&gt;tr_sub_flags = req_mapped-&gt;tr_sub_flags;
01949 
01950         <span class="comment">/* Init the Isoc descriptors */</span>
01951         <span class="keywordflow">for</span> (i = 0; i &lt; pkt_count; i++) {
01952                 ipds[i].<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a> = req_mapped-&gt;per_io_frame_descs[i].<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a>;
01953                 ipds[i].offset = req_mapped-&gt;per_io_frame_descs[i].offset;
01954                 ipds[i].status = req_mapped-&gt;per_io_frame_descs[i].status;      <span class="comment">/* 0 */</span>
01955                 ipds[i].actual_length =
01956                     req_mapped-&gt;per_io_frame_descs[i].actual_length;
01957         }
01958 
01959         <span class="keywordflow">return</span> 0;
01960 }
01961 
01962 <span class="keyword">static</span> <span class="keywordtype">void</span> prn_ext_request(<span class="keyword">struct</span> dwc_iso_xreq_port *ereq)
01963 {
01964         <span class="keyword">struct </span>dwc_iso_pkt_desc_port *xfd = NULL;
01965         <span class="keywordtype">int</span> i;
01966 
01967         DWC_DEBUG(<span class="stringliteral">"per_io_frame_descs=%p"</span>, ereq-&gt;per_io_frame_descs);
01968         DWC_DEBUG(<span class="stringliteral">"tr_sub_flags=%d"</span>, ereq-&gt;tr_sub_flags);
01969         DWC_DEBUG(<span class="stringliteral">"error_count=%d"</span>, ereq-&gt;error_count);
01970         DWC_DEBUG(<span class="stringliteral">"pio_alloc_pkt_count=%d"</span>, ereq-&gt;pio_alloc_pkt_count);
01971         DWC_DEBUG(<span class="stringliteral">"pio_pkt_count=%d"</span>, ereq-&gt;pio_pkt_count);
01972         DWC_DEBUG(<span class="stringliteral">"res=%d"</span>, ereq-&gt;res);
01973 
01974         <span class="keywordflow">for</span> (i = 0; i &lt; ereq-&gt;pio_pkt_count; i++) {
01975                 xfd = &amp;ereq-&gt;per_io_frame_descs[0];
01976                 DWC_DEBUG(<span class="stringliteral">"FD #%d"</span>, i);
01977 
01978                 DWC_DEBUG(<span class="stringliteral">"xfd-&gt;actual_length=%d"</span>, xfd-&gt;actual_length);
01979                 DWC_DEBUG(<span class="stringliteral">"xfd-&gt;length=%d"</span>, xfd-&gt;length);
01980                 DWC_DEBUG(<span class="stringliteral">"xfd-&gt;offset=%d"</span>, xfd-&gt;offset);
01981                 DWC_DEBUG(<span class="stringliteral">"xfd-&gt;status=%d"</span>, xfd-&gt;status);
01982         }
01983 }
01984 
01988 <span class="keywordtype">int</span> dwc_otg_pcd_xiso_ep_queue(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
01989                               uint8_t * buf, dwc_dma_t dma_buf, uint32_t buflen,
01990                               <span class="keywordtype">int</span> zero, <span class="keywordtype">void</span> *req_handle, <span class="keywordtype">int</span> atomic_alloc,
01991                               <span class="keywordtype">void</span> *ereq_nonport)
01992 {
01993         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req = NULL;
01994         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
01995         dwc_irqflags_t flags;
01996         <span class="keywordtype">int</span> res;
01997 
01998         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, ep_handle);
01999         <span class="keywordflow">if</span> (!ep) {
02000                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
02001                 <span class="keywordflow">return</span> -DWC_E_INVALID;
02002         }
02003 
02004         <span class="comment">/* We support this extension only for DDMA mode */</span>
02005         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC)
02006                 <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable)
02007                         <span class="keywordflow">return</span> -DWC_E_INVALID;
02008 
02009         <span class="comment">/* Create a dwc_otg_pcd_request_t object */</span>
02010         <span class="keywordflow">if</span> (atomic_alloc) {
02011                 req = DWC_ALLOC_ATOMIC(<span class="keyword">sizeof</span>(*req));
02012         } <span class="keywordflow">else</span> {
02013                 req = DWC_ALLOC(<span class="keyword">sizeof</span>(*req));
02014         }
02015 
02016         <span class="keywordflow">if</span> (!req) {
02017                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
02018         }
02019 
02020         <span class="comment">/* Create the Isoc descs for this request which shall be the exact match</span>
02021 <span class="comment">         * of the structure sent to us from the non-portable logic */</span>
02022         res =
02023             dwc_otg_pcd_xiso_create_pkt_descs(req, ereq_nonport, atomic_alloc);
02024         <span class="keywordflow">if</span> (res) {
02025                 DWC_WARN(<span class="stringliteral">"Failed to init the Isoc descriptors"</span>);
02026                 DWC_FREE(req);
02027                 <span class="keywordflow">return</span> res;
02028         }
02029 
02030         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
02031 
02032         DWC_CIRCLEQ_INIT_ENTRY(req, queue_entry);
02033         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o1">buf</a> = buf;
02034         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o2">dma</a> = dma_buf;
02035         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a> = buflen;
02036         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o5">sent_zlp</a> = zero;
02037         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o0">priv</a> = req_handle;
02038 
02039         <span class="comment">//DWC_SPINLOCK_IRQSAVE(pcd-&gt;lock, &amp;flags);</span>
02040         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = dma_buf;
02041         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = buf;
02042         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = buf;
02043         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 0;
02044         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
02045         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
02046         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = buflen;
02047 
02048         <span class="comment">/* Add this request to the tail */</span>
02049         DWC_CIRCLEQ_INSERT_TAIL(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>, req, queue_entry);
02050         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.xiso_queued_xfers++;
02051 
02052 <span class="comment">//DWC_DEBUG("CP_0");</span>
02053 <span class="comment">//DWC_DEBUG("req-&gt;ext_req.tr_sub_flags=%d", req-&gt;ext_req.tr_sub_flags);</span>
02054 <span class="comment">//prn_ext_request((struct dwc_iso_xreq_port *) ereq_nonport);</span>
02055 <span class="comment">//prn_ext_request(&amp;req-&gt;ext_req);</span>
02056 
02057         <span class="comment">//DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;lock, flags);</span>
02058 
02059         <span class="comment">/* If the req-&gt;status == ASAP  then check if there is any active transfer</span>
02060 <span class="comment">         * for this endpoint. If no active transfers, then get the first entry</span>
02061 <span class="comment">         * from the queue and start that transfer</span>
02062 <span class="comment">         */</span>
02063         <span class="keywordflow">if</span> (req-&gt;ext_req.tr_sub_flags == DWC_EREQ_TF_ASAP) {
02064                 res = dwc_otg_pcd_xiso_start_next_request(pcd, ep);
02065                 <span class="keywordflow">if</span> (res) {
02066                         DWC_WARN(<span class="stringliteral">"Failed to start the next Isoc transfer"</span>);
02067                         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02068                         DWC_FREE(req);
02069                         <span class="keywordflow">return</span> res;
02070                 }
02071         }
02072 
02073         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02074         <span class="keywordflow">return</span> 0;
02075 }
02076 
02077 <span class="preprocessor">#endif</span>
02078 <span class="preprocessor"></span><span class="comment">/* END ifdef DWC_UTE_PER_IO ***************************************************/</span>
<a name="l02079"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a21">02079</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a21">dwc_otg_pcd_ep_queue</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
02080                          uint8_t * buf, dwc_dma_t dma_buf, uint32_t buflen,
02081                          <span class="keywordtype">int</span> zero, <span class="keywordtype">void</span> *req_handle, <span class="keywordtype">int</span> atomic_alloc)
02082 {
02083         dwc_irqflags_t flags;
02084         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req;
02085         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
02086         uint32_t max_transfer;
02087 
02088         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, ep_handle);
02089         <span class="keywordflow">if</span> (!ep || (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> &amp;&amp; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> != 0)) {
02090                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
02091                 <span class="keywordflow">return</span> -DWC_E_INVALID;
02092         }
02093 
02094         <span class="keywordflow">if</span> (atomic_alloc) {
02095                 req = DWC_ALLOC_ATOMIC(<span class="keyword">sizeof</span>(*req));
02096         } <span class="keywordflow">else</span> {
02097                 req = DWC_ALLOC(<span class="keyword">sizeof</span>(*req));
02098         }
02099 
02100         <span class="keywordflow">if</span> (!req) {
02101                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
02102         }
02103         DWC_CIRCLEQ_INIT_ENTRY(req, queue_entry);
02104         <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_params-&gt;opt) {
02105                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> != 0) {
02106                         DWC_ERROR(<span class="stringliteral">"queue req %p, len %d buf %p\n"</span>,
02107                                   req_handle, buflen, buf);
02108                 }
02109         }
02110 
02111         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o1">buf</a> = buf;
02112         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o2">dma</a> = dma_buf;
02113         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a> = buflen;
02114         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o5">sent_zlp</a> = zero;
02115         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o0">priv</a> = req_handle;
02116         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a> = NULL;
02117         <span class="keywordflow">if</span> ((dma_buf &amp; 0x3) &amp;&amp; <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_enable
02118                         &amp;&amp; !<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable)
02119                 req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a> = DWC_DMA_ALLOC(buflen,
02120                                  &amp;req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o7">dw_align_buf_dma</a>);
02121         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
02122 
02123         <span class="comment">/*</span>
02124 <span class="comment">         * After adding request to the queue for IN ISOC wait for In Token Received</span>
02125 <span class="comment">         * when TX FIFO is empty interrupt and for OUT ISOC wait for OUT Token </span>
02126 <span class="comment">         * Received when EP is disabled interrupt to obtain starting microframe</span>
02127 <span class="comment">         * (odd/even) start transfer</span>
02128 <span class="comment">         */</span>
02129         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC)
02130         {
02131                 <span class="keywordflow">if</span> (req != 0) {
02132                         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = DWC_READ_REG32(&amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;diepctl)};
02133                         ++pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o10">request_pending</a>;
02134 
02135                         DWC_CIRCLEQ_INSERT_TAIL(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>, req, queue_entry);
02136                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>)
02137                         {
02138                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o10">cnak</a> = 1;
02139                                 DWC_WRITE_REG32(&amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;diepctl, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
02140                         }
02141                         
02142                         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02143                 }
02144                 <span class="keywordflow">return</span> 0;
02145         }
02146 
02147         <span class="comment">/*</span>
02148 <span class="comment">         * For EP0 IN without premature status, zlp is required?</span>
02149 <span class="comment">         */</span>
02150         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> == 0 &amp;&amp; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
02151                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%d-OUT ZLP\n"</span>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>);
02152                 <span class="comment">//_req-&gt;zero = 1;</span>
02153         }
02154 
02155         <span class="comment">/* Start the transfer */</span>
02156         <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>) &amp;&amp; !ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>) {
02157                 <span class="comment">/* EP0 Transfer? */</span>
02158                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> == 0) {
02159                         <span class="keywordflow">switch</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a>) {
02160                         <span class="keywordflow">case</span> EP0_IN_DATA_PHASE:
02161                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>,
02162                                             <span class="stringliteral">"%s ep0: EP0_IN_DATA_PHASE\n"</span>,
02163                                             __func__);
02164                                 <span class="keywordflow">break</span>;
02165 
02166                         <span class="keywordflow">case</span> EP0_OUT_DATA_PHASE:
02167                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>,
02168                                             <span class="stringliteral">"%s ep0: EP0_OUT_DATA_PHASE\n"</span>,
02169                                             __func__);
02170                                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o5">request_config</a>) {
02171                                         <span class="comment">/* Complete STATUS PHASE */</span>
02172                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 1;
02173                                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_IN_STATUS_PHASE;
02174                                 }
02175                                 <span class="keywordflow">break</span>;
02176 
02177                         <span class="keywordflow">case</span> EP0_IN_STATUS_PHASE:
02178                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>,
02179                                             <span class="stringliteral">"%s ep0: EP0_IN_STATUS_PHASE\n"</span>,
02180                                             __func__);
02181                                 <span class="keywordflow">break</span>;
02182 
02183                         <span class="keywordflow">default</span>:
02184                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"ep0: odd state %d\n"</span>,
02185                                             pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a>);
02186                                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02187                                 <span class="keywordflow">return</span> -DWC_E_SHUTDOWN;
02188                         }
02189 
02190                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = dma_buf;
02191                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = buf;
02192                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = buf;
02193                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = buflen;
02194                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
02195                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
02196                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>;
02197 
02198                         <span class="keywordflow">if</span> (zero) {
02199                                 <span class="keywordflow">if</span> ((ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> %
02200                                      ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> == 0)
02201                                     &amp;&amp; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> != 0)) {
02202                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 1;
02203                                 }
02204 
02205                         }
02206 
02207                         <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd),
02208                                                    &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02209                 }               <span class="comment">// non-ep0 endpoints</span>
02210                 <span class="keywordflow">else</span> {
02211 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
02212 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode != BM_STANDARD) {
02213                                 <span class="comment">/* store the request length */</span>
02214                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.cfi_req_len = buflen;
02215                                 pcd-&gt;cfi-&gt;ops.build_descriptors(pcd-&gt;cfi, pcd,
02216                                                                 ep, req);
02217                         } <span class="keywordflow">else</span> {
02218 <span class="preprocessor">#endif</span>
02219 <span class="preprocessor"></span>                                max_transfer =
02220                                     <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>)-&gt;
02221                                     core_params-&gt;max_transfer_size;
02222 
02223                                 <span class="comment">/* Setup and start the Transfer */</span>
02224                                 <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>){
02225                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>)
02226                                                 dwc_memcpy(req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>, buf, buflen);
02227                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o7">dw_align_buf_dma</a>;
02228                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>;
02229                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>;
02230                                 } <span class="keywordflow">else</span> {
02231                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = dma_buf;
02232                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = buf;
02233                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = buf;     
02234                                 }
02235                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 0;
02236                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
02237                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
02238                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = buflen;
02239 
02240                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> = max_transfer;
02241                                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
02242                                         uint32_t out_max_xfer =
02243                                             <a class="code" href="dwc__otg__pcd_8h.html#a2">DDMA_MAX_TRANSFER_SIZE</a> -
02244                                             (<a class="code" href="dwc__otg__pcd_8h.html#a2">DDMA_MAX_TRANSFER_SIZE</a> % 4);
02245                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
02246                                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> &gt;
02247                                                     DDMA_MAX_TRANSFER_SIZE) {
02248                                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> =
02249                                                             DDMA_MAX_TRANSFER_SIZE;
02250                                                 }
02251                                         } <span class="keywordflow">else</span> {
02252                                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> &gt;
02253                                                     out_max_xfer) {
02254                                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> =
02255                                                             out_max_xfer;
02256                                                 }
02257                                         }
02258                                 }
02259                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>) {
02260                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> -=
02261                                             (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> %
02262                                              ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>);
02263                                 }
02264 
02265                                 <span class="keywordflow">if</span> (zero) {
02266                                         <span class="keywordflow">if</span> ((ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> %
02267                                              ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> == 0)
02268                                             &amp;&amp; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> != 0)) {
02269                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 1;
02270                                         }
02271                                 }
02272 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
02273 <span class="preprocessor"></span>                        }
02274 <span class="preprocessor">#endif</span>
02275 <span class="preprocessor"></span>                        <a class="code" href="dwc__otg__cil_8h.html#a81">dwc_otg_ep_start_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd),
02276                                                   &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02277                 }
02278         }
02279 
02280         <span class="keywordflow">if</span> (req != 0) {
02281                 ++pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o10">request_pending</a>;
02282                 DWC_CIRCLEQ_INSERT_TAIL(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>, req, queue_entry);
02283                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> &amp;&amp; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>
02284                     &amp;&amp; !(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_enable)) {
02286                         <a class="code" href="uniondiepint__data.html">diepmsk_data_t</a> diepmsk = {.<a class="code" href="structdwc__otg__pcd.html#o12">d32</a> = 0 };
02287                         diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o5">intktxfemp</a> = 1;
02288                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;multiproc_int_enable) {
02289                                 DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
02290                                                  dev_global_regs-&gt;
02291                                                  diepeachintmsk[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>],
02292                                                  0, diepmsk.<a class="code" href="uniondiepint__data.html#o0">d32</a>);
02293                         } <span class="keywordflow">else</span> {
02294                                 DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
02295                                                  dev_global_regs-&gt;diepmsk, 0,
02296                                                  diepmsk.<a class="code" href="uniondiepint__data.html#o0">d32</a>);
02297                         }
02298 
02299                 }
02300         }
02301         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02302 
02303         <span class="keywordflow">return</span> 0;
02304 }
02305 
<a name="l02306"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a22">02306</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a22">dwc_otg_pcd_ep_dequeue</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
02307                            <span class="keywordtype">void</span> *req_handle)
02308 {
02309         dwc_irqflags_t flags;
02310         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req;
02311         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
02312 
02313         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, ep_handle);
02314         <span class="keywordflow">if</span> (!ep || (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> &amp;&amp; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> != 0)) {
02315                 DWC_WARN(<span class="stringliteral">"bad argument\n"</span>);
02316                 <span class="keywordflow">return</span> -DWC_E_INVALID;
02317         }
02318 
02319         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
02320 
02321         <span class="comment">/* make sure it's actually queued on this endpoint */</span>
02322         DWC_CIRCLEQ_FOREACH(req, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>, queue_entry) {
02323                 <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o0">priv</a> == (<span class="keywordtype">void</span> *)req_handle) {
02324                         <span class="keywordflow">break</span>;
02325                 }
02326         }
02327 
02328         <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o0">priv</a> != (<span class="keywordtype">void</span> *)req_handle) {
02329                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02330                 <span class="keywordflow">return</span> -DWC_E_INVALID;
02331         }
02332 
02333         <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY_ENTRY(req, queue_entry)) {
02334                 <a class="code" href="dwc__otg__pcd_8h.html#a17">dwc_otg_request_done</a>(ep, req, -DWC_E_RESTART);
02335         } <span class="keywordflow">else</span> {
02336                 req = NULL;
02337         }
02338 
02339         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02340 
02341         <span class="keywordflow">return</span> req ? 0 : -DWC_E_SHUTDOWN;
02342 
02343 }
02344 
<a name="l02345"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a23">02345</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a23">dwc_otg_pcd_ep_halt</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle, <span class="keywordtype">int</span> value)
02346 {
02347         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
02348         dwc_irqflags_t flags;
02349         <span class="keywordtype">int</span> retval = 0;
02350 
02351         ep = <a class="code" href="dwc__otg__pcd_8c.html#a1">get_ep_from_handle</a>(pcd, ep_handle);
02352 
02353         <span class="keywordflow">if</span> (!ep || (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> &amp;&amp; ep != &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>) ||
02354             (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a> &amp;&amp; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>-&gt;bmAttributes == UE_ISOCHRONOUS))) {
02355                 DWC_WARN(<span class="stringliteral">"%s, bad ep\n"</span>, __func__);
02356                 <span class="keywordflow">return</span> -DWC_E_INVALID;
02357         }
02358 
02359         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
02360         <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>)) {
02361                 DWC_WARN(<span class="stringliteral">"%d %s XFer In process\n"</span>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>,
02362                          ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>);
02363                 retval = -DWC_E_AGAIN;
02364         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value == 0) {
02365                 <a class="code" href="dwc__otg__cil_8h.html#a87">dwc_otg_ep_clear_stall</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02366         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value == 1) {
02367                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> == 1 &amp;&amp; <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
02368                         <a class="code" href="uniondtxfsts__data.html">dtxfsts_data_t</a> txstatus;
02369                         <a class="code" href="unionfifosize__data.html">fifosize_data_t</a> txfifosize;
02370 
02371                         txfifosize.<a class="code" href="unionfifosize__data.html#o0">d32</a> =
02372                             DWC_READ_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;
02373                                            dtxfsiz[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a>]);
02374                         txstatus.<a class="code" href="uniondtxfsts__data.html#o0">d32</a> =
02375                             DWC_READ_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
02376                                            in_ep_regs[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;dtxfsts);
02377 
02378                         <span class="keywordflow">if</span> (txstatus.<a class="code" href="uniondtxfsts__data.html#o3">b</a>.<a class="code" href="uniondtxfsts__data.html#o1">txfspcavail</a> &lt; txfifosize.<a class="code" href="unionfifosize__data.html#o3">b</a>.<a class="code" href="unionfifosize__data.html#o2">depth</a>) {
02379                                 DWC_WARN(<span class="stringliteral">"%s() Data In Tx Fifo\n"</span>, __func__);
02380                                 retval = -DWC_E_AGAIN;
02381                         } <span class="keywordflow">else</span> {
02382                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> == 0) {
02383                                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_STALL;
02384                                 }
02385 
02386                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
02387                                 <a class="code" href="dwc__otg__cil_8h.html#a86">dwc_otg_ep_set_stall</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd),
02388                                                      &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02389                         }
02390                 } <span class="keywordflow">else</span> {
02391                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> == 0) {
02392                                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_STALL;
02393                         }
02394 
02395                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
02396                         <a class="code" href="dwc__otg__cil_8h.html#a86">dwc_otg_ep_set_stall</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02397                 }
02398         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value == 2) {
02399                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_9">stall_clear_flag</a> = 0;
02400         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value == 3) {
02401                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_9">stall_clear_flag</a> = 1;
02402         }
02403 
02404         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02405 
02406         <span class="keywordflow">return</span> retval;
02407 }
02408 
<a name="l02412"></a><a class="code" href="dwc__otg__pcd_8c.html#a39">02412</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#a39">dwc_otg_pcd_rem_wkup_from_suspend</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">int</span> set)
02413 {
02414         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = { 0 };
02415         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
02416         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts;
02417 
02418         dsts.<a class="code" href="uniondsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o2">dsts</a>);
02419         <span class="keywordflow">if</span> (!dsts.<a class="code" href="uniondsts__data.html#o7">b</a>.<a class="code" href="uniondsts__data.html#o1">suspsts</a>) {
02420                 DWC_WARN(<span class="stringliteral">"Remote wakeup while is not in suspend state\n"</span>);
02421         }
02422         <span class="comment">/* Check if DEVICE_REMOTE_WAKEUP feature enabled */</span>
02423         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o6">remote_wakeup_enable</a>) {
02424                 <span class="keywordflow">if</span> (set) {
02425 
02426                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a>) {
02427                                 <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn;
02428 
02429                                 <a class="code" href="dwc__otg__adp_8h.html#a8">dwc_otg_adp_probe_stop</a>(core_if);
02430 
02431                                 <span class="comment">/* Mask SRP detected interrupt from Power Down Logic */</span>
02432                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
02433                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o17">srp_det_msk</a> = 1;
02434                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02435                                                  gpwrdn, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
02436 
02437                                 <span class="comment">/* Disable Power Down Logic */</span>
02438                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
02439                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
02440                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02441                                                  gpwrdn, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
02442 
02443                                 <span class="comment">/*</span>
02444 <span class="comment">                                 * Initialize the Core for Device mode.</span>
02445 <span class="comment">                                 */</span>
02446                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = B_PERIPHERAL;
02447                                 <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
02448                                 <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
02449                                 <a class="code" href="dwc__otg__cil_8h.html#a124">cil_pcd_start</a>(core_if);
02450 
02451                                 dwc_otg_initiate_srp(core_if);
02452                         }
02453 
02454                         dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o1">rmtwkupsig</a> = 1;
02455                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
02456                                          dev_global_regs-&gt;dctl, 0, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
02457                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"Set Remote Wakeup\n"</span>);
02458 
02459                         dwc_mdelay(2);
02460                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
02461                                          dev_global_regs-&gt;dctl, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>, 0);
02462                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"Clear Remote Wakeup\n"</span>);
02463                 }
02464         } <span class="keywordflow">else</span> {
02465                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"Remote Wakeup is disabled\n"</span>);
02466         }
02467 }
02468 
02469 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
02470 <span class="preprocessor"></span>
02473 <span class="keywordtype">void</span> dwc_otg_pcd_rem_wkup_from_sleep(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">int</span> set)
02474 {
02475         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
02476         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
02477 
02478         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
02479 
02480         <span class="comment">/* Check if we are in L1 state */</span>
02481         <span class="keywordflow">if</span> (!lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o8">prt_sleep_sts</a>) {
02482                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCD, <span class="stringliteral">"Device is not in sleep state\n"</span>);
02483                 <span class="keywordflow">return</span>;
02484         }
02485 
02486         <span class="comment">/* Check if host allows remote wakeup */</span>
02487         <span class="keywordflow">if</span> (!lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o4">rem_wkup_en</a>) {
02488                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCD, <span class="stringliteral">"Host does not allow remote wakeup\n"</span>);
02489                 <span class="keywordflow">return</span>;
02490         }
02491 
02492         <span class="comment">/* Check if Resume OK */</span>
02493         <span class="keywordflow">if</span> (!lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o9">sleep_state_resumeok</a>) {
02494                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCD, <span class="stringliteral">"Sleep state resume is not OK\n"</span>);
02495                 <span class="keywordflow">return</span>;
02496         }
02497 
02498         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
02499         lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o5">en_utmi_sleep</a> = 0;
02500         lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o6">hird_thres</a> &amp;= (~(1 &lt;&lt; 4));
02501         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>, lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a>);
02502 
02503         <span class="keywordflow">if</span> (set) {
02504                 <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = {.<a class="code" href="unionglpmctl__data.html#o0">d32</a> = 0 };
02505                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o1">rmtwkupsig</a> = 1;
02506                 <span class="comment">/* Set RmtWkUpSig bit to start remote wakup signaling.</span>
02507 <span class="comment">                 * Hardware will automatically clear this bit.</span>
02508 <span class="comment">                 */</span>
02509                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>,
02510                                  0, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
02511                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCD, <span class="stringliteral">"Set Remote Wakeup\n"</span>);
02512         }
02513 
02514 }
02515 <span class="preprocessor">#endif</span>
02516 <span class="preprocessor"></span>
<a name="l02520"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a34">02520</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a34">dwc_otg_pcd_remote_wakeup</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">int</span> set)
02521 {
02522         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
02523         dwc_irqflags_t flags;
02524         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if)) {
02525                 DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
02526 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
02527 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> == DWC_OTG_L1) {
02528                         dwc_otg_pcd_rem_wkup_from_sleep(pcd, set);
02529                 } <span class="keywordflow">else</span> {
02530 <span class="preprocessor">#endif</span>
02531 <span class="preprocessor"></span>                        <a class="code" href="dwc__otg__pcd_8c.html#a39">dwc_otg_pcd_rem_wkup_from_suspend</a>(pcd, set);
02532 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
02533 <span class="preprocessor"></span>                }
02534 <span class="preprocessor">#endif</span>
02535 <span class="preprocessor"></span>                DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02536         }
02537         <span class="keywordflow">return</span>;
02538 }
02539 
<a name="l02540"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a35">02540</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a35">dwc_otg_pcd_disconnect_us</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">int</span> no_of_usecs)
02541 {
02542         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
02543         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = { 0 };
02544 
02545         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if)) {
02546                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o2">sftdiscon</a> = 1;
02547                 DWC_PRINTF(<span class="stringliteral">"Soft disconnect for %d useconds\n"</span>,no_of_usecs);
02548                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, 0, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
02549                 dwc_udelay(no_of_usecs);
02550                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>,0);
02551                 
02552         } <span class="keywordflow">else</span>{
02553                 DWC_PRINTF(<span class="stringliteral">"NOT SUPPORTED IN HOST MODE\n"</span>);
02554         }
02555         <span class="keywordflow">return</span>;
02556 
02557 }
02558 
<a name="l02559"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a30">02559</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a30">dwc_otg_pcd_wakeup</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
02560 {
02561         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts;
02562         <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl;
02563 
02564         <span class="comment">/*</span>
02565 <span class="comment">         * This function starts the Protocol if no session is in progress. If</span>
02566 <span class="comment">         * a session is already in progress, but the device is suspended,</span>
02567 <span class="comment">         * remote wakeup signaling is started.</span>
02568 <span class="comment">         */</span>
02569 
02570         <span class="comment">/* Check if valid session */</span>
02571         gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> =
02572             DWC_READ_REG32(&amp;(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gotgctl));
02573         <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o17">bsesvld</a>) {
02574                 <span class="comment">/* Check if suspend state */</span>
02575                 dsts.<a class="code" href="uniondsts__data.html#o0">d32</a> =
02576                     DWC_READ_REG32(&amp;
02577                                    (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
02578                                     dev_global_regs-&gt;dsts));
02579                 <span class="keywordflow">if</span> (dsts.<a class="code" href="uniondsts__data.html#o7">b</a>.<a class="code" href="uniondsts__data.html#o1">suspsts</a>) {
02580                         <a class="code" href="dwc__otg__pcd__if_8h.html#a34">dwc_otg_pcd_remote_wakeup</a>(pcd, 1);
02581                 }
02582         } <span class="keywordflow">else</span> {
02583                 <a class="code" href="dwc__otg__pcd__if_8h.html#a33">dwc_otg_pcd_initiate_srp</a>(pcd);
02584         }
02585 
02586         <span class="keywordflow">return</span> 0;
02587 
02588 }
02589 
<a name="l02596"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a33">02596</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a33">dwc_otg_pcd_initiate_srp</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
02597 {
02598         dwc_irqflags_t flags;
02599         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, &amp;flags);
02600         dwc_otg_initiate_srp(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd));
02601         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>, flags);
02602 }
02603 
<a name="l02604"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a25">02604</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a25">dwc_otg_pcd_get_frame_number</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
02605 {
02606         <span class="keywordflow">return</span> <a class="code" href="dwc__otg__cil_8h.html#a77">dwc_otg_get_frame_number</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd));
02607 }
02608 
<a name="l02609"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a31">02609</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a31">dwc_otg_pcd_is_lpm_enabled</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
02610 {
02611         <span class="keywordflow">return</span> <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_params-&gt;lpm_enable;
02612 }
02613 
<a name="l02614"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a38">02614</a> uint32_t <a class="code" href="dwc__otg__pcd__if_8h.html#a38">get_b_hnp_enable</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
02615 {
02616         <span class="keywordflow">return</span> pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o7">b_hnp_enable</a>;
02617 }
02618 
02619 uint32_t get_a_hnp_support(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
02620 {
02621         <span class="keywordflow">return</span> pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o8">a_hnp_support</a>;
02622 }
02623 
02624 uint32_t get_a_alt_hnp_support(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
02625 {
02626         <span class="keywordflow">return</span> pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o9">a_alt_hnp_support</a>;
02627 }
02628 
<a name="l02629"></a><a class="code" href="dwc__otg__pcd__if_8h.html#a32">02629</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__if_8h.html#a32">dwc_otg_pcd_get_rmwkup_enable</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
02630 {
02631         <span class="keywordflow">return</span> pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o6">remote_wakeup_enable</a>;
02632 }
02633 
02634 <span class="preprocessor">#endif </span><span class="comment">/* DWC_HOST_ONLY */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 27 03:56:37 2011 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
