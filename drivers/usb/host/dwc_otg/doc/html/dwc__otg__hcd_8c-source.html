<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_hcd.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>dwc_otg_hcd.c</h1><a href="dwc__otg__hcd_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/* ==========================================================================</span>
00002 <span class="comment"> * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_hcd.c $</span>
00003 <span class="comment"> * $Revision: #104 $</span>
00004 <span class="comment"> * $Date: 2011/10/24 $</span>
00005 <span class="comment"> * $Change: 1871159 $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
00008 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
00009 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
00012 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
00013 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
00014 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
00015 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
00016 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
00017 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
00018 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
00019 <span class="comment"> * below, then you are not authorized to use the Software.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
00022 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
00025 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
00026 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
00027 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
00028 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
00031 <span class="comment"> * DAMAGE.</span>
00032 <span class="comment"> * ========================================================================== */</span>
00033 <span class="preprocessor">#ifndef DWC_DEVICE_ONLY</span>
00034 <span class="preprocessor"></span>
00042 <span class="preprocessor">#include "<a class="code" href="dwc__otg__hcd_8h.html">dwc_otg_hcd.h</a>"</span>
00043 <span class="preprocessor">#include "<a class="code" href="dwc__otg__regs_8h.html">dwc_otg_regs.h</a>"</span>
00044 
<a name="l00045"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a10">00045</a> <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="dwc__otg__hcd_8c.html#a1">dwc_otg_hcd_alloc_hcd</a>(<span class="keywordtype">void</span>)
00046 {
00047         <span class="keywordflow">return</span> DWC_ALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a>));
00048 }
00049 
<a name="l00054"></a><a class="code" href="dwc__otg__hcd_8c.html#a2">00054</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a2">dwc_otg_hcd_connect_timeout</a>(<span class="keywordtype">void</span> *ptr)
00055 {
00056         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, ptr);
00057         DWC_PRINTF(<span class="stringliteral">"Connect Timeout\n"</span>);
00058         __DWC_ERROR(<span class="stringliteral">"Device Not Connected/Responding\n"</span>);
00059 }
00060 
00061 <span class="preprocessor">#ifdef DEBUG</span>
00062 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> dump_channel_info(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
00063 {
00064         <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a> != NULL) {
00065                 <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc = qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a>;
00066                 dwc_list_link_t *item;
00067                 <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh_item;
00068                 <span class="keywordtype">int</span> num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o18">host_channels</a>;
00069                 <span class="keywordtype">int</span> i;
00070 
00071                 <a class="code" href="structdwc__otg__hc__regs.html">dwc_otg_hc_regs_t</a> *hc_regs;
00072                 <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
00073                 hcsplt_data_t hcsplt;
00074                 <a class="code" href="unionhctsiz__data.html">hctsiz_data_t</a> hctsiz;
00075                 uint32_t hcdma;
00076 
00077                 hc_regs = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o2">hc_regs</a>[hc-&gt;<a class="code" href="structdwc__hc.html#o0">hc_num</a>];
00078                 hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
00079                 hcsplt.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o1">hcsplt</a>);
00080                 hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o4">hctsiz</a>);
00081                 hcdma = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o5">hcdma</a>);
00082 
00083                 DWC_PRINTF(<span class="stringliteral">"  Assigned to channel %p:\n"</span>, hc);
00084                 DWC_PRINTF(<span class="stringliteral">"    hcchar 0x%08x, hcsplt 0x%08x\n"</span>, hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>,
00085                            hcsplt.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
00086                 DWC_PRINTF(<span class="stringliteral">"    hctsiz 0x%08x, hcdma 0x%08x\n"</span>, hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a>,
00087                            hcdma);
00088                 DWC_PRINTF(<span class="stringliteral">"    dev_addr: %d, ep_num: %d, ep_is_in: %d\n"</span>,
00089                            hc-&gt;<a class="code" href="structdwc__hc.html#o1">dev_addr</a>, hc-&gt;<a class="code" href="structdwc__hc.html#o2">ep_num</a>, hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a>);
00090                 DWC_PRINTF(<span class="stringliteral">"    ep_type: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a>);
00091                 DWC_PRINTF(<span class="stringliteral">"    max_packet: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#o6">max_packet</a>);
00092                 DWC_PRINTF(<span class="stringliteral">"    data_pid_start: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#o7">data_pid_start</a>);
00093                 DWC_PRINTF(<span class="stringliteral">"    xfer_started: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a>);
00094                 DWC_PRINTF(<span class="stringliteral">"    halt_status: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_10">halt_status</a>);
00095                 DWC_PRINTF(<span class="stringliteral">"    xfer_buff: %p\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a>);
00096                 DWC_PRINTF(<span class="stringliteral">"    xfer_len: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_2">xfer_len</a>);
00097                 DWC_PRINTF(<span class="stringliteral">"    qh: %p\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_18">qh</a>);
00098                 DWC_PRINTF(<span class="stringliteral">"  NP inactive sched:\n"</span>);
00099                 DWC_LIST_FOREACH(item, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o4">non_periodic_sched_inactive</a>) {
00100                         qh_item =
00101                             DWC_LIST_ENTRY(item, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
00102                         DWC_PRINTF(<span class="stringliteral">"    %p\n"</span>, qh_item);
00103                 }
00104                 DWC_PRINTF(<span class="stringliteral">"  NP active sched:\n"</span>);
00105                 DWC_LIST_FOREACH(item, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o5">non_periodic_sched_active</a>) {
00106                         qh_item =
00107                             DWC_LIST_ENTRY(item, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
00108                         DWC_PRINTF(<span class="stringliteral">"    %p\n"</span>, qh_item);
00109                 }
00110                 DWC_PRINTF(<span class="stringliteral">"  Channels: \n"</span>);
00111                 <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
00112                         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>[i];
00113                         DWC_PRINTF(<span class="stringliteral">"    %2d: %p\n"</span>, i, hc);
00114                 }
00115         }
00116 }
00117 <span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>
00118 
<a name="l00123"></a><a class="code" href="dwc__otg__hcd_8c.html#a3">00123</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a3">hcd_start_func</a>(<span class="keywordtype">void</span> *_vp)
00124 {
00125         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *hcd = (<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *) _vp;
00126 
00127         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"%s() %p\n"</span>, __func__, hcd);
00128         <span class="keywordflow">if</span> (hcd) {
00129                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a>-&gt;start(hcd);
00130         }
00131 }
00132 
00133 <span class="keyword">static</span> <span class="keywordtype">void</span> del_xfer_timers(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
00134 {
00135 <span class="preprocessor">#ifdef DEBUG</span>
00136 <span class="preprocessor"></span>        <span class="keywordtype">int</span> i;
00137         <span class="keywordtype">int</span> num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o18">host_channels</a>;
00138         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
00139                 DWC_TIMER_CANCEL(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hc_xfer_timer[i]);
00140         }
00141 <span class="preprocessor">#endif</span>
00142 <span class="preprocessor"></span>}
00143 
00144 <span class="keyword">static</span> <span class="keywordtype">void</span> del_timers(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
00145 {
00146         del_xfer_timers(hcd);
00147         DWC_TIMER_CANCEL(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o20">conn_timer</a>);
00148 }
00149 
<a name="l00154"></a><a class="code" href="dwc__otg__hcd_8c.html#a6">00154</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a6">kill_urbs_in_qh_list</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, dwc_list_link_t * qh_list)
00155 {
00156         dwc_list_link_t *qh_item;
00157         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
00158         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd, *qtd_tmp;
00159 
00160         DWC_LIST_FOREACH(qh_item, qh_list) {
00161                 qh = DWC_LIST_ENTRY(qh_item, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
00162                 DWC_CIRCLEQ_FOREACH_SAFE(qtd, qtd_tmp,
00163                                          &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>, qtd_list_entry) {
00164                         qtd = DWC_CIRCLEQ_FIRST(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>);
00165                         <span class="keywordflow">if</span> (qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o8">urb</a> != NULL) {
00166                                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a>-&gt;complete(hcd, qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o8">urb</a>-&gt;priv,
00167                                                     qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o8">urb</a>, -DWC_E_TIMEOUT);
00168                                 <a class="code" href="dwc__otg__hcd_8h.html#a59">dwc_otg_hcd_qtd_remove_and_free</a>(hcd, qtd, qh);
00169                         }
00170 
00171                 }
00172         }
00173 }
00174 
<a name="l00181"></a><a class="code" href="dwc__otg__hcd_8c.html#a7">00181</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a7">kill_all_urbs</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
00182 {
00183         <a class="code" href="dwc__otg__hcd_8c.html#a6">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o4">non_periodic_sched_inactive</a>);
00184         <a class="code" href="dwc__otg__hcd_8c.html#a6">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o5">non_periodic_sched_active</a>);
00185         <a class="code" href="dwc__otg__hcd_8c.html#a6">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o7">periodic_sched_inactive</a>);
00186         <a class="code" href="dwc__otg__hcd_8c.html#a6">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o8">periodic_sched_ready</a>);
00187         <a class="code" href="dwc__otg__hcd_8c.html#a6">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o9">periodic_sched_assigned</a>);
00188         <a class="code" href="dwc__otg__hcd_8c.html#a6">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o10">periodic_sched_queued</a>);
00189 }
00190 
<a name="l00197"></a><a class="code" href="dwc__otg__hcd_8c.html#a8">00197</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a8">dwc_otg_hcd_start_connect_timer</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
00198 {
00199         DWC_TIMER_SCHEDULE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o20">conn_timer</a>, 10000 <span class="comment">/* 10 secs */</span> );
00200 }
00201 
<a name="l00207"></a><a class="code" href="dwc__otg__hcd_8c.html#a9">00207</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__hcd_8c.html#a9">dwc_otg_hcd_session_start_cb</a>(<span class="keywordtype">void</span> *p)
00208 {
00209         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>;
00210         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, p);
00211         dwc_otg_hcd = p;
00212         <a class="code" href="dwc__otg__hcd_8c.html#a8">dwc_otg_hcd_start_connect_timer</a>(dwc_otg_hcd);
00213         <span class="keywordflow">return</span> 1;
00214 }
00215 
<a name="l00222"></a><a class="code" href="dwc__otg__hcd_8c.html#a10">00222</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__hcd_8c.html#a10">dwc_otg_hcd_start_cb</a>(<span class="keywordtype">void</span> *p)
00223 {
00224         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = p;
00225         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if;
00226         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0;
00227 
00228         core_if = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>;
00229 
00230         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == B_HOST) {
00231                 <span class="comment">/*</span>
00232 <span class="comment">                 * Reset the port.  During a HNP mode switch the reset</span>
00233 <span class="comment">                 * needs to occur within 1ms and have a duration of at</span>
00234 <span class="comment">                 * least 50ms.</span>
00235 <span class="comment">                 */</span>
00236                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
00237                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o9">prtrst</a> = 1;
00238                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
00239         }
00240         DWC_WORKQ_SCHEDULE_DELAYED(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o33">wq_otg</a>,
00241                                    <a class="code" href="dwc__otg__hcd_8c.html#a3">hcd_start_func</a>, dwc_otg_hcd, 50,
00242                                    <span class="stringliteral">"start hcd"</span>);
00243 
00244         <span class="keywordflow">return</span> 1;
00245 }
00246 
<a name="l00252"></a><a class="code" href="dwc__otg__hcd_8c.html#a11">00252</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__hcd_8c.html#a11">dwc_otg_hcd_disconnect_cb</a>(<span class="keywordtype">void</span> *p)
00253 {
00254         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> intr;
00255         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = p;
00256 
00257         <span class="comment">/*</span>
00258 <span class="comment">         * Set status flags for the hub driver.</span>
00259 <span class="comment">         */</span>
00260         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o1">port_connect_status_change</a> = 1;
00261         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o2">port_connect_status</a> = 0;
00262 
00263         <span class="comment">/*</span>
00264 <span class="comment">         * Shutdown any transfers in process by clearing the Tx FIFO Empty</span>
00265 <span class="comment">         * interrupt mask and status bits and disabling subsequent host</span>
00266 <span class="comment">         * channel interrupts.</span>
00267 <span class="comment">         */</span>
00268         intr.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00269         intr.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o6">nptxfempty</a> = 1;
00270         intr.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o27">ptxfempty</a> = 1;
00271         intr.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o26">hcintr</a> = 1;
00272         DWC_MODIFY_REG32(&amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>,
00273                          intr.<a class="code" href="uniongintsts__data.html#o0">d32</a>, 0);
00274         DWC_MODIFY_REG32(&amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>,
00275                          intr.<a class="code" href="uniongintsts__data.html#o0">d32</a>, 0);
00276 
00277         del_timers(dwc_otg_hcd);
00278 
00279         <span class="comment">/*</span>
00280 <span class="comment">         * Turn off the vbus power only if the core has transitioned to device</span>
00281 <span class="comment">         * mode. If still in host mode, need to keep power on to detect a</span>
00282 <span class="comment">         * reconnection.</span>
00283 <span class="comment">         */</span>
00284         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>)) {
00285                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> != A_SUSPEND) {
00286                         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0 = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
00287                         DWC_PRINTF(<span class="stringliteral">"Disconnect: PortPower off\n"</span>);
00288                         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 0;
00289                         DWC_WRITE_REG32(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>,
00290                                         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
00291                 }
00292 
00293                 <a class="code" href="dwc__otg__cil_8h.html#a99">dwc_otg_disable_host_interrupts</a>(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>);
00294         }
00295 
00296         <span class="comment">/* Respond with an error status to all URBs in the schedule. */</span>
00297         <a class="code" href="dwc__otg__hcd_8c.html#a7">kill_all_urbs</a>(dwc_otg_hcd);
00298 
00299         <span class="keywordflow">if</span> (dwc_otg_is_host_mode(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>)) {
00300                 <span class="comment">/* Clean up any host channels that were in use. */</span>
00301                 <span class="keywordtype">int</span> num_channels;
00302                 <span class="keywordtype">int</span> i;
00303                 <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *channel;
00304                 <a class="code" href="structdwc__otg__hc__regs.html">dwc_otg_hc_regs_t</a> *hc_regs;
00305                 <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
00306 
00307                 num_channels = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o18">host_channels</a>;
00308 
00309                 <span class="keywordflow">if</span> (!dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
00310                         <span class="comment">/* Flush out any channel requests in slave mode. */</span>
00311                         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
00312                                 channel = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>[i];
00313                                 <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY_ENTRY
00314                                     (channel, hc_list_entry)) {
00315                                         hc_regs =
00316                                             dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;
00317                                             host_if-&gt;hc_regs[i];
00318                                         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> =
00319                                             DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
00320                                         <span class="keywordflow">if</span> (hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a>) {
00321                                                 hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a> = 0;
00322                                                 hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o10">chdis</a> = 1;
00323                                                 hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o3">epdir</a> = 0;
00324                                                 DWC_WRITE_REG32
00325                                                     (&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>,
00326                                                      hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
00327                                         }
00328                                 }
00329                         }
00330                 }
00331 
00332                 <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
00333                         channel = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>[i];
00334                         <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY_ENTRY(channel, hc_list_entry)) {
00335                                 hc_regs =
00336                                     dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o2">hc_regs</a>[i];
00337                                 hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
00338                                 <span class="keywordflow">if</span> (hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a>) {
00339                                         <span class="comment">/* Halt the channel. */</span>
00340                                         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o10">chdis</a> = 1;
00341                                         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>,
00342                                                         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
00343                                 }
00344 
00345                                 <a class="code" href="dwc__otg__cil_8h.html#a93">dwc_otg_hc_cleanup</a>(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>,
00346                                                    channel);
00347                                 DWC_CIRCLEQ_INSERT_TAIL
00348                                     (&amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>, channel,
00349                                      hc_list_entry);
00350                                 <span class="comment">/*</span>
00351 <span class="comment">                                 * Added for Descriptor DMA to prevent channel double cleanup</span>
00352 <span class="comment">                                 * in release_channel_ddma(). Which called from ep_disable</span>
00353 <span class="comment">                                 * when device disconnect.</span>
00354 <span class="comment">                                 */</span>
00355                                 channel-&gt;<a class="code" href="structdwc__hc.html#z34_18">qh</a> = NULL;
00356                         }
00357                 }
00358         }
00359 
00360         <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a>-&gt;disconnect) {
00361                 dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a>-&gt;disconnect(dwc_otg_hcd);
00362         }
00363 
00364         <span class="keywordflow">return</span> 1;
00365 }
00366 
<a name="l00372"></a><a class="code" href="dwc__otg__hcd_8c.html#a12">00372</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__hcd_8c.html#a12">dwc_otg_hcd_stop_cb</a>(<span class="keywordtype">void</span> *p)
00373 {
00374         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = p;
00375 
00376         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, p);
00377         <a class="code" href="dwc__otg__hcd__if_8h.html#a17">dwc_otg_hcd_stop</a>(dwc_otg_hcd);
00378         <span class="keywordflow">return</span> 1;
00379 }
00380 
00381 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
00382 <span class="preprocessor"></span>
00387 <span class="keyword">static</span> <span class="keywordtype">int</span> dwc_otg_hcd_sleep_cb(<span class="keywordtype">void</span> *p)
00388 {
00389         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *hcd = p;
00390 
00391         dwc_otg_hcd_free_hc_from_lpm(hcd);
00392 
00393         <span class="keywordflow">return</span> 0;
00394 }
00395 <span class="preprocessor">#endif</span>
00396 <span class="preprocessor"></span>
<a name="l00402"></a><a class="code" href="dwc__otg__hcd_8c.html#a13">00402</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#a13">dwc_otg_hcd_rem_wakeup_cb</a>(<span class="keywordtype">void</span> *p)
00403 {
00404         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *hcd = p;
00405 
00406         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> == DWC_OTG_L2) {
00407                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o5">port_suspend_change</a> = 1;
00408         }
00409 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
00410 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
00411                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o7">port_l1_change</a> = 1;
00412         }
00413 <span class="preprocessor">#endif</span>
00414 <span class="preprocessor"></span>        <span class="keywordflow">return</span> 0;
00415 }
00416 
<a name="l00421"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a17">00421</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a17">dwc_otg_hcd_stop</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
00422 {
00423         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0 = {.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o0">d32</a> = 0 };
00424 
00425         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD STOP\n"</span>);
00426 
00427         <span class="comment">/*</span>
00428 <span class="comment">         * The root hub should be disconnected before this function is called.</span>
00429 <span class="comment">         * The disconnect will clear the QTD lists (via ..._hcd_urb_dequeue)</span>
00430 <span class="comment">         * and the QH lists (via ..._hcd_endpoint_disable).</span>
00431 <span class="comment">         */</span>
00432 
00433         <span class="comment">/* Turn off all host-specific interrupts. */</span>
00434         <a class="code" href="dwc__otg__cil_8h.html#a99">dwc_otg_disable_host_interrupts</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>);
00435 
00436         <span class="comment">/* Turn off the vbus power */</span>
00437         DWC_PRINTF(<span class="stringliteral">"PortPower off\n"</span>);
00438         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 0;
00439         DWC_WRITE_REG32(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
00440         dwc_mdelay(1);
00441 }
00442 
<a name="l00443"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a35">00443</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a35">dwc_otg_hcd_urb_enqueue</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
00444                             dwc_otg_hcd_urb_t * dwc_otg_urb, <span class="keywordtype">void</span> **ep_handle,
00445                             <span class="keywordtype">int</span> atomic_alloc)
00446 {
00447         dwc_irqflags_t flags;
00448         <span class="keywordtype">int</span> retval = 0;
00449         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd;
00450         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.<a class="code" href="unionhprt0__data.html#o0">d32</a> = 0 };
00451 
00452         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o2">port_connect_status</a>) {
00453                 <span class="comment">/* No longer connected. */</span>
00454                 DWC_ERROR(<span class="stringliteral">"Not connected\n"</span>);
00455                 <span class="keywordflow">return</span> -DWC_E_NO_DEVICE;
00456         }
00457 
00458         qtd = <a class="code" href="dwc__otg__hcd__queue_8c.html#a18">dwc_otg_hcd_qtd_create</a>(dwc_otg_urb, atomic_alloc);
00459         <span class="keywordflow">if</span> (qtd == NULL) {
00460                 DWC_ERROR(<span class="stringliteral">"DWC OTG HCD URB Enqueue failed creating QTD\n"</span>);
00461                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
00462         }
00463 
00464         retval =
00465             <a class="code" href="dwc__otg__hcd__queue_8c.html#a20">dwc_otg_hcd_qtd_add</a>(qtd, hcd, (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> **) ep_handle, atomic_alloc);
00466         <span class="keywordflow">if</span> (retval &lt; 0) {
00467                 DWC_ERROR(<span class="stringliteral">"DWC OTG HCD URB Enqueue failed adding QTD. "</span>
00468                           <span class="stringliteral">"Error status %d\n"</span>, retval);
00469                 <a class="code" href="dwc__otg__hcd_8h.html#a57">dwc_otg_hcd_qtd_free</a>(qtd);
00470         } <span class="keywordflow">else</span> {
00471                 qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o9">qh</a> = *ep_handle;
00472         }
00473         intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>);
00474         <span class="keywordflow">if</span> (!intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o4">sofintr</a> &amp;&amp; retval == 0) {
00475                 <a class="code" href="dwc__otg__hcd_8h.html#a8">dwc_otg_transaction_type_e</a> tr_type;
00476                 <span class="keywordflow">if</span> ((qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o9">qh</a>-&gt;<a class="code" href="structdwc__otg__qh.html#o0">ep_type</a> == UE_BULK)
00477                     &amp;&amp; !(qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o8">urb</a>-&gt;flags &amp; URB_GIVEBACK_ASAP)) {
00478                         <span class="comment">/* Do not schedule SG transactions until qtd has URB_GIVEBACK_ASAP set */</span>
00479                         <span class="keywordflow">return</span> 0;
00480                 }
00481                 DWC_SPINLOCK_IRQSAVE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, &amp;flags);
00482                 tr_type = <a class="code" href="dwc__otg__hcd_8h.html#a31">dwc_otg_hcd_select_transactions</a>(hcd);
00483                 <span class="keywordflow">if</span> (tr_type != DWC_OTG_TRANSACTION_NONE) {
00484                         <a class="code" href="dwc__otg__hcd_8h.html#a32">dwc_otg_hcd_queue_transactions</a>(hcd, tr_type);
00485                 }
00486                 DWC_SPINUNLOCK_IRQRESTORE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, flags);
00487         }
00488 
00489         <span class="keywordflow">return</span> retval;
00490 }
00491 
<a name="l00492"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a36">00492</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a36">dwc_otg_hcd_urb_dequeue</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
00493                             dwc_otg_hcd_urb_t * dwc_otg_urb)
00494 {
00495         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
00496         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *urb_qtd;
00497 
00498         urb_qtd = dwc_otg_urb-&gt;qtd;
00499         qh = urb_qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o9">qh</a>;
00500 <span class="preprocessor">#ifdef DEBUG</span>
00501 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CHK_DEBUG_LEVEL(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a> | <a class="code" href="dwc__otg__dbg_8h.html#a6">DBG_HCD_URB</a>)) {
00502                 <span class="keywordflow">if</span> (urb_qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o10">in_process</a>) {
00503                         dump_channel_info(hcd, qh);
00504                 }
00505         }
00506 <span class="preprocessor">#endif</span>
00507 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (urb_qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o10">in_process</a> &amp;&amp; qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a>) {
00508                 <span class="comment">/* The QTD is in process (it has been assigned to a channel). */</span>
00509                 <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o2">port_connect_status</a>) {
00510                         <span class="comment">/*</span>
00511 <span class="comment">                         * If still connected (i.e. in host mode), halt the</span>
00512 <span class="comment">                         * channel so it can be used for other transfers. If</span>
00513 <span class="comment">                         * no longer connected, the host registers can't be</span>
00514 <span class="comment">                         * written to halt the channel since the core is in</span>
00515 <span class="comment">                         * device mode.</span>
00516 <span class="comment">                         */</span>
00517                         <a class="code" href="dwc__otg__cil_8h.html#a92">dwc_otg_hc_halt</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>, qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a>,
00518                                         DWC_OTG_HC_XFER_URB_DEQUEUE);
00519                 }
00520         }
00521 
00522         <span class="comment">/*</span>
00523 <span class="comment">         * Free the QTD and clean up the associated QH. Leave the QH in the</span>
00524 <span class="comment">         * schedule if it has any remaining QTDs.</span>
00525 <span class="comment">         */</span>
00526 
00527         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
00528                 uint8_t b = urb_qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o10">in_process</a>;
00529                 <a class="code" href="dwc__otg__hcd_8h.html#a59">dwc_otg_hcd_qtd_remove_and_free</a>(hcd, urb_qtd, qh);
00530                 <span class="keywordflow">if</span> (b) {
00531                         <a class="code" href="dwc__otg__hcd__queue_8c.html#a17">dwc_otg_hcd_qh_deactivate</a>(hcd, qh, 0);
00532                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a> = NULL;
00533                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>)) {
00534                         <a class="code" href="dwc__otg__hcd__queue_8c.html#a16">dwc_otg_hcd_qh_remove</a>(hcd, qh);
00535                 }
00536         } <span class="keywordflow">else</span> {
00537                 <a class="code" href="dwc__otg__hcd_8h.html#a59">dwc_otg_hcd_qtd_remove_and_free</a>(hcd, urb_qtd, qh);
00538         }
00539         <span class="keywordflow">return</span> 0;
00540 }
00541 
<a name="l00542"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a37">00542</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a37">dwc_otg_hcd_endpoint_disable</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *ep_handle,
00543                                  <span class="keywordtype">int</span> retry)
00544 {
00545         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh = (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *) ep_handle;
00546         <span class="keywordtype">int</span> retval = 0;
00547         dwc_irqflags_t flags;
00548 
00549         <span class="keywordflow">if</span> (retry &lt; 0) {
00550                 retval = -DWC_E_INVALID;
00551                 <span class="keywordflow">goto</span> done;
00552         }
00553 
00554         <span class="keywordflow">if</span> (!qh) {
00555                 retval = -DWC_E_INVALID;
00556                 <span class="keywordflow">goto</span> done;
00557         }
00558 
00559         DWC_SPINLOCK_IRQSAVE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, &amp;flags);
00560 
00561         <span class="keywordflow">while</span> (!DWC_CIRCLEQ_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>) &amp;&amp; retry) {
00562                 DWC_SPINUNLOCK_IRQRESTORE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, flags);
00563                 retry--;
00564                 dwc_msleep(5);
00565                 DWC_SPINLOCK_IRQSAVE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, &amp;flags);
00566         }
00567 
00568         <a class="code" href="dwc__otg__hcd__queue_8c.html#a16">dwc_otg_hcd_qh_remove</a>(hcd, qh);
00569 
00570         DWC_SPINUNLOCK_IRQRESTORE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, flags);
00571         <span class="comment">/*</span>
00572 <span class="comment">         * Split dwc_otg_hcd_qh_remove_and_free() into qh_remove</span>
00573 <span class="comment">         * and qh_free to prevent stack dump on DWC_DMA_FREE() with</span>
00574 <span class="comment">         * irq_disabled (spinlock_irqsave) in dwc_otg_hcd_desc_list_free()</span>
00575 <span class="comment">         * and dwc_otg_hcd_frame_list_alloc().</span>
00576 <span class="comment">         */</span>
00577         <a class="code" href="dwc__otg__hcd__queue_8c.html#a6">dwc_otg_hcd_qh_free</a>(hcd, qh);
00578 
00579 done:
00580         <span class="keywordflow">return</span> retval;
00581 }
00582 
00583 <span class="preprocessor">#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,6,30)</span>
00584 <span class="preprocessor"></span><span class="keywordtype">int</span> dwc_otg_hcd_endpoint_reset(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *ep_handle)
00585 {
00586         <span class="keywordtype">int</span> retval = 0;
00587         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh = (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *) ep_handle;
00588         <span class="keywordflow">if</span> (!qh)
00589                 <span class="keywordflow">return</span> -DWC_E_INVALID;
00590 
00591         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o4">data_toggle</a> = DWC_OTG_HC_PID_DATA0;
00592         <span class="keywordflow">return</span> retval;
00593 }
00594 <span class="preprocessor">#endif</span>
00595 <span class="preprocessor"></span>
<a name="l00599"></a><a class="code" href="dwc__otg__hcd_8c.html#a0">00599</a> <span class="keyword">static</span> <a class="code" href="structdwc__otg__cil__callbacks.html">dwc_otg_cil_callbacks_t</a> <a class="code" href="dwc__otg__hcd_8c.html#a0">hcd_cil_callbacks</a> = {
00600         .<a class="code" href="structdwc__otg__cil__callbacks.html#o0">start</a> = dwc_otg_hcd_start_cb,
00601         .<a class="code" href="structdwc__otg__cil__callbacks.html#o1">stop</a> = dwc_otg_hcd_stop_cb,
00602         .<a class="code" href="structdwc__otg__cil__callbacks.html#o2">disconnect</a> = dwc_otg_hcd_disconnect_cb,
00603         .<a class="code" href="structdwc__otg__cil__callbacks.html#o5">session_start</a> = dwc_otg_hcd_session_start_cb,
00604         .<a class="code" href="structdwc__otg__cil__callbacks.html#o3">resume_wakeup</a> = dwc_otg_hcd_rem_wakeup_cb,
00605 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
00606 <span class="preprocessor"></span>        .sleep = dwc_otg_hcd_sleep_cb,
00607 <span class="preprocessor">#endif</span>
00608 <span class="preprocessor"></span>        .<a class="code" href="structdwc__otg__cil__callbacks.html#o6">p</a> = 0,
00609 };
00610 
<a name="l00614"></a><a class="code" href="dwc__otg__hcd_8c.html#a19">00614</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a19">reset_tasklet_func</a>(<span class="keywordtype">void</span> *data)
00615 {
00616         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = (<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *) data;
00617         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>;
00618         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0;
00619 
00620         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"USB RESET tasklet called\n"</span>);
00621 
00622         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
00623         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o9">prtrst</a> = 1;
00624         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
00625         dwc_mdelay(60);
00626 
00627         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o9">prtrst</a> = 0;
00628         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
00629         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o3">port_reset_change</a> = 1;
00630 }
00631 
00632 <span class="keyword">static</span> <span class="keywordtype">void</span> qh_list_free(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, dwc_list_link_t * qh_list)
00633 {
00634         dwc_list_link_t *item;
00635         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
00636         dwc_irqflags_t flags;
00637 
00638         <span class="keywordflow">if</span> (!qh_list-&gt;next) {
00639                 <span class="comment">/* The list hasn't been initialized yet. */</span>
00640                 <span class="keywordflow">return</span>;
00641         }
00642         <span class="comment">/*</span>
00643 <span class="comment">         * Hold spinlock here. Not needed in that case if bellow </span>
00644 <span class="comment">         * function is being called from ISR </span>
00645 <span class="comment">         */</span>
00646         DWC_SPINLOCK_IRQSAVE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, &amp;flags);
00647         <span class="comment">/* Ensure there are no QTDs or URBs left. */</span>
00648         <a class="code" href="dwc__otg__hcd_8c.html#a6">kill_urbs_in_qh_list</a>(hcd, qh_list);
00649         DWC_SPINUNLOCK_IRQRESTORE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, flags);
00650 
00651         DWC_LIST_FOREACH(item, qh_list) {
00652                 qh = DWC_LIST_ENTRY(item, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
00653                 <a class="code" href="dwc__otg__hcd_8h.html#a51">dwc_otg_hcd_qh_remove_and_free</a>(hcd, qh);
00654         }
00655 }
00656 
<a name="l00661"></a><a class="code" href="dwc__otg__hcd_8c.html#a21">00661</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a21">dwc_otg_hcd_power_up</a>(<span class="keywordtype">void</span> *ptr)
00662 {
00663         <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.d32 = 0 };
00664         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = (<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *) ptr;
00665 
00666         DWC_PRINTF(<span class="stringliteral">"%s called\n"</span>, __FUNCTION__);
00667 
00668         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a>) {
00669                 DWC_PRINTF(<span class="stringliteral">"Already exited from Hibernation\n"</span>);
00670                 <span class="keywordflow">return</span>;
00671         }
00672 
00673         <span class="comment">/* Switch on the voltage to the core */</span>
00674         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
00675         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00676         dwc_udelay(10);
00677 
00678         <span class="comment">/* Reset the core */</span>
00679         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00680         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00681         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00682         dwc_udelay(10);
00683 
00684         <span class="comment">/* Disable power clamps */</span>
00685         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00686         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o4">pwrdnclmp</a> = 1;
00687         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00688 
00689         <span class="comment">/* Remove reset the core signal */</span>
00690         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00691         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o5">pwrdnrstn</a> = 1;
00692         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
00693         dwc_udelay(10);
00694 
00695         <span class="comment">/* Disable PMU interrupt */</span>
00696         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00697         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
00698         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00699 
00700         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> = 0;
00701 
00702         <span class="comment">/* Disable PMU */</span>
00703         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00704         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
00705         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00706         dwc_udelay(10);
00707 
00708         <span class="comment">/* Enable VBUS */</span>
00709         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
00710         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o7">dis_vbus</a> = 1;
00711         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>, 0);
00712 
00713         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_HOST;
00714         <a class="code" href="dwc__otg__core__if_8h.html#a62">dwc_otg_core_init</a>(core_if);
00715         <a class="code" href="dwc__otg__core__if_8h.html#a64">dwc_otg_enable_global_interrupts</a>(core_if);
00716         <a class="code" href="dwc__otg__cil_8h.html#a119">cil_hcd_start</a>(core_if);
00717 }
00718 
<a name="l00723"></a><a class="code" href="dwc__otg__hcd_8c.html#a22">00723</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a22">dwc_otg_hcd_free</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>)
00724 {
00725         <span class="keywordtype">int</span> i;
00726 
00727         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD FREE\n"</span>);
00728 
00729         del_timers(dwc_otg_hcd);
00730 
00731         <span class="comment">/* Free memory for QH/QTD lists */</span>
00732         qh_list_free(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o4">non_periodic_sched_inactive</a>);
00733         qh_list_free(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o5">non_periodic_sched_active</a>);
00734         qh_list_free(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o7">periodic_sched_inactive</a>);
00735         qh_list_free(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o8">periodic_sched_ready</a>);
00736         qh_list_free(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o9">periodic_sched_assigned</a>);
00737         qh_list_free(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o10">periodic_sched_queued</a>);
00738 
00739         <span class="comment">/* Free memory for the host channels. */</span>
00740         <span class="keywordflow">for</span> (i = 0; i &lt; MAX_EPS_CHANNELS; i++) {
00741                 <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>[i];
00742 
00743 <span class="preprocessor">#ifdef DEBUG</span>
00744 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hc_xfer_timer[i]) {
00745                         DWC_TIMER_FREE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hc_xfer_timer[i]);
00746                 }
00747 <span class="preprocessor">#endif</span>
00748 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (hc != NULL) {
00749                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"HCD Free channel #%i, hc=%p\n"</span>,
00750                                     i, hc);
00751                         DWC_FREE(hc);
00752                 }
00753         }
00754 
00755         <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
00756                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o19">status_buf_dma</a>) {
00757                         DWC_DMA_FREE(DWC_OTG_HCD_STATUS_BUF_SIZE,
00758                                      dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o18">status_buf</a>,
00759                                      dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o19">status_buf_dma</a>);
00760                 }
00761         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o18">status_buf</a> != NULL) {
00762                 DWC_FREE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o18">status_buf</a>);
00763         }
00764         DWC_SPINLOCK_FREE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>);
00765         <span class="comment">/* Set core_if's lock pointer to NULL */</span>
00766         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a> = NULL;
00767 
00768         DWC_TIMER_FREE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o20">conn_timer</a>);
00769         DWC_TASK_FREE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o21">reset_tasklet</a>);
00770 
00771 <span class="preprocessor">#ifdef DWC_DEV_SRPCAP</span>
00772 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2 &amp;&amp;
00773             dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;pwron_timer) {
00774                 DWC_TIMER_FREE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;pwron_timer);
00775         }
00776 <span class="preprocessor">#endif</span>
00777 <span class="preprocessor"></span>        DWC_FREE(dwc_otg_hcd);
00778 }
00779 
<a name="l00780"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a11">00780</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a11">dwc_otg_hcd_init</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00781 {
00782         <span class="keywordtype">int</span> retval = 0;
00783         <span class="keywordtype">int</span> num_channels;
00784         <span class="keywordtype">int</span> i;
00785         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *channel;
00786 
00787         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a> = DWC_SPINLOCK_ALLOC();
00788         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>) {
00789                 DWC_ERROR(<span class="stringliteral">"Could not allocate lock for pcd"</span>);
00790                 DWC_FREE(hcd);
00791                 retval = -DWC_E_NO_MEMORY;
00792                 <span class="keywordflow">goto</span> out;
00793         }
00794         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a> = core_if;
00795 
00796         <span class="comment">/* Register the HCD CIL Callbacks */</span>
00797         <a class="code" href="dwc__otg__cil_8h.html#a117">dwc_otg_cil_register_hcd_callbacks</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>,
00798                                            &amp;<a class="code" href="dwc__otg__hcd_8c.html#a0">hcd_cil_callbacks</a>, hcd);
00799 
00800         <span class="comment">/* Initialize the non-periodic schedule. */</span>
00801         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o4">non_periodic_sched_inactive</a>);
00802         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o5">non_periodic_sched_active</a>);
00803 
00804         <span class="comment">/* Initialize the periodic schedule. */</span>
00805         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o7">periodic_sched_inactive</a>);
00806         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o8">periodic_sched_ready</a>);
00807         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o9">periodic_sched_assigned</a>);
00808         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o10">periodic_sched_queued</a>);
00809 
00810         <span class="comment">/*</span>
00811 <span class="comment">         * Create a host channel descriptor for each host channel implemented</span>
00812 <span class="comment">         * in the controller. Initialize the channel descriptor array.</span>
00813 <span class="comment">         */</span>
00814         DWC_CIRCLEQ_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>);
00815         num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o18">host_channels</a>;
00816         DWC_MEMSET(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>, 0, <span class="keyword">sizeof</span>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>));
00817         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
00818                 channel = DWC_ALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structdwc__hc.html">dwc_hc_t</a>));
00819                 <span class="keywordflow">if</span> (channel == NULL) {
00820                         retval = -DWC_E_NO_MEMORY;
00821                         DWC_ERROR(<span class="stringliteral">"%s: host channel allocation failed\n"</span>,
00822                                   __func__);
00823                         <a class="code" href="dwc__otg__hcd_8c.html#a22">dwc_otg_hcd_free</a>(hcd);
00824                         <span class="keywordflow">goto</span> out;
00825                 }
00826                 channel-&gt;<a class="code" href="structdwc__hc.html#o0">hc_num</a> = i;
00827                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>[i] = channel;
00828 <span class="preprocessor">#ifdef DEBUG</span>
00829 <span class="preprocessor"></span>                hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hc_xfer_timer[i] =
00830                     DWC_TIMER_ALLOC(<span class="stringliteral">"hc timer"</span>, hc_xfer_timeout,
00831                                     &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hc_xfer_info[i]);
00832 <span class="preprocessor">#endif</span>
00833 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"HCD Added channel #%d, hc=%p\n"</span>, i,
00834                             channel);
00835         }
00836 
00837         <span class="comment">/* Initialize the Connection timeout timer. */</span>
00838         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o20">conn_timer</a> = DWC_TIMER_ALLOC(<span class="stringliteral">"Connection timer"</span>,
00839                                           <a class="code" href="dwc__otg__hcd_8c.html#a2">dwc_otg_hcd_connect_timeout</a>, 0);
00840 
00841         <span class="comment">/* Initialize reset tasklet. */</span>
00842         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o21">reset_tasklet</a> = DWC_TASK_ALLOC(<span class="stringliteral">"reset_tasklet"</span>, <a class="code" href="dwc__otg__hcd_8c.html#a19">reset_tasklet_func</a>, hcd);
00843 <span class="preprocessor">#ifdef DWC_DEV_SRPCAP</span>
00844 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
00845                 <span class="comment">/* Initialize Power on timer for Host power up in case hibernation */</span>
00846                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;pwron_timer = DWC_TIMER_ALLOC(<span class="stringliteral">"PWRON TIMER"</span>,
00847                                                                         <a class="code" href="dwc__otg__hcd_8c.html#a21">dwc_otg_hcd_power_up</a>, core_if);
00848         }
00849 <span class="preprocessor">#endif  </span>
00850 <span class="preprocessor"></span>
00851         <span class="comment">/*</span>
00852 <span class="comment">         * Allocate space for storing data on status transactions. Normally no</span>
00853 <span class="comment">         * data is sent, but this space acts as a bit bucket. This must be</span>
00854 <span class="comment">         * done after usb_add_hcd since that function allocates the DMA buffer</span>
00855 <span class="comment">         * pool.</span>
00856 <span class="comment">         */</span>
00857         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
00858                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o18">status_buf</a> =
00859                     DWC_DMA_ALLOC(DWC_OTG_HCD_STATUS_BUF_SIZE,
00860                                   &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o19">status_buf_dma</a>);
00861         } <span class="keywordflow">else</span> {
00862                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o18">status_buf</a> = DWC_ALLOC(DWC_OTG_HCD_STATUS_BUF_SIZE);
00863         }
00864         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o18">status_buf</a>) {
00865                 retval = -DWC_E_NO_MEMORY;
00866                 DWC_ERROR(<span class="stringliteral">"%s: status_buf allocation failed\n"</span>, __func__);
00867                 <a class="code" href="dwc__otg__hcd_8c.html#a22">dwc_otg_hcd_free</a>(hcd);
00868                 <span class="keywordflow">goto</span> out;
00869         }
00870 
00871         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o24">otg_port</a> = 1;
00872         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o25">frame_list</a> = NULL;
00873         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o26">frame_list_dma</a> = 0;
00874         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o13">periodic_qh_count</a> = 0;
00875 out:
00876         <span class="keywordflow">return</span> retval;
00877 }
00878 
<a name="l00879"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a12">00879</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a12">dwc_otg_hcd_remove</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
00880 {
00881         <span class="comment">/* Turn off all host-specific interrupts. */</span>
00882         <a class="code" href="dwc__otg__cil_8h.html#a99">dwc_otg_disable_host_interrupts</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>);
00883 
00884         <a class="code" href="dwc__otg__hcd_8c.html#a22">dwc_otg_hcd_free</a>(hcd);
00885 }
00886 
<a name="l00890"></a><a class="code" href="dwc__otg__hcd_8c.html#a25">00890</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a25">dwc_otg_hcd_reinit</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
00891 {
00892         <span class="keywordtype">int</span> num_channels;
00893         <span class="keywordtype">int</span> i;
00894         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *channel;
00895         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *channel_tmp;
00896 
00897         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o0">d32</a> = 0;
00898 
00899         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a> = &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o5">non_periodic_sched_active</a>;
00900         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o16">non_periodic_channels</a> = 0;
00901         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o15">periodic_channels</a> = 0;
00902 
00903         <span class="comment">/*</span>
00904 <span class="comment">         * Put all channels in the free channel list and clean up channel</span>
00905 <span class="comment">         * states.</span>
00906 <span class="comment">         */</span>
00907         DWC_CIRCLEQ_FOREACH_SAFE(channel, channel_tmp,
00908                                  &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>, hc_list_entry) {
00909                 DWC_CIRCLEQ_REMOVE(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>, channel, hc_list_entry);
00910         }
00911 
00912         num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o18">host_channels</a>;
00913         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
00914                 channel = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>[i];
00915                 DWC_CIRCLEQ_INSERT_TAIL(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>, channel,
00916                                         hc_list_entry);
00917                 <a class="code" href="dwc__otg__cil_8h.html#a93">dwc_otg_hc_cleanup</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>, channel);
00918         }
00919 
00920         <span class="comment">/* Initialize the DWC core for host mode operation. */</span>
00921         <a class="code" href="dwc__otg__cil_8h.html#a73">dwc_otg_core_host_init</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>);
00922 
00923         <span class="comment">/* Set core_if's lock pointer to the hcd-&gt;lock */</span>
00924         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o48">lock</a> = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>;
00925 }
00926 
<a name="l00936"></a><a class="code" href="dwc__otg__hcd_8c.html#a26">00936</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a26">assign_and_init_hc</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
00937 {
00938         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc;
00939         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd;
00940         dwc_otg_hcd_urb_t *urb;
00941         <span class="keywordtype">void</span>* ptr = NULL;
00942 
00943         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"%s(%p,%p)\n"</span>, __func__, hcd, qh);
00944 
00945         hc = DWC_CIRCLEQ_FIRST(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>);
00946 
00947         <span class="comment">/* Remove the host channel from the free list. */</span>
00948         DWC_CIRCLEQ_REMOVE_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>, hc, hc_list_entry);
00949 
00950         qtd = DWC_CIRCLEQ_FIRST(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>);
00951 
00952         urb = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o8">urb</a>;
00953         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a> = hc;
00954 
00955         qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o10">in_process</a> = 1;
00956 
00957         <span class="comment">/*</span>
00958 <span class="comment">         * Use usb_pipedevice to determine device address. This address is</span>
00959 <span class="comment">         * 0 before the SET_ADDRESS command and the correct address afterward.</span>
00960 <span class="comment">         */</span>
00961         hc-&gt;<a class="code" href="structdwc__hc.html#o1">dev_addr</a> = dwc_otg_hcd_get_dev_addr(&amp;urb-&gt;pipe_info);
00962         hc-&gt;<a class="code" href="structdwc__hc.html#o2">ep_num</a> = dwc_otg_hcd_get_ep_num(&amp;urb-&gt;pipe_info);
00963         hc-&gt;<a class="code" href="structdwc__hc.html#o4">speed</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#o3">dev_speed</a>;
00964         hc-&gt;<a class="code" href="structdwc__hc.html#o6">max_packet</a> = <a class="code" href="dwc__otg__hcd_8h.html#a5">dwc_max_packet</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#o2">maxp</a>);
00965 
00966         hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a> = 0;
00967         hc-&gt;<a class="code" href="structdwc__hc.html#z34_10">halt_status</a> = DWC_OTG_HC_XFER_NO_HALT_STATUS;
00968         hc-&gt;<a class="code" href="structdwc__hc.html#z34_7">error_state</a> = (qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o4">error_count</a> &gt; 0);
00969         hc-&gt;<a class="code" href="structdwc__hc.html#z34_8">halt_on_queue</a> = 0;
00970         hc-&gt;<a class="code" href="structdwc__hc.html#z34_9">halt_pending</a> = 0;
00971         hc-&gt;<a class="code" href="structdwc__hc.html#z34_17">requests</a> = 0;
00972 
00973         <span class="comment">/*</span>
00974 <span class="comment">         * The following values may be modified in the transfer type section</span>
00975 <span class="comment">         * below. The xfer_len value may be reduced when the transfer is</span>
00976 <span class="comment">         * started to accommodate the max widths of the XferSize and PktCnt</span>
00977 <span class="comment">         * fields in the HCTSIZn register.</span>
00978 <span class="comment">         */</span>
00979 
00980         hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a> = (dwc_otg_hcd_is_pipe_in(&amp;urb-&gt;pipe_info) != 0);
00981         <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a>) {
00982                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_6">do_ping</a> = 0;
00983         } <span class="keywordflow">else</span> {
00984                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_6">do_ping</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#o5">ping_state</a>;
00985         }
00986 
00987         hc-&gt;<a class="code" href="structdwc__hc.html#o7">data_pid_start</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#o4">data_toggle</a>;
00988         hc-&gt;<a class="code" href="structdwc__hc.html#o8">multi_count</a> = 1;
00989 
00990         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
00991                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> = (uint8_t *) urb-&gt;dma + urb-&gt;actual_length;
00992 
00993                 <span class="comment">/* For non-dword aligned case */</span>
00994                 <span class="keywordflow">if</span> (((<span class="keywordtype">unsigned</span> long)hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> &amp; 0x3)
00995                     &amp;&amp; !hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
00996                         ptr = (uint8_t *) urb-&gt;buf + urb-&gt;actual_length;
00997                 }
00998         } <span class="keywordflow">else</span> {
00999                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> = (uint8_t *) urb-&gt;buf + urb-&gt;actual_length;
01000         }
01001         hc-&gt;<a class="code" href="structdwc__hc.html#z34_2">xfer_len</a> = urb-&gt;length - urb-&gt;actual_length;
01002         hc-&gt;<a class="code" href="structdwc__hc.html#z34_3">xfer_count</a> = 0;
01003 
01004         <span class="comment">/*</span>
01005 <span class="comment">         * Set the split attributes</span>
01006 <span class="comment">         */</span>
01007         hc-&gt;<a class="code" href="structdwc__hc.html#z34_11">do_split</a> = 0;
01008         <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#o8">do_split</a>) {
01009                 uint32_t hub_addr, port_addr;
01010                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_11">do_split</a> = 1;
01011                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_15">xact_pos</a> = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o6">isoc_split_pos</a>;
01012                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_12">complete_split</a> = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o2">complete_split</a>;
01013                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a>-&gt;hub_info(hcd, urb-&gt;<a class="code" href="structdwc__otg__hcd.html#o23">priv</a>, &amp;hub_addr, &amp;port_addr);
01014                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_13">hub_addr</a> = (uint8_t) hub_addr;
01015                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_14">port_addr</a> = (uint8_t) port_addr;
01016         }
01017 
01018         <span class="keywordflow">switch</span> (dwc_otg_hcd_get_pipe_type(&amp;urb-&gt;pipe_info)) {
01019         <span class="keywordflow">case</span> UE_CONTROL:
01020                 hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a> = DWC_OTG_EP_TYPE_CONTROL;
01021                 <span class="keywordflow">switch</span> (qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o1">control_phase</a>) {
01022                 <span class="keywordflow">case</span> DWC_OTG_CONTROL_SETUP:
01023                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  Control setup transaction\n"</span>);
01024                         hc-&gt;<a class="code" href="structdwc__hc.html#z34_6">do_ping</a> = 0;
01025                         hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a> = 0;
01026                         hc-&gt;<a class="code" href="structdwc__hc.html#o7">data_pid_start</a> = DWC_OTG_HC_PID_SETUP;
01027                         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
01028                                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> = (uint8_t *) urb-&gt;setup_dma;
01029                         } <span class="keywordflow">else</span> {
01030                                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> = (uint8_t *) urb-&gt;setup_packet;
01031                         }
01032                         hc-&gt;<a class="code" href="structdwc__hc.html#z34_2">xfer_len</a> = 8;
01033                         ptr = NULL;
01034                         <span class="keywordflow">break</span>;
01035                 <span class="keywordflow">case</span> DWC_OTG_CONTROL_DATA:
01036                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  Control data transaction\n"</span>);
01037                         hc-&gt;<a class="code" href="structdwc__hc.html#o7">data_pid_start</a> = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o0">data_toggle</a>;
01038                         <span class="keywordflow">break</span>;
01039                 <span class="keywordflow">case</span> DWC_OTG_CONTROL_STATUS:
01040                         <span class="comment">/*</span>
01041 <span class="comment">                         * Direction is opposite of data direction or IN if no</span>
01042 <span class="comment">                         * data.</span>
01043 <span class="comment">                         */</span>
01044                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  Control status transaction\n"</span>);
01045                         <span class="keywordflow">if</span> (urb-&gt;length == 0) {
01046                                 hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a> = 1;
01047                         } <span class="keywordflow">else</span> {
01048                                 hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a> =
01049                                     dwc_otg_hcd_is_pipe_out(&amp;urb-&gt;pipe_info);
01050                         }
01051                         <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a>) {
01052                                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_6">do_ping</a> = 0;
01053                         }
01054 
01055                         hc-&gt;<a class="code" href="structdwc__hc.html#o7">data_pid_start</a> = DWC_OTG_HC_PID_DATA1;
01056 
01057                         hc-&gt;<a class="code" href="structdwc__hc.html#z34_2">xfer_len</a> = 0;
01058                         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
01059                                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> = (uint8_t *) hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o19">status_buf_dma</a>;
01060                         } <span class="keywordflow">else</span> {
01061                                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> = (uint8_t *) hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o18">status_buf</a>;
01062                         }
01063                         ptr = NULL;
01064                         <span class="keywordflow">break</span>;
01065                 }
01066                 <span class="keywordflow">break</span>;
01067         <span class="keywordflow">case</span> UE_BULK:
01068                 hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a> = DWC_OTG_EP_TYPE_BULK;
01069                 <span class="keywordflow">break</span>;
01070         <span class="keywordflow">case</span> UE_INTERRUPT:
01071                 hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a> = DWC_OTG_EP_TYPE_INTR;
01072                 <span class="keywordflow">break</span>;
01073         <span class="keywordflow">case</span> UE_ISOCHRONOUS:
01074                 {
01075                         <span class="keyword">struct </span>dwc_otg_hcd_iso_packet_desc *frame_desc;
01076 
01077                         hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a> = DWC_OTG_EP_TYPE_ISOC;
01078 
01079                         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>)
01080                                 <span class="keywordflow">break</span>;
01081 
01082                         frame_desc = &amp;urb-&gt;iso_descs[qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o5">isoc_frame_index</a>];
01083 
01084                         frame_desc-&gt;status = 0;
01085 
01086                         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
01087                                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> = (uint8_t *) urb-&gt;dma;
01088                         } <span class="keywordflow">else</span> {
01089                                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> = (uint8_t *) urb-&gt;buf;
01090                         }
01091                         hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> +=
01092                             frame_desc-&gt;offset + qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o7">isoc_split_offset</a>;
01093                         hc-&gt;<a class="code" href="structdwc__hc.html#z34_2">xfer_len</a> =
01094                             frame_desc-&gt;length - qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o7">isoc_split_offset</a>;
01095 
01096                         <span class="comment">/* For non-dword aligned buffers */</span>
01097                         <span class="keywordflow">if</span> (((<span class="keywordtype">unsigned</span> long)hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a> &amp; 0x3)
01098                             &amp;&amp; hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
01099                                 ptr =
01100                                     (uint8_t *) urb-&gt;buf + frame_desc-&gt;offset +
01101                                     qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o7">isoc_split_offset</a>;
01102                         } <span class="keywordflow">else</span>
01103                                 ptr = NULL;
01104 
01105                         <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#z34_15">xact_pos</a> == DWC_HCSPLIT_XACTPOS_ALL) {
01106                                 <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#z34_2">xfer_len</a> &lt;= 188) {
01107                                         hc-&gt;<a class="code" href="structdwc__hc.html#z34_15">xact_pos</a> = DWC_HCSPLIT_XACTPOS_ALL;
01108                                 } <span class="keywordflow">else</span> {
01109                                         hc-&gt;<a class="code" href="structdwc__hc.html#z34_15">xact_pos</a> =
01110                                             DWC_HCSPLIT_XACTPOS_BEGIN;
01111                                 }
01112                         }
01113                 }
01114                 <span class="keywordflow">break</span>;
01115         }
01116         <span class="comment">/* non DWORD-aligned buffer case */</span>     
01117         <span class="keywordflow">if</span> (ptr) {
01118                 uint32_t buf_size;
01119                 <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a> != DWC_OTG_EP_TYPE_ISOC) {
01120                         buf_size = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o16">max_transfer_size</a>;
01121                 } <span class="keywordflow">else</span> {                                
01122                         buf_size = 4096;
01123                 }
01124                 <span class="keywordflow">if</span> (!qh-&gt;<a class="code" href="structdwc__otg__qh.html#o9">dw_align_buf</a>) {
01125                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#o9">dw_align_buf</a> = DWC_DMA_ALLOC_ATOMIC(buf_size,
01126                                                          &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o10">dw_align_buf_dma</a>);
01127                         <span class="keywordflow">if</span> (!qh-&gt;<a class="code" href="structdwc__otg__qh.html#o9">dw_align_buf</a>) {
01128                                 DWC_ERROR
01129                                     (<span class="stringliteral">"%s: Failed to allocate memory to handle "</span>
01130                                      <span class="stringliteral">"non-dword aligned buffer case\n"</span>,
01131                                      __func__);
01132                                 <span class="keywordflow">return</span>;
01133                         }
01134                 }
01135                 <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a>) {
01136                         dwc_memcpy(qh-&gt;<a class="code" href="structdwc__otg__qh.html#o9">dw_align_buf</a>, ptr, hc-&gt;<a class="code" href="structdwc__hc.html#z34_2">xfer_len</a>);
01137                 }
01138                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_1">align_buff</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#o10">dw_align_buf_dma</a>;
01139         } <span class="keywordflow">else</span> {
01140                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_1">align_buff</a> = 0;
01141         }
01142 
01143         <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a> == DWC_OTG_EP_TYPE_INTR ||
01144             hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a> == DWC_OTG_EP_TYPE_ISOC) {
01145                 <span class="comment">/*</span>
01146 <span class="comment">                 * This value may be modified when the transfer is started to</span>
01147 <span class="comment">                 * reflect the actual transfer length.</span>
01148 <span class="comment">                 */</span>
01149                 hc-&gt;<a class="code" href="structdwc__hc.html#o8">multi_count</a> = <a class="code" href="dwc__otg__hcd_8h.html#a4">dwc_hb_mult</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#o2">maxp</a>);
01150         }
01151 
01152         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>)
01153                 hc-&gt;<a class="code" href="structdwc__hc.html#z36_1">desc_list_addr</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#z40_1">desc_list_dma</a>;
01154 
01155         <a class="code" href="dwc__otg__cil_8h.html#a91">dwc_otg_hc_init</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>, hc);
01156         hc-&gt;<a class="code" href="structdwc__hc.html#z34_18">qh</a> = qh;
01157 }
01158 
<a name="l01168"></a><a class="code" href="dwc__otg__hcd_8h.html#a31">01168</a> <a class="code" href="dwc__otg__hcd_8h.html#a8">dwc_otg_transaction_type_e</a> <a class="code" href="dwc__otg__hcd_8h.html#a31">dwc_otg_hcd_select_transactions</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
01169 {
01170         dwc_list_link_t *qh_ptr;
01171         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
01172         <span class="keywordtype">int</span> num_channels;
01173         <a class="code" href="dwc__otg__hcd_8h.html#a8">dwc_otg_transaction_type_e</a> ret_val = DWC_OTG_TRANSACTION_NONE;
01174 
01175 <span class="preprocessor">#ifdef DEBUG_SOF</span>
01176 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"  Select Transactions\n"</span>);
01177 <span class="preprocessor">#endif</span>
01178 <span class="preprocessor"></span>
01179         <span class="comment">/* Process entries in the periodic ready list. */</span>
01180         qh_ptr = DWC_LIST_FIRST(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o8">periodic_sched_ready</a>);
01181 
01182         <span class="keywordflow">while</span> (qh_ptr != &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o8">periodic_sched_ready</a> &amp;&amp;
01183                !DWC_CIRCLEQ_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>)) {
01184 
01185                 qh = DWC_LIST_ENTRY(qh_ptr, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
01186                 <a class="code" href="dwc__otg__hcd_8c.html#a26">assign_and_init_hc</a>(hcd, qh);
01187 
01188                 <span class="comment">/*</span>
01189 <span class="comment">                 * Move the QH from the periodic ready schedule to the</span>
01190 <span class="comment">                 * periodic assigned schedule.</span>
01191 <span class="comment">                 */</span>
01192                 qh_ptr = DWC_LIST_NEXT(qh_ptr);
01193                 DWC_LIST_MOVE_HEAD(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o9">periodic_sched_assigned</a>,
01194                                    &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
01195 
01196                 ret_val = DWC_OTG_TRANSACTION_PERIODIC;
01197         }
01198 
01199         <span class="comment">/*</span>
01200 <span class="comment">         * Process entries in the inactive portion of the non-periodic</span>
01201 <span class="comment">         * schedule. Some free host channels may not be used if they are</span>
01202 <span class="comment">         * reserved for periodic transfers.</span>
01203 <span class="comment">         */</span>
01204         qh_ptr = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o4">non_periodic_sched_inactive</a>.next;
01205         num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o18">host_channels</a>;
01206         <span class="keywordflow">while</span> (qh_ptr != &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o4">non_periodic_sched_inactive</a> &amp;&amp;
01207                (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o16">non_periodic_channels</a> &lt;
01208                 num_channels - hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o15">periodic_channels</a>) &amp;&amp;
01209                !DWC_CIRCLEQ_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>)) {
01210 
01211                 qh = DWC_LIST_ENTRY(qh_ptr, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
01212 
01213                 <a class="code" href="dwc__otg__hcd_8c.html#a26">assign_and_init_hc</a>(hcd, qh);
01214 
01215                 <span class="comment">/*</span>
01216 <span class="comment">                 * Move the QH from the non-periodic inactive schedule to the</span>
01217 <span class="comment">                 * non-periodic active schedule.</span>
01218 <span class="comment">                 */</span>
01219                 qh_ptr = DWC_LIST_NEXT(qh_ptr);
01220                 DWC_LIST_MOVE_HEAD(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o5">non_periodic_sched_active</a>,
01221                                    &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
01222 
01223                 <span class="keywordflow">if</span> (ret_val == DWC_OTG_TRANSACTION_NONE) {
01224                         ret_val = DWC_OTG_TRANSACTION_NON_PERIODIC;
01225                 } <span class="keywordflow">else</span> {
01226                         ret_val = DWC_OTG_TRANSACTION_ALL;
01227                 }
01228 
01229                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o16">non_periodic_channels</a>++;
01230         }
01231 
01232         <span class="keywordflow">return</span> ret_val;
01233 }
01234 
<a name="l01253"></a><a class="code" href="dwc__otg__hcd_8c.html#a28">01253</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#a28">queue_transaction</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
01254                              <a class="code" href="structdwc__hc.html">dwc_hc_t</a> * hc, uint16_t fifo_dwords_avail)
01255 {
01256         <span class="keywordtype">int</span> retval;
01257 
01258         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
01259                 <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
01260                         <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a>
01261                             || (hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a> == DWC_OTG_EP_TYPE_ISOC)) {
01262                                 <a class="code" href="dwc__otg__hcd__ddma_8c.html#a25">dwc_otg_hcd_start_xfer_ddma</a>(hcd, hc-&gt;<a class="code" href="structdwc__hc.html#z34_18">qh</a>);
01263                                 hc-&gt;<a class="code" href="structdwc__hc.html#z34_18">qh</a>-&gt;<a class="code" href="structdwc__otg__qh.html#o5">ping_state</a> = 0;
01264                         }
01265                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a>) {
01266                         <a class="code" href="dwc__otg__cil_8h.html#a94">dwc_otg_hc_start_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>, hc);
01267                         hc-&gt;<a class="code" href="structdwc__hc.html#z34_18">qh</a>-&gt;<a class="code" href="structdwc__otg__qh.html#o5">ping_state</a> = 0;
01268                 }
01269                 retval = 0;
01270         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#z34_9">halt_pending</a>) {
01271                 <span class="comment">/* Don't queue a request if the channel has been halted. */</span>
01272                 retval = 0;
01273         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#z34_8">halt_on_queue</a>) {
01274                 <a class="code" href="dwc__otg__cil_8h.html#a92">dwc_otg_hc_halt</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>, hc, hc-&gt;<a class="code" href="structdwc__hc.html#z34_10">halt_status</a>);
01275                 retval = 0;
01276         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#z34_6">do_ping</a>) {
01277                 <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a>) {
01278                         <a class="code" href="dwc__otg__cil_8h.html#a94">dwc_otg_hc_start_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>, hc);
01279                 }
01280                 retval = 0;
01281         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a> || hc-&gt;<a class="code" href="structdwc__hc.html#o7">data_pid_start</a> == DWC_OTG_HC_PID_SETUP) {
01282                 <span class="keywordflow">if</span> ((fifo_dwords_avail * 4) &gt;= hc-&gt;<a class="code" href="structdwc__hc.html#o6">max_packet</a>) {
01283                         <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a>) {
01284                                 <a class="code" href="dwc__otg__cil_8h.html#a94">dwc_otg_hc_start_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>, hc);
01285                                 retval = 1;
01286                         } <span class="keywordflow">else</span> {
01287                                 retval =
01288                                     <a class="code" href="dwc__otg__cil_8h.html#a95">dwc_otg_hc_continue_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>,
01289                                                                  hc);
01290                         }
01291                 } <span class="keywordflow">else</span> {
01292                         retval = -1;
01293                 }
01294         } <span class="keywordflow">else</span> {
01295                 <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a>) {
01296                         <a class="code" href="dwc__otg__cil_8h.html#a94">dwc_otg_hc_start_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>, hc);
01297                         retval = 1;
01298                 } <span class="keywordflow">else</span> {
01299                         retval = <a class="code" href="dwc__otg__cil_8h.html#a95">dwc_otg_hc_continue_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>, hc);
01300                 }
01301         }
01302 
01303         <span class="keywordflow">return</span> retval;
01304 }
01305 
<a name="l01313"></a><a class="code" href="dwc__otg__hcd_8c.html#a29">01313</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a29">process_periodic_channels</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
01314 {
01315         hptxsts_data_t tx_status;
01316         dwc_list_link_t *qh_ptr;
01317         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
01318         <span class="keywordtype">int</span> status;
01319         <span class="keywordtype">int</span> no_queue_space = 0;
01320         <span class="keywordtype">int</span> no_fifo_space = 0;
01321 
01322         <a class="code" href="structdwc__otg__host__global__regs.html">dwc_otg_host_global_regs_t</a> *host_regs;
01323         host_regs = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o0">host_global_regs</a>;
01324 
01325         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"Queue periodic transactions\n"</span>);
01326 <span class="preprocessor">#ifdef DEBUG</span>
01327 <span class="preprocessor"></span>        tx_status.d32 = DWC_READ_REG32(&amp;host_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o4">hptxsts</a>);
01328         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>,
01329                     <span class="stringliteral">"  P Tx Req Queue Space Avail (before queue): %d\n"</span>,
01330                     tx_status.b.ptxqspcavail);
01331         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  P Tx FIFO Space Avail (before queue): %d\n"</span>,
01332                     tx_status.b.ptxfspcavail);
01333 <span class="preprocessor">#endif</span>
01334 <span class="preprocessor"></span>
01335         qh_ptr = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o9">periodic_sched_assigned</a>.next;
01336         <span class="keywordflow">while</span> (qh_ptr != &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o9">periodic_sched_assigned</a>) {
01337                 tx_status.d32 = DWC_READ_REG32(&amp;host_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o4">hptxsts</a>);
01338                 <span class="keywordflow">if</span> (tx_status.b.ptxqspcavail == 0) {
01339                         no_queue_space = 1;
01340                         <span class="keywordflow">break</span>;
01341                 }
01342 
01343                 qh = DWC_LIST_ENTRY(qh_ptr, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
01344 
01345                 <span class="comment">/*</span>
01346 <span class="comment">                 * Set a flag if we're queuing high-bandwidth in slave mode.</span>
01347 <span class="comment">                 * The flag prevents any halts to get into the request queue in</span>
01348 <span class="comment">                 * the middle of multiple high-bandwidth packets getting queued.</span>
01349 <span class="comment">                 */</span>
01350                 <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a> &amp;&amp; qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a>-&gt;<a class="code" href="structdwc__hc.html#o8">multi_count</a> &gt; 1) {
01351                         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o19">queuing_high_bandwidth</a> = 1;
01352                 }
01353                 status =
01354                     <a class="code" href="dwc__otg__hcd_8c.html#a28">queue_transaction</a>(hcd, qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a>,
01355                                       tx_status.b.ptxfspcavail);
01356                 <span class="keywordflow">if</span> (status &lt; 0) {
01357                         no_fifo_space = 1;
01358                         <span class="keywordflow">break</span>;
01359                 }
01360 
01361                 <span class="comment">/*</span>
01362 <span class="comment">                 * In Slave mode, stay on the current transfer until there is</span>
01363 <span class="comment">                 * nothing more to do or the high-bandwidth request count is</span>
01364 <span class="comment">                 * reached. In DMA mode, only need to queue one request. The</span>
01365 <span class="comment">                 * controller automatically handles multiple packets for</span>
01366 <span class="comment">                 * high-bandwidth transfers.</span>
01367 <span class="comment">                 */</span>
01368                 <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a> || status == 0 ||
01369                     qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a>-&gt;<a class="code" href="structdwc__hc.html#z34_17">requests</a> == qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a>-&gt;<a class="code" href="structdwc__hc.html#o8">multi_count</a>) {
01370                         qh_ptr = qh_ptr-&gt;next;
01371                         <span class="comment">/*</span>
01372 <span class="comment">                         * Move the QH from the periodic assigned schedule to</span>
01373 <span class="comment">                         * the periodic queued schedule.</span>
01374 <span class="comment">                         */</span>
01375                         DWC_LIST_MOVE_HEAD(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o10">periodic_sched_queued</a>,
01376                                            &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>);
01377 
01378                         <span class="comment">/* done queuing high bandwidth */</span>
01379                         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o19">queuing_high_bandwidth</a> = 0;
01380                 }
01381         }
01382 
01383         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
01384                 <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs;
01385                 <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.d32 = 0 };
01386 
01387                 global_regs = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>;
01388                 intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o27">ptxfempty</a> = 1;
01389 <span class="preprocessor">#ifdef DEBUG</span>
01390 <span class="preprocessor"></span>                tx_status.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = DWC_READ_REG32(&amp;host_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o4">hptxsts</a>);
01391                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>,
01392                             <span class="stringliteral">"  P Tx Req Queue Space Avail (after queue): %d\n"</span>,
01393                             tx_status.b.ptxqspcavail);
01394                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>,
01395                             <span class="stringliteral">"  P Tx FIFO Space Avail (after queue): %d\n"</span>,
01396                             tx_status.b.ptxfspcavail);
01397 <span class="preprocessor">#endif</span>
01398 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!DWC_LIST_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o9">periodic_sched_assigned</a>) ||
01399                     no_queue_space || no_fifo_space) {
01400                         <span class="comment">/*</span>
01401 <span class="comment">                         * May need to queue more transactions as the request</span>
01402 <span class="comment">                         * queue or Tx FIFO empties. Enable the periodic Tx</span>
01403 <span class="comment">                         * FIFO empty interrupt. (Always use the half-empty</span>
01404 <span class="comment">                         * level to ensure that new requests are loaded as</span>
01405 <span class="comment">                         * soon as possible.)</span>
01406 <span class="comment">                         */</span>
01407                         DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0,
01408                                          intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
01409                 } <span class="keywordflow">else</span> {
01410                         <span class="comment">/*</span>
01411 <span class="comment">                         * Disable the Tx FIFO empty interrupt since there are</span>
01412 <span class="comment">                         * no more transactions that need to be queued right</span>
01413 <span class="comment">                         * now. This function is called from interrupt</span>
01414 <span class="comment">                         * handlers to queue more transactions as transfer</span>
01415 <span class="comment">                         * states change.</span>
01416 <span class="comment">                         */</span>
01417                         DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>,
01418                                          0);
01419                 }
01420         }
01421 }
01422 
<a name="l01430"></a><a class="code" href="dwc__otg__hcd_8c.html#a30">01430</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a30">process_non_periodic_channels</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
01431 {
01432         <a class="code" href="uniongnptxsts__data.html">gnptxsts_data_t</a> tx_status;
01433         dwc_list_link_t *orig_qh_ptr;
01434         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
01435         <span class="keywordtype">int</span> status;
01436         <span class="keywordtype">int</span> no_queue_space = 0;
01437         <span class="keywordtype">int</span> no_fifo_space = 0;
01438         <span class="keywordtype">int</span> more_to_do = 0;
01439 
01440         <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs =
01441             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>;
01442 
01443         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"Queue non-periodic transactions\n"</span>);
01444 <span class="preprocessor">#ifdef DEBUG</span>
01445 <span class="preprocessor"></span>        tx_status.<a class="code" href="uniongnptxsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o11">gnptxsts</a>);
01446         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>,
01447                     <span class="stringliteral">"  NP Tx Req Queue Space Avail (before queue): %d\n"</span>,
01448                     tx_status.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o2">nptxqspcavail</a>);
01449         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  NP Tx FIFO Space Avail (before queue): %d\n"</span>,
01450                     tx_status.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o1">nptxfspcavail</a>);
01451 <span class="preprocessor">#endif</span>
01452 <span class="preprocessor"></span>        <span class="comment">/*</span>
01453 <span class="comment">         * Keep track of the starting point. Skip over the start-of-list</span>
01454 <span class="comment">         * entry.</span>
01455 <span class="comment">         */</span>
01456         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a> == &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o5">non_periodic_sched_active</a>) {
01457                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a> = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a>-&gt;next;
01458         }
01459         orig_qh_ptr = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a>;
01460 
01461         <span class="comment">/*</span>
01462 <span class="comment">         * Process once through the active list or until no more space is</span>
01463 <span class="comment">         * available in the request queue or the Tx FIFO.</span>
01464 <span class="comment">         */</span>
01465         <span class="keywordflow">do</span> {
01466                 tx_status.<a class="code" href="uniongnptxsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o11">gnptxsts</a>);
01467                 <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a> &amp;&amp; tx_status.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o2">nptxqspcavail</a> == 0) {
01468                         no_queue_space = 1;
01469                         <span class="keywordflow">break</span>;
01470                 }
01471 
01472                 qh = DWC_LIST_ENTRY(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a>, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>,
01473                                     qh_list_entry);
01474                 status =
01475                     <a class="code" href="dwc__otg__hcd_8c.html#a28">queue_transaction</a>(hcd, qh-&gt;<a class="code" href="structdwc__otg__qh.html#o7">channel</a>,
01476                                       tx_status.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o1">nptxfspcavail</a>);
01477 
01478                 <span class="keywordflow">if</span> (status &gt; 0) {
01479                         more_to_do = 1;
01480                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status &lt; 0) {
01481                         no_fifo_space = 1;
01482                         <span class="keywordflow">break</span>;
01483                 }
01484 
01485                 <span class="comment">/* Advance to next QH, skipping start-of-list entry. */</span>
01486                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a> = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a>-&gt;next;
01487                 <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a> == &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o5">non_periodic_sched_active</a>) {
01488                         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a> =
01489                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a>-&gt;next;
01490                 }
01491 
01492         } <span class="keywordflow">while</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o6">non_periodic_qh_ptr</a> != orig_qh_ptr);
01493 
01494         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
01495                 <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.d32 = 0 };
01496                 intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o6">nptxfempty</a> = 1;
01497 
01498 <span class="preprocessor">#ifdef DEBUG</span>
01499 <span class="preprocessor"></span>                tx_status.<a class="code" href="uniongnptxsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o11">gnptxsts</a>);
01500                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>,
01501                             <span class="stringliteral">"  NP Tx Req Queue Space Avail (after queue): %d\n"</span>,
01502                             tx_status.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o2">nptxqspcavail</a>);
01503                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>,
01504                             <span class="stringliteral">"  NP Tx FIFO Space Avail (after queue): %d\n"</span>,
01505                             tx_status.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o1">nptxfspcavail</a>);
01506 <span class="preprocessor">#endif</span>
01507 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (more_to_do || no_queue_space || no_fifo_space) {
01508                         <span class="comment">/*</span>
01509 <span class="comment">                         * May need to queue more transactions as the request</span>
01510 <span class="comment">                         * queue or Tx FIFO empties. Enable the non-periodic</span>
01511 <span class="comment">                         * Tx FIFO empty interrupt. (Always use the half-empty</span>
01512 <span class="comment">                         * level to ensure that new requests are loaded as</span>
01513 <span class="comment">                         * soon as possible.)</span>
01514 <span class="comment">                         */</span>
01515                         DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0,
01516                                          intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
01517                 } <span class="keywordflow">else</span> {
01518                         <span class="comment">/*</span>
01519 <span class="comment">                         * Disable the Tx FIFO empty interrupt since there are</span>
01520 <span class="comment">                         * no more transactions that need to be queued right</span>
01521 <span class="comment">                         * now. This function is called from interrupt</span>
01522 <span class="comment">                         * handlers to queue more transactions as transfer</span>
01523 <span class="comment">                         * states change.</span>
01524 <span class="comment">                         */</span>
01525                         DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>,
01526                                          0);
01527                 }
01528         }
01529 }
01530 
<a name="l01540"></a><a class="code" href="dwc__otg__hcd_8h.html#a32">01540</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8h.html#a32">dwc_otg_hcd_queue_transactions</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
01541                                     dwc_otg_transaction_type_e tr_type)
01542 {
01543 <span class="preprocessor">#ifdef DEBUG_SOF</span>
01544 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"Queue Transactions\n"</span>);
01545 <span class="preprocessor">#endif</span>
01546 <span class="preprocessor"></span>        <span class="comment">/* Process host channels associated with periodic transfers. */</span>
01547         <span class="keywordflow">if</span> ((tr_type == DWC_OTG_TRANSACTION_PERIODIC ||
01548              tr_type == DWC_OTG_TRANSACTION_ALL) &amp;&amp;
01549             !DWC_LIST_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o9">periodic_sched_assigned</a>)) {
01550 
01551                 <a class="code" href="dwc__otg__hcd_8c.html#a29">process_periodic_channels</a>(hcd);
01552         }
01553 
01554         <span class="comment">/* Process host channels associated with non-periodic transfers. */</span>
01555         <span class="keywordflow">if</span> (tr_type == DWC_OTG_TRANSACTION_NON_PERIODIC ||
01556             tr_type == DWC_OTG_TRANSACTION_ALL) {
01557                 <span class="keywordflow">if</span> (!DWC_LIST_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o5">non_periodic_sched_active</a>)) {
01558                         <a class="code" href="dwc__otg__hcd_8c.html#a30">process_non_periodic_channels</a>(hcd);
01559                 } <span class="keywordflow">else</span> {
01560                         <span class="comment">/*</span>
01561 <span class="comment">                         * Ensure NP Tx FIFO empty interrupt is disabled when</span>
01562 <span class="comment">                         * there are no non-periodic transfers to process.</span>
01563 <span class="comment">                         */</span>
01564                         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk = {.<a class="code" href="uniongnptxsts__data.html#o0">d32</a> = 0 };
01565                         gintmsk.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o6">nptxfempty</a> = 1;
01566                         DWC_MODIFY_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;
01567                                          core_global_regs-&gt;gintmsk, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>,
01568                                          0);
01569                 }
01570         }
01571 }
01572 
01573 <span class="preprocessor">#ifdef DWC_HS_ELECT_TST</span>
01574 <span class="preprocessor"></span><span class="comment">/*</span>
01575 <span class="comment"> * Quick and dirty hack to implement the HS Electrical Test</span>
01576 <span class="comment"> * SINGLE_STEP_GET_DEVICE_DESCRIPTOR feature.</span>
01577 <span class="comment"> *</span>
01578 <span class="comment"> * This code was copied from our userspace app "hset". It sends a</span>
01579 <span class="comment"> * Get Device Descriptor control sequence in two parts, first the</span>
01580 <span class="comment"> * Setup packet by itself, followed some time later by the In and</span>
01581 <span class="comment"> * Ack packets. Rather than trying to figure out how to add this</span>
01582 <span class="comment"> * functionality to the normal driver code, we just hijack the</span>
01583 <span class="comment"> * hardware, using these two function to drive the hardware</span>
01584 <span class="comment"> * directly.</span>
01585 <span class="comment"> */</span>
01586 
01587 <span class="keyword">static</span> <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs;
01588 <span class="keyword">static</span> <a class="code" href="structdwc__otg__host__global__regs.html">dwc_otg_host_global_regs_t</a> *hc_global_regs;
01589 <span class="keyword">static</span> <a class="code" href="structdwc__otg__hc__regs.html">dwc_otg_hc_regs_t</a> *hc_regs;
01590 <span class="keyword">static</span> uint32_t *data_fifo;
01591 
01592 <span class="keyword">static</span> <span class="keywordtype">void</span> do_setup(<span class="keywordtype">void</span>)
01593 {
01594         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01595         <a class="code" href="unionhctsiz__data.html">hctsiz_data_t</a> hctsiz;
01596         <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
01597         <a class="code" href="unionhaint__data.html">haint_data_t</a> haint;
01598         <a class="code" href="unionhcint__data.html">hcint_data_t</a> hcint;
01599 
01600         <span class="comment">/* Enable HAINTs */</span>
01601         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o6">haintmsk</a>, 0x0001);
01602 
01603         <span class="comment">/* Enable HCINTs */</span>
01604         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o3">hcintmsk</a>, 0x04a3);
01605 
01606         <span class="comment">/* Read GINTSTS */</span>
01607         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01608 
01609         <span class="comment">/* Read HAINT */</span>
01610         haint.<a class="code" href="unionhaint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>);
01611 
01612         <span class="comment">/* Read HCINT */</span>
01613         hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
01614 
01615         <span class="comment">/* Read HCCHAR */</span>
01616         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01617 
01618         <span class="comment">/* Clear HCINT */</span>
01619         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
01620 
01621         <span class="comment">/* Clear HAINT */</span>
01622         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, haint.<a class="code" href="unionhaint__data.html#o0">d32</a>);
01623 
01624         <span class="comment">/* Clear GINTSTS */</span>
01625         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01626 
01627         <span class="comment">/* Read GINTSTS */</span>
01628         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01629 
01630         <span class="comment">/*</span>
01631 <span class="comment">         * Send Setup packet (Get Device Descriptor)</span>
01632 <span class="comment">         */</span>
01633 
01634         <span class="comment">/* Make sure channel is disabled */</span>
01635         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01636         <span class="keywordflow">if</span> (hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a>) {
01637                 hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o10">chdis</a> = 1;
01638 <span class="comment">//              hcchar.b.chen = 1;</span>
01639                 DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
01640                 <span class="comment">//sleep(1);</span>
01641                 dwc_mdelay(1000);
01642 
01643                 <span class="comment">/* Read GINTSTS */</span>
01644                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01645 
01646                 <span class="comment">/* Read HAINT */</span>
01647                 haint.<a class="code" href="unionhaint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>);
01648 
01649                 <span class="comment">/* Read HCINT */</span>
01650                 hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
01651 
01652                 <span class="comment">/* Read HCCHAR */</span>
01653                 hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01654 
01655                 <span class="comment">/* Clear HCINT */</span>
01656                 DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
01657 
01658                 <span class="comment">/* Clear HAINT */</span>
01659                 DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, haint.<a class="code" href="unionhaint__data.html#o0">d32</a>);
01660 
01661                 <span class="comment">/* Clear GINTSTS */</span>
01662                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01663 
01664                 hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01665         }
01666 
01667         <span class="comment">/* Set HCTSIZ */</span>
01668         hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a> = 0;
01669         hctsiz.<a class="code" href="unionhctsiz__data.html#o5">b</a>.<a class="code" href="unionhctsiz__data.html#o1">xfersize</a> = 8;
01670         hctsiz.<a class="code" href="unionhctsiz__data.html#o5">b</a>.<a class="code" href="unionhctsiz__data.html#o2">pktcnt</a> = 1;
01671         hctsiz.<a class="code" href="unionhctsiz__data.html#o5">b</a>.<a class="code" href="unionhctsiz__data.html#o3">pid</a> = DWC_OTG_HC_PID_SETUP;
01672         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o4">hctsiz</a>, hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a>);
01673 
01674         <span class="comment">/* Set HCCHAR */</span>
01675         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01676         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o6">eptype</a> = DWC_OTG_EP_TYPE_CONTROL;
01677         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o3">epdir</a> = 0;
01678         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o2">epnum</a> = 0;
01679         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o1">mps</a> = 8;
01680         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a> = 1;
01681         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
01682 
01683         <span class="comment">/* Fill FIFO with Setup data for Get Device Descriptor */</span>
01684         data_fifo = (uint32_t *) ((<span class="keywordtype">char</span> *)global_regs + 0x1000);
01685         DWC_WRITE_REG32(data_fifo++, 0x01000680);
01686         DWC_WRITE_REG32(data_fifo++, 0x00080000);
01687 
01688         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01689 
01690         <span class="comment">/* Wait for host channel interrupt */</span>
01691         <span class="keywordflow">do</span> {
01692                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01693         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o26">hcintr</a> == 0);
01694 
01695         <span class="comment">/* Disable HCINTs */</span>
01696         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o3">hcintmsk</a>, 0x0000);
01697 
01698         <span class="comment">/* Disable HAINTs */</span>
01699         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o6">haintmsk</a>, 0x0000);
01700 
01701         <span class="comment">/* Read HAINT */</span>
01702         haint.<a class="code" href="unionhaint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>);
01703 
01704         <span class="comment">/* Read HCINT */</span>
01705         hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
01706 
01707         <span class="comment">/* Read HCCHAR */</span>
01708         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01709 
01710         <span class="comment">/* Clear HCINT */</span>
01711         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
01712 
01713         <span class="comment">/* Clear HAINT */</span>
01714         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, haint.<a class="code" href="unionhaint__data.html#o0">d32</a>);
01715 
01716         <span class="comment">/* Clear GINTSTS */</span>
01717         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01718 
01719         <span class="comment">/* Read GINTSTS */</span>
01720         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01721 }
01722 
01723 <span class="keyword">static</span> <span class="keywordtype">void</span> do_in_ack(<span class="keywordtype">void</span>)
01724 {
01725         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01726         <a class="code" href="unionhctsiz__data.html">hctsiz_data_t</a> hctsiz;
01727         <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
01728         <a class="code" href="unionhaint__data.html">haint_data_t</a> haint;
01729         <a class="code" href="unionhcint__data.html">hcint_data_t</a> hcint;
01730         <a class="code" href="unionhost__grxsts__data.html">host_grxsts_data_t</a> grxsts;
01731 
01732         <span class="comment">/* Enable HAINTs */</span>
01733         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o6">haintmsk</a>, 0x0001);
01734 
01735         <span class="comment">/* Enable HCINTs */</span>
01736         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o3">hcintmsk</a>, 0x04a3);
01737 
01738         <span class="comment">/* Read GINTSTS */</span>
01739         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01740 
01741         <span class="comment">/* Read HAINT */</span>
01742         haint.<a class="code" href="unionhaint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>);
01743 
01744         <span class="comment">/* Read HCINT */</span>
01745         hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
01746 
01747         <span class="comment">/* Read HCCHAR */</span>
01748         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01749 
01750         <span class="comment">/* Clear HCINT */</span>
01751         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
01752 
01753         <span class="comment">/* Clear HAINT */</span>
01754         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, haint.<a class="code" href="unionhaint__data.html#o0">d32</a>);
01755 
01756         <span class="comment">/* Clear GINTSTS */</span>
01757         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01758 
01759         <span class="comment">/* Read GINTSTS */</span>
01760         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01761 
01762         <span class="comment">/*</span>
01763 <span class="comment">         * Receive Control In packet</span>
01764 <span class="comment">         */</span>
01765 
01766         <span class="comment">/* Make sure channel is disabled */</span>
01767         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01768         <span class="keywordflow">if</span> (hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a>) {
01769                 hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o10">chdis</a> = 1;
01770                 hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a> = 1;
01771                 DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
01772                 <span class="comment">//sleep(1);</span>
01773                 dwc_mdelay(1000);
01774 
01775                 <span class="comment">/* Read GINTSTS */</span>
01776                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01777 
01778                 <span class="comment">/* Read HAINT */</span>
01779                 haint.<a class="code" href="unionhaint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>);
01780 
01781                 <span class="comment">/* Read HCINT */</span>
01782                 hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
01783 
01784                 <span class="comment">/* Read HCCHAR */</span>
01785                 hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01786 
01787                 <span class="comment">/* Clear HCINT */</span>
01788                 DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
01789 
01790                 <span class="comment">/* Clear HAINT */</span>
01791                 DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, haint.<a class="code" href="unionhaint__data.html#o0">d32</a>);
01792 
01793                 <span class="comment">/* Clear GINTSTS */</span>
01794                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01795 
01796                 hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01797         }
01798 
01799         <span class="comment">/* Set HCTSIZ */</span>
01800         hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a> = 0;
01801         hctsiz.<a class="code" href="unionhctsiz__data.html#o5">b</a>.<a class="code" href="unionhctsiz__data.html#o1">xfersize</a> = 8;
01802         hctsiz.<a class="code" href="unionhctsiz__data.html#o5">b</a>.<a class="code" href="unionhctsiz__data.html#o2">pktcnt</a> = 1;
01803         hctsiz.<a class="code" href="unionhctsiz__data.html#o5">b</a>.<a class="code" href="unionhctsiz__data.html#o3">pid</a> = DWC_OTG_HC_PID_DATA1;
01804         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o4">hctsiz</a>, hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a>);
01805 
01806         <span class="comment">/* Set HCCHAR */</span>
01807         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01808         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o6">eptype</a> = DWC_OTG_EP_TYPE_CONTROL;
01809         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o3">epdir</a> = 1;
01810         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o2">epnum</a> = 0;
01811         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o1">mps</a> = 8;
01812         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a> = 1;
01813         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
01814 
01815         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01816 
01817         <span class="comment">/* Wait for receive status queue interrupt */</span>
01818         <span class="keywordflow">do</span> {
01819                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01820         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o5">rxstsqlvl</a> == 0);
01821 
01822         <span class="comment">/* Read RXSTS */</span>
01823         grxsts.<a class="code" href="unionhost__grxsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o8">grxstsp</a>);
01824 
01825         <span class="comment">/* Clear RXSTSQLVL in GINTSTS */</span>
01826         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01827         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o5">rxstsqlvl</a> = 1;
01828         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01829 
01830         <span class="keywordflow">switch</span> (grxsts.<a class="code" href="unionhost__grxsts__data.html#o6">b</a>.<a class="code" href="unionhost__grxsts__data.html#o4">pktsts</a>) {
01831         <span class="keywordflow">case</span> DWC_GRXSTS_PKTSTS_IN:
01832                 <span class="comment">/* Read the data into the host buffer */</span>
01833                 <span class="keywordflow">if</span> (grxsts.<a class="code" href="unionhost__grxsts__data.html#o6">b</a>.<a class="code" href="unionhost__grxsts__data.html#o2">bcnt</a> &gt; 0) {
01834                         <span class="keywordtype">int</span> i;
01835                         <span class="keywordtype">int</span> word_count = (grxsts.<a class="code" href="unionhost__grxsts__data.html#o6">b</a>.<a class="code" href="unionhost__grxsts__data.html#o2">bcnt</a> + 3) / 4;
01836 
01837                         data_fifo = (uint32_t *) ((<span class="keywordtype">char</span> *)global_regs + 0x1000);
01838 
01839                         <span class="keywordflow">for</span> (i = 0; i &lt; word_count; i++) {
01840                                 (void)DWC_READ_REG32(data_fifo++);
01841                         }
01842                 }
01843                 <span class="keywordflow">break</span>;
01844 
01845         <span class="keywordflow">default</span>:
01846                 <span class="keywordflow">break</span>;
01847         }
01848 
01849         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01850 
01851         <span class="comment">/* Wait for receive status queue interrupt */</span>
01852         <span class="keywordflow">do</span> {
01853                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01854         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o5">rxstsqlvl</a> == 0);
01855 
01856         <span class="comment">/* Read RXSTS */</span>
01857         grxsts.<a class="code" href="unionhost__grxsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o8">grxstsp</a>);
01858 
01859         <span class="comment">/* Clear RXSTSQLVL in GINTSTS */</span>
01860         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01861         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o5">rxstsqlvl</a> = 1;
01862         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01863 
01864         <span class="keywordflow">switch</span> (grxsts.<a class="code" href="unionhost__grxsts__data.html#o6">b</a>.<a class="code" href="unionhost__grxsts__data.html#o4">pktsts</a>) {
01865         <span class="keywordflow">case</span> DWC_GRXSTS_PKTSTS_IN_XFER_COMP:
01866                 <span class="keywordflow">break</span>;
01867 
01868         <span class="keywordflow">default</span>:
01869                 <span class="keywordflow">break</span>;
01870         }
01871 
01872         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01873 
01874         <span class="comment">/* Wait for host channel interrupt */</span>
01875         <span class="keywordflow">do</span> {
01876                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01877         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o26">hcintr</a> == 0);
01878 
01879         <span class="comment">/* Read HAINT */</span>
01880         haint.<a class="code" href="unionhaint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>);
01881 
01882         <span class="comment">/* Read HCINT */</span>
01883         hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
01884 
01885         <span class="comment">/* Read HCCHAR */</span>
01886         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01887 
01888         <span class="comment">/* Clear HCINT */</span>
01889         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
01890 
01891         <span class="comment">/* Clear HAINT */</span>
01892         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, haint.<a class="code" href="unionhaint__data.html#o0">d32</a>);
01893 
01894         <span class="comment">/* Clear GINTSTS */</span>
01895         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01896 
01897         <span class="comment">/* Read GINTSTS */</span>
01898         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01899 
01900 <span class="comment">//      usleep(100000);</span>
01901 <span class="comment">//      mdelay(100);</span>
01902         dwc_mdelay(1);
01903 
01904         <span class="comment">/*</span>
01905 <span class="comment">         * Send handshake packet</span>
01906 <span class="comment">         */</span>
01907 
01908         <span class="comment">/* Read HAINT */</span>
01909         haint.<a class="code" href="unionhaint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>);
01910 
01911         <span class="comment">/* Read HCINT */</span>
01912         hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
01913 
01914         <span class="comment">/* Read HCCHAR */</span>
01915         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01916 
01917         <span class="comment">/* Clear HCINT */</span>
01918         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
01919 
01920         <span class="comment">/* Clear HAINT */</span>
01921         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, haint.<a class="code" href="unionhaint__data.html#o0">d32</a>);
01922 
01923         <span class="comment">/* Clear GINTSTS */</span>
01924         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01925 
01926         <span class="comment">/* Read GINTSTS */</span>
01927         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01928 
01929         <span class="comment">/* Make sure channel is disabled */</span>
01930         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01931         <span class="keywordflow">if</span> (hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a>) {
01932                 hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o10">chdis</a> = 1;
01933                 hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a> = 1;
01934                 DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
01935                 <span class="comment">//sleep(1);</span>
01936                 dwc_mdelay(1000);
01937 
01938                 <span class="comment">/* Read GINTSTS */</span>
01939                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01940 
01941                 <span class="comment">/* Read HAINT */</span>
01942                 haint.<a class="code" href="unionhaint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>);
01943 
01944                 <span class="comment">/* Read HCINT */</span>
01945                 hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
01946 
01947                 <span class="comment">/* Read HCCHAR */</span>
01948                 hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01949 
01950                 <span class="comment">/* Clear HCINT */</span>
01951                 DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
01952 
01953                 <span class="comment">/* Clear HAINT */</span>
01954                 DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, haint.<a class="code" href="unionhaint__data.html#o0">d32</a>);
01955 
01956                 <span class="comment">/* Clear GINTSTS */</span>
01957                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01958 
01959                 hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01960         }
01961 
01962         <span class="comment">/* Set HCTSIZ */</span>
01963         hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a> = 0;
01964         hctsiz.<a class="code" href="unionhctsiz__data.html#o5">b</a>.<a class="code" href="unionhctsiz__data.html#o1">xfersize</a> = 0;
01965         hctsiz.<a class="code" href="unionhctsiz__data.html#o5">b</a>.<a class="code" href="unionhctsiz__data.html#o2">pktcnt</a> = 1;
01966         hctsiz.<a class="code" href="unionhctsiz__data.html#o5">b</a>.<a class="code" href="unionhctsiz__data.html#o3">pid</a> = DWC_OTG_HC_PID_DATA1;
01967         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o4">hctsiz</a>, hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a>);
01968 
01969         <span class="comment">/* Set HCCHAR */</span>
01970         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01971         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o6">eptype</a> = DWC_OTG_EP_TYPE_CONTROL;
01972         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o3">epdir</a> = 0;
01973         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o2">epnum</a> = 0;
01974         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o1">mps</a> = 8;
01975         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o11">chen</a> = 1;
01976         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
01977 
01978         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01979 
01980         <span class="comment">/* Wait for host channel interrupt */</span>
01981         <span class="keywordflow">do</span> {
01982                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01983         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o26">hcintr</a> == 0);
01984 
01985         <span class="comment">/* Disable HCINTs */</span>
01986         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o3">hcintmsk</a>, 0x0000);
01987 
01988         <span class="comment">/* Disable HAINTs */</span>
01989         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o6">haintmsk</a>, 0x0000);
01990 
01991         <span class="comment">/* Read HAINT */</span>
01992         haint.<a class="code" href="unionhaint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>);
01993 
01994         <span class="comment">/* Read HCINT */</span>
01995         hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
01996 
01997         <span class="comment">/* Read HCCHAR */</span>
01998         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
01999 
02000         <span class="comment">/* Clear HCINT */</span>
02001         DWC_WRITE_REG32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
02002 
02003         <span class="comment">/* Clear HAINT */</span>
02004         DWC_WRITE_REG32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o5">haint</a>, haint.<a class="code" href="unionhaint__data.html#o0">d32</a>);
02005 
02006         <span class="comment">/* Clear GINTSTS */</span>
02007         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
02008 
02009         <span class="comment">/* Read GINTSTS */</span>
02010         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
02011 }
02012 <span class="preprocessor">#endif</span>
02013 <span class="preprocessor"></span>
<a name="l02015"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a18">02015</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a18">dwc_otg_hcd_hub_control</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>,
02016                             uint16_t typeReq,
02017                             uint16_t wValue,
02018                             uint16_t wIndex, uint8_t * buf, uint16_t wLength)
02019 {
02020         <span class="keywordtype">int</span> retval = 0;
02021 
02022         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>;
02023         usb_hub_descriptor_t *hub_desc;
02024         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0 = {.d32 = 0 };
02025 
02026         uint32_t port_status;
02027 
02028         <span class="keywordflow">switch</span> (typeReq) {
02029         <span class="keywordflow">case</span> UCR_CLEAR_HUB_FEATURE:
02030                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02031                             <span class="stringliteral">"ClearHubFeature 0x%x\n"</span>, wValue);
02032                 <span class="keywordflow">switch</span> (wValue) {
02033                 <span class="keywordflow">case</span> UHF_C_HUB_LOCAL_POWER:
02034                 <span class="keywordflow">case</span> UHF_C_HUB_OVER_CURRENT:
02035                         <span class="comment">/* Nothing required here */</span>
02036                         <span class="keywordflow">break</span>;
02037                 <span class="keywordflow">default</span>:
02038                         retval = -DWC_E_INVALID;
02039                         DWC_ERROR(<span class="stringliteral">"DWC OTG HCD - "</span>
02040                                   <span class="stringliteral">"ClearHubFeature request %xh unknown\n"</span>,
02041                                   wValue);
02042                 }
02043                 <span class="keywordflow">break</span>;
02044         <span class="keywordflow">case</span> UCR_CLEAR_PORT_FEATURE:
02045 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
02046 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (wValue != UHF_PORT_L1)
02047 <span class="preprocessor">#endif</span>
02048 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (!wIndex || wIndex &gt; 1)
02049                                 <span class="keywordflow">goto</span> error;
02050 
02051                 <span class="keywordflow">switch</span> (wValue) {
02052                 <span class="keywordflow">case</span> UHF_PORT_ENABLE:
02053                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02054                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_ENABLE\n"</span>);
02055                         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02056                         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o3">prtena</a> = 1;
02057                         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02058                         <span class="keywordflow">break</span>;
02059                 <span class="keywordflow">case</span> UHF_PORT_SUSPEND:
02060                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02061                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_SUSPEND\n"</span>);
02062 
02063                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
02064                                 dwc_otg_host_hibernation_restore(core_if, 0, 0);
02065                         } <span class="keywordflow">else</span> {
02066                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0);
02067                                 dwc_mdelay(5);
02068 
02069                                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02070                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o7">prtres</a> = 1;
02071                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02072                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o8">prtsusp</a> = 0;
02073                                 <span class="comment">/* Clear Resume bit */</span>
02074                                 dwc_mdelay(100);
02075                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o7">prtres</a> = 0;
02076                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02077                         }
02078                         <span class="keywordflow">break</span>;
02079 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
02080 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_PORT_L1:
02081                         {
02082                                 <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.<a class="code" href="unionhprt0__data.html#o0">d32</a> = 0 };
02083                                 <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg = {.<a class="code" href="unionhprt0__data.html#o0">d32</a> = 0 };
02084 
02085                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> =
02086                                     DWC_READ_REG32(&amp;core_if-&gt;
02087                                                    core_global_regs-&gt;glpmcfg);
02088                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o5">en_utmi_sleep</a> = 0;
02089                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o6">hird_thres</a> &amp;= (~(1 &lt;&lt; 4));
02090                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o8">prt_sleep_sts</a> = 1;
02091                                 DWC_WRITE_REG32(&amp;core_if-&gt;
02092                                                 core_global_regs-&gt;glpmcfg,
02093                                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a>);
02094 
02095                                 <span class="comment">/* Clear Enbl_L1Gating bit. */</span>
02096                                 pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o6">enbl_sleep_gating</a> = 1;
02097                                 DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>,
02098                                                  0);
02099 
02100                                 dwc_mdelay(5);
02101 
02102                                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02103                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o7">prtres</a> = 1;
02104                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>,
02105                                                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02106                                 <span class="comment">/* This bit will be cleared in wakeup interrupt handle */</span>
02107                                 <span class="keywordflow">break</span>;
02108                         }
02109 <span class="preprocessor">#endif</span>
02110 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_PORT_POWER:
02111                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02112                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_POWER\n"</span>);
02113                         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02114                         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 0;
02115                         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02116                         <span class="keywordflow">break</span>;
02117                 <span class="keywordflow">case</span> UHF_PORT_INDICATOR:
02118                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02119                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_INDICATOR\n"</span>);
02120                         <span class="comment">/* Port inidicator not supported */</span>
02121                         <span class="keywordflow">break</span>;
02122                 <span class="keywordflow">case</span> UHF_C_PORT_CONNECTION:
02123                         <span class="comment">/* Clears drivers internal connect status change</span>
02124 <span class="comment">                         * flag */</span>
02125                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02126                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_CONNECTION\n"</span>);
02127                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o1">port_connect_status_change</a> = 0;
02128                         <span class="keywordflow">break</span>;
02129                 <span class="keywordflow">case</span> UHF_C_PORT_RESET:
02130                         <span class="comment">/* Clears the driver's internal Port Reset Change</span>
02131 <span class="comment">                         * flag */</span>
02132                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02133                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_RESET\n"</span>);
02134                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o3">port_reset_change</a> = 0;
02135                         <span class="keywordflow">break</span>;
02136                 <span class="keywordflow">case</span> UHF_C_PORT_ENABLE:
02137                         <span class="comment">/* Clears the driver's internal Port</span>
02138 <span class="comment">                         * Enable/Disable Change flag */</span>
02139                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02140                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_ENABLE\n"</span>);
02141                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o4">port_enable_change</a> = 0;
02142                         <span class="keywordflow">break</span>;
02143                 <span class="keywordflow">case</span> UHF_C_PORT_SUSPEND:
02144                         <span class="comment">/* Clears the driver's internal Port Suspend</span>
02145 <span class="comment">                         * Change flag, which is set when resume signaling on</span>
02146 <span class="comment">                         * the host port is complete */</span>
02147                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02148                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_SUSPEND\n"</span>);
02149                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o5">port_suspend_change</a> = 0;
02150                         <span class="keywordflow">break</span>;
02151 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
02152 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_C_PORT_L1:
02153                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o7">port_l1_change</a> = 0;
02154                         <span class="keywordflow">break</span>;
02155 <span class="preprocessor">#endif</span>
02156 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_C_PORT_OVER_CURRENT:
02157                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02158                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_OVER_CURRENT\n"</span>);
02159                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o6">port_over_current_change</a> = 0;
02160                         <span class="keywordflow">break</span>;
02161                 <span class="keywordflow">default</span>:
02162                         retval = -DWC_E_INVALID;
02163                         DWC_ERROR(<span class="stringliteral">"DWC OTG HCD - "</span>
02164                                   <span class="stringliteral">"ClearPortFeature request %xh "</span>
02165                                   <span class="stringliteral">"unknown or unsupported\n"</span>, wValue);
02166                 }
02167                 <span class="keywordflow">break</span>;
02168         <span class="keywordflow">case</span> UCR_GET_HUB_DESCRIPTOR:
02169                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02170                             <span class="stringliteral">"GetHubDescriptor\n"</span>);
02171                 hub_desc = (usb_hub_descriptor_t *) buf;
02172                 hub_desc-&gt;bDescLength = 9;
02173                 hub_desc-&gt;bDescriptorType = 0x29;
02174                 hub_desc-&gt;bNbrPorts = 1;
02175                 USETW(hub_desc-&gt;wHubCharacteristics, 0x08);
02176                 hub_desc-&gt;bPwrOn2PwrGood = 1;
02177                 hub_desc-&gt;bHubContrCurrent = 0;
02178                 hub_desc-&gt;DeviceRemovable[0] = 0;
02179                 hub_desc-&gt;DeviceRemovable[1] = 0xff;
02180                 <span class="keywordflow">break</span>;
02181         <span class="keywordflow">case</span> UCR_GET_HUB_STATUS:
02182                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02183                             <span class="stringliteral">"GetHubStatus\n"</span>);
02184                 DWC_MEMSET(buf, 0, 4);
02185                 <span class="keywordflow">break</span>;
02186         <span class="keywordflow">case</span> UCR_GET_PORT_STATUS:
02187                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02188                             <span class="stringliteral">"GetPortStatus wIndex = 0x%04x FLAGS=0x%08x\n"</span>,
02189                             wIndex, dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o0">d32</a>);
02190                 <span class="keywordflow">if</span> (!wIndex || wIndex &gt; 1)
02191                         <span class="keywordflow">goto</span> error;
02192 
02193                 port_status = 0;
02194 
02195                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o1">port_connect_status_change</a>)
02196                         port_status |= (1 &lt;&lt; UHF_C_PORT_CONNECTION);
02197 
02198                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o4">port_enable_change</a>)
02199                         port_status |= (1 &lt;&lt; UHF_C_PORT_ENABLE);
02200 
02201                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o5">port_suspend_change</a>)
02202                         port_status |= (1 &lt;&lt; UHF_C_PORT_SUSPEND);
02203 
02204                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o7">port_l1_change</a>)
02205                         port_status |= (1 &lt;&lt; UHF_C_PORT_L1);
02206 
02207                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o3">port_reset_change</a>) {
02208                         port_status |= (1 &lt;&lt; UHF_C_PORT_RESET);
02209                 }
02210 
02211                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o6">port_over_current_change</a>) {
02212                         DWC_WARN(<span class="stringliteral">"Overcurrent change detected\n"</span>);
02213                         port_status |= (1 &lt;&lt; UHF_C_PORT_OVER_CURRENT);
02214                 }
02215 
02216                 <span class="keywordflow">if</span> (!dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o2">port_connect_status</a>) {
02217                         <span class="comment">/*</span>
02218 <span class="comment">                         * The port is disconnected, which means the core is</span>
02219 <span class="comment">                         * either in device mode or it soon will be. Just</span>
02220 <span class="comment">                         * return 0's for the remainder of the port status</span>
02221 <span class="comment">                         * since the port register can't be read if the core</span>
02222 <span class="comment">                         * is in device mode.</span>
02223 <span class="comment">                         */</span>
02224                         *((__le32 *) buf) = dwc_cpu_to_le32(&amp;port_status);
02225                         <span class="keywordflow">break</span>;
02226                 }
02227 
02228                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = DWC_READ_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>);
02229                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  HPRT0: 0x%08x\n"</span>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02230 
02231                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o1">prtconnsts</a>)
02232                         port_status |= (1 &lt;&lt; UHF_PORT_CONNECTION);
02233 
02234                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o3">prtena</a>)
02235                         port_status |= (1 &lt;&lt; UHF_PORT_ENABLE);
02236 
02237                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o8">prtsusp</a>)
02238                         port_status |= (1 &lt;&lt; UHF_PORT_SUSPEND);
02239 
02240                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o5">prtovrcurract</a>)
02241                         port_status |= (1 &lt;&lt; UHF_PORT_OVER_CURRENT);
02242 
02243                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o9">prtrst</a>)
02244                         port_status |= (1 &lt;&lt; UHF_PORT_RESET);
02245 
02246                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a>)
02247                         port_status |= (1 &lt;&lt; UHF_PORT_POWER);
02248 
02249                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o14">prtspd</a> == DWC_HPRT0_PRTSPD_HIGH_SPEED)
02250                         port_status |= (1 &lt;&lt; UHF_PORT_HIGH_SPEED);
02251                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o14">prtspd</a> == DWC_HPRT0_PRTSPD_LOW_SPEED)
02252                         port_status |= (1 &lt;&lt; UHF_PORT_LOW_SPEED);
02253 
02254                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o13">prttstctl</a>)
02255                         port_status |= (1 &lt;&lt; UHF_PORT_TEST);
02256                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__core__if_8h.html#a186">dwc_otg_get_lpm_portsleepstatus</a>(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>)) {
02257                         port_status |= (1 &lt;&lt; UHF_PORT_L1);
02258                 }
02259                 <span class="comment">/*</span>
02260 <span class="comment">                   For Synopsys HW emulation of Power down wkup_control asserts the </span>
02261 <span class="comment">                   hreset_n and prst_n on suspned. This causes the HPRT0 to be zero. </span>
02262 <span class="comment">                   We intentionally tell the software that port is in L2Suspend state. </span>
02263 <span class="comment">                   Only for STE.</span>
02264 <span class="comment">                */</span>
02265                 <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2)
02266                     &amp;&amp; (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> == 1)) {
02267                         port_status |= (1 &lt;&lt; UHF_PORT_SUSPEND);
02268                 }
02269                 <span class="comment">/* USB_PORT_FEAT_INDICATOR unsupported always 0 */</span>
02270 
02271                 *((__le32 *) buf) = dwc_cpu_to_le32(&amp;port_status);
02272 
02273                 <span class="keywordflow">break</span>;
02274         <span class="keywordflow">case</span> UCR_SET_HUB_FEATURE:
02275                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02276                             <span class="stringliteral">"SetHubFeature\n"</span>);
02277                 <span class="comment">/* No HUB features supported */</span>
02278                 <span class="keywordflow">break</span>;
02279         <span class="keywordflow">case</span> UCR_SET_PORT_FEATURE:
02280                 <span class="keywordflow">if</span> (wValue != UHF_PORT_TEST &amp;&amp; (!wIndex || wIndex &gt; 1))
02281                         <span class="keywordflow">goto</span> error;
02282 
02283                 <span class="keywordflow">if</span> (!dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o2">port_connect_status</a>) {
02284                         <span class="comment">/*</span>
02285 <span class="comment">                         * The port is disconnected, which means the core is</span>
02286 <span class="comment">                         * either in device mode or it soon will be. Just</span>
02287 <span class="comment">                         * return without doing anything since the port</span>
02288 <span class="comment">                         * register can't be written if the core is in device</span>
02289 <span class="comment">                         * mode.</span>
02290 <span class="comment">                         */</span>
02291                         <span class="keywordflow">break</span>;
02292                 }
02293 
02294                 <span class="keywordflow">switch</span> (wValue) {
02295                 <span class="keywordflow">case</span> UHF_PORT_SUSPEND:
02296                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02297                                     <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_SUSPEND\n"</span>);
02298                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd__if_8h.html#a19">dwc_otg_hcd_otg_port</a>(dwc_otg_hcd) != wIndex) {
02299                                 <span class="keywordflow">goto</span> error;
02300                         }
02301                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2) {
02302                                 <span class="keywordtype">int</span> timeout = 300;
02303                                 dwc_irqflags_t flags;
02304                                 <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.<a class="code" href="unionhprt0__data.html#o0">d32</a> = 0 };
02305                                 <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn = {.<a class="code" href="unionhprt0__data.html#o0">d32</a> = 0 };
02306                                 <a class="code" href="uniongusbcfg__data.html">gusbcfg_data_t</a> gusbcfg = {.<a class="code" href="unionhprt0__data.html#o0">d32</a> = 0 };
02307 <span class="preprocessor">#ifdef DWC_DEV_SRPCAP</span>
02308 <span class="preprocessor"></span>                                int32_t otg_cap_param = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o1">otg_cap</a>;
02309 <span class="preprocessor">#endif</span>
02310 <span class="preprocessor"></span>                                DWC_PRINTF(<span class="stringliteral">"Preparing for complete power-off\n"</span>);
02311 
02312                                 <span class="comment">/* Save registers before hibernation */</span>
02313                                 <a class="code" href="dwc__otg__cil_8h.html#a63">dwc_otg_save_global_regs</a>(core_if);
02314                                 <a class="code" href="dwc__otg__cil_8h.html#a65">dwc_otg_save_host_regs</a>(core_if);
02315 
02316                                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02317                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o8">prtsusp</a> = 1;
02318                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o3">prtena</a> = 0;
02319                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02320                                 <span class="comment">/* Spin hprt0.b.prtsusp to became 1 */</span>
02321                                 <span class="keywordflow">do</span> {
02322                                         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02323                                         <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o8">prtsusp</a>) {
02324                                                 <span class="keywordflow">break</span>;
02325                                         }
02326                                         dwc_mdelay(1);
02327                                 } <span class="keywordflow">while</span> (--timeout);
02328                                 <span class="keywordflow">if</span> (!timeout) {
02329                                         DWC_WARN(<span class="stringliteral">"Suspend wasn't genereted\n"</span>);
02330                                 }
02331                                 dwc_udelay(10);
02332 
02333                                 <span class="comment">/*</span>
02334 <span class="comment">                                 * We need to disable interrupts to prevent servicing of any IRQ</span>
02335 <span class="comment">                                 * during going to hibernation</span>
02336 <span class="comment">                                 */</span>
02337                                 DWC_SPINLOCK_IRQSAVE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, &amp;flags);
02338                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L2;
02339 <span class="preprocessor">#ifdef DWC_DEV_SRPCAP</span>
02340 <span class="preprocessor"></span>                                hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02341                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 0;
02342                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o3">prtena</a> = 0;
02343                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>,
02344                                                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02345 <span class="preprocessor">#endif</span>
02346 <span class="preprocessor"></span>                                gusbcfg.<a class="code" href="uniongusbcfg__data.html#o0">d32</a> =
02347                                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02348                                                    gusbcfg);
02349                                 <span class="keywordflow">if</span> (gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o3">ulpi_utmi_sel</a> == 1) {
02350                                         <span class="comment">/* ULPI interface */</span>
02351                                         <span class="comment">/* Suspend the Phy Clock */</span>
02352                                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a> = 0;
02353                                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
02354                                         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0,
02355                                                          pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
02356                                         dwc_udelay(10);
02357                                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
02358                                         DWC_MODIFY_REG32(&amp;core_if-&gt;
02359                                                          core_global_regs-&gt;
02360                                                          gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
02361                                 } <span class="keywordflow">else</span> {
02362                                         <span class="comment">/* UTMI+ Interface */</span>
02363                                         gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
02364                                         DWC_MODIFY_REG32(&amp;core_if-&gt;
02365                                                          core_global_regs-&gt;
02366                                                          gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
02367                                         dwc_udelay(10);
02368                                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
02369                                         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0, pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
02370                                         dwc_udelay(10);
02371                                 }
02372 <span class="preprocessor">#ifdef DWC_DEV_SRPCAP                           </span>
02373 <span class="preprocessor"></span>                                gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
02374                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o7">dis_vbus</a> = 1;
02375                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02376                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
02377 <span class="preprocessor">#endif</span>
02378 <span class="preprocessor"></span>                                gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
02379                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o1">pmuintsel</a> = 1;
02380                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02381                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
02382                                 dwc_udelay(10);
02383 
02384                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
02385 <span class="preprocessor">#ifdef DWC_DEV_SRPCAP</span>
02386 <span class="preprocessor"></span>                                gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o17">srp_det_msk</a> = 1;
02387 <span class="preprocessor">#endif</span>
02388 <span class="preprocessor"></span>                                gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o13">disconn_det_msk</a> = 1;
02389                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o9">lnstchng_msk</a> = 1;
02390                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o19">sts_chngint_msk</a> = 1;
02391                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02392                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
02393                                 dwc_udelay(10);
02394 
02395                                 <span class="comment">/* Enable Power Down Clamp and all interrupts in GPWRDN */</span>
02396                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
02397                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o4">pwrdnclmp</a> = 1;
02398                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02399                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
02400                                 dwc_udelay(10);
02401 
02402                                 <span class="comment">/* Switch off VDD */</span>
02403                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
02404                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o6">pwrdnswtch</a> = 1;
02405                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02406                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
02407 
02408 <span class="preprocessor">#ifdef DWC_DEV_SRPCAP</span>
02409 <span class="preprocessor"></span>                                <span class="keywordflow">if</span> (otg_cap_param == DWC_OTG_CAP_PARAM_HNP_SRP_CAPABLE)
02410                                 {
02411                                         core_if-&gt;pwron_timer_started = 1;
02412                                         DWC_TIMER_SCHEDULE(core_if-&gt;pwron_timer, 6000 <span class="comment">/* 6 secs */</span> );
02413                                 }
02414 <span class="preprocessor">#endif</span>
02415 <span class="preprocessor"></span>                                <span class="comment">/* Save gpwrdn register for further usage if stschng interrupt */</span>
02416                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o39">gr_backup</a>-&gt;gpwrdn_local =
02417                                                 DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o22">gpwrdn</a>);
02418 
02419                                 <span class="comment">/* Set flag to indicate that we are in hibernation */</span>
02420                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> = 1;
02421                                 DWC_SPINUNLOCK_IRQRESTORE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>,flags);
02422 
02423                                 DWC_PRINTF(<span class="stringliteral">"Host hibernation completed\n"</span>);
02424                                 <span class="comment">// Exit from case statement</span>
02425                                 <span class="keywordflow">break</span>;
02426 
02427                         }
02428                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd__if_8h.html#a19">dwc_otg_hcd_otg_port</a>(dwc_otg_hcd) == wIndex &amp;&amp;
02429                             dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a>-&gt;get_b_hnp_enable(dwc_otg_hcd)) {
02430                                 <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl = {.d32 = 0 };
02431                                 gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o11">hstsethnpen</a> = 1;
02432                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02433                                                  gotgctl, 0, gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>);
02434                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> = A_SUSPEND;
02435                         }
02436                         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02437                         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o8">prtsusp</a> = 1;
02438                         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02439                         {
02440                                 dwc_irqflags_t flags;
02441                                 <span class="comment">/* Update lx_state */</span>
02442                                 DWC_SPINLOCK_IRQSAVE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, &amp;flags);
02443                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L2;
02444                                 DWC_SPINUNLOCK_IRQRESTORE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o22">lock</a>, flags);
02445                         }
02446                         <span class="comment">/* Suspend the Phy Clock */</span>
02447                         {
02448                                 <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.d32 = 0 };
02449                                 pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
02450                                 DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0,
02451                                                  pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
02452                                 dwc_udelay(10);
02453                         }
02454 
02455                         <span class="comment">/* For HNP the bus must be suspended for at least 200ms. */</span>
02456                         <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a>-&gt;get_b_hnp_enable(dwc_otg_hcd)) {
02457                                 <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.<a class="code" href="unionpcgcctl__data.html#o0">d32</a> = 0 };
02458                                 pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
02459                 DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>, 0);
02460                                 dwc_mdelay(200);
02461                         }
02462 
02464 <span class="preprocessor">#if 0 //vahrama !!!!!!!!!!!!!!!!!!</span>
02465 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a>) {
02466                                 <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl = {.<a class="code" href="unionpcgcctl__data.html#o0">d32</a> = 0 };
02467                                 <a class="code" href="uniongpwrdn__data.html">gpwrdn_data_t</a> gpwrdn;
02468 
02469                                 <span class="keywordflow">while</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o16">asesvld</a> == 1) {
02470                                         gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a> =
02471                                             DWC_READ_REG32(&amp;core_if-&gt;
02472                                                            core_global_regs-&gt;
02473                                                            gotgctl);
02474                                         dwc_mdelay(100);
02475                                 }
02476 
02477                                 <span class="comment">/* Enable Power Down Logic */</span>
02478                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
02479                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o2">pmuactv</a> = 1;
02480                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02481                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
02482 
02483                                 <span class="comment">/* Unmask SRP detected interrupt from Power Down Logic */</span>
02484                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a> = 0;
02485                                 gpwrdn.<a class="code" href="uniongpwrdn__data.html#o26">b</a>.<a class="code" href="uniongpwrdn__data.html#o17">srp_det_msk</a> = 1;
02486                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;
02487                                                  gpwrdn, 0, gpwrdn.<a class="code" href="uniongpwrdn__data.html#o0">d32</a>);
02488 
02489                                 <a class="code" href="dwc__otg__adp_8h.html#a6">dwc_otg_adp_probe_start</a>(core_if);
02490                         }
02491 <span class="preprocessor">#endif</span>
02492 <span class="preprocessor"></span>                        <span class="keywordflow">break</span>;
02493                 <span class="keywordflow">case</span> UHF_PORT_POWER:
02494                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02495                                     <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_POWER\n"</span>);
02496                         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02497                         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 1;
02498                         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02499                         <span class="keywordflow">break</span>;
02500                 <span class="keywordflow">case</span> UHF_PORT_RESET:
02501                         <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o42">power_down</a> == 2)
02502                             &amp;&amp; (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> == 1)) {
02503                                 <span class="comment">/* If we are going to exit from Hibernated</span>
02504 <span class="comment">                                 * state via USB RESET.</span>
02505 <span class="comment">                                 */</span>
02506                                 dwc_otg_host_hibernation_restore(core_if, 0, 1);
02507                         } <span class="keywordflow">else</span> {
02508                                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02509 
02510                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>,
02511                                             <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02512                                             <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_RESET\n"</span>);
02513                                 {
02514                                         <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.<a class="code" href="unionhprt0__data.html#o0">d32</a> = 0 };
02515                                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o6">enbl_sleep_gating</a> = 1;
02516                                         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
02517                                         DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>, 0);
02518                                         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0);
02519                                 }
02520 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
02521 <span class="preprocessor"></span>                                {
02522                                         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
02523                                         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> =
02524                                                 DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
02525                                         <span class="keywordflow">if</span> (lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o8">prt_sleep_sts</a>) {
02526                                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o5">en_utmi_sleep</a> = 0;
02527                                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o6">hird_thres</a> &amp;= (~(1 &lt;&lt; 4));
02528                                                 DWC_WRITE_REG32
02529                                                     (&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>,
02530                                                      lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a>);
02531                                                 dwc_mdelay(1);
02532                                         }
02533                                 }
02534 <span class="preprocessor">#endif</span>
02535 <span class="preprocessor"></span>                                hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02536                                 <span class="comment">/* Clear suspend bit if resetting from suspended state. */</span>
02537                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o8">prtsusp</a> = 0;
02538                                 <span class="comment">/* When B-Host the Port reset bit is set in</span>
02539 <span class="comment">                                 * the Start HCD Callback function, so that</span>
02540 <span class="comment">                                 * the reset is started within 1ms of the HNP</span>
02541 <span class="comment">                                 * success interrupt. */</span>
02542                                 <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__hcd__if_8h.html#a21">dwc_otg_hcd_is_b_host</a>(dwc_otg_hcd)) {
02543                                         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o12">prtpwr</a> = 1;
02544                                         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o9">prtrst</a> = 1;
02545                                         DWC_PRINTF(<span class="stringliteral">"Indeed it is in host mode hprt0 = %08x\n"</span>,hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02546                                         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>,
02547                                                         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02548                                 }
02549                                 <span class="comment">/* Clear reset bit in 10ms (FS/LS) or 50ms (HS) */</span>
02550                                 dwc_mdelay(60);
02551                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o9">prtrst</a> = 0;
02552                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02553                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L0; <span class="comment">/* Now back to the on state */</span>
02554                         }
02555                         <span class="keywordflow">break</span>;
02556 <span class="preprocessor">#ifdef DWC_HS_ELECT_TST</span>
02557 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_PORT_TEST:
02558                         {
02559                                 uint32_t t;
02560                                 <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk;
02561 
02562                                 t = (wIndex &gt;&gt; 8);      <span class="comment">/* MSB wIndex USB */</span>
02563                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>,
02564                                             <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02565                                             <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_TEST %d\n"</span>,
02566                                             t);
02567                                 DWC_WARN(<span class="stringliteral">"USB_PORT_FEAT_TEST %d\n"</span>, t);
02568                                 <span class="keywordflow">if</span> (t &lt; 6) {
02569                                         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02570                                         hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o13">prttstctl</a> = t;
02571                                         DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>,
02572                                                         hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02573                                 } <span class="keywordflow">else</span> {
02574                                         <span class="comment">/* Setup global vars with reg addresses (quick and</span>
02575 <span class="comment">                                         * dirty hack, should be cleaned up)</span>
02576 <span class="comment">                                         */</span>
02577                                         global_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>;
02578                                         hc_global_regs =
02579                                             core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o0">host_global_regs</a>;
02580                                         hc_regs =
02581                                             (<a class="code" href="structdwc__otg__hc__regs.html">dwc_otg_hc_regs_t</a> *) ((<span class="keywordtype">char</span> *)
02582                                                                    global_regs +
02583                                                                    0x500);
02584                                         data_fifo =
02585                                             (uint32_t *) ((<span class="keywordtype">char</span> *)global_regs +
02586                                                           0x1000);
02587 
02588                                         <span class="keywordflow">if</span> (t == 6) {   <span class="comment">/* HS_HOST_PORT_SUSPEND_RESUME */</span>
02589                                                 <span class="comment">/* Save current interrupt mask */</span>
02590                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a> =
02591                                                     DWC_READ_REG32
02592                                                     (&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>);
02593 
02594                                                 <span class="comment">/* Disable all interrupts while we muck with</span>
02595 <span class="comment">                                                 * the hardware directly</span>
02596 <span class="comment">                                                 */</span>
02597                                                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0);
02598 
02599                                                 <span class="comment">/* 15 second delay per the test spec */</span>
02600                                                 dwc_mdelay(15000);
02601 
02602                                                 <span class="comment">/* Drive suspend on the root port */</span>
02603                                                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> =
02604                                                     <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02605                                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o8">prtsusp</a> = 1;
02606                                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o7">prtres</a> = 0;
02607                                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02608 
02609                                                 <span class="comment">/* 15 second delay per the test spec */</span>
02610                                                 dwc_mdelay(15000);
02611 
02612                                                 <span class="comment">/* Drive resume on the root port */</span>
02613                                                 hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a> =
02614                                                     <a class="code" href="dwc__otg__cil_8h.html#a102">dwc_otg_read_hprt0</a>(core_if);
02615                                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o8">prtsusp</a> = 0;
02616                                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o7">prtres</a> = 1;
02617                                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02618                                                 dwc_mdelay(100);
02619 
02620                                                 <span class="comment">/* Clear the resume bit */</span>
02621                                                 hprt0.<a class="code" href="unionhprt0__data.html#o16">b</a>.<a class="code" href="unionhprt0__data.html#o7">prtres</a> = 0;
02622                                                 DWC_WRITE_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o1">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#o0">d32</a>);
02623 
02624                                                 <span class="comment">/* Restore interrupts */</span>
02625                                                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
02626                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t == 7) {    <span class="comment">/* SINGLE_STEP_GET_DEVICE_DESCRIPTOR setup */</span>
02627                                                 <span class="comment">/* Save current interrupt mask */</span>
02628                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a> =
02629                                                     DWC_READ_REG32
02630                                                     (&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>);
02631 
02632                                                 <span class="comment">/* Disable all interrupts while we muck with</span>
02633 <span class="comment">                                                 * the hardware directly</span>
02634 <span class="comment">                                                 */</span>
02635                                                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0);
02636 
02637                                                 <span class="comment">/* 15 second delay per the test spec */</span>
02638                                                 dwc_mdelay(15000);
02639 
02640                                                 <span class="comment">/* Send the Setup packet */</span>
02641                                                 do_setup();
02642 
02643                                                 <span class="comment">/* 15 second delay so nothing else happens for awhile */</span>
02644                                                 dwc_mdelay(15000);
02645 
02646                                                 <span class="comment">/* Restore interrupts */</span>
02647                                                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
02648                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t == 8) {    <span class="comment">/* SINGLE_STEP_GET_DEVICE_DESCRIPTOR execute */</span>
02649                                                 <span class="comment">/* Save current interrupt mask */</span>
02650                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a> =
02651                                                     DWC_READ_REG32
02652                                                     (&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>);
02653 
02654                                                 <span class="comment">/* Disable all interrupts while we muck with</span>
02655 <span class="comment">                                                 * the hardware directly</span>
02656 <span class="comment">                                                 */</span>
02657                                                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0);
02658 
02659                                                 <span class="comment">/* Send the Setup packet */</span>
02660                                                 do_setup();
02661 
02662                                                 <span class="comment">/* 15 second delay so nothing else happens for awhile */</span>
02663                                                 dwc_mdelay(15000);
02664 
02665                                                 <span class="comment">/* Send the In and Ack packets */</span>
02666                                                 do_in_ack();
02667 
02668                                                 <span class="comment">/* 15 second delay so nothing else happens for awhile */</span>
02669                                                 dwc_mdelay(15000);
02670 
02671                                                 <span class="comment">/* Restore interrupts */</span>
02672                                                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
02673                                         }
02674                                 }
02675                                 <span class="keywordflow">break</span>;
02676                         }
02677 <span class="preprocessor">#endif </span><span class="comment">/* DWC_HS_ELECT_TST */</span>
02678 
02679                 <span class="keywordflow">case</span> UHF_PORT_INDICATOR:
02680                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
02681                                     <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_INDICATOR\n"</span>);
02682                         <span class="comment">/* Not supported */</span>
02683                         <span class="keywordflow">break</span>;
02684                 <span class="keywordflow">default</span>:
02685                         retval = -DWC_E_INVALID;
02686                         DWC_ERROR(<span class="stringliteral">"DWC OTG HCD - "</span>
02687                                   <span class="stringliteral">"SetPortFeature request %xh "</span>
02688                                   <span class="stringliteral">"unknown or unsupported\n"</span>, wValue);
02689                         <span class="keywordflow">break</span>;
02690                 }
02691                 <span class="keywordflow">break</span>;
02692 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
02693 <span class="preprocessor"></span>        <span class="keywordflow">case</span> UCR_SET_AND_TEST_PORT_FEATURE:
02694                 <span class="keywordflow">if</span> (wValue != UHF_PORT_L1) {
02695                         <span class="keywordflow">goto</span> error;
02696                 }
02697                 {
02698                         <span class="keywordtype">int</span> portnum, hird, devaddr, remwake;
02699                         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
02700                         uint32_t time_usecs;
02701                         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
02702                         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk;
02703 
02704                         <span class="keywordflow">if</span> (!dwc_otg_get_param_lpm_enable(core_if)) {
02705                                 <span class="keywordflow">goto</span> error;
02706                         }
02707                         <span class="keywordflow">if</span> (wValue != UHF_PORT_L1 || wLength != 1) {
02708                                 <span class="keywordflow">goto</span> error;
02709                         }
02710                         <span class="comment">/* Check if the port currently is in SLEEP state */</span>
02711                         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> =
02712                             DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
02713                         <span class="keywordflow">if</span> (lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o8">prt_sleep_sts</a>) {
02714                                 DWC_INFO(<span class="stringliteral">"Port is already in sleep mode\n"</span>);
02715                                 buf[0] = 0;     <span class="comment">/* Return success */</span>
02716                                 <span class="keywordflow">break</span>;
02717                         }
02718 
02719                         portnum = wIndex &amp; 0xf;
02720                         hird = (wIndex &gt;&gt; 4) &amp; 0xf;
02721                         devaddr = (wIndex &gt;&gt; 8) &amp; 0x7f;
02722                         remwake = (wIndex &gt;&gt; 15);
02723 
02724                         <span class="keywordflow">if</span> (portnum != 1) {
02725                                 retval = -DWC_E_INVALID;
02726                                 DWC_WARN
02727                                     (<span class="stringliteral">"Wrong port number(%d) in SetandTestPortFeature request\n"</span>,
02728                                      portnum);
02729                                 <span class="keywordflow">break</span>;
02730                         }
02731 
02732                         DWC_PRINTF
02733                             (<span class="stringliteral">"SetandTestPortFeature request: portnum = %d, hird = %d, devaddr = %d, rewake = %d\n"</span>,
02734                              portnum, hird, devaddr, remwake);
02735                         <span class="comment">/* Disable LPM interrupt */</span>
02736                         gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = 0;
02737                         gintmsk.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o28">lpmtranrcvd</a> = 1;
02738                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>,
02739                                          gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
02740 
02741                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd__if_8h.html#a25">dwc_otg_hcd_send_lpm</a>
02742                             (dwc_otg_hcd, devaddr, hird, remwake)) {
02743                                 retval = -DWC_E_INVALID;
02744                                 <span class="keywordflow">break</span>;
02745                         }
02746 
02747                         time_usecs = 10 * (lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o11">retry_count</a> + 1);
02748                         <span class="comment">/* We will consider timeout if time_usecs microseconds pass,</span>
02749 <span class="comment">                         * and we don't receive LPM transaction status.</span>
02750 <span class="comment">                         * After receiving non-error responce(ACK/NYET/STALL) from device,</span>
02751 <span class="comment">                         *  core will set lpmtranrcvd bit.</span>
02752 <span class="comment">                         */</span>
02753                         <span class="keywordflow">do</span> {
02754                                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> =
02755                                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
02756                                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o28">lpmtranrcvd</a>) {
02757                                         <span class="keywordflow">break</span>;
02758                                 }
02759                                 dwc_udelay(1);
02760                         } <span class="keywordflow">while</span> (--time_usecs);
02761                         <span class="comment">/* lpm_int bit will be cleared in LPM interrupt handler */</span>
02762 
02763                         <span class="comment">/* Now fill status</span>
02764 <span class="comment">                         * 0x00 - Success</span>
02765 <span class="comment">                         * 0x10 - NYET</span>
02766 <span class="comment">                         * 0x11 - Timeout</span>
02767 <span class="comment">                         */</span>
02768                         <span class="keywordflow">if</span> (!gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o28">lpmtranrcvd</a>) {
02769                                 buf[0] = 0x3;   <span class="comment">/* Completion code is Timeout */</span>
02770                                 dwc_otg_hcd_free_hc_from_lpm(dwc_otg_hcd);
02771                         } <span class="keywordflow">else</span> {
02772                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> =
02773                                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
02774                                 <span class="keywordflow">if</span> (lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o7">lpm_resp</a> == 0x3) {
02775                                         <span class="comment">/* ACK responce from the device */</span>
02776                                         buf[0] = 0x00;  <span class="comment">/* Success */</span>
02777                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o7">lpm_resp</a> == 0x2) {
02778                                         <span class="comment">/* NYET responce from the device */</span>
02779                                         buf[0] = 0x2;
02780                                 } <span class="keywordflow">else</span> {
02781                                         <span class="comment">/* Otherwise responce with Timeout */</span>
02782                                         buf[0] = 0x3;
02783                                 }
02784                         }
02785                         DWC_PRINTF(<span class="stringliteral">"Device responce to LPM trans is %x\n"</span>,
02786                                    lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o7">lpm_resp</a>);
02787                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0,
02788                                          gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
02789 
02790                         <span class="keywordflow">break</span>;
02791                 }
02792 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_USB_DWC_OTG_LPM */</span>
02793         <span class="keywordflow">default</span>:
02794 error:
02795                 retval = -DWC_E_INVALID;
02796                 DWC_WARN(<span class="stringliteral">"DWC OTG HCD - "</span>
02797                          <span class="stringliteral">"Unknown hub control request type or invalid typeReq: %xh wIndex: %xh wValue: %xh\n"</span>,
02798                          typeReq, wIndex, wValue);
02799                 <span class="keywordflow">break</span>;
02800         }
02801 
02802         <span class="keywordflow">return</span> retval;
02803 }
02804 
02805 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
02806 <span class="preprocessor"></span>
02807 <span class="keywordtype">int</span> dwc_otg_hcd_get_hc_for_lpm_tran(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, uint8_t devaddr)
02808 {
02809         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>;
02810         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc;
02811         <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
02812         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk = {.d32 = 0 };
02813 
02814         <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>)) {
02815                 DWC_PRINTF(<span class="stringliteral">"No free channel to select for LPM transaction\n"</span>);
02816                 <span class="keywordflow">return</span> -1;
02817         }
02818 
02819         hc = DWC_CIRCLEQ_FIRST(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>);
02820 
02821         <span class="comment">/* Mask host channel interrupts. */</span>
02822         gintmsk.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o26">hcintr</a> = 1;
02823         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
02824 
02825         <span class="comment">/* Fill fields that core needs for LPM transaction */</span>
02826         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o8">devaddr</a> = devaddr;
02827         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o2">epnum</a> = 0;
02828         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o6">eptype</a> = DWC_OTG_EP_TYPE_CONTROL;
02829         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o1">mps</a> = 64;
02830         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o5">lspddev</a> = (hc-&gt;<a class="code" href="structdwc__hc.html#o4">speed</a> == DWC_OTG_EP_SPEED_LOW);
02831         hcchar.<a class="code" href="unionhcchar__data.html#o12">b</a>.<a class="code" href="unionhcchar__data.html#o3">epdir</a> = 0;     <span class="comment">/* OUT */</span>
02832         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o2">hc_regs</a>[hc-&gt;<a class="code" href="structdwc__hc.html#o0">hc_num</a>]-&gt;hcchar,
02833                         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
02834 
02835         <span class="comment">/* Remove the host channel from the free list. */</span>
02836         DWC_CIRCLEQ_REMOVE_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>, hc, hc_list_entry);
02837 
02838         DWC_PRINTF(<span class="stringliteral">"hcnum = %d devaddr = %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#o0">hc_num</a>, devaddr);
02839 
02840         <span class="keywordflow">return</span> hc-&gt;<a class="code" href="structdwc__hc.html#o0">hc_num</a>;
02841 }
02842 
02844 <span class="keywordtype">void</span> dwc_otg_hcd_free_hc_from_lpm(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
02845 {
02846         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc;
02847         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
02848         uint8_t hc_num;
02849 
02850         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
02851         hc_num = lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o10">lpm_chan_index</a>;
02852 
02853         hc = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>[hc_num];
02854 
02855         DWC_PRINTF(<span class="stringliteral">"Freeing channel %d after LPM\n"</span>, hc_num);
02856         <span class="comment">/* Return host channel to free list */</span>
02857         DWC_CIRCLEQ_INSERT_TAIL(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o14">free_hc_list</a>, hc, hc_list_entry);
02858 }
02859 
02860 <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a25">dwc_otg_hcd_send_lpm</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, uint8_t devaddr, uint8_t hird,
02861                          uint8_t bRemoteWake)
02862 {
02863         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
02864         <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.d32 = 0 };
02865         <span class="keywordtype">int</span> channel;
02866 
02867         channel = dwc_otg_hcd_get_hc_for_lpm_tran(hcd, devaddr);
02868         <span class="keywordflow">if</span> (channel &lt; 0) {
02869                 <span class="keywordflow">return</span> channel;
02870         }
02871 
02872         pcgcctl.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o6">enbl_sleep_gating</a> = 1;
02873         DWC_MODIFY_REG32(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, 0, pcgcctl.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>);
02874 
02875         <span class="comment">/* Read LPM config register */</span>
02876         lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>);
02877 
02878         <span class="comment">/* Program LPM transaction fields */</span>
02879         lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o4">rem_wkup_en</a> = bRemoteWake;
02880         lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o3">hird</a> = hird;
02881         lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o6">hird_thres</a> = 0x1c;
02882         lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o10">lpm_chan_index</a> = channel;
02883         lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o5">en_utmi_sleep</a> = 1;
02884         <span class="comment">/* Program LPM config register */</span>
02885         DWC_WRITE_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>, lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a>);
02886 
02887         <span class="comment">/* Send LPM transaction */</span>
02888         lpmcfg.<a class="code" href="unionglpmctl__data.html#o17">b</a>.<a class="code" href="unionglpmctl__data.html#o12">send_lpm</a> = 1;
02889         DWC_WRITE_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o21">glpmcfg</a>, lpmcfg.<a class="code" href="unionglpmctl__data.html#o0">d32</a>);
02890 
02891         <span class="keywordflow">return</span> 0;
02892 }
02893 
02894 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_USB_DWC_OTG_LPM */</span>
02895 
<a name="l02896"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a39">02896</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a39">dwc_otg_hcd_is_status_changed</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">int</span> port)
02897 {
02898         <span class="keywordtype">int</span> retval;
02899 
02900         <span class="keywordflow">if</span> (port != 1) {
02901                 <span class="keywordflow">return</span> -DWC_E_INVALID;
02902         }
02903 
02904         retval = (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o1">port_connect_status_change</a> ||
02905                   hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o3">port_reset_change</a> ||
02906                   hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o4">port_enable_change</a> ||
02907                   hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o5">port_suspend_change</a> ||
02908                   hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o6">port_over_current_change</a>);
02909 <span class="preprocessor">#ifdef DEBUG</span>
02910 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (retval) {
02911                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a4">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB STATUS DATA:"</span>
02912                             <span class="stringliteral">" Root port status changed\n"</span>);
02913                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  port_connect_status_change: %d\n"</span>,
02914                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o1">port_connect_status_change</a>);
02915                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  port_reset_change: %d\n"</span>,
02916                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o3">port_reset_change</a>);
02917                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  port_enable_change: %d\n"</span>,
02918                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o4">port_enable_change</a>);
02919                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  port_suspend_change: %d\n"</span>,
02920                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o5">port_suspend_change</a>);
02921                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"  port_over_current_change: %d\n"</span>,
02922                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o9">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#o6">port_over_current_change</a>);
02923         }
02924 <span class="preprocessor">#endif</span>
02925 <span class="preprocessor"></span>        <span class="keywordflow">return</span> retval;
02926 }
02927 
<a name="l02928"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a22">02928</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a22">dwc_otg_hcd_get_frame_number</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>)
02929 {
02930         <a class="code" href="unionhfnum__data.html">hfnum_data_t</a> hfnum;
02931         hfnum.<a class="code" href="unionhfnum__data.html#o0">d32</a> =
02932             DWC_READ_REG32(&amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o0">host_global_regs</a>-&gt;
02933                            hfnum);
02934 
02935 <span class="preprocessor">#ifdef DEBUG_SOF</span>
02936 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a5">DBG_HCDV</a>, <span class="stringliteral">"DWC OTG HCD GET FRAME NUMBER %d\n"</span>,
02937                     hfnum.<a class="code" href="unionhfnum__data.html#o3">b</a>.<a class="code" href="unionhfnum__data.html#o1">frnum</a>);
02938 <span class="preprocessor">#endif</span>
02939 <span class="preprocessor"></span>        <span class="keywordflow">return</span> hfnum.<a class="code" href="unionhfnum__data.html#o3">b</a>.<a class="code" href="unionhfnum__data.html#o1">frnum</a>;
02940 }
02941 
<a name="l02942"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a16">02942</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a16">dwc_otg_hcd_start</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
02943                       <span class="keyword">struct</span> dwc_otg_hcd_function_ops *fops)
02944 {
02945         <span class="keywordtype">int</span> retval = 0;
02946 
02947         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o2">fops</a> = fops;
02948         <span class="keywordflow">if</span> (!dwc_otg_is_device_mode(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>) &amp;&amp; 
02949                 (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o43">adp_enable</a> || hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o44">adp</a>.adp_started)) {
02950                 <a class="code" href="dwc__otg__hcd_8c.html#a25">dwc_otg_hcd_reinit</a>(hcd);
02951         } <span class="keywordflow">else</span> {
02952                 retval = -DWC_E_NO_DEVICE;
02953         }
02954 
02955         <span class="keywordflow">return</span> retval;
02956 }
02957 
<a name="l02958"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a14">02958</a> <span class="keywordtype">void</span> *<a class="code" href="dwc__otg__hcd__if_8h.html#a14">dwc_otg_hcd_get_priv_data</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
02959 {
02960         <span class="keywordflow">return</span> hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o23">priv</a>;
02961 }
02962 
<a name="l02963"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a15">02963</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a15">dwc_otg_hcd_set_priv_data</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *priv_data)
02964 {
02965         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o23">priv</a> = priv_data;
02966 }
02967 
<a name="l02968"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a19">02968</a> uint32_t <a class="code" href="dwc__otg__hcd__if_8h.html#a19">dwc_otg_hcd_otg_port</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
02969 {
02970         <span class="keywordflow">return</span> hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o24">otg_port</a>;
02971 }
02972 
<a name="l02973"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a21">02973</a> uint32_t <a class="code" href="dwc__otg__hcd__if_8h.html#a21">dwc_otg_hcd_is_b_host</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
02974 {
02975         uint32_t is_b_host;
02976         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o27">op_state</a> == B_HOST) {
02977                 is_b_host = 1;
02978         } <span class="keywordflow">else</span> {
02979                 is_b_host = 0;
02980         }
02981 
02982         <span class="keywordflow">return</span> is_b_host;
02983 }
02984 
<a name="l02985"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a26">02985</a> dwc_otg_hcd_urb_t *<a class="code" href="dwc__otg__hcd__if_8h.html#a26">dwc_otg_hcd_urb_alloc</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
02986                                          <span class="keywordtype">int</span> iso_desc_count, <span class="keywordtype">int</span> atomic_alloc)
02987 {
02988         dwc_otg_hcd_urb_t *dwc_otg_urb;
02989         uint32_t size;
02990 
02991         size =
02992             <span class="keyword">sizeof</span>(*dwc_otg_urb) +
02993             iso_desc_count * <span class="keyword">sizeof</span>(<span class="keyword">struct </span>dwc_otg_hcd_iso_packet_desc);
02994         <span class="keywordflow">if</span> (atomic_alloc)
02995                 dwc_otg_urb = DWC_ALLOC_ATOMIC(size);
02996         <span class="keywordflow">else</span>
02997                 dwc_otg_urb = DWC_ALLOC(size);
02998 
02999         dwc_otg_urb-&gt;packet_count = iso_desc_count;
03000 
03001         <span class="keywordflow">return</span> dwc_otg_urb;
03002 }
03003 
<a name="l03004"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a27">03004</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a27">dwc_otg_hcd_urb_set_pipeinfo</a>(dwc_otg_hcd_urb_t * dwc_otg_urb,
03005                                   uint8_t dev_addr, uint8_t ep_num,
03006                                   uint8_t ep_type, uint8_t ep_dir, uint16_t mps)
03007 {
03008         dwc_otg_hcd_fill_pipe(&amp;dwc_otg_urb-&gt;pipe_info, dev_addr, ep_num,
03009                               ep_type, ep_dir, mps);
03010 <span class="preprocessor">#if 0</span>
03011 <span class="preprocessor"></span>        DWC_PRINTF
03012             (<span class="stringliteral">"addr = %d, ep_num = %d, ep_dir = 0x%x, ep_type = 0x%x, mps = %d\n"</span>,
03013              dev_addr, ep_num, ep_dir, ep_type, mps);
03014 <span class="preprocessor">#endif</span>
03015 <span class="preprocessor"></span>}
03016 
<a name="l03017"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a28">03017</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a28">dwc_otg_hcd_urb_set_params</a>(dwc_otg_hcd_urb_t * dwc_otg_urb,
03018                                 <span class="keywordtype">void</span> *urb_handle, <span class="keywordtype">void</span> *buf, dwc_dma_t dma,
03019                                 uint32_t buflen, <span class="keywordtype">void</span> *setup_packet,
03020                                 dwc_dma_t setup_dma, uint32_t flags,
03021                                 uint16_t interval)
03022 {
03023         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd.html#o23">priv</a> = urb_handle;
03024         dwc_otg_urb-&gt;buf = buf;
03025         dwc_otg_urb-&gt;dma = dma;
03026         dwc_otg_urb-&gt;length = buflen;
03027         dwc_otg_urb-&gt;setup_packet = setup_packet;
03028         dwc_otg_urb-&gt;setup_dma = setup_dma;
03029         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd.html#o3">flags</a> = flags;
03030         dwc_otg_urb-&gt;interval = interval;
03031         dwc_otg_urb-&gt;status = -DWC_E_IN_PROGRESS;
03032 }
03033 
<a name="l03034"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a29">03034</a> uint32_t <a class="code" href="dwc__otg__hcd__if_8h.html#a29">dwc_otg_hcd_urb_get_status</a>(dwc_otg_hcd_urb_t * dwc_otg_urb)
03035 {
03036         <span class="keywordflow">return</span> dwc_otg_urb-&gt;status;
03037 }
03038 
<a name="l03039"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a30">03039</a> uint32_t <a class="code" href="dwc__otg__hcd__if_8h.html#a30">dwc_otg_hcd_urb_get_actual_length</a>(dwc_otg_hcd_urb_t * dwc_otg_urb)
03040 {
03041         <span class="keywordflow">return</span> dwc_otg_urb-&gt;actual_length;
03042 }
03043 
<a name="l03044"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a31">03044</a> uint32_t <a class="code" href="dwc__otg__hcd__if_8h.html#a31">dwc_otg_hcd_urb_get_error_count</a>(dwc_otg_hcd_urb_t * dwc_otg_urb)
03045 {
03046         <span class="keywordflow">return</span> dwc_otg_urb-&gt;error_count;
03047 }
03048 
<a name="l03049"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a32">03049</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a32">dwc_otg_hcd_urb_set_iso_desc_params</a>(dwc_otg_hcd_urb_t * dwc_otg_urb,
03050                                          <span class="keywordtype">int</span> desc_num, uint32_t offset,
03051                                          uint32_t length)
03052 {
03053         dwc_otg_urb-&gt;iso_descs[desc_num].offset = offset;
03054         dwc_otg_urb-&gt;iso_descs[desc_num].length = length;
03055 }
03056 
<a name="l03057"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a33">03057</a> uint32_t <a class="code" href="dwc__otg__hcd__if_8h.html#a33">dwc_otg_hcd_urb_get_iso_desc_status</a>(dwc_otg_hcd_urb_t * dwc_otg_urb,
03058                                              <span class="keywordtype">int</span> desc_num)
03059 {
03060         <span class="keywordflow">return</span> dwc_otg_urb-&gt;iso_descs[desc_num].status;
03061 }
03062 
<a name="l03063"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a34">03063</a> uint32_t <a class="code" href="dwc__otg__hcd__if_8h.html#a34">dwc_otg_hcd_urb_get_iso_desc_actual_length</a>(dwc_otg_hcd_urb_t *
03064                                                     dwc_otg_urb, <span class="keywordtype">int</span> desc_num)
03065 {
03066         <span class="keywordflow">return</span> dwc_otg_urb-&gt;iso_descs[desc_num].actual_length;
03067 }
03068 
<a name="l03069"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a40">03069</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a40">dwc_otg_hcd_is_bandwidth_allocated</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *ep_handle)
03070 {
03071         <span class="keywordtype">int</span> allocated = 0;
03072         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh = (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *) ep_handle;
03073 
03074         <span class="keywordflow">if</span> (qh) {
03075                 <span class="keywordflow">if</span> (!DWC_LIST_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>)) {
03076                         allocated = 1;
03077                 }
03078         }
03079         <span class="keywordflow">return</span> allocated;
03080 }
03081 
<a name="l03082"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a41">03082</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a41">dwc_otg_hcd_is_bandwidth_freed</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *ep_handle)
03083 {
03084         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh = (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *) ep_handle;
03085         <span class="keywordtype">int</span> freed = 0;
03086         DWC_ASSERT(qh, <span class="stringliteral">"qh is not allocated\n"</span>);
03087 
03088         <span class="keywordflow">if</span> (DWC_LIST_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#o11">qh_list_entry</a>)) {
03089                 freed = 1;
03090         }
03091 
03092         <span class="keywordflow">return</span> freed;
03093 }
03094 
<a name="l03095"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a42">03095</a> uint8_t <a class="code" href="dwc__otg__hcd__if_8h.html#a42">dwc_otg_hcd_get_ep_bandwidth</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *ep_handle)
03096 {
03097         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh = (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *) ep_handle;
03098         DWC_ASSERT(qh, <span class="stringliteral">"qh is not allocated\n"</span>);
03099         <span class="keywordflow">return</span> qh-&gt;<a class="code" href="structdwc__otg__qh.html#z38_0">usecs</a>;
03100 }
03101 
<a name="l03102"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a23">03102</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a23">dwc_otg_hcd_dump_state</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
03103 {
03104 <span class="preprocessor">#ifdef DEBUG</span>
03105 <span class="preprocessor"></span>        <span class="keywordtype">int</span> num_channels;
03106         <span class="keywordtype">int</span> i;
03107         <a class="code" href="uniongnptxsts__data.html">gnptxsts_data_t</a> np_tx_status;
03108         hptxsts_data_t p_tx_status;
03109 
03110         num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o18">host_channels</a>;
03111         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
03112         DWC_PRINTF
03113             (<span class="stringliteral">"************************************************************\n"</span>);
03114         DWC_PRINTF(<span class="stringliteral">"HCD State:\n"</span>);
03115         DWC_PRINTF(<span class="stringliteral">"  Num channels: %d\n"</span>, num_channels);
03116         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
03117                 <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o17">hc_ptr_array</a>[i];
03118                 DWC_PRINTF(<span class="stringliteral">"  Channel %d:\n"</span>, i);
03119                 DWC_PRINTF(<span class="stringliteral">"    dev_addr: %d, ep_num: %d, ep_is_in: %d\n"</span>,
03120                            hc-&gt;<a class="code" href="structdwc__hc.html#o1">dev_addr</a>, hc-&gt;<a class="code" href="structdwc__hc.html#o2">ep_num</a>, hc-&gt;<a class="code" href="structdwc__hc.html#o3">ep_is_in</a>);
03121                 DWC_PRINTF(<span class="stringliteral">"    speed: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#o4">speed</a>);
03122                 DWC_PRINTF(<span class="stringliteral">"    ep_type: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#o5">ep_type</a>);
03123                 DWC_PRINTF(<span class="stringliteral">"    max_packet: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#o6">max_packet</a>);
03124                 DWC_PRINTF(<span class="stringliteral">"    data_pid_start: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#o7">data_pid_start</a>);
03125                 DWC_PRINTF(<span class="stringliteral">"    multi_count: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#o8">multi_count</a>);
03126                 DWC_PRINTF(<span class="stringliteral">"    xfer_started: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a>);
03127                 DWC_PRINTF(<span class="stringliteral">"    xfer_buff: %p\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_0">xfer_buff</a>);
03128                 DWC_PRINTF(<span class="stringliteral">"    xfer_len: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_2">xfer_len</a>);
03129                 DWC_PRINTF(<span class="stringliteral">"    xfer_count: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_3">xfer_count</a>);
03130                 DWC_PRINTF(<span class="stringliteral">"    halt_on_queue: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_8">halt_on_queue</a>);
03131                 DWC_PRINTF(<span class="stringliteral">"    halt_pending: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_9">halt_pending</a>);
03132                 DWC_PRINTF(<span class="stringliteral">"    halt_status: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_10">halt_status</a>);
03133                 DWC_PRINTF(<span class="stringliteral">"    do_split: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_11">do_split</a>);
03134                 DWC_PRINTF(<span class="stringliteral">"    complete_split: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_12">complete_split</a>);
03135                 DWC_PRINTF(<span class="stringliteral">"    hub_addr: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_13">hub_addr</a>);
03136                 DWC_PRINTF(<span class="stringliteral">"    port_addr: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_14">port_addr</a>);
03137                 DWC_PRINTF(<span class="stringliteral">"    xact_pos: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_15">xact_pos</a>);
03138                 DWC_PRINTF(<span class="stringliteral">"    requests: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_17">requests</a>);
03139                 DWC_PRINTF(<span class="stringliteral">"    qh: %p\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#z34_18">qh</a>);
03140                 <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a>) {
03141                         <a class="code" href="unionhfnum__data.html">hfnum_data_t</a> hfnum;
03142                         <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
03143                         <a class="code" href="unionhctsiz__data.html">hctsiz_data_t</a> hctsiz;
03144                         <a class="code" href="unionhcint__data.html">hcint_data_t</a> hcint;
03145                         <a class="code" href="unionhcintmsk__data.html">hcintmsk_data_t</a> hcintmsk;
03146                         hfnum.<a class="code" href="unionhfnum__data.html#o0">d32</a> =
03147                             DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;
03148                                            host_if-&gt;host_global_regs-&gt;hfnum);
03149                         hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a> =
03150                             DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;
03151                                            hc_regs[i]-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o0">hcchar</a>);
03152                         hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a> =
03153                             DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;
03154                                            hc_regs[i]-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o4">hctsiz</a>);
03155                         hcint.<a class="code" href="unionhcint__data.html#o0">d32</a> =
03156                             DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;
03157                                            hc_regs[i]-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o2">hcint</a>);
03158                         hcintmsk.<a class="code" href="unionhcintmsk__data.html#o0">d32</a> =
03159                             DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;
03160                                            hc_regs[i]-&gt;<a class="code" href="structdwc__otg__hc__regs.html#o3">hcintmsk</a>);
03161                         DWC_PRINTF(<span class="stringliteral">"    hfnum: 0x%08x\n"</span>, hfnum.<a class="code" href="unionhfnum__data.html#o0">d32</a>);
03162                         DWC_PRINTF(<span class="stringliteral">"    hcchar: 0x%08x\n"</span>, hcchar.<a class="code" href="unionhcchar__data.html#o0">d32</a>);
03163                         DWC_PRINTF(<span class="stringliteral">"    hctsiz: 0x%08x\n"</span>, hctsiz.<a class="code" href="unionhctsiz__data.html#o0">d32</a>);
03164                         DWC_PRINTF(<span class="stringliteral">"    hcint: 0x%08x\n"</span>, hcint.<a class="code" href="unionhcint__data.html#o0">d32</a>);
03165                         DWC_PRINTF(<span class="stringliteral">"    hcintmsk: 0x%08x\n"</span>, hcintmsk.<a class="code" href="unionhcintmsk__data.html#o0">d32</a>);
03166                 }
03167                 <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#z34_5">xfer_started</a> &amp;&amp; hc-&gt;<a class="code" href="structdwc__hc.html#z34_18">qh</a>) {
03168                         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd;
03169                         dwc_otg_hcd_urb_t *urb;
03170                         
03171                         DWC_CIRCLEQ_FOREACH(qtd, &amp;hc-&gt;<a class="code" href="structdwc__hc.html#z34_18">qh</a>-&gt;<a class="code" href="structdwc__otg__qh.html#o6">qtd_list</a>, qtd_list_entry) {
03172                                 <span class="keywordflow">if</span> (!qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o10">in_process</a>)
03173                                         <span class="keywordflow">break</span>;
03174                                 
03175                                 urb = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#o8">urb</a>;
03176                         DWC_PRINTF(<span class="stringliteral">"    URB Info:\n"</span>);
03177                         DWC_PRINTF(<span class="stringliteral">"      qtd: %p, urb: %p\n"</span>, qtd, urb);
03178                         <span class="keywordflow">if</span> (urb) {
03179                                 DWC_PRINTF(<span class="stringliteral">"      Dev: %d, EP: %d %s\n"</span>,
03180                                            dwc_otg_hcd_get_dev_addr(&amp;urb-&gt;
03181                                                                     pipe_info),
03182                                            dwc_otg_hcd_get_ep_num(&amp;urb-&gt;
03183                                                                   pipe_info),
03184                                            dwc_otg_hcd_is_pipe_in(&amp;urb-&gt;
03185                                                                   pipe_info) ?
03186                                            <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>);
03187                                 DWC_PRINTF(<span class="stringliteral">"      Max packet size: %d\n"</span>,
03188                                            dwc_otg_hcd_get_mps(&amp;urb-&gt;
03189                                                                pipe_info));
03190                                 DWC_PRINTF(<span class="stringliteral">"      transfer_buffer: %p\n"</span>,
03191                                            urb-&gt;buf);
03192                                 DWC_PRINTF(<span class="stringliteral">"      transfer_dma: %p\n"</span>,
03193                                            (<span class="keywordtype">void</span> *)urb-&gt;dma);
03194                                 DWC_PRINTF(<span class="stringliteral">"      transfer_buffer_length: %d\n"</span>,
03195                                            urb-&gt;length);
03196                                         DWC_PRINTF(<span class="stringliteral">"      actual_length: %d\n"</span>,
03197                                                    urb-&gt;actual_length);
03198                                 }
03199                         }
03200                 }
03201         }
03202         DWC_PRINTF(<span class="stringliteral">"  non_periodic_channels: %d\n"</span>, hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o16">non_periodic_channels</a>);
03203         DWC_PRINTF(<span class="stringliteral">"  periodic_channels: %d\n"</span>, hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o15">periodic_channels</a>);
03204         DWC_PRINTF(<span class="stringliteral">"  periodic_usecs: %d\n"</span>, hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o11">periodic_usecs</a>);
03205         np_tx_status.<a class="code" href="uniongnptxsts__data.html#o0">d32</a> =
03206             DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o11">gnptxsts</a>);
03207         DWC_PRINTF(<span class="stringliteral">"  NP Tx Req Queue Space Avail: %d\n"</span>,
03208                    np_tx_status.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o2">nptxqspcavail</a>);
03209         DWC_PRINTF(<span class="stringliteral">"  NP Tx FIFO Space Avail: %d\n"</span>,
03210                    np_tx_status.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o1">nptxfspcavail</a>);
03211         p_tx_status.<a class="code" href="uniongnptxsts__data.html#o0">d32</a> =
03212             DWC_READ_REG32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o3">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#o0">host_global_regs</a>-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#o4">hptxsts</a>);
03213         DWC_PRINTF(<span class="stringliteral">"  P Tx Req Queue Space Avail: %d\n"</span>,
03214                    p_tx_status.b.ptxqspcavail);
03215         DWC_PRINTF(<span class="stringliteral">"  P Tx FIFO Space Avail: %d\n"</span>, p_tx_status.b.ptxfspcavail);
03216         <a class="code" href="dwc__otg__hcd__if_8h.html#a24">dwc_otg_hcd_dump_frrem</a>(hcd);
03217         <a class="code" href="dwc__otg__core__if_8h.html#a161">dwc_otg_dump_global_registers</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>);
03218         <a class="code" href="dwc__otg__core__if_8h.html#a160">dwc_otg_dump_host_registers</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>);
03219         DWC_PRINTF
03220             (<span class="stringliteral">"************************************************************\n"</span>);
03221         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
03222 <span class="preprocessor">#endif</span>
03223 <span class="preprocessor"></span>}
03224 
03225 <span class="preprocessor">#ifdef DEBUG</span>
03226 <span class="preprocessor"></span><span class="keywordtype">void</span> dwc_print_setup_data(uint8_t * setup)
03227 {
03228         <span class="keywordtype">int</span> i;
03229         <span class="keywordflow">if</span> (CHK_DEBUG_LEVEL(DBG_HCD)) {
03230                 DWC_PRINTF(<span class="stringliteral">"Setup Data = MSB "</span>);
03231                 <span class="keywordflow">for</span> (i = 7; i &gt;= 0; i--)
03232                         DWC_PRINTF(<span class="stringliteral">"%02x "</span>, setup[i]);
03233                 DWC_PRINTF(<span class="stringliteral">"\n"</span>);
03234                 DWC_PRINTF(<span class="stringliteral">"  bmRequestType Tranfer = %s\n"</span>,
03235                            (setup[0] &amp; 0x80) ? <span class="stringliteral">"Device-to-Host"</span> :
03236                            <span class="stringliteral">"Host-to-Device"</span>);
03237                 DWC_PRINTF(<span class="stringliteral">"  bmRequestType Type = "</span>);
03238                 <span class="keywordflow">switch</span> ((setup[0] &amp; 0x60) &gt;&gt; 5) {
03239                 <span class="keywordflow">case</span> 0:
03240                         DWC_PRINTF(<span class="stringliteral">"Standard\n"</span>);
03241                         <span class="keywordflow">break</span>;
03242                 <span class="keywordflow">case</span> 1:
03243                         DWC_PRINTF(<span class="stringliteral">"Class\n"</span>);
03244                         <span class="keywordflow">break</span>;
03245                 <span class="keywordflow">case</span> 2:
03246                         DWC_PRINTF(<span class="stringliteral">"Vendor\n"</span>);
03247                         <span class="keywordflow">break</span>;
03248                 <span class="keywordflow">case</span> 3:
03249                         DWC_PRINTF(<span class="stringliteral">"Reserved\n"</span>);
03250                         <span class="keywordflow">break</span>;
03251                 }
03252                 DWC_PRINTF(<span class="stringliteral">"  bmRequestType Recipient = "</span>);
03253                 <span class="keywordflow">switch</span> (setup[0] &amp; 0x1f) {
03254                 <span class="keywordflow">case</span> 0:
03255                         DWC_PRINTF(<span class="stringliteral">"Device\n"</span>);
03256                         <span class="keywordflow">break</span>;
03257                 <span class="keywordflow">case</span> 1:
03258                         DWC_PRINTF(<span class="stringliteral">"Interface\n"</span>);
03259                         <span class="keywordflow">break</span>;
03260                 <span class="keywordflow">case</span> 2:
03261                         DWC_PRINTF(<span class="stringliteral">"Endpoint\n"</span>);
03262                         <span class="keywordflow">break</span>;
03263                 <span class="keywordflow">case</span> 3:
03264                         DWC_PRINTF(<span class="stringliteral">"Other\n"</span>);
03265                         <span class="keywordflow">break</span>;
03266                 <span class="keywordflow">default</span>:
03267                         DWC_PRINTF(<span class="stringliteral">"Reserved\n"</span>);
03268                         <span class="keywordflow">break</span>;
03269                 }
03270                 DWC_PRINTF(<span class="stringliteral">"  bRequest = 0x%0x\n"</span>, setup[1]);
03271                 DWC_PRINTF(<span class="stringliteral">"  wValue = 0x%0x\n"</span>, *((uint16_t *) &amp; setup[2]));
03272                 DWC_PRINTF(<span class="stringliteral">"  wIndex = 0x%0x\n"</span>, *((uint16_t *) &amp; setup[4]));
03273                 DWC_PRINTF(<span class="stringliteral">"  wLength = 0x%0x\n\n"</span>, *((uint16_t *) &amp; setup[6]));
03274         }
03275 }
03276 <span class="preprocessor">#endif</span>
03277 <span class="preprocessor"></span>
<a name="l03278"></a><a class="code" href="dwc__otg__hcd__if_8h.html#a24">03278</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__if_8h.html#a24">dwc_otg_hcd_dump_frrem</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
03279 {
03280 <span class="preprocessor">#if 0</span>
03281 <span class="preprocessor"></span>        DWC_PRINTF(<span class="stringliteral">"Frame remaining at SOF:\n"</span>);
03282         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03283                    hcd-&gt;frrem_samples, hcd-&gt;frrem_accum,
03284                    (hcd-&gt;frrem_samples &gt; 0) ?
03285                    hcd-&gt;frrem_accum / hcd-&gt;frrem_samples : 0);
03286 
03287         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
03288         DWC_PRINTF(<span class="stringliteral">"Frame remaining at start_transfer (uframe 7):\n"</span>);
03289         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03290                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_7_samples,
03291                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_7_frrem_accum,
03292                    (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_7_samples &gt;
03293                     0) ? hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_7_frrem_accum /
03294                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_7_samples : 0);
03295         DWC_PRINTF(<span class="stringliteral">"Frame remaining at start_transfer (uframe 0):\n"</span>);
03296         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03297                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_0_samples,
03298                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_0_frrem_accum,
03299                    (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_0_samples &gt;
03300                     0) ? hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_0_frrem_accum /
03301                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_0_samples : 0);
03302         DWC_PRINTF(<span class="stringliteral">"Frame remaining at start_transfer (uframe 1-6):\n"</span>);
03303         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03304                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_other_samples,
03305                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_other_frrem_accum,
03306                    (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_other_samples &gt;
03307                     0) ? hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_other_frrem_accum /
03308                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#o1">core_if</a>-&gt;hfnum_other_samples : 0);
03309 
03310         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
03311         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point A (uframe 7):\n"</span>);
03312         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03313                    hcd-&gt;hfnum_7_samples_a, hcd-&gt;hfnum_7_frrem_accum_a,
03314                    (hcd-&gt;hfnum_7_samples_a &gt; 0) ?
03315                    hcd-&gt;hfnum_7_frrem_accum_a / hcd-&gt;hfnum_7_samples_a : 0);
03316         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point A (uframe 0):\n"</span>);
03317         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03318                    hcd-&gt;hfnum_0_samples_a, hcd-&gt;hfnum_0_frrem_accum_a,
03319                    (hcd-&gt;hfnum_0_samples_a &gt; 0) ?
03320                    hcd-&gt;hfnum_0_frrem_accum_a / hcd-&gt;hfnum_0_samples_a : 0);
03321         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point A (uframe 1-6):\n"</span>);
03322         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03323                    hcd-&gt;hfnum_other_samples_a, hcd-&gt;hfnum_other_frrem_accum_a,
03324                    (hcd-&gt;hfnum_other_samples_a &gt; 0) ?
03325                    hcd-&gt;hfnum_other_frrem_accum_a /
03326                    hcd-&gt;hfnum_other_samples_a : 0);
03327 
03328         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
03329         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point B (uframe 7):\n"</span>);
03330         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03331                    hcd-&gt;hfnum_7_samples_b, hcd-&gt;hfnum_7_frrem_accum_b,
03332                    (hcd-&gt;hfnum_7_samples_b &gt; 0) ?
03333                    hcd-&gt;hfnum_7_frrem_accum_b / hcd-&gt;hfnum_7_samples_b : 0);
03334         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point B (uframe 0):\n"</span>);
03335         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03336                    hcd-&gt;hfnum_0_samples_b, hcd-&gt;hfnum_0_frrem_accum_b,
03337                    (hcd-&gt;hfnum_0_samples_b &gt; 0) ?
03338                    hcd-&gt;hfnum_0_frrem_accum_b / hcd-&gt;hfnum_0_samples_b : 0);
03339         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point B (uframe 1-6):\n"</span>);
03340         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
03341                    hcd-&gt;hfnum_other_samples_b, hcd-&gt;hfnum_other_frrem_accum_b,
03342                    (hcd-&gt;hfnum_other_samples_b &gt; 0) ?
03343                    hcd-&gt;hfnum_other_frrem_accum_b /
03344                    hcd-&gt;hfnum_other_samples_b : 0);
03345 <span class="preprocessor">#endif</span>
03346 <span class="preprocessor"></span>}
03347 
03348 <span class="preprocessor">#endif </span><span class="comment">/* DWC_DEVICE_ONLY */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 27 03:56:37 2011 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
