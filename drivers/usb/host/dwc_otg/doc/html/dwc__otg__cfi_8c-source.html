<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_cfi.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>dwc_otg_cfi.c</h1><a href="dwc__otg__cfi_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/* ==========================================================================</span>
00002 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
00003 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
00004 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
00005 <span class="comment"> * </span>
00006 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
00007 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
00008 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
00009 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
00010 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
00011 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
00012 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
00013 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
00014 <span class="comment"> * below, then you are not authorized to use the Software.</span>
00015 <span class="comment"> * </span>
00016 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
00017 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00018 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00019 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
00020 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
00021 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
00022 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
00023 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00024 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00025 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
00026 <span class="comment"> * DAMAGE.</span>
00027 <span class="comment"> * ========================================================================== */</span>
00028 
00035 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
00036 <span class="preprocessor"></span>
00037 <span class="preprocessor">#include "<a class="code" href="dwc__otg__pcd_8h.html">dwc_otg_pcd.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="dwc__otg__cfi_8h.html">dwc_otg_cfi.h</a>"</span>
00039 
00041 <span class="preprocessor">#define DWC_CONSTANT_CPU_TO_LE16(x) (x)</span>
00042 <span class="preprocessor"></span>
00043 <span class="keyword">extern</span> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *<a class="code" href="dwc__otg__pcd__intr_8c.html#a8">get_ep_by_addr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, u16 wIndex);
00044 
00045 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_core_features_buf(uint8_t * buf, uint16_t buflen);
00046 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_get_feature_value(uint8_t * buf, uint16_t buflen,
00047                                  <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
00048                                  <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *ctrl_req);
00049 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_set_feature_value(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd);
00050 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_get_sg_val(uint8_t * buf, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
00051                              <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *req);
00052 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_get_concat_val(uint8_t * buf, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
00053                                  <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *req);
00054 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_get_align_val(uint8_t * buf, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
00055                                 <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *req);
00056 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_preproc_reset(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
00057                              <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *req);
00058 <span class="keyword">static</span> <span class="keywordtype">void</span> cfi_free_ep_bs_dyn_data(<a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep);
00059 
00060 <span class="keyword">static</span> uint16_t get_dfifo_size(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if);
00061 <span class="keyword">static</span> int32_t get_rxfifo_size(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, uint16_t wValue);
00062 <span class="keyword">static</span> int32_t get_txfifo_size(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd, uint16_t wValue);
00063 
00064 <span class="keyword">static</span> uint8_t resize_fifos(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if);
00065 
00067 <span class="keyword">static</span> <a class="code" href="structcfi__all__features__header.html">cfi_all_features_header_t</a> all_props_desc_header = {
00068         .wVersion = DWC_CONSTANT_CPU_TO_LE16(0x100),
00069         .wCoreID = DWC_CONSTANT_CPU_TO_LE16(CFI_CORE_ID_OTG),
00070         .wNumFeatures = DWC_CONSTANT_CPU_TO_LE16(9),
00071 };
00072 
00074 <span class="keyword">static</span> <a class="code" href="structcfi__feature__desc__header.html">cfi_feature_desc_header_t</a> prop_descs[] = {
00075 
00076         <span class="comment">/* FT_ID_DMA_MODE */</span>
00077         {
00078          .wFeatureID = DWC_CONSTANT_CPU_TO_LE16(FT_ID_DMA_MODE),
00079          .bmAttributes = CFI_FEATURE_ATTR_RW,
00080          .wDataLength = DWC_CONSTANT_CPU_TO_LE16(1),
00081          },
00082 
00083         <span class="comment">/* FT_ID_DMA_BUFFER_SETUP */</span>
00084         {
00085          .wFeatureID = DWC_CONSTANT_CPU_TO_LE16(FT_ID_DMA_BUFFER_SETUP),
00086          .bmAttributes = CFI_FEATURE_ATTR_RW,
00087          .wDataLength = DWC_CONSTANT_CPU_TO_LE16(6),
00088          },
00089 
00090         <span class="comment">/* FT_ID_DMA_BUFF_ALIGN */</span>
00091         {
00092          .wFeatureID = DWC_CONSTANT_CPU_TO_LE16(FT_ID_DMA_BUFF_ALIGN),
00093          .bmAttributes = CFI_FEATURE_ATTR_RW,
00094          .wDataLength = DWC_CONSTANT_CPU_TO_LE16(2),
00095          },
00096 
00097         <span class="comment">/* FT_ID_DMA_CONCAT_SETUP */</span>
00098         {
00099          .wFeatureID = DWC_CONSTANT_CPU_TO_LE16(FT_ID_DMA_CONCAT_SETUP),
00100          .bmAttributes = CFI_FEATURE_ATTR_RW,
00101          <span class="comment">//.wDataLength  = DWC_CONSTANT_CPU_TO_LE16(6),</span>
00102          },
00103 
00104         <span class="comment">/* FT_ID_DMA_CIRCULAR */</span>
00105         {
00106          .wFeatureID = DWC_CONSTANT_CPU_TO_LE16(FT_ID_DMA_CIRCULAR),
00107          .bmAttributes = CFI_FEATURE_ATTR_RW,
00108          .wDataLength = DWC_CONSTANT_CPU_TO_LE16(6),
00109          },
00110 
00111         <span class="comment">/* FT_ID_THRESHOLD_SETUP */</span>
00112         {
00113          .wFeatureID = DWC_CONSTANT_CPU_TO_LE16(FT_ID_THRESHOLD_SETUP),
00114          .bmAttributes = CFI_FEATURE_ATTR_RW,
00115          .wDataLength = DWC_CONSTANT_CPU_TO_LE16(6),
00116          },
00117 
00118         <span class="comment">/* FT_ID_DFIFO_DEPTH */</span>
00119         {
00120          .wFeatureID = DWC_CONSTANT_CPU_TO_LE16(FT_ID_DFIFO_DEPTH),
00121          .bmAttributes = CFI_FEATURE_ATTR_RO,
00122          .wDataLength = DWC_CONSTANT_CPU_TO_LE16(2),
00123          },
00124 
00125         <span class="comment">/* FT_ID_TX_FIFO_DEPTH */</span>
00126         {
00127          .wFeatureID = DWC_CONSTANT_CPU_TO_LE16(FT_ID_TX_FIFO_DEPTH),
00128          .bmAttributes = CFI_FEATURE_ATTR_RW,
00129          .wDataLength = DWC_CONSTANT_CPU_TO_LE16(2),
00130          },
00131 
00132         <span class="comment">/* FT_ID_RX_FIFO_DEPTH */</span>
00133         {
00134          .wFeatureID = DWC_CONSTANT_CPU_TO_LE16(FT_ID_RX_FIFO_DEPTH),
00135          .bmAttributes = CFI_FEATURE_ATTR_RW,
00136          .wDataLength = DWC_CONSTANT_CPU_TO_LE16(2),
00137          }
00138 };
00139 
00141 <a class="code" href="structcfi__string.html">cfi_string_t</a> prop_name_table[] = {
00142         {FT_ID_DMA_MODE, <span class="stringliteral">"dma_mode"</span>},
00143         {FT_ID_DMA_BUFFER_SETUP, <span class="stringliteral">"buffer_setup"</span>},
00144         {FT_ID_DMA_BUFF_ALIGN, <span class="stringliteral">"buffer_align"</span>},
00145         {FT_ID_DMA_CONCAT_SETUP, <span class="stringliteral">"concat_setup"</span>},
00146         {FT_ID_DMA_CIRCULAR, <span class="stringliteral">"buffer_circular"</span>},
00147         {FT_ID_THRESHOLD_SETUP, <span class="stringliteral">"threshold_setup"</span>},
00148         {FT_ID_DFIFO_DEPTH, <span class="stringliteral">"dfifo_depth"</span>},
00149         {FT_ID_TX_FIFO_DEPTH, <span class="stringliteral">"txfifo_depth"</span>},
00150         {FT_ID_RX_FIFO_DEPTH, <span class="stringliteral">"rxfifo_depth"</span>},
00151         {}
00152 };
00153 
00154 <span class="comment">/************************************************************************/</span>
00155 
00161 <span class="keyword">const</span> uint8_t *get_prop_name(uint16_t prop_id, <span class="keywordtype">int</span> *len)
00162 {
00163         <a class="code" href="structcfi__string.html">cfi_string_t</a> *pstr;
00164         *len = 0;
00165 
00166         <span class="keywordflow">for</span> (pstr = prop_name_table; pstr &amp;&amp; pstr-&gt;<a class="code" href="structcfi__string.html#o1">s</a>; pstr++) {
00167                 <span class="keywordflow">if</span> (pstr-&gt;<a class="code" href="structcfi__string.html#o0">id</a> == prop_id) {
00168                         *len = DWC_STRLEN(pstr-&gt;<a class="code" href="structcfi__string.html#o1">s</a>);
00169                         <span class="keywordflow">return</span> pstr-&gt;<a class="code" href="structcfi__string.html#o1">s</a>;
00170                 }
00171         }
00172         <span class="keywordflow">return</span> NULL;
00173 }
00174 
00180 <span class="keywordtype">int</span> cfi_setup(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd, <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *ctrl)
00181 {
00182         <span class="keywordtype">int</span> retval = 0;
00183         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = NULL;
00184         cfiobject_t *cfi = pcd-&gt;cfi;
00185         <span class="keyword">struct </span><a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if</a> *coreif = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00186         uint16_t wLen = DWC_LE16_TO_CPU(&amp;ctrl-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o4">wLength</a>);
00187         uint16_t wValue = DWC_LE16_TO_CPU(&amp;ctrl-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a>);
00188         uint16_t wIndex = DWC_LE16_TO_CPU(&amp;ctrl-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o3">wIndex</a>);
00189         uint32_t regaddr = 0;
00190         uint32_t regval = 0;
00191 
00192         <span class="comment">/* Save this Control Request in the CFI object. </span>
00193 <span class="comment">         * The data field will be assigned in the data stage completion CB function.</span>
00194 <span class="comment">         */</span>
00195         cfi-&gt;ctrl_req = *ctrl;
00196         cfi-&gt;ctrl_req.<a class="code" href="structcfi__usb__ctrlrequest.html#o5">data</a> = NULL;
00197 
00198         cfi-&gt;need_gadget_att = 0;
00199         cfi-&gt;need_status_in_complete = 0;
00200 
00201         <span class="keywordflow">switch</span> (ctrl-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o1">bRequest</a>) {
00202         <span class="keywordflow">case</span> <a class="code" href="dwc__cfi__common_8h.html#a1">VEN_CORE_GET_FEATURES</a>:
00203                 retval = cfi_core_features_buf(cfi-&gt;buf_in.buf, CFI_IN_BUF_LEN);
00204                 <span class="keywordflow">if</span> (retval &gt;= 0) {
00205                         <span class="comment">//dump_msg(cfi-&gt;buf_in.buf, retval);</span>
00206                         ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00207 
00208                         retval = min((uint16_t) retval, wLen);
00209                         <span class="comment">/* Transfer this buffer to the host through the EP0-IN EP */</span>
00210                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = cfi-&gt;buf_in.addr;
00211                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = cfi-&gt;buf_in.buf;
00212                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = cfi-&gt;buf_in.buf;
00213                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = retval;
00214                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
00215                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
00216                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>;
00217 
00218                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 1;
00219                         <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(coreif, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
00220                 }
00221                 retval = 0;
00222                 <span class="keywordflow">break</span>;
00223 
00224         <span class="keywordflow">case</span> <a class="code" href="dwc__cfi__common_8h.html#a2">VEN_CORE_GET_FEATURE</a>:
00225                 CFI_INFO(<span class="stringliteral">"VEN_CORE_GET_FEATURE\n"</span>);
00226                 retval = cfi_get_feature_value(cfi-&gt;buf_in.buf, CFI_IN_BUF_LEN,
00227                                                pcd, ctrl);
00228                 <span class="keywordflow">if</span> (retval &gt;= 0) {
00229                         ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00230 
00231                         retval = min((uint16_t) retval, wLen);
00232                         <span class="comment">/* Transfer this buffer to the host through the EP0-IN EP */</span>
00233                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = cfi-&gt;buf_in.addr;
00234                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = cfi-&gt;buf_in.buf;
00235                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = cfi-&gt;buf_in.buf;
00236                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = retval;
00237                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
00238                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
00239                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>;
00240 
00241                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 1;
00242                         <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(coreif, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
00243                 }
00244                 CFI_INFO(<span class="stringliteral">"VEN_CORE_GET_FEATURE=%d\n"</span>, retval);
00245                 dump_msg(cfi-&gt;buf_in.buf, retval);
00246                 <span class="keywordflow">break</span>;
00247 
00248         <span class="keywordflow">case</span> <a class="code" href="dwc__cfi__common_8h.html#a3">VEN_CORE_SET_FEATURE</a>:
00249                 CFI_INFO(<span class="stringliteral">"VEN_CORE_SET_FEATURE\n"</span>);
00250                 <span class="comment">/* Set up an XFER to get the data stage of the control request,</span>
00251 <span class="comment">                 * which is the new value of the feature to be modified.</span>
00252 <span class="comment">                 */</span>
00253                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00254                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 0;
00255                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = cfi-&gt;buf_out.addr;
00256                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = cfi-&gt;buf_out.buf;
00257                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = cfi-&gt;buf_out.buf;
00258                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = wLen;
00259                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
00260                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
00261                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>;
00262 
00263                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 1;
00264                 <span class="comment">/* Read the control write's data stage */</span>
00265                 <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(coreif, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
00266                 retval = 0;
00267                 <span class="keywordflow">break</span>;
00268 
00269         <span class="keywordflow">case</span> <a class="code" href="dwc__cfi__common_8h.html#a4">VEN_CORE_RESET_FEATURES</a>:
00270                 CFI_INFO(<span class="stringliteral">"VEN_CORE_RESET_FEATURES\n"</span>);
00271                 cfi-&gt;need_gadget_att = 1;
00272                 cfi-&gt;need_status_in_complete = 1;
00273                 retval = cfi_preproc_reset(pcd, ctrl);
00274                 CFI_INFO(<span class="stringliteral">"VEN_CORE_RESET_FEATURES = (%d)\n"</span>, retval);
00275                 <span class="keywordflow">break</span>;
00276 
00277         <span class="keywordflow">case</span> <a class="code" href="dwc__cfi__common_8h.html#a5">VEN_CORE_ACTIVATE_FEATURES</a>:
00278                 CFI_INFO(<span class="stringliteral">"VEN_CORE_ACTIVATE_FEATURES\n"</span>);
00279                 <span class="keywordflow">break</span>;
00280 
00281         <span class="keywordflow">case</span> <a class="code" href="dwc__cfi__common_8h.html#a6">VEN_CORE_READ_REGISTER</a>:
00282                 CFI_INFO(<span class="stringliteral">"VEN_CORE_READ_REGISTER\n"</span>);
00283                 <span class="comment">/* wValue optionally contains the HI WORD of the register offset and</span>
00284 <span class="comment">                 * wIndex contains the LOW WORD of the register offset </span>
00285 <span class="comment">                 */</span>
00286                 <span class="keywordflow">if</span> (wValue == 0) {
00287                         <span class="comment">/* @TODO - MAS - fix the access to the base field */</span>
00288                         regaddr = 0;
00289                         <span class="comment">//regaddr = (uint32_t) pcd-&gt;otg_dev-&gt;os_dep.base;</span>
00290                         <span class="comment">//GET_CORE_IF(pcd)-&gt;co</span>
00291                         regaddr |= wIndex;
00292                 } <span class="keywordflow">else</span> {
00293                         regaddr = (wValue &lt;&lt; 16) | wIndex;
00294                 }
00295 
00296                 <span class="comment">/* Read a 32-bit value of the memory at the regaddr */</span>
00297                 regval = DWC_READ_REG32((uint32_t *) regaddr);
00298 
00299                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00300                 dwc_memcpy(cfi-&gt;buf_in.buf, &amp;regval, <span class="keyword">sizeof</span>(uint32_t));
00301                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 1;
00302                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = cfi-&gt;buf_in.addr;
00303                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = cfi-&gt;buf_in.buf;
00304                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = cfi-&gt;buf_in.buf;
00305                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = wLen;
00306                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
00307                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
00308                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>;
00309 
00310                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 1;
00311                 <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(coreif, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
00312                 cfi-&gt;need_gadget_att = 0;
00313                 retval = 0;
00314                 <span class="keywordflow">break</span>;
00315 
00316         <span class="keywordflow">case</span> <a class="code" href="dwc__cfi__common_8h.html#a7">VEN_CORE_WRITE_REGISTER</a>:
00317                 CFI_INFO(<span class="stringliteral">"VEN_CORE_WRITE_REGISTER\n"</span>);
00318                 <span class="comment">/* Set up an XFER to get the data stage of the control request,</span>
00319 <span class="comment">                 * which is the new value of the register to be modified.</span>
00320 <span class="comment">                 */</span>
00321                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00322                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 0;
00323                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = cfi-&gt;buf_out.addr;
00324                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = cfi-&gt;buf_out.buf;
00325                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = cfi-&gt;buf_out.buf;
00326                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = wLen;
00327                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
00328                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
00329                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>;
00330 
00331                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 1;
00332                 <span class="comment">/* Read the control write's data stage */</span>
00333                 <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(coreif, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
00334                 retval = 0;
00335                 <span class="keywordflow">break</span>;
00336 
00337         <span class="keywordflow">default</span>:
00338                 retval = -DWC_E_NOT_SUPPORTED;
00339                 <span class="keywordflow">break</span>;
00340         }
00341 
00342         <span class="keywordflow">return</span> retval;
00343 }
00344 
00356 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_core_features_buf(uint8_t * buf, uint16_t buflen)
00357 {
00358         <a class="code" href="structcfi__feature__desc__header.html">cfi_feature_desc_header_t</a> *prop_hdr = prop_descs;
00359         <a class="code" href="structcfi__feature__desc__header.html">cfi_feature_desc_header_t</a> *prop;
00360         <a class="code" href="structcfi__all__features__header.html">cfi_all_features_header_t</a> *all_props_hdr = &amp;all_props_desc_header;
00361         <a class="code" href="structcfi__all__features__header.html">cfi_all_features_header_t</a> *tmp;
00362         uint8_t *tmpbuf = buf;
00363         <span class="keyword">const</span> uint8_t *pname = NULL;
00364         <span class="keywordtype">int</span> i, j, namelen = 0, totlen;
00365 
00366         <span class="comment">/* Prepare and copy the core features into the buffer */</span>
00367         CFI_INFO(<span class="stringliteral">"%s:\n"</span>, __func__);
00368 
00369         tmp = (<a class="code" href="structcfi__all__features__header.html">cfi_all_features_header_t</a> *) tmpbuf;
00370         *tmp = *all_props_hdr;
00371         tmpbuf += CFI_ALL_FEATURES_HDR_LEN;
00372 
00373         j = <span class="keyword">sizeof</span>(prop_descs) / <span class="keyword">sizeof</span>(<a class="code" href="structcfi__all__features__header.html">cfi_all_features_header_t</a>);
00374         <span class="keywordflow">for</span> (i = 0; i &lt; j; i++, prop_hdr++) {
00375                 pname = get_prop_name(prop_hdr-&gt;<a class="code" href="structcfi__feature__desc__header.html#o0">wFeatureID</a>, &amp;namelen);
00376                 prop = (<a class="code" href="structcfi__feature__desc__header.html">cfi_feature_desc_header_t</a> *) tmpbuf;
00377                 *prop = *prop_hdr;
00378 
00379                 prop-&gt;<a class="code" href="structcfi__feature__desc__header.html#o4">bNameLen</a> = namelen;
00380                 prop-&gt;<a class="code" href="structcfi__feature__desc__header.html#o1">wLength</a> =
00381                     DWC_CONSTANT_CPU_TO_LE16(CFI_FEATURE_DESC_HDR_LEN +
00382                                              namelen);
00383 
00384                 tmpbuf += CFI_FEATURE_DESC_HDR_LEN;
00385                 dwc_memcpy(tmpbuf, pname, namelen);
00386                 tmpbuf += namelen;
00387         }
00388 
00389         totlen = tmpbuf - buf;
00390 
00391         <span class="keywordflow">if</span> (totlen &gt; 0) {
00392                 tmp = (<a class="code" href="structcfi__all__features__header.html">cfi_all_features_header_t</a> *) buf;
00393                 tmp-&gt;<a class="code" href="structcfi__all__features__header.html#o0">wTotalLen</a> = DWC_CONSTANT_CPU_TO_LE16(totlen);
00394         }
00395 
00396         <span class="keywordflow">return</span> totlen;
00397 }
00398 
00402 <span class="keyword">static</span> <span class="keywordtype">void</span> cfi_release(cfiobject_t * cfiobj)
00403 {
00404         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *cfiep;
00405         dwc_list_link_t *tmp;
00406 
00407         CFI_INFO(<span class="stringliteral">"%s\n"</span>, __func__);
00408 
00409         <span class="keywordflow">if</span> (cfiobj-&gt;buf_in.buf) {
00410                 DWC_DMA_FREE(CFI_IN_BUF_LEN, cfiobj-&gt;buf_in.buf,
00411                              cfiobj-&gt;buf_in.addr);
00412                 cfiobj-&gt;buf_in.buf = NULL;
00413         }
00414 
00415         <span class="keywordflow">if</span> (cfiobj-&gt;buf_out.buf) {
00416                 DWC_DMA_FREE(CFI_OUT_BUF_LEN, cfiobj-&gt;buf_out.buf,
00417                              cfiobj-&gt;buf_out.addr);
00418                 cfiobj-&gt;buf_out.buf = NULL;
00419         }
00420 
00421         <span class="comment">/* Free the Buffer Setup values for each EP */</span>
00422         <span class="comment">//list_for_each_entry(cfiep, &amp;cfiobj-&gt;active_eps, lh) {</span>
00423         DWC_LIST_FOREACH(tmp, &amp;cfiobj-&gt;active_eps) {
00424                 cfiep = DWC_LIST_ENTRY(tmp, <span class="keyword">struct</span> <a class="code" href="structcfi__ep.html">cfi_ep</a>, lh);
00425                 cfi_free_ep_bs_dyn_data(cfiep);
00426         }
00427 }
00428 
00432 <span class="keyword">static</span> <span class="keywordtype">void</span> cfi_free_ep_bs_dyn_data(<a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep)
00433 {
00434         <span class="keywordflow">if</span> (cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>) {
00435                 DWC_FREE(cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>);
00436                 cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a> = NULL;
00437         }
00438 
00439         <span class="keywordflow">if</span> (cfiep-&gt;<a class="code" href="structcfi__ep.html#o6">bm_align</a>) {
00440                 DWC_FREE(cfiep-&gt;<a class="code" href="structcfi__ep.html#o6">bm_align</a>);
00441                 cfiep-&gt;<a class="code" href="structcfi__ep.html#o6">bm_align</a> = NULL;
00442         }
00443 
00444         <span class="keywordflow">if</span> (cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>) {
00445                 <span class="keywordflow">if</span> (NULL != cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>) {
00446                         DWC_FREE(cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>);
00447                         cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a> = NULL;
00448                 }
00449                 DWC_FREE(cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>);
00450                 cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a> = NULL;
00451         }
00452 }
00453 
00459 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_init_defaults(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd, <a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep)
00460 {
00461         <span class="keywordtype">int</span> retval = 0;
00462 
00463         cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a> = DWC_ALLOC(<span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__sg__buffer__setup.html">ddma_sg_buffer_setup_t</a>));
00464         <span class="keywordflow">if</span> (NULL == cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>) {
00465                 CFI_INFO(<span class="stringliteral">"Failed to allocate memory for SG feature value\n"</span>);
00466                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
00467         }
00468         dwc_memset(cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__sg__buffer__setup.html">ddma_sg_buffer_setup_t</a>));
00469 
00470         <span class="comment">/* For the Concatenation feature's default value we do not allocate</span>
00471 <span class="comment">         * memory for the wTxBytes field - it will be done in the set_feature_value</span>
00472 <span class="comment">         * request handler.</span>
00473 <span class="comment">         */</span>
00474         cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a> = DWC_ALLOC(<span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__concat__buffer__setup.html">ddma_concat_buffer_setup_t</a>));
00475         <span class="keywordflow">if</span> (NULL == cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>) {
00476                 CFI_INFO
00477                     (<span class="stringliteral">"Failed to allocate memory for CONCATENATION feature value\n"</span>);
00478                 DWC_FREE(cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>);
00479                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
00480         }
00481         dwc_memset(cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__concat__buffer__setup.html">ddma_concat_buffer_setup_t</a>));
00482 
00483         cfiep-&gt;<a class="code" href="structcfi__ep.html#o6">bm_align</a> = DWC_ALLOC(<span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__align__buffer__setup.html">ddma_align_buffer_setup_t</a>));
00484         <span class="keywordflow">if</span> (NULL == cfiep-&gt;<a class="code" href="structcfi__ep.html#o6">bm_align</a>) {
00485                 CFI_INFO
00486                     (<span class="stringliteral">"Failed to allocate memory for Alignment feature value\n"</span>);
00487                 DWC_FREE(cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>);
00488                 DWC_FREE(cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>);
00489                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
00490         }
00491         dwc_memset(cfiep-&gt;<a class="code" href="structcfi__ep.html#o6">bm_align</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__align__buffer__setup.html">ddma_align_buffer_setup_t</a>));
00492 
00493         <span class="keywordflow">return</span> retval;
00494 }
00495 
00507 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_enable(<span class="keyword">struct</span> cfiobject *cfi, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
00508                          <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> *ep)
00509 {
00510         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *cfiep;
00511         <span class="keywordtype">int</span> retval = -DWC_E_NOT_SUPPORTED;
00512 
00513         CFI_INFO(<span class="stringliteral">"%s: epname=%s; epnum=0x%02x\n"</span>, __func__,
00514                  <span class="stringliteral">"EP_"</span> <span class="comment">/*ep-&gt;ep.name */</span> , ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>-&gt;bEndpointAddress);
00515         <span class="comment">/* MAS - Check whether this endpoint already is in the list */</span>
00516         cfiep = <a class="code" href="dwc__otg__cfi_8h.html#a34">get_cfi_ep_by_pcd_ep</a>(cfi, ep);
00517 
00518         <span class="keywordflow">if</span> (NULL == cfiep) {
00519                 <span class="comment">/* Allocate a cfi_ep_t object */</span>
00520                 cfiep = DWC_ALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structcfi__ep.html">cfi_ep_t</a>));
00521                 <span class="keywordflow">if</span> (NULL == cfiep) {
00522                         CFI_INFO
00523                             (<span class="stringliteral">"Unable to allocate memory for &lt;cfiep&gt; in function %s\n"</span>,
00524                              __func__);
00525                         <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
00526                 }
00527                 dwc_memset(cfiep, 0, <span class="keyword">sizeof</span>(<a class="code" href="structcfi__ep.html">cfi_ep_t</a>));
00528 
00529                 <span class="comment">/* Save the dwc_otg_pcd_ep pointer in the cfiep object */</span>
00530                 cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a> = ep;
00531 
00532                 <span class="comment">/* Allocate the DMA Descriptors chain of MAX_DMA_DESCS_PER_EP count */</span>
00533                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.descs =
00534                     DWC_DMA_ALLOC(MAX_DMA_DESCS_PER_EP *
00535                                   <span class="keyword">sizeof</span>(dwc_otg_dma_desc_t),
00536                                   &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.descs_dma_addr);
00537 
00538                 <span class="keywordflow">if</span> (NULL == ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.descs) {
00539                         DWC_FREE(cfiep);
00540                         <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
00541                 }
00542 
00543                 DWC_LIST_INIT(&amp;cfiep-&gt;<a class="code" href="structcfi__ep.html#o0">lh</a>);
00544 
00545                 <span class="comment">/* Set the buffer mode to BM_STANDARD. It will be modified </span>
00546 <span class="comment">                 * when building descriptors for a specific buffer mode */</span>
00547                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode = BM_STANDARD;
00548 
00549                 <span class="comment">/* Create and initialize the default values for this EP's Buffer modes */</span>
00550                 <span class="keywordflow">if</span> ((retval = cfi_ep_init_defaults(pcd, cfiep)) &lt; 0)
00551                         <span class="keywordflow">return</span> retval;
00552 
00553                 <span class="comment">/* Add the cfi_ep_t object to the CFI object's list of active endpoints */</span>
00554                 DWC_LIST_INSERT_TAIL(&amp;cfi-&gt;active_eps, &amp;cfiep-&gt;<a class="code" href="structcfi__ep.html#o0">lh</a>);
00555                 retval = 0;
00556         } <span class="keywordflow">else</span> {                <span class="comment">/* The sought EP already is in the list */</span>
00557                 CFI_INFO(<span class="stringliteral">"%s: The sought EP already is in the list\n"</span>,
00558                          __func__);
00559         }
00560 
00561         <span class="keywordflow">return</span> retval;
00562 }
00563 
00569 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ctrl_write_complete(<span class="keyword">struct</span> cfiobject *cfi,
00570                                    <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd)
00571 {
00572         uint32_t addr, reg_value;
00573         uint16_t wIndex, wValue;
00574         uint8_t bRequest;
00575         uint8_t *buf = cfi-&gt;buf_out.buf;
00576         <span class="comment">//struct usb_ctrlrequest *ctrl_req = &amp;cfi-&gt;ctrl_req_saved;</span>
00577         <span class="keyword">struct </span><a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *ctrl_req = &amp;cfi-&gt;ctrl_req;
00578         <span class="keywordtype">int</span> retval = -DWC_E_NOT_SUPPORTED;
00579 
00580         CFI_INFO(<span class="stringliteral">"%s\n"</span>, __func__);
00581 
00582         bRequest = ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o1">bRequest</a>;
00583         wIndex = DWC_CONSTANT_CPU_TO_LE16(ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o3">wIndex</a>);
00584         wValue = DWC_CONSTANT_CPU_TO_LE16(ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a>);
00585 
00586         <span class="comment">/* </span>
00587 <span class="comment">         * Save the pointer to the data stage in the ctrl_req's &lt;data&gt; field.</span>
00588 <span class="comment">         * The request should be already saved in the command stage by now.</span>
00589 <span class="comment">         */</span>
00590         ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o5">data</a> = cfi-&gt;buf_out.buf;
00591         cfi-&gt;need_status_in_complete = 0;
00592         cfi-&gt;need_gadget_att = 0;
00593 
00594         <span class="keywordflow">switch</span> (bRequest) {
00595         <span class="keywordflow">case</span> <a class="code" href="dwc__cfi__common_8h.html#a7">VEN_CORE_WRITE_REGISTER</a>:
00596                 <span class="comment">/* The buffer contains raw data of the new value for the register */</span>
00597                 reg_value = *((uint32_t *) buf);
00598                 <span class="keywordflow">if</span> (wValue == 0) {
00599                         addr = 0;
00600                         <span class="comment">//addr = (uint32_t) pcd-&gt;otg_dev-&gt;os_dep.base;</span>
00601                         addr += wIndex;
00602                 } <span class="keywordflow">else</span> {
00603                         addr = (wValue &lt;&lt; 16) | wIndex;
00604                 }
00605 
00606                 <span class="comment">//writel(reg_value, addr);</span>
00607 
00608                 retval = 0;
00609                 cfi-&gt;need_status_in_complete = 1;
00610                 <span class="keywordflow">break</span>;
00611 
00612         <span class="keywordflow">case</span> <a class="code" href="dwc__cfi__common_8h.html#a3">VEN_CORE_SET_FEATURE</a>:
00613                 <span class="comment">/* The buffer contains raw data of the new value of the feature */</span>
00614                 retval = cfi_set_feature_value(pcd);
00615                 <span class="keywordflow">if</span> (retval &lt; 0)
00616                         <span class="keywordflow">return</span> retval;
00617 
00618                 cfi-&gt;need_status_in_complete = 1;
00619                 <span class="keywordflow">break</span>;
00620 
00621         <span class="keywordflow">default</span>:
00622                 <span class="keywordflow">break</span>;
00623         }
00624 
00625         <span class="keywordflow">return</span> retval;
00626 }
00627 
00631 <span class="keyword">static</span> <span class="keywordtype">void</span> cfi_build_sg_descs(<span class="keyword">struct</span> cfiobject *cfi, <a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep,
00632                                <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req)
00633 {
00634         <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> *ep = cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>;
00635         <a class="code" href="struct__ddma__sg__buffer__setup.html">ddma_sg_buffer_setup_t</a> *sgval = cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>;
00636         <span class="keyword">struct </span>dwc_otg_dma_desc *desc = cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.descs;
00637         <span class="keyword">struct </span>dwc_otg_dma_desc *desc_last = cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.descs;
00638         dma_addr_t buff_addr = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o2">dma</a>;
00639         <span class="keywordtype">int</span> i;
00640         uint32_t txsize, off;
00641 
00642         txsize = sgval-&gt;<a class="code" href="struct__ddma__sg__buffer__setup.html#o4">wSize</a>;
00643         off = sgval-&gt;<a class="code" href="struct__ddma__sg__buffer__setup.html#o2">bOffset</a>;
00644 
00645 <span class="comment">//      CFI_INFO("%s: %s TXSIZE=0x%08x; OFFSET=0x%08x\n", </span>
00646 <span class="comment">//              __func__, cfiep-&gt;ep-&gt;ep.name, txsize, off);</span>
00647 
00648         <span class="keywordflow">for</span> (i = 0; i &lt; sgval-&gt;<a class="code" href="struct__ddma__sg__buffer__setup.html#o3">bCount</a>; i++) {
00649                 desc-&gt;status.b.bs = BS_HOST_BUSY;
00650                 desc-&gt;buf = buff_addr;
00651                 desc-&gt;status.b.l = 0;
00652                 desc-&gt;status.b.ioc = 0;
00653                 desc-&gt;status.b.sp = 0;
00654                 desc-&gt;status.b.bytes = txsize;
00655                 desc-&gt;status.b.bs = BS_HOST_READY;
00656 
00657                 <span class="comment">/* Set the next address of the buffer */</span>
00658                 buff_addr += txsize + off;
00659                 desc_last = desc;
00660                 desc++;
00661         }
00662 
00663         <span class="comment">/* Set the last, ioc and sp bits on the Last DMA Descriptor */</span>
00664         desc_last-&gt;status.b.l = 1;
00665         desc_last-&gt;status.b.ioc = 1;
00666         desc_last-&gt;status.b.sp = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a>;
00667         <span class="comment">/* Save the last DMA descriptor pointer */</span>
00668         cfiep-&gt;<a class="code" href="structcfi__ep.html#o2">dma_desc_last</a> = desc_last;
00669         cfiep-&gt;<a class="code" href="structcfi__ep.html#o8">desc_count</a> = sgval-&gt;<a class="code" href="struct__ddma__sg__buffer__setup.html#o3">bCount</a>;
00670 }
00671 
00675 <span class="keyword">static</span> <span class="keywordtype">void</span> cfi_build_concat_descs(<span class="keyword">struct</span> cfiobject *cfi, <a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep,
00676                                    <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req)
00677 {
00678         <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> *ep = cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>;
00679         <a class="code" href="struct__ddma__concat__buffer__setup.html">ddma_concat_buffer_setup_t</a> *concatval = cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>;
00680         <span class="keyword">struct </span>dwc_otg_dma_desc *desc = cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.descs;
00681         <span class="keyword">struct </span>dwc_otg_dma_desc *desc_last = cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.descs;
00682         dma_addr_t buff_addr = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o2">dma</a>;
00683         <span class="keywordtype">int</span> i;
00684         uint16_t *txsize;
00685 
00686         txsize = concatval-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>;
00687 
00688         <span class="keywordflow">for</span> (i = 0; i &lt; concatval-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o0">hdr</a>.<a class="code" href="struct__ddma__concat__buffer__setup__hdr.html#o1">bDescCount</a>; i++) {
00689                 desc-&gt;buf = buff_addr;
00690                 desc-&gt;status.b.bs = BS_HOST_BUSY;
00691                 desc-&gt;status.b.l = 0;
00692                 desc-&gt;status.b.ioc = 0;
00693                 desc-&gt;status.b.sp = 0;
00694                 desc-&gt;status.b.bytes = *txsize;
00695                 desc-&gt;status.b.bs = BS_HOST_READY;
00696 
00697                 txsize++;
00698                 <span class="comment">/* Set the next address of the buffer */</span>
00699                 buff_addr += UGETW(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>-&gt;wMaxPacketSize);
00700                 desc_last = desc;
00701                 desc++;
00702         }
00703 
00704         <span class="comment">/* Set the last, ioc and sp bits on the Last DMA Descriptor */</span>
00705         desc_last-&gt;status.b.l = 1;
00706         desc_last-&gt;status.b.ioc = 1;
00707         desc_last-&gt;status.b.sp = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a>;
00708         cfiep-&gt;<a class="code" href="structcfi__ep.html#o2">dma_desc_last</a> = desc_last;
00709         cfiep-&gt;<a class="code" href="structcfi__ep.html#o8">desc_count</a> = concatval-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o0">hdr</a>.<a class="code" href="struct__ddma__concat__buffer__setup__hdr.html#o1">bDescCount</a>;
00710 }
00711 
00715 <span class="keyword">static</span> <span class="keywordtype">void</span> cfi_build_circ_descs(<span class="keyword">struct</span> cfiobject *cfi, <a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep,
00716                                  <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req)
00717 {
00718         <span class="comment">/* @todo: MAS - add implementation when this feature needs to be tested */</span>
00719 }
00720 
00724 <span class="keyword">static</span> <span class="keywordtype">void</span> cfi_build_align_descs(<span class="keyword">struct</span> cfiobject *cfi, <a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep,
00725                                   <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req)
00726 {
00727         <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> *ep = cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>;
00728         <a class="code" href="struct__ddma__align__buffer__setup.html">ddma_align_buffer_setup_t</a> *alignval = cfiep-&gt;<a class="code" href="structcfi__ep.html#o6">bm_align</a>;
00729         <span class="keyword">struct </span>dwc_otg_dma_desc *desc = cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.descs;
00730         dma_addr_t buff_addr = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o2">dma</a>;
00731 
00732         desc-&gt;status.b.bs = BS_HOST_BUSY;
00733         desc-&gt;status.b.l = 1;
00734         desc-&gt;status.b.ioc = 1;
00735         desc-&gt;status.b.sp = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a>;
00736         desc-&gt;status.b.bytes = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a>;
00737         <span class="comment">/* Adjust the buffer alignment */</span>
00738         desc-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o1">buf</a> = (buff_addr + alignval-&gt;<a class="code" href="struct__ddma__align__buffer__setup.html#o1">bAlign</a>);
00739         desc-&gt;status.b.bs = BS_HOST_READY;
00740         cfiep-&gt;<a class="code" href="structcfi__ep.html#o2">dma_desc_last</a> = desc;
00741         cfiep-&gt;<a class="code" href="structcfi__ep.html#o8">desc_count</a> = 1;
00742 }
00743 
00748 <span class="keyword">static</span> <span class="keywordtype">void</span> cfi_build_descriptors(<span class="keyword">struct</span> cfiobject *cfi,
00749                                   <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
00750                                   <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> *ep,
00751                                   <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req)
00752 {
00753         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *cfiep;
00754 
00755         <span class="comment">/* Get the cfiep by the dwc_otg_pcd_ep */</span>
00756         cfiep = <a class="code" href="dwc__otg__cfi_8h.html#a34">get_cfi_ep_by_pcd_ep</a>(cfi, ep);
00757         <span class="keywordflow">if</span> (NULL == cfiep) {
00758                 CFI_INFO(<span class="stringliteral">"%s: Unable to find a matching active endpoint\n"</span>,
00759                          __func__);
00760                 <span class="keywordflow">return</span>;
00761         }
00762 
00763         cfiep-&gt;<a class="code" href="structcfi__ep.html#o7">xfer_len</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a>;
00764 
00765         <span class="comment">/* Iterate through all the DMA descriptors */</span>
00766         <span class="keywordflow">switch</span> (cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode) {
00767         <span class="keywordflow">case</span> BM_SG:
00768                 cfi_build_sg_descs(cfi, cfiep, req);
00769                 <span class="keywordflow">break</span>;
00770 
00771         <span class="keywordflow">case</span> BM_CONCAT:
00772                 cfi_build_concat_descs(cfi, cfiep, req);
00773                 <span class="keywordflow">break</span>;
00774 
00775         <span class="keywordflow">case</span> BM_CIRCULAR:
00776                 cfi_build_circ_descs(cfi, cfiep, req);
00777                 <span class="keywordflow">break</span>;
00778 
00779         <span class="keywordflow">case</span> BM_ALIGN:
00780                 cfi_build_align_descs(cfi, cfiep, req);
00781                 <span class="keywordflow">break</span>;
00782 
00783         <span class="keywordflow">default</span>:
00784                 <span class="keywordflow">break</span>;
00785         }
00786 }
00787 
00791 <span class="keyword">static</span> <span class="keywordtype">void</span> *cfi_ep_alloc_buf(<span class="keyword">struct</span> cfiobject *cfi, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
00792                               <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep</a> *ep, dma_addr_t * dma,
00793                               <span class="keywordtype">unsigned</span> size, gfp_t flags)
00794 {
00795         <span class="keywordflow">return</span> DWC_DMA_ALLOC(size, dma);
00796 }
00797 
00801 <span class="keywordtype">int</span> init_cfi(cfiobject_t * cfiobj)
00802 {
00803         CFI_INFO(<span class="stringliteral">"%s\n"</span>, __func__);
00804 
00805         <span class="comment">/* Allocate a buffer for IN XFERs */</span>
00806         cfiobj-&gt;buf_in.<a class="code" href="structdwc__otg__pcd__request.html#o1">buf</a> =
00807             DWC_DMA_ALLOC(CFI_IN_BUF_LEN, &amp;cfiobj-&gt;buf_in.addr);
00808         <span class="keywordflow">if</span> (NULL == cfiobj-&gt;buf_in.buf) {
00809                 CFI_INFO(<span class="stringliteral">"Unable to allocate buffer for INs\n"</span>);
00810                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
00811         }
00812 
00813         <span class="comment">/* Allocate a buffer for OUT XFERs */</span>
00814         cfiobj-&gt;buf_out.<a class="code" href="structdwc__otg__pcd__request.html#o1">buf</a> =
00815             DWC_DMA_ALLOC(CFI_OUT_BUF_LEN, &amp;cfiobj-&gt;buf_out.addr);
00816         <span class="keywordflow">if</span> (NULL == cfiobj-&gt;buf_out.buf) {
00817                 CFI_INFO(<span class="stringliteral">"Unable to allocate buffer for OUT\n"</span>);
00818                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
00819         }
00820 
00821         <span class="comment">/* Initialize the callback function pointers */</span>
00822         cfiobj-&gt;ops.release = cfi_release;
00823         cfiobj-&gt;ops.ep_enable = cfi_ep_enable;
00824         cfiobj-&gt;ops.ctrl_write_complete = cfi_ctrl_write_complete;
00825         cfiobj-&gt;ops.build_descriptors = cfi_build_descriptors;
00826         cfiobj-&gt;ops.ep_alloc_buf = cfi_ep_alloc_buf;
00827 
00828         <span class="comment">/* Initialize the list of active endpoints in the CFI object */</span>
00829         DWC_LIST_INIT(&amp;cfiobj-&gt;active_eps);
00830 
00831         <span class="keywordflow">return</span> 0;
00832 }
00833 
00839 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_get_feature_value(uint8_t * buf, uint16_t buflen,
00840                                  <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
00841                                  <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *ctrl_req)
00842 {
00843         <span class="keywordtype">int</span> retval = -DWC_E_NOT_SUPPORTED;
00844         <span class="keyword">struct </span><a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if</a> *coreif = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00845         uint16_t dfifo, rxfifo, txfifo;
00846 
00847         <span class="keywordflow">switch</span> (ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o3">wIndex</a>) {
00848                 <span class="comment">/* Whether the DDMA is enabled or not */</span>
00849         <span class="keywordflow">case</span> <a class="code" href="dwc__otg__cfi_8h.html#a1">FT_ID_DMA_MODE</a>:
00850                 *buf = (coreif-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a> &amp;&amp; coreif-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) ? 1 : 0;
00851                 retval = 1;
00852                 <span class="keywordflow">break</span>;
00853 
00854         <span class="keywordflow">case</span> FT_ID_DMA_BUFFER_SETUP:
00855                 retval = cfi_ep_get_sg_val(buf, pcd, ctrl_req);
00856                 <span class="keywordflow">break</span>;
00857 
00858         <span class="keywordflow">case</span> FT_ID_DMA_BUFF_ALIGN:
00859                 retval = cfi_ep_get_align_val(buf, pcd, ctrl_req);
00860                 <span class="keywordflow">break</span>;
00861 
00862         <span class="keywordflow">case</span> FT_ID_DMA_CONCAT_SETUP:
00863                 retval = cfi_ep_get_concat_val(buf, pcd, ctrl_req);
00864                 <span class="keywordflow">break</span>;
00865 
00866         <span class="keywordflow">case</span> FT_ID_DMA_CIRCULAR:
00867                 CFI_INFO(<span class="stringliteral">"GetFeature value (FT_ID_DMA_CIRCULAR)\n"</span>);
00868                 <span class="keywordflow">break</span>;
00869 
00870         <span class="keywordflow">case</span> FT_ID_THRESHOLD_SETUP:
00871                 CFI_INFO(<span class="stringliteral">"GetFeature value (FT_ID_THRESHOLD_SETUP)\n"</span>);
00872                 <span class="keywordflow">break</span>;
00873 
00874         <span class="keywordflow">case</span> FT_ID_DFIFO_DEPTH:
00875                 dfifo = get_dfifo_size(coreif);
00876                 *((uint16_t *) buf) = dfifo;
00877                 retval = <span class="keyword">sizeof</span>(uint16_t);
00878                 <span class="keywordflow">break</span>;
00879 
00880         <span class="keywordflow">case</span> FT_ID_TX_FIFO_DEPTH:
00881                 retval = get_txfifo_size(pcd, ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a>);
00882                 <span class="keywordflow">if</span> (retval &gt;= 0) {
00883                         txfifo = retval;
00884                         *((uint16_t *) buf) = txfifo;
00885                         retval = <span class="keyword">sizeof</span>(uint16_t);
00886                 }
00887                 <span class="keywordflow">break</span>;
00888 
00889         <span class="keywordflow">case</span> FT_ID_RX_FIFO_DEPTH:
00890                 retval = get_rxfifo_size(coreif, ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a>);
00891                 <span class="keywordflow">if</span> (retval &gt;= 0) {
00892                         rxfifo = retval;
00893                         *((uint16_t *) buf) = rxfifo;
00894                         retval = <span class="keyword">sizeof</span>(uint16_t);
00895                 }
00896                 <span class="keywordflow">break</span>;
00897         }
00898 
00899         <span class="keywordflow">return</span> retval;
00900 }
00901 
00905 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_reset_sg_val(<a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep)
00906 {
00907         dwc_memset(cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__sg__buffer__setup.html">ddma_sg_buffer_setup_t</a>));
00908         <span class="keywordflow">return</span> 0;
00909 }
00910 
00914 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_reset_align_val(<a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep)
00915 {
00916         dwc_memset(cfiep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__sg__buffer__setup.html">ddma_sg_buffer_setup_t</a>));
00917         <span class="keywordflow">return</span> 0;
00918 }
00919 
00925 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_reset_concat_val(<a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep)
00926 {
00927         <span class="comment">/* First we need to free the wTxBytes field */</span>
00928         <span class="keywordflow">if</span> (cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>) {
00929                 DWC_FREE(cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>);
00930                 cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a> = NULL;
00931         }
00932 
00933         dwc_memset(cfiep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__concat__buffer__setup.html">ddma_concat_buffer_setup_t</a>));
00934         <span class="keywordflow">return</span> 0;
00935 }
00936 
00940 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_reset_all_setup_vals(<a class="code" href="structcfi__ep.html">cfi_ep_t</a> * cfiep)
00941 {
00942         cfi_reset_sg_val(cfiep);
00943         cfi_reset_align_val(cfiep);
00944         cfi_reset_concat_val(cfiep);
00945         <span class="keywordflow">return</span> 0;
00946 }
00947 
00948 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_handle_reset_fifo_val(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd, uint8_t ep_addr,
00949                                      uint8_t rx_rst, uint8_t tx_rst)
00950 {
00951         <span class="keywordtype">int</span> retval = -DWC_E_INVALID;
00952         uint16_t tx_siz[15];
00953         uint16_t rx_siz = 0;
00954         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = NULL;
00955         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00956         <a class="code" href="structdwc__otg__core__params.html">dwc_otg_core_params_t</a> *params = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_params;
00957 
00958         <span class="keywordflow">if</span> (rx_rst) {
00959                 rx_siz = params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a>;
00960                 params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a> = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;init_rxfsiz;
00961         }
00962 
00963         <span class="keywordflow">if</span> (tx_rst) {
00964                 <span class="keywordflow">if</span> (ep_addr == 0) {
00965                         <span class="keywordtype">int</span> i;
00966 
00967                         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>; i++) {
00968                                 tx_siz[i] =
00969                                     core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[i];
00970                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[i] =
00971                                     core_if-&gt;init_txfsiz[i];
00972                         }
00973                 } <span class="keywordflow">else</span> {
00974 
00975                         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a8">get_ep_by_addr</a>(pcd, ep_addr);
00976 
00977                         <span class="keywordflow">if</span> (NULL == ep) {
00978                                 CFI_INFO
00979                                     (<span class="stringliteral">"%s: Unable to get the endpoint addr=0x%02x\n"</span>,
00980                                      __func__, ep_addr);
00981                                 <span class="keywordflow">return</span> -DWC_E_INVALID;
00982                         }
00983 
00984                         tx_siz[0] =
00985                             params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> -
00986                                                      1];
00987                         params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> - 1] =
00988                             <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;init_txfsiz[ep-&gt;
00989                                                           <a class="code" href="structdwc__ep.html">dwc_ep</a>.tx_fifo_num -
00990                                                           1];
00991                 }
00992         }
00993 
00994         <span class="keywordflow">if</span> (resize_fifos(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd))) {
00995                 retval = 0;
00996         } <span class="keywordflow">else</span> {
00997                 CFI_INFO
00998                     (<span class="stringliteral">"%s: Error resetting the feature Reset All(FIFO size)\n"</span>,
00999                      __func__);
01000                 <span class="keywordflow">if</span> (rx_rst) {
01001                         params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a> = rx_siz;
01002                 }
01003 
01004                 <span class="keywordflow">if</span> (tx_rst) {
01005                         <span class="keywordflow">if</span> (ep_addr == 0) {
01006                                 <span class="keywordtype">int</span> i;
01007                                 <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>;
01008                                      i++) {
01009                                         core_if-&gt;
01010                                             core_params-&gt;dev_tx_fifo_size[i] =
01011                                             tx_siz[i];
01012                                 }
01013                         } <span class="keywordflow">else</span> {
01014                                 params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[ep-&gt;
01015                                                          <a class="code" href="structdwc__ep.html">dwc_ep</a>.tx_fifo_num -
01016                                                          1] = tx_siz[0];
01017                         }
01018                 }
01019                 retval = -DWC_E_INVALID;
01020         }
01021         <span class="keywordflow">return</span> retval;
01022 }
01023 
01024 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_handle_reset_all(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd, uint8_t addr)
01025 {
01026         <span class="keywordtype">int</span> retval = 0;
01027         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *cfiep;
01028         cfiobject_t *cfi = pcd-&gt;cfi;
01029         dwc_list_link_t *tmp;
01030 
01031         retval = cfi_handle_reset_fifo_val(pcd, addr, 1, 1);
01032         <span class="keywordflow">if</span> (retval &lt; 0) {
01033                 <span class="keywordflow">return</span> retval;
01034         }
01035 
01036         <span class="comment">/* If the EP address is known then reset the features for only that EP */</span>
01037         <span class="keywordflow">if</span> (addr) {
01038                 cfiep = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, addr);
01039                 <span class="keywordflow">if</span> (NULL == cfiep) {
01040                         CFI_INFO(<span class="stringliteral">"%s: Error getting the EP address 0x%02x\n"</span>,
01041                                  __func__, addr);
01042                         <span class="keywordflow">return</span> -DWC_E_INVALID;
01043                 }
01044                 retval = cfi_ep_reset_all_setup_vals(cfiep);
01045                 cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode = BM_STANDARD;
01046         }
01047         <span class="comment">/* Otherwise (wValue == 0), reset all features of all EP's */</span>
01048         <span class="keywordflow">else</span> {
01049                 <span class="comment">/* Traverse all the active EP's and reset the feature(s) value(s) */</span>
01050                 <span class="comment">//list_for_each_entry(cfiep, &amp;cfi-&gt;active_eps, lh) {</span>
01051                 DWC_LIST_FOREACH(tmp, &amp;cfi-&gt;active_eps) {
01052                         cfiep = DWC_LIST_ENTRY(tmp, <span class="keyword">struct</span> <a class="code" href="structcfi__ep.html">cfi_ep</a>, lh);
01053                         retval = cfi_ep_reset_all_setup_vals(cfiep);
01054                         cfiep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode = BM_STANDARD;
01055                         <span class="keywordflow">if</span> (retval &lt; 0) {
01056                                 CFI_INFO
01057                                     (<span class="stringliteral">"%s: Error resetting the feature Reset All\n"</span>,
01058                                      __func__);
01059                                 <span class="keywordflow">return</span> retval;
01060                         }
01061                 }
01062         }
01063         <span class="keywordflow">return</span> retval;
01064 }
01065 
01066 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_handle_reset_dma_buff_setup(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
01067                                            uint8_t addr)
01068 {
01069         <span class="keywordtype">int</span> retval = 0;
01070         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *cfiep;
01071         cfiobject_t *cfi = pcd-&gt;cfi;
01072         dwc_list_link_t *tmp;
01073 
01074         <span class="comment">/* If the EP address is known then reset the features for only that EP */</span>
01075         <span class="keywordflow">if</span> (addr) {
01076                 cfiep = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, addr);
01077                 <span class="keywordflow">if</span> (NULL == cfiep) {
01078                         CFI_INFO(<span class="stringliteral">"%s: Error getting the EP address 0x%02x\n"</span>,
01079                                  __func__, addr);
01080                         <span class="keywordflow">return</span> -DWC_E_INVALID;
01081                 }
01082                 retval = cfi_reset_sg_val(cfiep);
01083         }
01084         <span class="comment">/* Otherwise (wValue == 0), reset all features of all EP's */</span>
01085         <span class="keywordflow">else</span> {
01086                 <span class="comment">/* Traverse all the active EP's and reset the feature(s) value(s) */</span>
01087                 <span class="comment">//list_for_each_entry(cfiep, &amp;cfi-&gt;active_eps, lh) {</span>
01088                 DWC_LIST_FOREACH(tmp, &amp;cfi-&gt;active_eps) {
01089                         cfiep = DWC_LIST_ENTRY(tmp, <span class="keyword">struct</span> <a class="code" href="structcfi__ep.html">cfi_ep</a>, lh);
01090                         retval = cfi_reset_sg_val(cfiep);
01091                         <span class="keywordflow">if</span> (retval &lt; 0) {
01092                                 CFI_INFO
01093                                     (<span class="stringliteral">"%s: Error resetting the feature Buffer Setup\n"</span>,
01094                                      __func__);
01095                                 <span class="keywordflow">return</span> retval;
01096                         }
01097                 }
01098         }
01099         <span class="keywordflow">return</span> retval;
01100 }
01101 
01102 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_handle_reset_concat_val(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd, uint8_t addr)
01103 {
01104         <span class="keywordtype">int</span> retval = 0;
01105         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *cfiep;
01106         cfiobject_t *cfi = pcd-&gt;cfi;
01107         dwc_list_link_t *tmp;
01108 
01109         <span class="comment">/* If the EP address is known then reset the features for only that EP */</span>
01110         <span class="keywordflow">if</span> (addr) {
01111                 cfiep = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, addr);
01112                 <span class="keywordflow">if</span> (NULL == cfiep) {
01113                         CFI_INFO(<span class="stringliteral">"%s: Error getting the EP address 0x%02x\n"</span>,
01114                                  __func__, addr);
01115                         <span class="keywordflow">return</span> -DWC_E_INVALID;
01116                 }
01117                 retval = cfi_reset_concat_val(cfiep);
01118         }
01119         <span class="comment">/* Otherwise (wValue == 0), reset all features of all EP's */</span>
01120         <span class="keywordflow">else</span> {
01121                 <span class="comment">/* Traverse all the active EP's and reset the feature(s) value(s) */</span>
01122                 <span class="comment">//list_for_each_entry(cfiep, &amp;cfi-&gt;active_eps, lh) {</span>
01123                 DWC_LIST_FOREACH(tmp, &amp;cfi-&gt;active_eps) {
01124                         cfiep = DWC_LIST_ENTRY(tmp, <span class="keyword">struct</span> <a class="code" href="structcfi__ep.html">cfi_ep</a>, lh);
01125                         retval = cfi_reset_concat_val(cfiep);
01126                         <span class="keywordflow">if</span> (retval &lt; 0) {
01127                                 CFI_INFO
01128                                     (<span class="stringliteral">"%s: Error resetting the feature Concatenation Value\n"</span>,
01129                                      __func__);
01130                                 <span class="keywordflow">return</span> retval;
01131                         }
01132                 }
01133         }
01134         <span class="keywordflow">return</span> retval;
01135 }
01136 
01137 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_handle_reset_align_val(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd, uint8_t addr)
01138 {
01139         <span class="keywordtype">int</span> retval = 0;
01140         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *cfiep;
01141         cfiobject_t *cfi = pcd-&gt;cfi;
01142         dwc_list_link_t *tmp;
01143 
01144         <span class="comment">/* If the EP address is known then reset the features for only that EP */</span>
01145         <span class="keywordflow">if</span> (addr) {
01146                 cfiep = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, addr);
01147                 <span class="keywordflow">if</span> (NULL == cfiep) {
01148                         CFI_INFO(<span class="stringliteral">"%s: Error getting the EP address 0x%02x\n"</span>,
01149                                  __func__, addr);
01150                         <span class="keywordflow">return</span> -DWC_E_INVALID;
01151                 }
01152                 retval = cfi_reset_align_val(cfiep);
01153         }
01154         <span class="comment">/* Otherwise (wValue == 0), reset all features of all EP's */</span>
01155         <span class="keywordflow">else</span> {
01156                 <span class="comment">/* Traverse all the active EP's and reset the feature(s) value(s) */</span>
01157                 <span class="comment">//list_for_each_entry(cfiep, &amp;cfi-&gt;active_eps, lh) {</span>
01158                 DWC_LIST_FOREACH(tmp, &amp;cfi-&gt;active_eps) {
01159                         cfiep = DWC_LIST_ENTRY(tmp, <span class="keyword">struct</span> <a class="code" href="structcfi__ep.html">cfi_ep</a>, lh);
01160                         retval = cfi_reset_align_val(cfiep);
01161                         <span class="keywordflow">if</span> (retval &lt; 0) {
01162                                 CFI_INFO
01163                                     (<span class="stringliteral">"%s: Error resetting the feature Aliignment Value\n"</span>,
01164                                      __func__);
01165                                 <span class="keywordflow">return</span> retval;
01166                         }
01167                 }
01168         }
01169         <span class="keywordflow">return</span> retval;
01170 
01171 }
01172 
01173 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_preproc_reset(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
01174                              <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *req)
01175 {
01176         <span class="keywordtype">int</span> retval = 0;
01177 
01178         <span class="keywordflow">switch</span> (req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o3">wIndex</a>) {
01179         <span class="keywordflow">case</span> 0:
01180                 <span class="comment">/* Reset all features */</span>
01181                 retval = cfi_handle_reset_all(pcd, req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a> &amp; 0xff);
01182                 <span class="keywordflow">break</span>;
01183 
01184         <span class="keywordflow">case</span> FT_ID_DMA_BUFFER_SETUP:
01185                 <span class="comment">/* Reset the SG buffer setup */</span>
01186                 retval =
01187                     cfi_handle_reset_dma_buff_setup(pcd, req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a> &amp; 0xff);
01188                 <span class="keywordflow">break</span>;
01189 
01190         <span class="keywordflow">case</span> FT_ID_DMA_CONCAT_SETUP:
01191                 <span class="comment">/* Reset the Concatenation buffer setup */</span>
01192                 retval = cfi_handle_reset_concat_val(pcd, req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a> &amp; 0xff);
01193                 <span class="keywordflow">break</span>;
01194 
01195         <span class="keywordflow">case</span> FT_ID_DMA_BUFF_ALIGN:
01196                 <span class="comment">/* Reset the Alignment buffer setup */</span>
01197                 retval = cfi_handle_reset_align_val(pcd, req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a> &amp; 0xff);
01198                 <span class="keywordflow">break</span>;
01199 
01200         <span class="keywordflow">case</span> FT_ID_TX_FIFO_DEPTH:
01201                 retval =
01202                     cfi_handle_reset_fifo_val(pcd, req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a> &amp; 0xff, 0, 1);
01203                 pcd-&gt;cfi-&gt;need_gadget_att = 0;
01204                 <span class="keywordflow">break</span>;
01205 
01206         <span class="keywordflow">case</span> FT_ID_RX_FIFO_DEPTH:
01207                 retval = cfi_handle_reset_fifo_val(pcd, 0, 1, 0);
01208                 pcd-&gt;cfi-&gt;need_gadget_att = 0;
01209                 <span class="keywordflow">break</span>;
01210         <span class="keywordflow">default</span>:
01211                 <span class="keywordflow">break</span>;
01212         }
01213         <span class="keywordflow">return</span> retval;
01214 }
01215 
01219 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_set_sg_val(uint8_t * buf, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd)
01220 {
01221         uint8_t inaddr, outaddr;
01222         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *epin, *epout;
01223         <a class="code" href="struct__ddma__sg__buffer__setup.html">ddma_sg_buffer_setup_t</a> *psgval;
01224         uint32_t desccount, size;
01225 
01226         CFI_INFO(<span class="stringliteral">"%s\n"</span>, __func__);
01227 
01228         psgval = (<a class="code" href="struct__ddma__sg__buffer__setup.html">ddma_sg_buffer_setup_t</a> *) buf;
01229         desccount = (uint32_t) psgval-&gt;<a class="code" href="struct__ddma__sg__buffer__setup.html#o3">bCount</a>;
01230         size = (uint32_t) psgval-&gt;<a class="code" href="struct__ddma__sg__buffer__setup.html#o4">wSize</a>;
01231 
01232         <span class="comment">/* Check the DMA descriptor count */</span>
01233         <span class="keywordflow">if</span> ((desccount &gt; MAX_DMA_DESCS_PER_EP) || (desccount == 0)) {
01234                 CFI_INFO
01235                     (<span class="stringliteral">"%s: The count of DMA Descriptors should be between 1 and %d\n"</span>,
01236                      __func__, MAX_DMA_DESCS_PER_EP);
01237                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01238         }
01239 
01240         <span class="comment">/* Check the DMA descriptor count */</span>
01241 
01242         <span class="keywordflow">if</span> (size == 0) {
01243 
01244                 CFI_INFO(<span class="stringliteral">"%s: The transfer size should be at least 1 byte\n"</span>,
01245                          __func__);
01246 
01247                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01248 
01249         }
01250 
01251         inaddr = psgval-&gt;<a class="code" href="struct__ddma__sg__buffer__setup.html#o1">bInEndpointAddress</a>;
01252         outaddr = psgval-&gt;<a class="code" href="struct__ddma__sg__buffer__setup.html#o0">bOutEndpointAddress</a>;
01253 
01254         epin = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, inaddr);
01255         epout = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, outaddr);
01256 
01257         <span class="keywordflow">if</span> (NULL == epin || NULL == epout) {
01258                 CFI_INFO
01259                     (<span class="stringliteral">"%s: Unable to get the endpoints inaddr=0x%02x outaddr=0x%02x\n"</span>,
01260                      __func__, inaddr, outaddr);
01261                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01262         }
01263 
01264         epin-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode = BM_SG;
01265         dwc_memcpy(epin-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>, psgval, <span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__sg__buffer__setup.html">ddma_sg_buffer_setup_t</a>));
01266 
01267         epout-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode = BM_SG;
01268         dwc_memcpy(epout-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>, psgval, <span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__sg__buffer__setup.html">ddma_sg_buffer_setup_t</a>));
01269 
01270         <span class="keywordflow">return</span> 0;
01271 }
01272 
01276 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_set_alignment_val(uint8_t * buf, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd)
01277 {
01278         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *ep;
01279         uint8_t addr;
01280         <a class="code" href="struct__ddma__align__buffer__setup.html">ddma_align_buffer_setup_t</a> *palignval;
01281 
01282         palignval = (<a class="code" href="struct__ddma__align__buffer__setup.html">ddma_align_buffer_setup_t</a> *) buf;
01283         addr = palignval-&gt;<a class="code" href="struct__ddma__align__buffer__setup.html#o0">bEndpointAddress</a>;
01284 
01285         ep = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, addr);
01286 
01287         <span class="keywordflow">if</span> (NULL == ep) {
01288                 CFI_INFO(<span class="stringliteral">"%s: Unable to get the endpoint addr=0x%02x\n"</span>,
01289                          __func__, addr);
01290                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01291         }
01292 
01293         ep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode = BM_ALIGN;
01294         dwc_memcpy(ep-&gt;<a class="code" href="structcfi__ep.html#o6">bm_align</a>, palignval, <span class="keyword">sizeof</span>(<a class="code" href="struct__ddma__align__buffer__setup.html">ddma_align_buffer_setup_t</a>));
01295 
01296         <span class="keywordflow">return</span> 0;
01297 }
01298 
01302 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_set_concat_val(uint8_t * buf, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd)
01303 {
01304         uint8_t addr;
01305         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *ep;
01306         <span class="keyword">struct </span><a class="code" href="struct__ddma__concat__buffer__setup__hdr.html">_ddma_concat_buffer_setup_hdr</a> *pConcatValHdr;
01307         uint16_t *pVals;
01308         uint32_t desccount;
01309         <span class="keywordtype">int</span> i;
01310         uint16_t mps;
01311 
01312         pConcatValHdr = (<span class="keyword">struct </span><a class="code" href="struct__ddma__concat__buffer__setup__hdr.html">_ddma_concat_buffer_setup_hdr</a> *)buf;
01313         desccount = (uint32_t) pConcatValHdr-&gt;<a class="code" href="struct__ddma__concat__buffer__setup__hdr.html#o1">bDescCount</a>;
01314         pVals = (uint16_t *) (buf + BS_CONCAT_VAL_HDR_LEN);
01315 
01316         <span class="comment">/* Check the DMA descriptor count */</span>
01317         <span class="keywordflow">if</span> (desccount &gt; MAX_DMA_DESCS_PER_EP) {
01318                 CFI_INFO(<span class="stringliteral">"%s: Maximum DMA Descriptor count should be %d\n"</span>,
01319                          __func__, MAX_DMA_DESCS_PER_EP);
01320                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01321         }
01322 
01323         addr = pConcatValHdr-&gt;<a class="code" href="struct__ddma__concat__buffer__setup__hdr.html#o0">bEndpointAddress</a>;
01324         ep = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, addr);
01325         <span class="keywordflow">if</span> (NULL == ep) {
01326                 CFI_INFO(<span class="stringliteral">"%s: Unable to get the endpoint addr=0x%02x\n"</span>,
01327                          __func__, addr);
01328                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01329         }
01330 
01331         mps = UGETW(ep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o0">desc</a>-&gt;wMaxPacketSize);
01332 
01333 <span class="preprocessor">#if 0</span>
01334 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0; i &lt; desccount; i++) {
01335                 CFI_INFO(<span class="stringliteral">"%s: wTxSize[%d]=0x%04x\n"</span>, __func__, i, pVals[i]);
01336         }
01337         CFI_INFO(<span class="stringliteral">"%s: epname=%s; mps=%d\n"</span>, __func__, ep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;ep.name, mps);
01338 <span class="preprocessor">#endif</span>
01339 <span class="preprocessor"></span>
01340         <span class="comment">/* Check the wTxSizes to be less than or equal to the mps */</span>
01341         <span class="keywordflow">for</span> (i = 0; i &lt; desccount; i++) {
01342                 <span class="keywordflow">if</span> (pVals[i] &gt; mps) {
01343                         CFI_INFO
01344                             (<span class="stringliteral">"%s: ERROR - the wTxSize[%d] should be &lt;= MPS (wTxSize=%d)\n"</span>,
01345                              __func__, i, pVals[i]);
01346                         <span class="keywordflow">return</span> -DWC_E_INVALID;
01347                 }
01348         }
01349 
01350         ep-&gt;<a class="code" href="structcfi__ep.html#o1">ep</a>-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode = BM_CONCAT;
01351         dwc_memcpy(ep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>, pConcatValHdr, BS_CONCAT_VAL_HDR_LEN);
01352 
01353         <span class="comment">/* Free the previously allocated storage for the wTxBytes */</span>
01354         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>) {
01355                 DWC_FREE(ep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>);
01356         }
01357 
01358         <span class="comment">/* Allocate a new storage for the wTxBytes field */</span>
01359         ep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a> =
01360             DWC_ALLOC(<span class="keyword">sizeof</span>(uint16_t) * pConcatValHdr-&gt;<a class="code" href="struct__ddma__concat__buffer__setup__hdr.html#o1">bDescCount</a>);
01361         <span class="keywordflow">if</span> (NULL == ep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>) {
01362                 CFI_INFO(<span class="stringliteral">"%s: Unable to allocate memory\n"</span>, __func__);
01363                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
01364         }
01365 
01366         <span class="comment">/* Copy the new values into the wTxBytes filed */</span>
01367         dwc_memcpy(ep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>, buf + BS_CONCAT_VAL_HDR_LEN,
01368                    <span class="keyword">sizeof</span>(uint16_t) * pConcatValHdr-&gt;<a class="code" href="struct__ddma__concat__buffer__setup__hdr.html#o1">bDescCount</a>);
01369 
01370         <span class="keywordflow">return</span> 0;
01371 }
01372 
01381 <span class="keyword">static</span> uint16_t get_dfifo_size(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01382 {
01383         <a class="code" href="structdwc__otg__core__params.html">dwc_otg_core_params_t</a> *params = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>;
01384         uint16_t dfifo_total = 0;
01385         <span class="keywordtype">int</span> i;
01386 
01387         <span class="comment">/* The shared RxFIFO size */</span>
01388         dfifo_total =
01389             params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a> + params-&gt;<a class="code" href="structdwc__otg__core__params.html#o11">dev_nperio_tx_fifo_size</a>;
01390 
01391         <span class="comment">/* Add up each TxFIFO size to the total */</span>
01392         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>; i++) {
01393                 dfifo_total += params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[i];
01394         }
01395 
01396         <span class="keywordflow">return</span> dfifo_total;
01397 }
01398 
01407 <span class="keyword">static</span> int32_t get_rxfifo_size(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, uint16_t wValue)
01408 {
01409         <span class="keywordflow">switch</span> (wValue &gt;&gt; 8) {
01410         <span class="keywordflow">case</span> 0:
01411                 <span class="keywordflow">return</span> (core_if-&gt;pwron_rxfsiz &lt;
01412                         32768) ? core_if-&gt;pwron_rxfsiz : 32768;
01413                 <span class="keywordflow">break</span>;
01414         <span class="keywordflow">case</span> 1:
01415                 <span class="keywordflow">return</span> core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a>;
01416                 <span class="keywordflow">break</span>;
01417         <span class="keywordflow">default</span>:
01418                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01419                 <span class="keywordflow">break</span>;
01420         }
01421 }
01422 
01431 <span class="keyword">static</span> int32_t get_txfifo_size(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd, uint16_t wValue)
01432 {
01433         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
01434 
01435         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a8">get_ep_by_addr</a>(pcd, wValue &amp; 0xff);
01436 
01437         <span class="keywordflow">if</span> (NULL == ep) {
01438                 CFI_INFO(<span class="stringliteral">"%s: Unable to get the endpoint addr=0x%02x\n"</span>,
01439                          __func__, wValue &amp; 0xff);
01440                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01441         }
01442 
01443         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
01444                 CFI_INFO
01445                     (<span class="stringliteral">"%s: No Tx FIFO assingned to the Out endpoint addr=0x%02x\n"</span>,
01446                      __func__, wValue &amp; 0xff);
01447                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01448         }
01449 
01450         <span class="keywordflow">switch</span> (wValue &gt;&gt; 8) {
01451         <span class="keywordflow">case</span> 0:
01452                 <span class="keywordflow">return</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;pwron_txfsiz
01453                         [ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> - 1] &lt;
01454                         768) ? <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;pwron_txfsiz[ep-&gt;
01455                                                               <a class="code" href="structdwc__ep.html">dwc_ep</a>.tx_fifo_num
01456                                                               - 1] : 32768;
01457                 <span class="keywordflow">break</span>;
01458         <span class="keywordflow">case</span> 1:
01459                 <span class="keywordflow">return</span> <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_params-&gt;
01460                     dev_tx_fifo_size[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> - 1];
01461                 <span class="keywordflow">break</span>;
01462         <span class="keywordflow">default</span>:
01463                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01464                 <span class="keywordflow">break</span>;
01465         }
01466 }
01467 
01477 <span class="keyword">static</span> uint8_t check_fifo_sizes(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01478 {
01479         uint16_t dfifo_actual = 0;
01480         <a class="code" href="structdwc__otg__core__params.html">dwc_otg_core_params_t</a> *params = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>;
01481         uint16_t start_addr = 0;
01482         <span class="keywordtype">int</span> i;
01483 
01484         dfifo_actual =
01485             params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a> + params-&gt;<a class="code" href="structdwc__otg__core__params.html#o11">dev_nperio_tx_fifo_size</a>;
01486 
01487         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>; i++) {
01488                 dfifo_actual += params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[i];
01489         }
01490 
01491         <span class="keywordflow">if</span> (dfifo_actual &gt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o11">total_fifo_size</a>) {
01492                 <span class="keywordflow">return</span> 0;
01493         }
01494 
01495         <span class="keywordflow">if</span> (params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a> &gt; 32768 || params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a> &lt; 16)
01496                 <span class="keywordflow">return</span> 0;
01497 
01498         <span class="keywordflow">if</span> (params-&gt;<a class="code" href="structdwc__otg__core__params.html#o11">dev_nperio_tx_fifo_size</a> &gt; 32768
01499             || params-&gt;<a class="code" href="structdwc__otg__core__params.html#o11">dev_nperio_tx_fifo_size</a> &lt; 16)
01500                 <span class="keywordflow">return</span> 0;
01501 
01502         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>; i++) {
01503 
01504                 <span class="keywordflow">if</span> (params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[i] &gt; 768
01505                     || params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[i] &lt; 4)
01506                         <span class="keywordflow">return</span> 0;
01507         }
01508 
01509         <span class="keywordflow">if</span> (params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a> &gt; core_if-&gt;pwron_rxfsiz)
01510                 <span class="keywordflow">return</span> 0;
01511         start_addr = params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a>;
01512 
01513         <span class="keywordflow">if</span> (params-&gt;<a class="code" href="structdwc__otg__core__params.html#o11">dev_nperio_tx_fifo_size</a> &gt; core_if-&gt;pwron_gnptxfsiz)
01514                 <span class="keywordflow">return</span> 0;
01515         start_addr += params-&gt;<a class="code" href="structdwc__otg__core__params.html#o11">dev_nperio_tx_fifo_size</a>;
01516 
01517         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>; i++) {
01518 
01519                 <span class="keywordflow">if</span> (params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[i] &gt; core_if-&gt;pwron_txfsiz[i])
01520                         <span class="keywordflow">return</span> 0;
01521                 start_addr += params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[i];
01522         }
01523 
01524         <span class="keywordflow">return</span> 1;
01525 }
01526 
01535 <span class="keyword">static</span> uint8_t resize_fifos(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01536 {
01537         <span class="keywordtype">int</span> i = 0;
01538         <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>;
01539         <a class="code" href="structdwc__otg__core__params.html">dwc_otg_core_params_t</a> *params = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>;
01540         uint32_t rx_fifo_size;
01541         <a class="code" href="unionfifosize__data.html">fifosize_data_t</a> nptxfifosize;
01542         <a class="code" href="unionfifosize__data.html">fifosize_data_t</a> txfifosize[15];
01543 
01544         uint32_t rx_fsz_bak;
01545         uint32_t nptxfsz_bak;
01546         uint32_t txfsz_bak[15];
01547 
01548         uint16_t start_address;
01549         uint8_t retval = 1;
01550 
01551         <span class="keywordflow">if</span> (!check_fifo_sizes(core_if)) {
01552                 <span class="keywordflow">return</span> 0;
01553         }
01554 
01555         <span class="comment">/* Configure data FIFO sizes */</span>
01556         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o21">hwcfg2</a>.<a class="code" href="unionhwcfg2__data.html#o16">b</a>.<a class="code" href="unionhwcfg2__data.html#o9">dynamic_fifo</a> &amp;&amp; params-&gt;<a class="code" href="structdwc__otg__core__params.html#o8">enable_dynamic_fifo</a>) {
01557                 rx_fsz_bak = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o9">grxfsiz</a>);
01558                 rx_fifo_size = params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a>;
01559                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o9">grxfsiz</a>, rx_fifo_size);
01560 
01561                 <span class="comment">/*</span>
01562 <span class="comment">                 * Tx FIFOs These FIFOs are numbered from 1 to 15.</span>
01563 <span class="comment">                 * Indexes of the FIFO size module parameters in the</span>
01564 <span class="comment">                 * dev_tx_fifo_size array and the FIFO size registers in</span>
01565 <span class="comment">                 * the dtxfsiz array run from 0 to 14.</span>
01566 <span class="comment">                 */</span>
01567 
01568                 <span class="comment">/* Non-periodic Tx FIFO */</span>
01569                 nptxfsz_bak = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o10">gnptxfsiz</a>);
01570                 nptxfifosize.<a class="code" href="unionfifosize__data.html#o3">b</a>.<a class="code" href="unionfifosize__data.html#o2">depth</a> = params-&gt;<a class="code" href="structdwc__otg__core__params.html#o11">dev_nperio_tx_fifo_size</a>;
01571                 start_address = params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a>;
01572                 nptxfifosize.<a class="code" href="unionfifosize__data.html#o3">b</a>.<a class="code" href="unionfifosize__data.html#o1">startaddr</a> = start_address;
01573 
01574                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o10">gnptxfsiz</a>, nptxfifosize.<a class="code" href="unionfifosize__data.html#o0">d32</a>);
01575 
01576                 start_address += nptxfifosize.<a class="code" href="unionfifosize__data.html#o3">b</a>.<a class="code" href="unionfifosize__data.html#o2">depth</a>;
01577 
01578                 <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>; i++) {
01579                         txfsz_bak[i] = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o27">dtxfsiz</a>[i]);
01580 
01581                         txfifosize[i].<a class="code" href="unionfifosize__data.html#o3">b</a>.<a class="code" href="unionfifosize__data.html#o2">depth</a> = params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[i];
01582                         txfifosize[i].<a class="code" href="unionfifosize__data.html#o3">b</a>.<a class="code" href="unionfifosize__data.html#o1">startaddr</a> = start_address;
01583                         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o27">dtxfsiz</a>[i],
01584                                         txfifosize[i].<a class="code" href="unionfifosize__data.html#o0">d32</a>);
01585 
01586                         start_address += txfifosize[i].<a class="code" href="unionfifosize__data.html#o3">b</a>.<a class="code" href="unionfifosize__data.html#o2">depth</a>;
01587                 }
01588 
01590                 <span class="keywordflow">if</span> (rx_fifo_size != DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o9">grxfsiz</a>)) {
01591                         retval = 0;
01592                 }
01593 
01594                 <span class="keywordflow">if</span> (nptxfifosize.<a class="code" href="unionfifosize__data.html#o0">d32</a> != DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o10">gnptxfsiz</a>)) {
01595                         retval = 0;
01596                 }
01597 
01598                 <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>; i++) {
01599                         <span class="keywordflow">if</span> (txfifosize[i].<a class="code" href="unionfifosize__data.html#o0">d32</a> !=
01600                             DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o27">dtxfsiz</a>[i])) {
01601                                 retval = 0;
01602                         }
01603                 }
01604 
01606                 <span class="keywordflow">if</span> (retval == 0) {
01607                         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o9">grxfsiz</a>, rx_fsz_bak);
01608 
01609                         <span class="comment">/* Non-periodic Tx FIFO */</span>
01610                         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o10">gnptxfsiz</a>, nptxfsz_bak);
01611 
01612                         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o23">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#o17">b</a>.<a class="code" href="unionhwcfg4__data.html#o14">num_in_eps</a>; i++) {
01613                                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o27">dtxfsiz</a>[i],
01614                                                 txfsz_bak[i]);
01615                         }
01616                 }
01617         } <span class="keywordflow">else</span> {
01618                 <span class="keywordflow">return</span> 0;
01619         }
01620 
01621         <span class="comment">/* Flush the FIFOs */</span>
01622         <a class="code" href="dwc__otg__cil_8h.html#a104">dwc_otg_flush_tx_fifo</a>(core_if, 0x10);   <span class="comment">/* all Tx FIFOs */</span>
01623         <a class="code" href="dwc__otg__cil_8h.html#a105">dwc_otg_flush_rx_fifo</a>(core_if);
01624 
01625         <span class="keywordflow">return</span> retval;
01626 }
01627 
01631 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_set_tx_fifo_val(uint8_t * buf, <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01632 {
01633         <span class="keywordtype">int</span> retval;
01634         uint32_t fsiz;
01635         uint16_t size;
01636         uint16_t ep_addr;
01637         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
01638         <a class="code" href="structdwc__otg__core__params.html">dwc_otg_core_params_t</a> *params = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_params;
01639         <a class="code" href="struct__tx__fifo__size__setup.html">tx_fifo_size_setup_t</a> *ptxfifoval;
01640 
01641         ptxfifoval = (<a class="code" href="struct__tx__fifo__size__setup.html">tx_fifo_size_setup_t</a> *) buf;
01642         ep_addr = ptxfifoval-&gt;<a class="code" href="struct__tx__fifo__size__setup.html#o0">bEndpointAddress</a>;
01643         size = ptxfifoval-&gt;<a class="code" href="struct__tx__fifo__size__setup.html#o1">wDepth</a>;
01644 
01645         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a8">get_ep_by_addr</a>(pcd, ep_addr);
01646 
01647         CFI_INFO
01648             (<span class="stringliteral">"%s: Set Tx FIFO size: endpoint addr=0x%02x, depth=%d, FIFO Num=%d\n"</span>,
01649              __func__, ep_addr, size, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a>);
01650 
01651         <span class="keywordflow">if</span> (NULL == ep) {
01652                 CFI_INFO(<span class="stringliteral">"%s: Unable to get the endpoint addr=0x%02x\n"</span>,
01653                          __func__, ep_addr);
01654                 <span class="keywordflow">return</span> -DWC_E_INVALID;
01655         }
01656 
01657         fsiz = params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> - 1];
01658         params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> - 1] = size;
01659 
01660         <span class="keywordflow">if</span> (resize_fifos(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd))) {
01661                 retval = 0;
01662         } <span class="keywordflow">else</span> {
01663                 CFI_INFO
01664                     (<span class="stringliteral">"%s: Error setting the feature Tx FIFO Size for EP%d\n"</span>,
01665                      __func__, ep_addr);
01666                 params-&gt;<a class="code" href="structdwc__otg__core__params.html#o28">dev_tx_fifo_size</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a> - 1] = fsiz;
01667                 retval = -DWC_E_INVALID;
01668         }
01669 
01670         <span class="keywordflow">return</span> retval;
01671 }
01672 
01676 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_set_rx_fifo_val(uint8_t * buf, <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01677 {
01678         <span class="keywordtype">int</span> retval;
01679         uint32_t fsiz;
01680         uint16_t size;
01681         <a class="code" href="structdwc__otg__core__params.html">dwc_otg_core_params_t</a> *params = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_params;
01682         <a class="code" href="struct__rx__fifo__size__setup.html">rx_fifo_size_setup_t</a> *prxfifoval;
01683 
01684         prxfifoval = (<a class="code" href="struct__rx__fifo__size__setup.html">rx_fifo_size_setup_t</a> *) buf;
01685         size = prxfifoval-&gt;<a class="code" href="struct__rx__fifo__size__setup.html#o0">wDepth</a>;
01686 
01687         fsiz = params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a>;
01688         params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a> = size;
01689 
01690         <span class="keywordflow">if</span> (resize_fifos(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd))) {
01691                 retval = 0;
01692         } <span class="keywordflow">else</span> {
01693                 CFI_INFO(<span class="stringliteral">"%s: Error setting the feature Rx FIFO Size\n"</span>,
01694                          __func__);
01695                 params-&gt;<a class="code" href="structdwc__otg__core__params.html#o10">dev_rx_fifo_size</a> = fsiz;
01696                 retval = -DWC_E_INVALID;
01697         }
01698 
01699         <span class="keywordflow">return</span> retval;
01700 }
01701 
01705 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_get_sg_val(uint8_t * buf, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
01706                              <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *req)
01707 {
01708         <span class="keywordtype">int</span> retval = -DWC_E_INVALID;
01709         uint8_t addr;
01710         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *ep;
01711 
01712         <span class="comment">/* The Low Byte of the wValue contains a non-zero address of the endpoint */</span>
01713         addr = req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a> &amp; 0xFF;
01714         <span class="keywordflow">if</span> (addr == 0)          <span class="comment">/* The address should be non-zero */</span>
01715                 <span class="keywordflow">return</span> retval;
01716 
01717         ep = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, addr);
01718         <span class="keywordflow">if</span> (NULL == ep) {
01719                 CFI_INFO(<span class="stringliteral">"%s: Unable to get the endpoint address(0x%02x)\n"</span>,
01720                          __func__, addr);
01721                 <span class="keywordflow">return</span> retval;
01722         }
01723 
01724         dwc_memcpy(buf, ep-&gt;<a class="code" href="structcfi__ep.html#o3">bm_sg</a>, BS_SG_VAL_DESC_LEN);
01725         retval = BS_SG_VAL_DESC_LEN;
01726         <span class="keywordflow">return</span> retval;
01727 }
01728 
01733 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_get_concat_val(uint8_t * buf, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
01734                                  <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *req)
01735 {
01736         <span class="keywordtype">int</span> retval = -DWC_E_INVALID;
01737         uint8_t addr;
01738         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *ep;
01739         uint8_t desc_count;
01740 
01741         <span class="comment">/* The Low Byte of the wValue contains a non-zero address of the endpoint */</span>
01742         addr = req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a> &amp; 0xFF;
01743         <span class="keywordflow">if</span> (addr == 0)          <span class="comment">/* The address should be non-zero */</span>
01744                 <span class="keywordflow">return</span> retval;
01745 
01746         ep = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, addr);
01747         <span class="keywordflow">if</span> (NULL == ep) {
01748                 CFI_INFO(<span class="stringliteral">"%s: Unable to get the endpoint address(0x%02x)\n"</span>,
01749                          __func__, addr);
01750                 <span class="keywordflow">return</span> retval;
01751         }
01752 
01753         <span class="comment">/* Copy the header to the buffer */</span>
01754         dwc_memcpy(buf, ep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>, BS_CONCAT_VAL_HDR_LEN);
01755         <span class="comment">/* Advance the buffer pointer by the header size */</span>
01756         buf += BS_CONCAT_VAL_HDR_LEN;
01757 
01758         desc_count = ep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o0">hdr</a>.<a class="code" href="struct__ddma__concat__buffer__setup__hdr.html#o1">bDescCount</a>;
01759         <span class="comment">/* Copy alll the wTxBytes to the buffer */</span>
01760         dwc_memcpy(buf, ep-&gt;<a class="code" href="structcfi__ep.html#o5">bm_concat</a>-&gt;<a class="code" href="struct__ddma__concat__buffer__setup.html#o1">wTxBytes</a>, <span class="keyword">sizeof</span>(uid16_t) * desc_count);
01761 
01762         retval = BS_CONCAT_VAL_HDR_LEN + <span class="keyword">sizeof</span>(uid16_t) * desc_count;
01763         <span class="keywordflow">return</span> retval;
01764 }
01765 
01772 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_ep_get_align_val(uint8_t * buf, <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd,
01773                                 <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *req)
01774 {
01775         <span class="keywordtype">int</span> retval = -DWC_E_INVALID;
01776         uint8_t addr;
01777         <a class="code" href="structcfi__ep.html">cfi_ep_t</a> *ep;
01778 
01779         <span class="comment">/* The Low Byte of the wValue contains a non-zero address of the endpoint */</span>
01780         addr = req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a> &amp; 0xFF;
01781         <span class="keywordflow">if</span> (addr == 0)          <span class="comment">/* The address should be non-zero */</span>
01782                 <span class="keywordflow">return</span> retval;
01783 
01784         ep = <a class="code" href="dwc__otg__cfi_8h.html#a33">get_cfi_ep_by_addr</a>(pcd-&gt;cfi, addr);
01785         <span class="keywordflow">if</span> (NULL == ep) {
01786                 CFI_INFO(<span class="stringliteral">"%s: Unable to get the endpoint address(0x%02x)\n"</span>,
01787                          __func__, addr);
01788                 <span class="keywordflow">return</span> retval;
01789         }
01790 
01791         dwc_memcpy(buf, ep-&gt;<a class="code" href="structcfi__ep.html#o6">bm_align</a>, BS_ALIGN_VAL_HDR_LEN);
01792         retval = BS_ALIGN_VAL_HDR_LEN;
01793 
01794         <span class="keywordflow">return</span> retval;
01795 }
01796 
01804 <span class="keyword">static</span> <span class="keywordtype">int</span> cfi_set_feature_value(<span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd)
01805 {
01806         <span class="keywordtype">int</span> retval = -DWC_E_NOT_SUPPORTED;
01807         uint16_t wIndex, wValue;
01808         uint8_t bRequest;
01809         <span class="keyword">struct </span><a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if</a> *coreif;
01810         cfiobject_t *cfi = pcd-&gt;cfi;
01811         <span class="keyword">struct </span><a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *ctrl_req;
01812         uint8_t *buf;
01813         ctrl_req = &amp;cfi-&gt;ctrl_req;
01814 
01815         buf = pcd-&gt;cfi-&gt;ctrl_req.data;
01816 
01817         coreif = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01818         bRequest = ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o1">bRequest</a>;
01819         wIndex = DWC_CONSTANT_CPU_TO_LE16(ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o3">wIndex</a>);
01820         wValue = DWC_CONSTANT_CPU_TO_LE16(ctrl_req-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o2">wValue</a>);
01821 
01822         <span class="comment">/* See which feature is to be modified */</span>
01823         <span class="keywordflow">switch</span> (wIndex) {
01824         <span class="keywordflow">case</span> FT_ID_DMA_BUFFER_SETUP:
01825                 <span class="comment">/* Modify the feature */</span>
01826                 <span class="keywordflow">if</span> ((retval = cfi_ep_set_sg_val(buf, pcd)) &lt; 0)
01827                         <span class="keywordflow">return</span> retval;
01828 
01829                 <span class="comment">/* And send this request to the gadget */</span>
01830                 cfi-&gt;need_gadget_att = 1;
01831                 <span class="keywordflow">break</span>;
01832 
01833         <span class="keywordflow">case</span> FT_ID_DMA_BUFF_ALIGN:
01834                 <span class="keywordflow">if</span> ((retval = cfi_ep_set_alignment_val(buf, pcd)) &lt; 0)
01835                         <span class="keywordflow">return</span> retval;
01836                 cfi-&gt;need_gadget_att = 1;
01837                 <span class="keywordflow">break</span>;
01838 
01839         <span class="keywordflow">case</span> FT_ID_DMA_CONCAT_SETUP:
01840                 <span class="comment">/* Modify the feature */</span>
01841                 <span class="keywordflow">if</span> ((retval = cfi_ep_set_concat_val(buf, pcd)) &lt; 0)
01842                         <span class="keywordflow">return</span> retval;
01843                 cfi-&gt;need_gadget_att = 1;
01844                 <span class="keywordflow">break</span>;
01845 
01846         <span class="keywordflow">case</span> FT_ID_DMA_CIRCULAR:
01847                 CFI_INFO(<span class="stringliteral">"FT_ID_DMA_CIRCULAR\n"</span>);
01848                 <span class="keywordflow">break</span>;
01849 
01850         <span class="keywordflow">case</span> FT_ID_THRESHOLD_SETUP:
01851                 CFI_INFO(<span class="stringliteral">"FT_ID_THRESHOLD_SETUP\n"</span>);
01852                 <span class="keywordflow">break</span>;
01853 
01854         <span class="keywordflow">case</span> FT_ID_DFIFO_DEPTH:
01855                 CFI_INFO(<span class="stringliteral">"FT_ID_DFIFO_DEPTH\n"</span>);
01856                 <span class="keywordflow">break</span>;
01857 
01858         <span class="keywordflow">case</span> FT_ID_TX_FIFO_DEPTH:
01859                 CFI_INFO(<span class="stringliteral">"FT_ID_TX_FIFO_DEPTH\n"</span>);
01860                 <span class="keywordflow">if</span> ((retval = cfi_ep_set_tx_fifo_val(buf, pcd)) &lt; 0)
01861                         <span class="keywordflow">return</span> retval;
01862                 cfi-&gt;need_gadget_att = 0;
01863                 <span class="keywordflow">break</span>;
01864 
01865         <span class="keywordflow">case</span> FT_ID_RX_FIFO_DEPTH:
01866                 CFI_INFO(<span class="stringliteral">"FT_ID_RX_FIFO_DEPTH\n"</span>);
01867                 <span class="keywordflow">if</span> ((retval = cfi_set_rx_fifo_val(buf, pcd)) &lt; 0)
01868                         <span class="keywordflow">return</span> retval;
01869                 cfi-&gt;need_gadget_att = 0;
01870                 <span class="keywordflow">break</span>;
01871         }
01872 
01873         <span class="keywordflow">return</span> retval;
01874 }
01875 
01876 <span class="preprocessor">#endif //DWC_UTE_CFI</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 27 03:56:37 2011 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
