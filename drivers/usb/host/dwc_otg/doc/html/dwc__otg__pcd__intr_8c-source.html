<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_pcd_intr.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>dwc_otg_pcd_intr.c</h1><a href="dwc__otg__pcd__intr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/* ==========================================================================</span>
00002 <span class="comment"> * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_pcd_intr.c $</span>
00003 <span class="comment"> * $Revision: #113 $</span>
00004 <span class="comment"> * $Date: 2011/10/24 $</span>
00005 <span class="comment"> * $Change: 1871160 $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
00008 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
00009 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
00012 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
00013 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
00014 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
00015 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
00016 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
00017 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
00018 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
00019 <span class="comment"> * below, then you are not authorized to use the Software.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
00022 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
00025 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
00026 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
00027 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
00028 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
00031 <span class="comment"> * DAMAGE.</span>
00032 <span class="comment"> * ========================================================================== */</span>
00033 <span class="preprocessor">#ifndef DWC_HOST_ONLY</span>
00034 <span class="preprocessor"></span>
00035 <span class="preprocessor">#include "<a class="code" href="dwc__otg__pcd_8h.html">dwc_otg_pcd.h</a>"</span>
00036 
00037 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="dwc__otg__cfi_8h.html">dwc_otg_cfi.h</a>"</span>
00039 <span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span>
00041 <span class="preprocessor">#ifdef DWC_UTE_PER_IO</span>
00042 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">void</span> complete_xiso_ep(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep);
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span><span class="comment">//#define PRINT_CFI_DMA_DESCS</span>
00045 
00046 <span class="preprocessor">#define DEBUG_EP0</span>
00047 <span class="preprocessor"></span>
<a name="l00051"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a3">00051</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a3">dwc_otg_pcd_update_otg</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> reset)
00052 {
00053 
00054         <span class="keywordflow">if</span> (reset) {
00055                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o7">b_hnp_enable</a> = 0;
00056                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o8">a_hnp_support</a> = 0;
00057                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o9">a_alt_hnp_support</a> = 0;
00058         }
00059 
00060         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o9">hnp_changed</a>) {
00061                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o9">hnp_changed</a>(pcd);
00062         }
00063 }
00064 
<a name="l00079"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a4">00079</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a4">print_ep0_state</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00080 {
00081 <span class="preprocessor">#ifdef DEBUG</span>
00082 <span class="preprocessor"></span>        <span class="keywordtype">char</span> str[40];
00083 
00084         <span class="keywordflow">switch</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a>) {
00085         <span class="keywordflow">case</span> EP0_DISCONNECT:
00086                 dwc_strcpy(str, <span class="stringliteral">"EP0_DISCONNECT"</span>);
00087                 <span class="keywordflow">break</span>;
00088         <span class="keywordflow">case</span> EP0_IDLE:
00089                 dwc_strcpy(str, <span class="stringliteral">"EP0_IDLE"</span>);
00090                 <span class="keywordflow">break</span>;
00091         <span class="keywordflow">case</span> EP0_IN_DATA_PHASE:
00092                 dwc_strcpy(str, <span class="stringliteral">"EP0_IN_DATA_PHASE"</span>);
00093                 <span class="keywordflow">break</span>;
00094         <span class="keywordflow">case</span> EP0_OUT_DATA_PHASE:
00095                 dwc_strcpy(str, <span class="stringliteral">"EP0_OUT_DATA_PHASE"</span>);
00096                 <span class="keywordflow">break</span>;
00097         <span class="keywordflow">case</span> EP0_IN_STATUS_PHASE:
00098                 dwc_strcpy(str, <span class="stringliteral">"EP0_IN_STATUS_PHASE"</span>);
00099                 <span class="keywordflow">break</span>;
00100         <span class="keywordflow">case</span> EP0_OUT_STATUS_PHASE:
00101                 dwc_strcpy(str, <span class="stringliteral">"EP0_OUT_STATUS_PHASE"</span>);
00102                 <span class="keywordflow">break</span>;
00103         <span class="keywordflow">case</span> EP0_STALL:
00104                 dwc_strcpy(str, <span class="stringliteral">"EP0_STALL"</span>);
00105                 <span class="keywordflow">break</span>;
00106         <span class="keywordflow">default</span>:
00107                 dwc_strcpy(str, <span class="stringliteral">"EP0_INVALID"</span>);
00108         }
00109 
00110         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"%s(%d)\n"</span>, str, pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a>);
00111 <span class="preprocessor">#endif</span>
00112 <span class="preprocessor"></span>}
00113 
<a name="l00119"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a5">00119</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a5">print_memory_payload</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,  <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * ep)
00120 {
00121 <span class="preprocessor">#ifdef DEBUG</span>
00122 <span class="preprocessor"></span>        <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz_init = {.d32 = 0 };
00123         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz_updt = {.d32 = 0 };
00124         <span class="keywordtype">int</span> pack_num;
00125         <span class="keywordtype">unsigned</span> payload;
00126         
00127         deptsiz_init.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o35">start_doeptsiz_val</a>[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>];
00128         deptsiz_updt.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
00129                 DWC_READ_REG32(&amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
00130                                                 out_ep_regs[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doeptsiz);
00131         <span class="comment">/* Payload will be */</span>
00132         payload = deptsiz_init.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> - deptsiz_updt.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>;
00133         <span class="comment">/* Packet count is decremented every time a packet</span>
00134 <span class="comment">         * is written to the RxFIFO not in to the external memory</span>
00135 <span class="comment">         * So, if payload == 0, then it means no packet was sent to ext memory*/</span>
00136         pack_num = (!payload) ? 0 : (deptsiz_init.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> - deptsiz_updt.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>);
00137         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
00138                 <span class="stringliteral">"Payload for EP%d-%s\n"</span>,
00139                 ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>, (ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>));
00140         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
00141                 <span class="stringliteral">"Number of transfered bytes = 0x%08x\n"</span>, payload);
00142         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
00143                 <span class="stringliteral">"Number of transfered packets = %d\n"</span>, pack_num);       
00144 <span class="preprocessor">#endif  </span>
00145 <span class="preprocessor"></span>}
00146 
00147 
00148 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
00149 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> print_desc(<span class="keyword">struct</span> dwc_otg_dma_desc *ddesc,
00150                               <span class="keyword">const</span> uint8_t * epname, <span class="keywordtype">int</span> descnum)
00151 {
00152         CFI_INFO
00153             (<span class="stringliteral">"%s DMA_DESC(%d) buf=0x%08x bytes=0x%04x; sp=0x%x; l=0x%x; sts=0x%02x; bs=0x%02x\n"</span>,
00154              epname, descnum, ddesc-&gt;buf, ddesc-&gt;status.b.bytes,
00155              ddesc-&gt;status.b.sp, ddesc-&gt;status.b.l, ddesc-&gt;status.b.sts,
00156              ddesc-&gt;status.b.bs);
00157 }
00158 <span class="preprocessor">#endif</span>
00159 <span class="preprocessor"></span>
<a name="l00163"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a6">00163</a> <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *<a class="code" href="dwc__otg__pcd__intr_8c.html#a6">get_in_ep</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, uint32_t ep_num)
00164 {
00165         <span class="keywordtype">int</span> i;
00166         <span class="keywordtype">int</span> num_in_eps = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;num_in_eps;
00167         <span class="keywordflow">if</span> (ep_num == 0) {
00168                 <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00169         } <span class="keywordflow">else</span> {
00170                 <span class="keywordflow">for</span> (i = 0; i &lt; num_in_eps; ++i) {
00171                         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> == ep_num)
00172                                 <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i];
00173                 }
00174                 <span class="keywordflow">return</span> 0;
00175         }
00176 }
00177 
<a name="l00181"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a7">00181</a> <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *<a class="code" href="dwc__otg__pcd__intr_8c.html#a7">get_out_ep</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, uint32_t ep_num)
00182 {
00183         <span class="keywordtype">int</span> i;
00184         <span class="keywordtype">int</span> num_out_eps = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;num_out_eps;
00185         <span class="keywordflow">if</span> (ep_num == 0) {
00186                 <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00187         } <span class="keywordflow">else</span> {
00188                 <span class="keywordflow">for</span> (i = 0; i &lt; num_out_eps; ++i) {
00189                         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a> == ep_num)
00190                                 <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i];
00191                 }
00192                 <span class="keywordflow">return</span> 0;
00193         }
00194 }
00195 
<a name="l00200"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a8">00200</a> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *<a class="code" href="dwc__otg__pcd__intr_8c.html#a8">get_ep_by_addr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, u16 wIndex)
00201 {
00202         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00203         uint32_t ep_num = UE_GET_ADDR(wIndex);
00204 
00205         <span class="keywordflow">if</span> (ep_num == 0) {
00206                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00207         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UE_GET_DIR(wIndex) == UE_DIR_IN) {   <span class="comment">/* in ep */</span>
00208                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[ep_num - 1];
00209         } <span class="keywordflow">else</span> {
00210                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[ep_num - 1];
00211         }
00212 
00213         <span class="keywordflow">return</span> ep;
00214 }
00215 
<a name="l00220"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a9">00220</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a9">start_next_request</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
00221 {
00222         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req = 0;
00223         uint32_t max_transfer =
00224             <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>)-&gt;core_params-&gt;max_transfer_size;
00225 
00226 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
00227 <span class="preprocessor"></span>        <span class="keyword">struct </span><a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd</a> *pcd;
00228         pcd = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>;
00229 <span class="preprocessor">#endif</span>
00230 <span class="preprocessor"></span>
00231         <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>)) {
00232                 req = DWC_CIRCLEQ_FIRST(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
00233 
00234 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
00235 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode != BM_STANDARD) {
00236                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.cfi_req_len = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a>;
00237                         pcd-&gt;cfi-&gt;ops.build_descriptors(pcd-&gt;cfi, pcd, ep, req);
00238                 } <span class="keywordflow">else</span> {
00239 <span class="preprocessor">#endif</span>
00240 <span class="preprocessor"></span>                        <span class="comment">/* Setup and start the Transfer */</span>
00241                         <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>) {
00242                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o7">dw_align_buf_dma</a>;
00243                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>;
00244                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>;
00245                         } <span class="keywordflow">else</span> {
00246                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o2">dma</a>;
00247                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o1">buf</a>;
00248                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o1">buf</a>;
00249                         }
00250                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
00251                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a>;
00252                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 0;
00253                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
00254 
00255                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> = max_transfer;
00256                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>)-&gt;dma_desc_enable) {
00257                                 uint32_t out_max_xfer = <a class="code" href="dwc__otg__pcd_8h.html#a2">DDMA_MAX_TRANSFER_SIZE</a>
00258                                     - (<a class="code" href="dwc__otg__pcd_8h.html#a2">DDMA_MAX_TRANSFER_SIZE</a> % 4);
00259                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
00260                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> &gt;
00261                                             DDMA_MAX_TRANSFER_SIZE) {
00262                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> =
00263                                                     DDMA_MAX_TRANSFER_SIZE;
00264                                         }
00265                                 } <span class="keywordflow">else</span> {
00266                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> &gt; out_max_xfer) {
00267                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> =
00268                                                     out_max_xfer;
00269                                         }
00270                                 }
00271                         }
00272                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>) {
00273                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> -=
00274                                     (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a> % ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>);
00275                         }
00276                         <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o5">sent_zlp</a>) {
00277                                 <span class="keywordflow">if</span> ((ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> %
00278                                      ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> == 0)
00279                                     &amp;&amp; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> != 0)) {
00280                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 1;
00281                                 }
00282 
00283                         }
00284 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
00285 <span class="preprocessor"></span>                }
00286 <span class="preprocessor">#endif</span>
00287 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__cil_8h.html#a81">dwc_otg_ep_start_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
00288         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
00289                 DWC_PRINTF(<span class="stringliteral">"There are no more ISOC requests \n"</span>);
00290                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> = 0xFFFFFFFF;
00291         }
00292 }
00293 
<a name="l00298"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a10">00298</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a10">dwc_otg_pcd_handle_sof_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00299 {
00300         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00301 
00302         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00303 
00304         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"SOF\n"</span>);
00305 
00306         <span class="comment">/* Clear interrupt */</span>
00307         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00308         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o4">sofintr</a> = 1;
00309         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00310 
00311         <span class="keywordflow">return</span> 1;
00312 }
00313 
<a name="l00331"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a11">00331</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a11">dwc_otg_pcd_handle_rx_status_q_level_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00332 {
00333         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00334         <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>;
00335         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmask = {.d32 = 0 };
00336         <a class="code" href="uniondevice__grxsts__data.html">device_grxsts_data_t</a> status;
00337         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00338         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00339 <span class="preprocessor">#ifdef DEBUG</span>
00340 <span class="preprocessor"></span>        <span class="keyword">static</span> <span class="keywordtype">char</span> *dpid_str[] = { <span class="stringliteral">"D0"</span>, <span class="stringliteral">"D2"</span>, <span class="stringliteral">"D1"</span>, <span class="stringliteral">"MDATA"</span> };
00341 <span class="preprocessor">#endif</span>
00342 <span class="preprocessor"></span>
00343         <span class="comment">//DWC_DEBUGPL(DBG_PCDV, "%s(%p)\n", __func__, _pcd);</span>
00344         <span class="comment">/* Disable the Rx Status Queue Level interrupt */</span>
00345         gintmask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o5">rxstsqlvl</a> = 1;
00346         DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, gintmask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
00347 
00348         <span class="comment">/* Get the Status from the top of the FIFO */</span>
00349         status.<a class="code" href="uniondevice__grxsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o8">grxstsp</a>);
00350 
00351         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"EP:%d BCnt:%d DPID:%s "</span>
00352                     <span class="stringliteral">"pktsts:%x Frame:%d(0x%0x)\n"</span>,
00353                     status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o1">epnum</a>, status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o2">bcnt</a>,
00354                     dpid_str[status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o3">dpid</a>],
00355                     status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o4">pktsts</a>, status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o5">fn</a>, status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o5">fn</a>);
00356         <span class="comment">/* Get pointer to EP structure */</span>
00357         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a7">get_out_ep</a>(pcd, status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o1">epnum</a>);
00358 
00359         <span class="keywordflow">switch</span> (status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o4">pktsts</a>) {
00360         <span class="keywordflow">case</span> DWC_DSTS_GOUT_NAK:
00361                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"Global OUT NAK\n"</span>);
00362                 <span class="keywordflow">break</span>;
00363         <span class="keywordflow">case</span> DWC_STS_DATA_UPDT:
00364                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"OUT Data Packet\n"</span>);
00365                 <span class="keywordflow">if</span> (status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o2">bcnt</a> &amp;&amp; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a>) {
00367                         <a class="code" href="dwc__otg__cil_8h.html#a103">dwc_otg_read_packet</a>(core_if,
00368                                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a>,
00369                                             status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o2">bcnt</a>);
00370                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> += status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o2">bcnt</a>;
00371                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> += status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o2">bcnt</a>;
00372                 }
00373                 <span class="keywordflow">break</span>;
00374         <span class="keywordflow">case</span> DWC_STS_XFER_COMP:
00375                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"OUT Complete\n"</span>);
00376                 <span class="keywordflow">break</span>;
00377         <span class="keywordflow">case</span> DWC_DSTS_SETUP_COMP:
00378 <span class="preprocessor">#ifdef DEBUG_EP0</span>
00379 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"Setup Complete\n"</span>);
00380 <span class="preprocessor">#endif</span>
00381 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
00382         <span class="keywordflow">case</span> DWC_DSTS_SETUP_UPDT:
00383                 <a class="code" href="dwc__otg__cil_8h.html#a76">dwc_otg_read_setup_packet</a>(core_if, pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o12">d32</a>);
00384 <span class="preprocessor">#ifdef DEBUG_EP0</span>
00385 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>,
00386                             <span class="stringliteral">"SETUP PKT: %02x.%02x v%04x i%04x l%04x\n"</span>,
00387                             pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>.bmRequestType,
00388                             pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>.bRequest,
00389                             UGETW(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>.wValue),
00390                             UGETW(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>.wIndex),
00391                             UGETW(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>.wLength));
00392 <span class="preprocessor">#endif</span>
00393 <span class="preprocessor"></span>                ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> += status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o2">bcnt</a>;
00394                 <span class="keywordflow">break</span>;
00395         <span class="keywordflow">default</span>:
00396                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"Invalid Packet Status (0x%0x)\n"</span>,
00397                             status.<a class="code" href="uniondevice__grxsts__data.html#o7">b</a>.<a class="code" href="uniondevice__grxsts__data.html#o4">pktsts</a>);
00398                 <span class="keywordflow">break</span>;
00399         }
00400 
00401         <span class="comment">/* Enable the Rx Status Queue Level interrupt */</span>
00402         DWC_MODIFY_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0, gintmask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
00403         <span class="comment">/* Clear interrupt */</span>
00404         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00405         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o5">rxstsqlvl</a> = 1;
00406         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00407 
00408         <span class="comment">//DWC_DEBUGPL(DBG_PCDV, "EXIT: %s\n", __func__);</span>
00409         <span class="keywordflow">return</span> 1;
00410 }
00411 
<a name="l00424"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a12">00424</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a12">get_ep_of_last_in_token</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
00425 {
00426         <a class="code" href="structdwc__otg__dev__global__regs.html">dwc_otg_device_global_regs_t</a> *dev_global_regs =
00427             core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>;
00428         <span class="keyword">const</span> uint32_t TOKEN_Q_DEPTH = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o21">hwcfg2</a>.<a class="code" href="unionhwcfg2__data.html#o16">b</a>.<a class="code" href="unionhwcfg2__data.html#o14">dev_token_q_depth</a>;
00429         <span class="comment">/* Number of Token Queue Registers */</span>
00430         <span class="keyword">const</span> <span class="keywordtype">int</span> DTKNQ_REG_CNT = (TOKEN_Q_DEPTH + 7) / 8;
00431         <a class="code" href="uniondtknq1__data.html">dtknq1_data_t</a> dtknqr1;
00432         uint32_t in_tkn_epnums[4];
00433         <span class="keywordtype">int</span> ndx = 0;
00434         <span class="keywordtype">int</span> i = 0;
00435         <span class="keyword">volatile</span> uint32_t *addr = &amp;dev_global_regs-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o8">dtknqr1</a>;
00436         <span class="keywordtype">int</span> epnum = 0;
00437 
00438         <span class="comment">//DWC_DEBUGPL(DBG_PCD,"dev_token_q_depth=%d\n",TOKEN_Q_DEPTH);</span>
00439 
00440         <span class="comment">/* Read the DTKNQ Registers */</span>
00441         <span class="keywordflow">for</span> (i = 0; i &lt; DTKNQ_REG_CNT; i++) {
00442                 in_tkn_epnums[i] = DWC_READ_REG32(addr);
00443                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"DTKNQR%d=0x%08x\n"</span>, i + 1,
00444                             in_tkn_epnums[i]);
00445                 <span class="keywordflow">if</span> (addr == &amp;dev_global_regs-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o10">dvbusdis</a>) {
00446                         addr = &amp;dev_global_regs-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o12">dtknqr3_dthrctl</a>;
00447                 } <span class="keywordflow">else</span> {
00448                         ++addr;
00449                 }
00450 
00451         }
00452 
00453         <span class="comment">/* Copy the DTKNQR1 data to the bit field. */</span>
00454         dtknqr1.<a class="code" href="uniondtknq1__data.html#o0">d32</a> = in_tkn_epnums[0];
00455         <span class="comment">/* Get the EP numbers */</span>
00456         in_tkn_epnums[0] = dtknqr1.<a class="code" href="uniondtknq1__data.html#o5">b</a>.<a class="code" href="uniondtknq1__data.html#o4">epnums0_5</a>;
00457         ndx = dtknqr1.<a class="code" href="uniondtknq1__data.html#o5">b</a>.<a class="code" href="uniondtknq1__data.html#o1">intknwptr</a> - 1;
00458 
00459         <span class="comment">//DWC_DEBUGPL(DBG_PCDV,"ndx=%d\n",ndx);</span>
00460         <span class="keywordflow">if</span> (ndx == -1) {
00463                 <span class="keywordtype">int</span> cnt = TOKEN_Q_DEPTH;
00464                 <span class="keywordflow">if</span> (TOKEN_Q_DEPTH &lt;= 6) {
00465                         cnt = TOKEN_Q_DEPTH - 1;
00466                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TOKEN_Q_DEPTH &lt;= 14) {
00467                         cnt = TOKEN_Q_DEPTH - 7;
00468                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TOKEN_Q_DEPTH &lt;= 22) {
00469                         cnt = TOKEN_Q_DEPTH - 15;
00470                 } <span class="keywordflow">else</span> {
00471                         cnt = TOKEN_Q_DEPTH - 23;
00472                 }
00473                 epnum = (in_tkn_epnums[DTKNQ_REG_CNT - 1] &gt;&gt; (cnt * 4)) &amp; 0xF;
00474         } <span class="keywordflow">else</span> {
00475                 <span class="keywordflow">if</span> (ndx &lt;= 5) {
00476                         epnum = (in_tkn_epnums[0] &gt;&gt; (ndx * 4)) &amp; 0xF;
00477                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ndx &lt;= 13) {
00478                         ndx -= 6;
00479                         epnum = (in_tkn_epnums[1] &gt;&gt; (ndx * 4)) &amp; 0xF;
00480                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ndx &lt;= 21) {
00481                         ndx -= 14;
00482                         epnum = (in_tkn_epnums[2] &gt;&gt; (ndx * 4)) &amp; 0xF;
00483                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ndx &lt;= 29) {
00484                         ndx -= 22;
00485                         epnum = (in_tkn_epnums[3] &gt;&gt; (ndx * 4)) &amp; 0xF;
00486                 }
00487         }
00488         <span class="comment">//DWC_DEBUGPL(DBG_PCD,"epnum=%d\n",epnum);</span>
00489         <span class="keywordflow">return</span> epnum;
00490 }
00491 
<a name="l00497"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a13">00497</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a13">dwc_otg_pcd_handle_np_tx_fifo_empty_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00498 {
00499         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00500         <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>;
00501         <a class="code" href="structdwc__otg__dev__in__ep__regs.html">dwc_otg_dev_in_ep_regs_t</a> *ep_regs;
00502         <a class="code" href="uniongnptxsts__data.html">gnptxsts_data_t</a> txstatus = {.d32 = 0 };
00503         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00504 
00505         <span class="keywordtype">int</span> epnum = 0;
00506         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = 0;
00507         uint32_t len = 0;
00508         <span class="keywordtype">int</span> dwords;
00509 
00510         <span class="comment">/* Get the epnum from the IN Token Learning Queue. */</span>
00511         epnum = <a class="code" href="dwc__otg__pcd__intr_8c.html#a12">get_ep_of_last_in_token</a>(core_if);
00512         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a6">get_in_ep</a>(pcd, epnum);
00513 
00514         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"NP TxFifo Empty: %d \n"</span>, epnum);
00515 
00516         ep_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum];
00517 
00518         len = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> - ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
00519         <span class="keywordflow">if</span> (len &gt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) {
00520                 len = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00521         }
00522         dwords = (len + 3) / 4;
00523 
00524         <span class="comment">/* While there is space in the queue and space in the FIFO and</span>
00525 <span class="comment">         * More data to tranfer, Write packets to the Tx FIFO */</span>
00526         txstatus.<a class="code" href="uniongnptxsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o11">gnptxsts</a>);
00527         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"b4 GNPTXSTS=0x%08x\n"</span>, txstatus.<a class="code" href="uniongnptxsts__data.html#o0">d32</a>);
00528 
00529         <span class="keywordflow">while</span> (txstatus.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o2">nptxqspcavail</a> &gt; 0 &amp;&amp;
00530                txstatus.<a class="code" href="uniongnptxsts__data.html#o7">b</a>.<a class="code" href="uniongnptxsts__data.html#o1">nptxfspcavail</a> &gt; dwords &amp;&amp;
00531                ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>) {
00532                 <span class="comment">/* Write the FIFO */</span>
00533                 <a class="code" href="dwc__otg__cil_8h.html#a85">dwc_otg_ep_write_packet</a>(core_if, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>, 0);
00534                 len = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> - ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
00535 
00536                 <span class="keywordflow">if</span> (len &gt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) {
00537                         len = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00538                 }
00539 
00540                 dwords = (len + 3) / 4;
00541                 txstatus.<a class="code" href="uniongnptxsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o11">gnptxsts</a>);
00542                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"GNPTXSTS=0x%08x\n"</span>, txstatus.<a class="code" href="uniongnptxsts__data.html#o0">d32</a>);
00543         }
00544 
00545         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"GNPTXSTS=0x%08x\n"</span>,
00546                     DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o11">gnptxsts</a>));
00547 
00548         <span class="comment">/* Clear interrupt */</span>
00549         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00550         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o6">nptxfempty</a> = 1;
00551         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00552 
00553         <span class="keywordflow">return</span> 1;
00554 }
00555 
<a name="l00561"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a14">00561</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a14">write_empty_tx_fifo</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, uint32_t epnum)
00562 {
00563         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00564         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
00565         <a class="code" href="structdwc__otg__dev__in__ep__regs.html">dwc_otg_dev_in_ep_regs_t</a> *ep_regs;
00566         <a class="code" href="uniondtxfsts__data.html">dtxfsts_data_t</a> txstatus = {.d32 = 0 };
00567         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = 0;
00568         uint32_t len = 0;
00569         <span class="keywordtype">int</span> dwords;
00570 
00571         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a6">get_in_ep</a>(pcd, epnum);
00572 
00573         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"Dedicated TxFifo Empty: %d \n"</span>, epnum);
00574 
00575         ep_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum];
00576 
00577         len = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> - ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
00578 
00579         <span class="keywordflow">if</span> (len &gt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) {
00580                 len = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00581         }
00582 
00583         dwords = (len + 3) / 4;
00584 
00585         <span class="comment">/* While there is space in the queue and space in the FIFO and</span>
00586 <span class="comment">         * More data to tranfer, Write packets to the Tx FIFO */</span>
00587         txstatus.<a class="code" href="uniondtxfsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o6">dtxfsts</a>);
00588         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"b4 dtxfsts[%d]=0x%08x\n"</span>, epnum, txstatus.<a class="code" href="uniondtxfsts__data.html#o0">d32</a>);
00589 
00590         <span class="keywordflow">while</span> (txstatus.<a class="code" href="uniondtxfsts__data.html#o3">b</a>.<a class="code" href="uniondtxfsts__data.html#o1">txfspcavail</a> &gt; dwords &amp;&amp;
00591                ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> &amp;&amp;
00592                ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> != 0) {
00593                 <span class="comment">/* Write the FIFO */</span>
00594                 <a class="code" href="dwc__otg__cil_8h.html#a85">dwc_otg_ep_write_packet</a>(core_if, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>, 0);
00595 
00596                 len = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> - ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
00597                 <span class="keywordflow">if</span> (len &gt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) {
00598                         len = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00599                 }
00600 
00601                 dwords = (len + 3) / 4;
00602                 txstatus.<a class="code" href="uniondtxfsts__data.html#o0">d32</a> =
00603                     DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o6">dtxfsts</a>);
00604                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"dtxfsts[%d]=0x%08x\n"</span>, epnum,
00605                             txstatus.<a class="code" href="uniondtxfsts__data.html#o0">d32</a>);
00606         }
00607 
00608         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"b4 dtxfsts[%d]=0x%08x\n"</span>, epnum,
00609                     DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o6">dtxfsts</a>));
00610 
00611         <span class="keywordflow">return</span> 1;
00612 }
00613 
<a name="l00619"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a15">00619</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a15">dwc_otg_pcd_stop</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00620 {
00621         <span class="keywordtype">int</span> i, num_in_eps, num_out_eps;
00622         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00623 
00624         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.<a class="code" href="uniondtxfsts__data.html#o0">d32</a> = 0 };
00625 
00626         DWC_SPINLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
00627 
00628         num_in_eps = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;num_in_eps;
00629         num_out_eps = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;num_out_eps;
00630 
00631         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s() \n"</span>, __func__);
00632         <span class="comment">/* don't disconnect drivers more than once */</span>
00633         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> == EP0_DISCONNECT) {
00634                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"%s() Already Disconnected\n"</span>, __func__);
00635                 DWC_SPINUNLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
00636                 <span class="keywordflow">return</span>;
00637         }
00638         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_DISCONNECT;
00639 
00640         <span class="comment">/* Reset the OTG state. */</span>
00641         <a class="code" href="dwc__otg__pcd__intr_8c.html#a3">dwc_otg_pcd_update_otg</a>(pcd, 1);
00642 
00643         <span class="comment">/* Disable the NP Tx Fifo Empty Interrupt. */</span>
00644         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o6">nptxfempty</a> = 1;
00645         DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintmsk,
00646                          intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
00647 
00648         <span class="comment">/* Flush the FIFOs */</span>
00650         <a class="code" href="dwc__otg__cil_8h.html#a104">dwc_otg_flush_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), 0x10);
00651         <a class="code" href="dwc__otg__cil_8h.html#a105">dwc_otg_flush_rx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd));
00652 
00653         <span class="comment">/* prevent new request submissions, kill any outstanding requests  */</span>
00654         ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
00655         <a class="code" href="dwc__otg__pcd_8h.html#a16">dwc_otg_request_nuke</a>(ep);
00656         <span class="comment">/* prevent new request submissions, kill any outstanding requests  */</span>
00657         <span class="keywordflow">for</span> (i = 0; i &lt; num_in_eps; i++) {
00658                 <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i];
00659                 <a class="code" href="dwc__otg__pcd_8h.html#a16">dwc_otg_request_nuke</a>(ep);
00660         }
00661         <span class="comment">/* prevent new request submissions, kill any outstanding requests  */</span>
00662         <span class="keywordflow">for</span> (i = 0; i &lt; num_out_eps; i++) {
00663                 <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i];
00664                 <a class="code" href="dwc__otg__pcd_8h.html#a16">dwc_otg_request_nuke</a>(ep);
00665         }
00666 
00667         <span class="comment">/* report disconnect; the driver is already quiesced */</span>
00668         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o1">disconnect</a>) {
00669                 DWC_SPINUNLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
00670                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o1">disconnect</a>(pcd);
00671                 DWC_SPINLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
00672         }
00673         DWC_SPINUNLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
00674 }
00675 
<a name="l00679"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a16">00679</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a16">dwc_otg_pcd_handle_i2c_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00680 {
00681         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.d32 = 0 };
00682         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00683 
00684         DWC_PRINTF(<span class="stringliteral">"INTERRUPT Handler not implemented for %s\n"</span>, <span class="stringliteral">"i2cintr"</span>);
00685         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o10">i2cintr</a> = 1;
00686         DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintmsk,
00687                          intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
00688 
00689         <span class="comment">/* Clear interrupt */</span>
00690         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00691         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o10">i2cintr</a> = 1;
00692         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintsts,
00693                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00694         <span class="keywordflow">return</span> 1;
00695 }
00696 
<a name="l00700"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a17">00700</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a17">dwc_otg_pcd_handle_early_suspend_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00701 {
00702         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00703 <span class="preprocessor">#if defined(VERBOSE)</span>
00704 <span class="preprocessor"></span>        DWC_PRINTF(<span class="stringliteral">"Early Suspend Detected\n"</span>);
00705 <span class="preprocessor">#endif</span>
00706 <span class="preprocessor"></span>
00707         <span class="comment">/* Clear interrupt */</span>
00708         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00709         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o11">erlysuspend</a> = 1;
00710         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintsts,
00711                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00712         <span class="keywordflow">return</span> 1;
00713 }
00714 
<a name="l00732"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a18">00732</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a18">ep0_out_start</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
00733                                  <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00734 {
00735         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
00736         <a class="code" href="uniondeptsiz0__data.html">deptsiz0_data_t</a> doeptsize0 = {.d32 = 0 };
00737         <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc;
00738         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> doepctl = {.d32 = 0 };
00739 
00740 <span class="preprocessor">#ifdef VERBOSE</span>
00741 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s() doepctl0=%0x\n"</span>, __func__,
00742                     DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>));
00743 <span class="preprocessor">#endif</span>
00744 <span class="preprocessor"></span>
00745         doeptsize0.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o5">supcnt</a> = 3;
00746         doeptsize0.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o3">pktcnt</a> = 1;
00747         doeptsize0.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o1">xfersize</a> = 8 * 3;
00748 
00749         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
00750                 <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
00752                         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o4">doeptsiz</a>,
00753                                         doeptsize0.<a class="code" href="uniondeptsiz0__data.html#o0">d32</a>);
00754 
00756                         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o5">doepdma</a>,
00757                                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o14">setup_pkt_dma_handle</a>);
00758                 } <span class="keywordflow">else</span> {
00759                         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o16">setup_desc_index</a> =
00760                             (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o16">setup_desc_index</a> + 1) &amp; 1;
00761                         dma_desc =
00762                             dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o14">setup_desc_addr</a>[dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o16">setup_desc_index</a>];
00763 
00765                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> = BS_HOST_BUSY;
00766                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 1;
00767                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 1;
00768                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o1">bytes</a> = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
00769                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o14">setup_pkt_dma_handle</a>;
00770                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o9">sts</a> = 0;
00771                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> = BS_HOST_READY;
00772 
00774                         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o5">doepdma</a>,
00775                                         dev_if-&gt;
00776                                         dma_setup_desc_addr
00777                                         [dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o16">setup_desc_index</a>]);
00778                 }
00779 
00780         } <span class="keywordflow">else</span> {
00782                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o4">doeptsiz</a>,
00783                                 doeptsize0.<a class="code" href="uniondeptsiz0__data.html#o0">d32</a>);
00784         }
00785 
00787         doepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> = 1;
00788         doepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o10">cnak</a> = 1;
00789         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>, doepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
00790 
00791 <span class="preprocessor">#ifdef VERBOSE</span>
00792 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"doepctl0=%0x\n"</span>,
00793                     DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>));
00794         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"diepctl0=%0x\n"</span>,
00795                     DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>));
00796 <span class="preprocessor">#endif</span>
00797 <span class="preprocessor"></span>}
00798 
<a name="l00822"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a19">00822</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a19">dwc_otg_pcd_handle_usb_reset_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
00823 {
00824         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
00825         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
00826         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> doepctl = {.d32 = 0 };
00827         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> diepctl = {.d32 = 0 };
00828         <a class="code" href="uniondaint__data.html">daint_data_t</a> daintmsk = {.d32 = 0 };
00829         <a class="code" href="uniondoepint__data.html">doepmsk_data_t</a> doepmsk = {.d32 = 0 };
00830         <a class="code" href="uniondiepint__data.html">diepmsk_data_t</a> diepmsk = {.d32 = 0 };
00831         <a class="code" href="uniondcfg__data.html">dcfg_data_t</a> dcfg = {.d32 = 0 };
00832         <a class="code" href="uniongrstctl__data.html">grstctl_t</a> resetctl = {.d32 = 0 };
00833         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = {.d32 = 0 };
00834         <span class="keywordtype">int</span> i = 0;
00835         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
00836         <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> power = {.d32 = 0 };
00837 
00838         power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a> = DWC_READ_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>);
00839         <span class="keywordflow">if</span> (power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a>) {
00840                 power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a> = 0;
00841                 power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o1">stoppclk</a> = 1;
00842                 DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>, 0);
00843 
00844                 power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o3">pwrclmp</a> = 1;
00845                 DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>, 0);
00846 
00847                 power.<a class="code" href="unionpcgcctl__data.html#o21">b</a>.<a class="code" href="unionpcgcctl__data.html#o4">rstpdwnmodule</a> = 1;
00848                 DWC_MODIFY_REG32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o9">pcgcctl</a>, power.<a class="code" href="unionpcgcctl__data.html#o0">d32</a>, 0);
00849         }
00850 
00851         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o38">lx_state</a> = DWC_OTG_L0;
00852 
00853         DWC_PRINTF(<span class="stringliteral">"USB RESET\n"</span>);
00854 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
00855 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 1; i &lt; 16; ++i) {
00856                 <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
00857                 <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
00858                 ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a6">get_in_ep</a>(pcd, i);
00859                 <span class="keywordflow">if</span> (ep != 0) {
00860                         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
00861                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> = 0xffffffff;
00862                 }
00863         }
00864 <span class="preprocessor">#endif </span><span class="comment">/* DWC_EN_ISOC */</span>
00865 
00866         <span class="comment">/* reset the HNP settings */</span>
00867         <a class="code" href="dwc__otg__pcd__intr_8c.html#a3">dwc_otg_pcd_update_otg</a>(pcd, 1);
00868 
00869         <span class="comment">/* Clear the Remote Wakeup Signalling */</span>
00870         dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o1">rmtwkupsig</a> = 1;
00871         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>, 0);
00872 
00873         <span class="comment">/* Set NAK for all OUT EPs */</span>
00874         doepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o11">snak</a> = 1;
00875         <span class="keywordflow">for</span> (i = 0; i &lt;= dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o5">num_out_eps</a>; i++) {
00876                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>, doepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
00877         }
00878 
00879         <span class="comment">/* Flush the NP Tx FIFO */</span>
00880         <a class="code" href="dwc__otg__cil_8h.html#a104">dwc_otg_flush_tx_fifo</a>(core_if, 0x10);
00881         <span class="comment">/* Flush the Learning Queue */</span>
00882         resetctl.<a class="code" href="uniongrstctl__data.html#o11">b</a>.<a class="code" href="uniongrstctl__data.html#o4">intknqflsh</a> = 1;
00883         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o4">grstctl</a>, resetctl.<a class="code" href="uniongrstctl__data.html#o0">d32</a>);
00884 
00885         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o27">en_multiple_tx_fifo</a> &amp;&amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
00886                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a> = 0;
00887                 <span class="keywordflow">for</span> (i = 0; i&lt;= core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; ++i) {
00888                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[i] = 0xff;  <span class="comment">// 0xff - EP not active</span>
00889                 }
00890                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[0] = 0;     
00891                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o51">first_in_nextep_seq</a> = 0;
00892                 diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
00893                 diepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o2">nextep</a> = 0;
00894                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>, diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
00895                 
00896                 <span class="comment">/* Update IN Endpoint Mismatch Count by active IN NP EP count + 1 */</span>
00897                 dcfg.<a class="code" href="uniondcfg__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o0">dcfg</a>);
00898                 dcfg.<a class="code" href="uniondcfg__data.html#o12">b</a>.<a class="code" href="uniondcfg__data.html#o8">epmscnt</a> = 2;
00899                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o0">dcfg</a>, dcfg.<a class="code" href="uniondcfg__data.html#o0">d32</a>);
00900 
00901                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,<span class="stringliteral">"%s first_in_nextep_seq= %2d; nextep_seq[]:\n"</span>, 
00902                         __func__, core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o51">first_in_nextep_seq</a>);
00903                 <span class="keywordflow">for</span> (i=0; i &lt;= core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
00904                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%2d\n"</span>, core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[i]);
00905                 }
00906         }
00907 
00908         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
00909                 daintmsk.<a class="code" href="uniondaint__data.html#o36">b</a>.<a class="code" href="uniondaint__data.html#o4">inep0</a> = 1;
00910                 daintmsk.<a class="code" href="uniondaint__data.html#o36">b</a>.<a class="code" href="uniondaint__data.html#o20">outep0</a> = 1;
00911                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o15">deachintmsk</a>,
00912                                 daintmsk.<a class="code" href="uniondaint__data.html#o0">d32</a>);
00913 
00914                 doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o4">setup</a> = 1;
00915                 doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o1">xfercompl</a> = 1;
00916                 doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o3">ahberr</a> = 1;
00917                 doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o2">epdisabled</a> = 1;
00918 
00919                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
00920                         doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o6">stsphsercvd</a> = 1;
00921                         doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o10">bna</a> = 1;
00922                 }
00923 <span class="comment">/*              </span>
00924 <span class="comment">                doepmsk.b.babble = 1;</span>
00925 <span class="comment">                doepmsk.b.nyet = 1;</span>
00926 <span class="comment">                </span>
00927 <span class="comment">                if (core_if-&gt;dma_enable) {</span>
00928 <span class="comment">                        doepmsk.b.nak = 1;</span>
00929 <span class="comment">                }</span>
00930 <span class="comment">*/</span>
00931                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o17">doepeachintmsk</a>[0],
00932                                 doepmsk.<a class="code" href="uniondoepint__data.html#o0">d32</a>);
00933 
00934                 diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o1">xfercompl</a> = 1;
00935                 diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o4">timeout</a> = 1;
00936                 diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o2">epdisabled</a> = 1;
00937                 diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o3">ahberr</a> = 1;
00938                 diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o6">intknepmis</a> = 1; 
00939                 <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o18">en_multiple_tx_fifo</a> &amp;&amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>)
00940                         diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o6">intknepmis</a> = 0; 
00941 
00942 <span class="comment">/*              if (core_if-&gt;dma_desc_enable) {</span>
00943 <span class="comment">                        diepmsk.b.bna = 1;</span>
00944 <span class="comment">                }</span>
00945 <span class="comment">*/</span>
00946 <span class="comment">/*              </span>
00947 <span class="comment">                if (core_if-&gt;dma_enable) {</span>
00948 <span class="comment">                        diepmsk.b.nak = 1;</span>
00949 <span class="comment">                }</span>
00950 <span class="comment">*/</span>
00951                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o16">diepeachintmsk</a>[0],
00952                                 diepmsk.<a class="code" href="uniondiepint__data.html#o0">d32</a>);
00953         } <span class="keywordflow">else</span> {
00954                 daintmsk.<a class="code" href="uniondaint__data.html#o36">b</a>.<a class="code" href="uniondaint__data.html#o4">inep0</a> = 1;
00955                 daintmsk.<a class="code" href="uniondaint__data.html#o36">b</a>.<a class="code" href="uniondaint__data.html#o20">outep0</a> = 1;
00956                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o7">daintmsk</a>,
00957                                 daintmsk.<a class="code" href="uniondaint__data.html#o0">d32</a>);
00958 
00959                 doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o4">setup</a> = 1;
00960                 doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o1">xfercompl</a> = 1;
00961                 doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o3">ahberr</a> = 1;
00962                 doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o2">epdisabled</a> = 1;
00963 
00964                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
00965                         doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o6">stsphsercvd</a> = 1;
00966                         doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o10">bna</a> = 1;
00967                 }
00968                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o5">doepmsk</a>, doepmsk.<a class="code" href="uniondoepint__data.html#o0">d32</a>);
00969 
00970                 diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o1">xfercompl</a> = 1;
00971                 diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o4">timeout</a> = 1;
00972                 diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o2">epdisabled</a> = 1;
00973                 diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o3">ahberr</a> = 1;
00974                 <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o18">en_multiple_tx_fifo</a> &amp;&amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>)
00975                         diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o6">intknepmis</a> = 0; 
00976 <span class="comment">/*</span>
00977 <span class="comment">                if (core_if-&gt;dma_desc_enable) {</span>
00978 <span class="comment">                        diepmsk.b.bna = 1;</span>
00979 <span class="comment">                }</span>
00980 <span class="comment">*/</span>
00981 
00982                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o4">diepmsk</a>, diepmsk.<a class="code" href="uniondiepint__data.html#o0">d32</a>);
00983         }
00984 
00985         <span class="comment">/* Reset Device Address */</span>
00986         dcfg.<a class="code" href="uniondcfg__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o0">dcfg</a>);
00987         dcfg.<a class="code" href="uniondcfg__data.html#o12">b</a>.<a class="code" href="uniondcfg__data.html#o4">devaddr</a> = 0;
00988         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o0">dcfg</a>, dcfg.<a class="code" href="uniondcfg__data.html#o0">d32</a>);
00989 
00990         <span class="comment">/* setup EP0 to receive SETUP packets */</span>
00991         <a class="code" href="dwc__otg__pcd__intr_8c.html#a18">ep0_out_start</a>(core_if, pcd);
00992 
00993         <span class="comment">/* Clear interrupt */</span>
00994         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
00995         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o13">usbreset</a> = 1;
00996         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
00997 
00998         <span class="keywordflow">return</span> 1;
00999 }
01000 
<a name="l01007"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a20">01007</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a20">get_device_speed</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
01008 {
01009         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts;
01010         <span class="keywordtype">int</span> speed = 0;
01011         dsts.<a class="code" href="uniondsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o2">dsts</a>);
01012 
01013         <span class="keywordflow">switch</span> (dsts.<a class="code" href="uniondsts__data.html#o7">b</a>.<a class="code" href="uniondsts__data.html#o2">enumspd</a>) {
01014         <span class="keywordflow">case</span> DWC_DSTS_ENUMSPD_HS_PHY_30MHZ_OR_60MHZ:
01015                 speed = USB_SPEED_HIGH;
01016                 <span class="keywordflow">break</span>;
01017         <span class="keywordflow">case</span> DWC_DSTS_ENUMSPD_FS_PHY_30MHZ_OR_60MHZ:
01018         <span class="keywordflow">case</span> DWC_DSTS_ENUMSPD_FS_PHY_48MHZ:
01019                 speed = USB_SPEED_FULL;
01020                 <span class="keywordflow">break</span>;
01021 
01022         <span class="keywordflow">case</span> DWC_DSTS_ENUMSPD_LS_PHY_6MHZ:
01023                 speed = USB_SPEED_LOW;
01024                 <span class="keywordflow">break</span>;
01025         }
01026 
01027         <span class="keywordflow">return</span> speed;
01028 }
01029 
<a name="l01035"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a21">01035</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a21">dwc_otg_pcd_handle_enum_done_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01036 {
01037         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep0 = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
01038         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01039         <a class="code" href="uniongusbcfg__data.html">gusbcfg_data_t</a> gusbcfg;
01040         <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs =
01041             <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs;
01042         uint8_t utmi16b, utmi8b;
01043         <span class="keywordtype">int</span> speed;
01044         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"SPEED ENUM\n"</span>);
01045 
01046         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;snpsid &gt;= OTG_CORE_REV_2_60a) {
01047                 utmi16b = 6;    <span class="comment">//vahrama old value was 6;</span>
01048                 utmi8b = 9;
01049         } <span class="keywordflow">else</span> {
01050                 utmi16b = 4;
01051                 utmi8b = 8;
01052         }
01053         <a class="code" href="dwc__otg__cil_8h.html#a78">dwc_otg_ep0_activate</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01054 
01055 <span class="preprocessor">#ifdef DEBUG_EP0</span>
01056 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__pcd__intr_8c.html#a4">print_ep0_state</a>(pcd);
01057 <span class="preprocessor">#endif</span>
01058 <span class="preprocessor"></span>
01059         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> == EP0_DISCONNECT) {
01060                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_IDLE;
01061         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> == EP0_STALL) {
01062                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_IDLE;
01063         }
01064 
01065         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_IDLE;
01066 
01067         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 0;
01068 
01069         speed = <a class="code" href="dwc__otg__pcd__intr_8c.html#a20">get_device_speed</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd));
01070         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o0">connect</a>(pcd, speed);
01071 
01072         <span class="comment">/* Set USB turnaround time based on device speed and PHY interface. */</span>
01073         gusbcfg.<a class="code" href="uniongusbcfg__data.html#o0">d32</a> = DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o3">gusbcfg</a>);
01074         <span class="keywordflow">if</span> (speed == USB_SPEED_HIGH) {
01075                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;hwcfg2.b.hs_phy_type ==
01076                     DWC_HWCFG2_HS_PHY_TYPE_ULPI) {
01077                         <span class="comment">/* ULPI interface */</span>
01078                         gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o9">usbtrdtim</a> = 9;
01079                 }
01080                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;hwcfg2.b.hs_phy_type ==
01081                     DWC_HWCFG2_HS_PHY_TYPE_UTMI) {
01082                         <span class="comment">/* UTMI+ interface */</span>
01083                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;hwcfg4.b.utmi_phy_data_width == 0) {
01084                                 gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o9">usbtrdtim</a> = utmi8b;
01085                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;hwcfg4.
01086                                    b.utmi_phy_data_width == 1) {
01087                                 gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o9">usbtrdtim</a> = utmi16b;
01088                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;
01089                                    core_params-&gt;phy_utmi_width == 8) {
01090                                 gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o9">usbtrdtim</a> = utmi8b;
01091                         } <span class="keywordflow">else</span> {
01092                                 gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o9">usbtrdtim</a> = utmi16b;
01093                         }
01094                 }
01095                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;hwcfg2.b.hs_phy_type ==
01096                     DWC_HWCFG2_HS_PHY_TYPE_UTMI_ULPI) {
01097                         <span class="comment">/* UTMI+  OR  ULPI interface */</span>
01098                         <span class="keywordflow">if</span> (gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o3">ulpi_utmi_sel</a> == 1) {
01099                                 <span class="comment">/* ULPI interface */</span>
01100                                 gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o9">usbtrdtim</a> = 9;
01101                         } <span class="keywordflow">else</span> {
01102                                 <span class="comment">/* UTMI+ interface */</span>
01103                                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;
01104                                     core_params-&gt;phy_utmi_width == 16) {
01105                                         gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o9">usbtrdtim</a> = utmi16b;
01106                                 } <span class="keywordflow">else</span> {
01107                                         gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o9">usbtrdtim</a> = utmi8b;
01108                                 }
01109                         }
01110                 }
01111         } <span class="keywordflow">else</span> {
01112                 <span class="comment">/* Full or low speed */</span>
01113                 gusbcfg.<a class="code" href="uniongusbcfg__data.html#o28">b</a>.<a class="code" href="uniongusbcfg__data.html#o9">usbtrdtim</a> = 9;
01114         }
01115         DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o3">gusbcfg</a>, gusbcfg.<a class="code" href="uniongusbcfg__data.html#o0">d32</a>);
01116 
01117         <span class="comment">/* Clear interrupt */</span>
01118         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01119         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o14">enumdone</a> = 1;
01120         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintsts,
01121                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01122         <span class="keywordflow">return</span> 1;
01123 }
01124 
<a name="l01130"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a22">01130</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a22">dwc_otg_pcd_handle_isoc_out_packet_dropped_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01131 {
01132         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
01133         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01134 
01135         DWC_WARN(<span class="stringliteral">"INTERRUPT Handler not implemented for %s\n"</span>,
01136                  <span class="stringliteral">"ISOC Out Dropped"</span>);
01137 
01138         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o15">isooutdrop</a> = 1;
01139         DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintmsk,
01140                          intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
01141 
01142         <span class="comment">/* Clear interrupt */</span>
01143         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01144         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o15">isooutdrop</a> = 1;
01145         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintsts,
01146                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01147 
01148         <span class="keywordflow">return</span> 1;
01149 }
01150 
<a name="l01156"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a23">01156</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a23">dwc_otg_pcd_handle_end_periodic_frame_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01157 {
01158         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
01159         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01160         DWC_PRINTF(<span class="stringliteral">"INTERRUPT Handler not implemented for %s\n"</span>, <span class="stringliteral">"EOP"</span>);
01161 
01162         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o16">eopframe</a> = 1;
01163         DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintmsk,
01164                          intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
01165 
01166         <span class="comment">/* Clear interrupt */</span>
01167         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01168         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o16">eopframe</a> = 1;
01169         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintsts,
01170                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01171 
01172         <span class="keywordflow">return</span> 1;
01173 }
01174 
<a name="l01184"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a24">01184</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a24">dwc_otg_pcd_handle_ep_mismatch_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01185 {
01186         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01187         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01188         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl;
01189         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
01190 
01191         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o18">en_multiple_tx_fifo</a> &amp;&amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
01192                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a> = 1;
01193         
01194                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, core_if);
01195         
01196                 gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
01197                 <span class="keywordflow">if</span> (!gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o7">ginnakeff</a>) {
01198                         <span class="comment">/* Disable EP Mismatch interrupt */</span>
01199                         intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = 0;
01200                         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o18">epmismatch</a> = 1;
01201                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
01202                         <span class="comment">/* Enable the Global IN NAK Effective Interrupt */</span>
01203                         intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = 0;
01204                         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o7">ginnakeff</a> = 1;
01205                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0, intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
01206                         <span class="comment">/* Set the global non-periodic IN NAK handshake */</span>
01207                         dctl.<a class="code" href="uniondctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>);
01208                         dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o6">sgnpinnak</a> = 1;
01209                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
01210                 } <span class="keywordflow">else</span> {
01211                         DWC_PRINTF(<span class="stringliteral">"gintsts.b.ginnakeff = 1! dctl.b.sgnpinnak not set\n"</span>);
01212                 }
01213                 <span class="comment">/* Disabling of all EP's will be done in dwc_otg_pcd_handle_in_nak_effective()</span>
01214 <span class="comment">                 * handler after Global IN NAK Effective interrupt will be asserted */</span>
01215         }
01216         <span class="comment">/* Clear interrupt */</span>
01217         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01218         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o18">epmismatch</a> = 1;
01219         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01220 
01221         <span class="keywordflow">return</span> 1;
01222 }
01223 
<a name="l01232"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a25">01232</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a25">dwc_otg_pcd_handle_ep_fetsusp_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01233 {
01234         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
01235         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> <a class="code" href="uniongintmsk__data.html">gintmsk_data</a>;
01236         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl;
01237         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01238         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, core_if);
01239         
01240         <span class="comment">/* Clear the global non-periodic IN NAK handshake */</span>
01241         dctl.<a class="code" href="uniondctl__data.html#o0">d32</a> = 0;
01242         dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o7">cgnpinnak</a> = 1;
01243         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>); 
01244         
01245         <span class="comment">/* Mask GINTSTS.FETSUSP interrupt */</span>
01246         gintmsk_data.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>);
01247         gintmsk_data.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o23">fetsusp</a> = 0;
01248         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, gintmsk_data.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
01249 
01250         <span class="comment">/* Clear interrupt */</span>
01251         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
01252         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o23">fetsusp</a> = 1;
01253         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
01254 
01255         <span class="keywordflow">return</span> 1;
01256 }
<a name="l01260"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a26">01260</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keyword">const</span> <span class="keywordtype">int</span> err_val)
01261 {
01262         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep0 = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
01263         usb_device_request_t *ctrl = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>;
01264         DWC_WARN(<span class="stringliteral">"req %02x.%02x protocol STALL; err %d\n"</span>,
01265                  ctrl-&gt;bmRequestType, ctrl-&gt;bRequest, err_val);
01266 
01267         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 1;
01268         <a class="code" href="dwc__otg__cil_8h.html#a86">dwc_otg_ep_set_stall</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01269         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
01270         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_IDLE;
01271         <a class="code" href="dwc__otg__pcd__intr_8c.html#a18">ep0_out_start</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), pcd);
01272 }
01273 
<a name="l01277"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a27">01277</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a27">do_gadget_setup</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
01278                                    usb_device_request_t * ctrl)
01279 {
01280         <span class="keywordtype">int</span> ret = 0;
01281         DWC_SPINUNLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
01282         ret = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o2">setup</a>(pcd, (uint8_t *) ctrl);
01283         DWC_SPINLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
01284         <span class="keywordflow">if</span> (ret &lt; 0) {
01285                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, ret);
01286         }
01287 
01300         <span class="keywordflow">if</span> (ret == 256 + 999) {
01301                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o5">request_config</a> = 1;
01302         }
01303 }
01304 
01305 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01306 <span class="preprocessor"></span>
01310 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> cfi_gadget_setup(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
01311                                    <span class="keyword">struct</span> <a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *ctrl_req)
01312 {
01313         <span class="keywordtype">int</span> ret = 0;
01314 
01315         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a> &amp;&amp; pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o10">cfi_setup</a>) {
01316                 DWC_SPINUNLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
01317                 ret = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o0">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#o10">cfi_setup</a>(pcd, ctrl_req);
01318                 DWC_SPINLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
01319                 <span class="keywordflow">if</span> (ret &lt; 0) {
01320                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, ret);
01321                         <span class="keywordflow">return</span> ret;
01322                 }
01323         }
01324 
01325         <span class="keywordflow">return</span> ret;
01326 }
01327 <span class="preprocessor">#endif</span>
01328 <span class="preprocessor"></span>
<a name="l01333"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a28">01333</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01334 {
01335         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep0 = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
01336         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> == EP0_STALL) {
01337                 <span class="keywordflow">return</span>;
01338         }
01339 
01340         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_IN_STATUS_PHASE;
01341 
01342         <span class="comment">/* Prepare for more SETUP Packets */</span>
01343         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"EP0 IN ZLP\n"</span>);
01344         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 0;
01345         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
01346         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 1;
01347         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o14">setup_pkt_dma_handle</a>;
01348         <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01349 
01350         <span class="comment">/* Prepare for more SETUP Packets */</span>
01351         <span class="comment">//ep0_out_start(GET_CORE_IF(pcd), pcd);</span>
01352 }
01353 
<a name="l01358"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a29">01358</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a29">do_setup_out_status_phase</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01359 {
01360         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep0 = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
01361         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> == EP0_STALL) {
01362                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"EP0 STALLED\n"</span>);
01363                 <span class="keywordflow">return</span>;
01364         }
01365         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_OUT_STATUS_PHASE;
01366 
01367         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"EP0 OUT ZLP\n"</span>);
01368         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 0;
01369         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
01370         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 0;
01371         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o14">setup_pkt_dma_handle</a>;
01372         <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01373 
01374         <span class="comment">/* Prepare for more SETUP Packets */</span>
01375         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dma_enable == 0) {
01376                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a18">ep0_out_start</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), pcd);
01377         }
01378 }
01379 
<a name="l01384"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a30">01384</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a30">pcd_clear_halt</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
01385 {
01386         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_9">stall_clear_flag</a> == 0)
01387                 <a class="code" href="dwc__otg__cil_8h.html#a87">dwc_otg_ep_clear_stall</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01388 
01389         <span class="comment">/* Reactive the EP */</span>
01390         <a class="code" href="dwc__otg__cil_8h.html#a79">dwc_otg_ep_activate</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01391         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>) {
01392                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 0;
01393                 <span class="comment">/* If there is a request in the EP queue start it */</span>
01394 
01398                 <span class="comment">/*</span>
01399 <span class="comment">                 * Above fixme is solved by implmenting a tasklet to call the</span>
01400 <span class="comment">                 * start_next_request(), outside of interrupt context at some</span>
01401 <span class="comment">                 * time after the current time, after a clear-halt setup packet.</span>
01402 <span class="comment">                 * Still need to implement ep mismatch in the future if a gadget</span>
01403 <span class="comment">                 * ever uses more than one endpoint at once</span>
01404 <span class="comment">                 */</span>
01405                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o5">queue_sof</a> = 1;
01406                 DWC_TASK_SCHEDULE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o22">start_xfer_tasklet</a>);
01407         }
01408         <span class="comment">/* Start Control Status Phase */</span>
01409         <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
01410 }
01411 
<a name="l01423"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a31">01423</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a31">do_test_mode</a>(<span class="keywordtype">void</span> *data)
01424 {
01425         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl;
01426         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) data;
01427         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01428         <span class="keywordtype">int</span> test_mode = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o23">test_mode</a>;
01429 
01430 <span class="comment">//        DWC_WARN("%s() has not been tested since being rewritten!\n", __func__);</span>
01431 
01432         dctl.<a class="code" href="uniondctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>);
01433         <span class="keywordflow">switch</span> (test_mode) {
01434         <span class="keywordflow">case</span> 1:         <span class="comment">// TEST_J</span>
01435                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o5">tstctl</a> = 1;
01436                 <span class="keywordflow">break</span>;
01437 
01438         <span class="keywordflow">case</span> 2:         <span class="comment">// TEST_K</span>
01439                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o5">tstctl</a> = 2;
01440                 <span class="keywordflow">break</span>;
01441 
01442         <span class="keywordflow">case</span> 3:         <span class="comment">// TEST_SE0_NAK</span>
01443                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o5">tstctl</a> = 3;
01444                 <span class="keywordflow">break</span>;
01445 
01446         <span class="keywordflow">case</span> 4:         <span class="comment">// TEST_PACKET</span>
01447                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o5">tstctl</a> = 4;
01448                 <span class="keywordflow">break</span>;
01449 
01450         <span class="keywordflow">case</span> 5:         <span class="comment">// TEST_FORCE_ENABLE</span>
01451                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o5">tstctl</a> = 5;
01452                 <span class="keywordflow">break</span>;
01453         }
01454         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
01455 }
01456 
<a name="l01460"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a32">01460</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a32">do_get_status</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01461 {
01462         usb_device_request_t ctrl = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>;
01463         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
01464         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep0 = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
01465         uint16_t *status = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a>;
01466         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01467 
01468 <span class="preprocessor">#ifdef DEBUG_EP0</span>
01469 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>,
01470                     <span class="stringliteral">"GET_STATUS %02x.%02x v%04x i%04x l%04x\n"</span>,
01471                     ctrl.bmRequestType, ctrl.bRequest,
01472                     UGETW(ctrl.wValue), UGETW(ctrl.wIndex),
01473                     UGETW(ctrl.wLength));
01474 <span class="preprocessor">#endif</span>
01475 <span class="preprocessor"></span>
01476         <span class="keywordflow">switch</span> (UT_GET_RECIPIENT(ctrl.bmRequestType)) {
01477         <span class="keywordflow">case</span> UT_DEVICE:
01478                 <span class="keywordflow">if</span>(UGETW(ctrl.wIndex) == 0xF000) { <span class="comment">/* OTG Status selector */</span>
01479                         DWC_PRINTF(<span class="stringliteral">"wIndex - %d\n"</span>, UGETW(ctrl.wIndex));
01480                         DWC_PRINTF(<span class="stringliteral">"OTG VERSION - %d\n"</span>, core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o46">otg_ver</a>);
01481                         DWC_PRINTF(<span class="stringliteral">"OTG CAP - %d, %d\n"</span>, core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o1">otg_cap</a>,
01482                                                 DWC_OTG_CAP_PARAM_HNP_SRP_CAPABLE);
01483                         <span class="keywordflow">if</span>(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o46">otg_ver</a> == 1 &amp;&amp; 
01484                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o1">otg_cap</a> == DWC_OTG_CAP_PARAM_HNP_SRP_CAPABLE) {
01485                                 uint8_t *otgsts = (uint8_t*)pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o15">status_buf</a>;
01486                                 *otgsts = (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o47">otg_sts</a> &amp; 0x1);
01487                                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 1;
01488                                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = (uint8_t *) otgsts;
01489                                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = (uint8_t *) otgsts;
01490                                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o16">status_buf_dma_handle</a>;
01491                                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 1;
01492                                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
01493                                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>;
01494                                 <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01495                                 <span class="keywordflow">return</span>;
01496                         } <span class="keywordflow">else</span> {
01497                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, -DWC_E_NOT_SUPPORTED);
01498                                 <span class="keywordflow">return</span>;
01499                         }
01500                         <span class="keywordflow">break</span>;
01501                 } <span class="keywordflow">else</span> {
01502                         *status = 0x1;  <span class="comment">/* Self powered */</span>
01503                         *status |= pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o6">remote_wakeup_enable</a> &lt;&lt; 1;
01504                         <span class="keywordflow">break</span>;
01505                 }
01506         <span class="keywordflow">case</span> UT_INTERFACE:
01507                 *status = 0;
01508                 <span class="keywordflow">break</span>;
01509 
01510         <span class="keywordflow">case</span> UT_ENDPOINT:
01511                 ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a8">get_ep_by_addr</a>(pcd, UGETW(ctrl.wIndex));
01512                 <span class="keywordflow">if</span> (ep == 0 || UGETW(ctrl.wLength) &gt; 2) {
01513                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, -DWC_E_NOT_SUPPORTED);
01514                         <span class="keywordflow">return</span>;
01515                 }
01517                 *status = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>;
01518                 <span class="keywordflow">break</span>;
01519         }
01520         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 1;
01521         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = (uint8_t *) status;
01522         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = (uint8_t *) status;
01523         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o16">status_buf_dma_handle</a>;
01524         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 2;
01525         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
01526         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> = ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>;
01527         <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01528 }
01529 
<a name="l01533"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a33">01533</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a33">do_set_feature</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01534 {
01535         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01536         <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>;
01537         usb_device_request_t ctrl = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>;
01538         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = 0;
01539         int32_t otg_cap_param = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o1">otg_cap</a>;
01540         <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl = {.d32 = 0 };
01541 
01542         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"SET_FEATURE:%02x.%02x v%04x i%04x l%04x\n"</span>,
01543                     ctrl.bmRequestType, ctrl.bRequest,
01544                     UGETW(ctrl.wValue), UGETW(ctrl.wIndex),
01545                     UGETW(ctrl.wLength));
01546         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"otg_cap=%d\n"</span>, otg_cap_param);
01547 
01548         <span class="keywordflow">switch</span> (UT_GET_RECIPIENT(ctrl.bmRequestType)) {
01549         <span class="keywordflow">case</span> UT_DEVICE:
01550                 <span class="keywordflow">switch</span> (UGETW(ctrl.wValue)) {
01551                 <span class="keywordflow">case</span> UF_DEVICE_REMOTE_WAKEUP:
01552                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o6">remote_wakeup_enable</a> = 1;
01553                         <span class="keywordflow">break</span>;
01554 
01555                 <span class="keywordflow">case</span> UF_TEST_MODE:
01556                         <span class="comment">/* Setup the Test Mode tasklet to do the Test</span>
01557 <span class="comment">                         * Packet generation after the SETUP Status</span>
01558 <span class="comment">                         * phase has completed. */</span>
01559 
01563                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o23">test_mode</a> = UGETW(ctrl.wIndex) &gt;&gt; 8;
01564                         DWC_TASK_SCHEDULE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o21">test_mode_tasklet</a>);
01565                         <span class="keywordflow">break</span>;
01566 
01567                 <span class="keywordflow">case</span> UF_DEVICE_B_HNP_ENABLE:
01568                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
01569                                     <span class="stringliteral">"SET_FEATURE: USB_DEVICE_B_HNP_ENABLE\n"</span>);
01570 
01571                         <span class="comment">/* dev may initiate HNP */</span>
01572                         <span class="keywordflow">if</span> (otg_cap_param == DWC_OTG_CAP_PARAM_HNP_SRP_CAPABLE) {
01573                                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o7">b_hnp_enable</a> = 1;
01574                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a3">dwc_otg_pcd_update_otg</a>(pcd, 0);
01575                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"Request B HNP\n"</span>);
01578                                 gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o12">devhnpen</a> = 1;
01579                                 gotgctl.<a class="code" href="uniongotgctl__data.html#o23">b</a>.<a class="code" href="uniongotgctl__data.html#o10">hnpreq</a> = 1;
01580                                 DWC_WRITE_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o0">gotgctl</a>,
01581                                                 gotgctl.<a class="code" href="uniongotgctl__data.html#o0">d32</a>);
01582                         } <span class="keywordflow">else</span> {
01583                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, -DWC_E_NOT_SUPPORTED);
01584                                 <span class="keywordflow">return</span>;
01585                         }
01586                         <span class="keywordflow">break</span>;
01587 
01588                 <span class="keywordflow">case</span> UF_DEVICE_A_HNP_SUPPORT:
01589                         <span class="comment">/* RH port supports HNP */</span>
01590                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
01591                                     <span class="stringliteral">"SET_FEATURE: USB_DEVICE_A_HNP_SUPPORT\n"</span>);
01592                         <span class="keywordflow">if</span> (otg_cap_param == DWC_OTG_CAP_PARAM_HNP_SRP_CAPABLE) {
01593                                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o8">a_hnp_support</a> = 1;
01594                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a3">dwc_otg_pcd_update_otg</a>(pcd, 0);
01595                         } <span class="keywordflow">else</span> {
01596                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, -DWC_E_NOT_SUPPORTED);
01597                                 <span class="keywordflow">return</span>;
01598                         }
01599                         <span class="keywordflow">break</span>;
01600 
01601                 <span class="keywordflow">case</span> UF_DEVICE_A_ALT_HNP_SUPPORT:
01602                         <span class="comment">/* other RH port does */</span>
01603                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
01604                                     <span class="stringliteral">"SET_FEATURE: USB_DEVICE_A_ALT_HNP_SUPPORT\n"</span>);
01605                         <span class="keywordflow">if</span> (otg_cap_param == DWC_OTG_CAP_PARAM_HNP_SRP_CAPABLE) {
01606                                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o9">a_alt_hnp_support</a> = 1;
01607                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a3">dwc_otg_pcd_update_otg</a>(pcd, 0);
01608                         } <span class="keywordflow">else</span> {
01609                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, -DWC_E_NOT_SUPPORTED);
01610                                 <span class="keywordflow">return</span>;
01611                         }
01612                         <span class="keywordflow">break</span>;
01613 
01614                 <span class="keywordflow">default</span>:
01615                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, -DWC_E_NOT_SUPPORTED);
01616                         <span class="keywordflow">return</span>;
01617 
01618                 }
01619                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
01620                 <span class="keywordflow">break</span>;
01621 
01622         <span class="keywordflow">case</span> UT_INTERFACE:
01623                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a27">do_gadget_setup</a>(pcd, &amp;ctrl);
01624                 <span class="keywordflow">break</span>;
01625 
01626         <span class="keywordflow">case</span> UT_ENDPOINT:
01627                 <span class="keywordflow">if</span> (UGETW(ctrl.wValue) == UF_ENDPOINT_HALT) {
01628                         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a8">get_ep_by_addr</a>(pcd, UGETW(ctrl.wIndex));
01629                         <span class="keywordflow">if</span> (ep == 0) {
01630                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, -DWC_E_NOT_SUPPORTED);
01631                                 <span class="keywordflow">return</span>;
01632                         }
01633                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
01634                         <a class="code" href="dwc__otg__cil_8h.html#a86">dwc_otg_ep_set_stall</a>(core_if, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
01635                 }
01636                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
01637                 <span class="keywordflow">break</span>;
01638         }
01639 }
01640 
<a name="l01644"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a34">01644</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a34">do_clear_feature</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01645 {
01646         usb_device_request_t ctrl = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>;
01647         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = 0;
01648 
01649         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>,
01650                     <span class="stringliteral">"CLEAR_FEATURE:%02x.%02x v%04x i%04x l%04x\n"</span>,
01651                     ctrl.bmRequestType, ctrl.bRequest,
01652                     UGETW(ctrl.wValue), UGETW(ctrl.wIndex),
01653                     UGETW(ctrl.wLength));
01654 
01655         <span class="keywordflow">switch</span> (UT_GET_RECIPIENT(ctrl.bmRequestType)) {
01656         <span class="keywordflow">case</span> UT_DEVICE:
01657                 <span class="keywordflow">switch</span> (UGETW(ctrl.wValue)) {
01658                 <span class="keywordflow">case</span> UF_DEVICE_REMOTE_WAKEUP:
01659                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o6">remote_wakeup_enable</a> = 0;
01660                         <span class="keywordflow">break</span>;
01661 
01662                 <span class="keywordflow">case</span> UF_TEST_MODE:
01664                         <span class="keywordflow">break</span>;
01665 
01666                 <span class="keywordflow">default</span>:
01667                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, -DWC_E_NOT_SUPPORTED);
01668                         <span class="keywordflow">return</span>;
01669                 }
01670                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
01671                 <span class="keywordflow">break</span>;
01672 
01673         <span class="keywordflow">case</span> UT_ENDPOINT:
01674                 ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a8">get_ep_by_addr</a>(pcd, UGETW(ctrl.wIndex));
01675                 <span class="keywordflow">if</span> (ep == 0) {
01676                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, -DWC_E_NOT_SUPPORTED);
01677                         <span class="keywordflow">return</span>;
01678                 }
01679 
01680                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a30">pcd_clear_halt</a>(pcd, ep);
01681 
01682                 <span class="keywordflow">break</span>;
01683         }
01684 }
01685 
<a name="l01689"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a35">01689</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a35">do_set_address</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01690 {
01691         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if;
01692         usb_device_request_t ctrl = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>;
01693 
01694         <span class="keywordflow">if</span> (ctrl.bmRequestType == UT_DEVICE) {
01695                 <a class="code" href="uniondcfg__data.html">dcfg_data_t</a> dcfg = {.<a class="code" href="structdwc__otg__pcd.html#o12">d32</a> = 0 };
01696 
01697 <span class="preprocessor">#ifdef DEBUG_EP0</span>
01698 <span class="preprocessor"></span><span class="comment">//                      DWC_DEBUGPL(DBG_PCDV, "SET_ADDRESS:%d\n", ctrl.wValue);</span>
01699 <span class="preprocessor">#endif</span>
01700 <span class="preprocessor"></span>                dcfg.<a class="code" href="uniondcfg__data.html#o12">b</a>.<a class="code" href="uniondcfg__data.html#o4">devaddr</a> = UGETW(ctrl.wValue);
01701                 DWC_MODIFY_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o0">dcfg</a>, 0, dcfg.<a class="code" href="uniondcfg__data.html#o0">d32</a>);
01702                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
01703         }
01704 }
01705 
<a name="l01756"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a36">01756</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a36">pcd_setup</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
01757 {
01758         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
01759         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
01760         usb_device_request_t ctrl = pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o13">setup_pkt</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o11">req</a>;
01761         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep0 = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
01762 
01763         <a class="code" href="uniondeptsiz0__data.html">deptsiz0_data_t</a> doeptsize0 = {.d32 = 0 };
01764 
01765 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01766 <span class="preprocessor"></span>        <span class="keywordtype">int</span> retval = 0;
01767         <span class="keyword">struct </span><a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> cfi_req;
01768 <span class="preprocessor">#endif</span>
01769 <span class="preprocessor"></span>
01770 <span class="preprocessor">#ifdef DEBUG_EP0</span>
01771 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"SETUP %02x.%02x v%04x i%04x l%04x\n"</span>,
01772                     ctrl.bmRequestType, ctrl.bRequest,
01773                     UGETW(ctrl.wValue), UGETW(ctrl.wIndex),
01774                     UGETW(ctrl.wLength));
01775 <span class="preprocessor">#endif</span>
01776 <span class="preprocessor"></span>
01777         doeptsize0.<a class="code" href="uniondeptsiz0__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o4">doeptsiz</a>);
01778 
01781         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a> &amp;&amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> == 0
01782             &amp;&amp; (doeptsize0.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o5">supcnt</a> &lt; 2)) {
01783                 DWC_ERROR
01784                     (<span class="stringliteral">"\n\n-----------    CANNOT handle &gt; 1 setup packet in DMA mode\n\n"</span>);
01785         }
01786 
01787         <span class="comment">/* Clean up the request queue */</span>
01788         <a class="code" href="dwc__otg__pcd_8h.html#a16">dwc_otg_request_nuke</a>(ep0);
01789         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 0;
01790 
01791         <span class="keywordflow">if</span> (ctrl.bmRequestType &amp; UE_DIR_IN) {
01792                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 1;
01793                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_IN_DATA_PHASE;
01794         } <span class="keywordflow">else</span> {
01795                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 0;
01796                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_OUT_DATA_PHASE;
01797         }
01798 
01799         <span class="keywordflow">if</span> (UGETW(ctrl.wLength) == 0) {
01800                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 1;
01801                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_IN_STATUS_PHASE;
01802         }
01803 
01804         <span class="keywordflow">if</span> (UT_GET_TYPE(ctrl.bmRequestType) != UT_STANDARD) {
01805 
01806 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01807 <span class="preprocessor"></span>                DWC_MEMCPY(&amp;cfi_req, &amp;ctrl, <span class="keyword">sizeof</span>(usb_device_request_t));
01808 
01809                 <span class="comment">//printk(KERN_ALERT "CFI: req_type=0x%02x; req=0x%02x\n", </span>
01810                                 ctrl.bRequestType, ctrl.bRequest);
01811                 <span class="keywordflow">if</span> (UT_GET_TYPE(cfi_req.<a class="code" href="structcfi__usb__ctrlrequest.html#o0">bRequestType</a>) == UT_VENDOR) {
01812                         <span class="keywordflow">if</span> (cfi_req.<a class="code" href="structcfi__usb__ctrlrequest.html#o1">bRequest</a> &gt; 0xB0 &amp;&amp; cfi_req.<a class="code" href="structcfi__usb__ctrlrequest.html#o1">bRequest</a> &lt; 0xBF) {
01813                                 retval = cfi_setup(pcd, &amp;cfi_req);
01814                                 <span class="keywordflow">if</span> (retval &lt; 0) {
01815                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, retval);
01816                                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 0;
01817                                         <span class="keywordflow">return</span>;
01818                                 }
01819 
01820                                 <span class="comment">/* if need gadget setup then call it and check the retval */</span>
01821                                 <span class="keywordflow">if</span> (pcd-&gt;cfi-&gt;need_gadget_att) {
01822                                         retval =
01823                                             cfi_gadget_setup(pcd,
01824                                                              &amp;pcd-&gt;
01825                                                              cfi-&gt;ctrl_req);
01826                                         <span class="keywordflow">if</span> (retval &lt; 0) {
01827                                                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 0;
01828                                                 <span class="keywordflow">return</span>;
01829                                         }
01830                                 }
01831 
01832                                 <span class="keywordflow">if</span> (pcd-&gt;cfi-&gt;need_status_in_complete) {
01833                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
01834                                 }
01835                                 <span class="keywordflow">return</span>;
01836                         }
01837                 }
01838 <span class="preprocessor">#endif</span>
01839 <span class="preprocessor"></span>
01840                 <span class="comment">/* handle non-standard (class/vendor) requests in the gadget driver */</span>
01841                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a27">do_gadget_setup</a>(pcd, &amp;ctrl);
01842                 <span class="keywordflow">return</span>;
01843         }
01844 
01847 
01848 
01849 
01850         <span class="keywordflow">switch</span> (ctrl.bRequest) {
01851         <span class="keywordflow">case</span> UR_GET_STATUS:
01852                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a32">do_get_status</a>(pcd);
01853                 <span class="keywordflow">break</span>;
01854 
01855         <span class="keywordflow">case</span> UR_CLEAR_FEATURE:
01856                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a34">do_clear_feature</a>(pcd);
01857                 <span class="keywordflow">break</span>;
01858 
01859         <span class="keywordflow">case</span> UR_SET_FEATURE:
01860                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a33">do_set_feature</a>(pcd);
01861                 <span class="keywordflow">break</span>;
01862 
01863         <span class="keywordflow">case</span> UR_SET_ADDRESS:
01864                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a35">do_set_address</a>(pcd);
01865                 <span class="keywordflow">break</span>;
01866 
01867         <span class="keywordflow">case</span> UR_SET_INTERFACE:
01868         <span class="keywordflow">case</span> UR_SET_CONFIG:
01869 <span class="comment">//              _pcd-&gt;request_config = 1;       /* Configuration changed */</span>
01870                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a27">do_gadget_setup</a>(pcd, &amp;ctrl);
01871                 <span class="keywordflow">break</span>;
01872 
01873         <span class="keywordflow">case</span> UR_SYNCH_FRAME:
01874                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a27">do_gadget_setup</a>(pcd, &amp;ctrl);
01875                 <span class="keywordflow">break</span>;
01876 
01877         <span class="keywordflow">default</span>:
01878                 <span class="comment">/* Call the Gadget Driver's setup functions */</span>
01879                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a27">do_gadget_setup</a>(pcd, &amp;ctrl);
01880                 <span class="keywordflow">break</span>;
01881         }
01882 }
01883 
<a name="l01887"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a37">01887</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a37">ep0_complete_request</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
01888 {
01889         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>);
01890         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
01891         <a class="code" href="structdwc__otg__dev__in__ep__regs.html">dwc_otg_dev_in_ep_regs_t</a> *in_ep_regs =
01892             dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>];
01893 <span class="preprocessor">#ifdef DEBUG_EP0</span>
01894 <span class="preprocessor"></span>        <a class="code" href="structdwc__otg__dev__out__ep__regs.html">dwc_otg_dev_out_ep_regs_t</a> *out_ep_regs =
01895             dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>];
01896 <span class="preprocessor">#endif</span>
01897 <span class="preprocessor"></span>        <a class="code" href="uniondeptsiz0__data.html">deptsiz0_data_t</a> deptsiz;
01898         <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> desc_sts;
01899         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req;
01900         <span class="keywordtype">int</span> is_last = 0;
01901         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>;
01902 
01903 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01904 <span class="preprocessor"></span>        <span class="keyword">struct </span><a class="code" href="structcfi__usb__ctrlrequest.html">cfi_usb_ctrlrequest</a> *ctrlreq;
01905         <span class="keywordtype">int</span> retval = -DWC_E_NOT_SUPPORTED;
01906 <span class="preprocessor">#endif</span>
01907 <span class="preprocessor"></span>
01908         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> &amp;&amp; DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>)) {
01909                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
01910 <span class="preprocessor">#ifdef DEBUG_EP0</span>
01911 <span class="preprocessor"></span>                        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"Do setup OUT status phase\n"</span>);
01912 <span class="preprocessor">#endif</span>
01913 <span class="preprocessor"></span>                        <a class="code" href="dwc__otg__pcd__intr_8c.html#a29">do_setup_out_status_phase</a>(pcd);
01914                 } <span class="keywordflow">else</span> {
01915 <span class="preprocessor">#ifdef DEBUG_EP0</span>
01916 <span class="preprocessor"></span>                        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"Do setup IN status phase\n"</span>);
01917 <span class="preprocessor">#endif</span>
01918 <span class="preprocessor"></span>
01919 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
01920 <span class="preprocessor"></span>                        ctrlreq = &amp;pcd-&gt;cfi-&gt;ctrl_req;
01921 
01922                         <span class="keywordflow">if</span> (UT_GET_TYPE(ctrlreq-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o0">bRequestType</a>) == UT_VENDOR) {
01923                                 <span class="keywordflow">if</span> (ctrlreq-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o1">bRequest</a> &gt; 0xB0
01924                                     &amp;&amp; ctrlreq-&gt;<a class="code" href="structcfi__usb__ctrlrequest.html#o1">bRequest</a> &lt; 0xBF) {
01925 
01926                                         <span class="comment">/* Return if the PCD failed to handle the request */</span>
01927                                         <span class="keywordflow">if</span> ((retval =
01928                                              pcd-&gt;cfi-&gt;ops.
01929                                              ctrl_write_complete(pcd-&gt;cfi,
01930                                                                  pcd)) &lt; 0) {
01931                                                 CFI_INFO
01932                                                     (<span class="stringliteral">"ERROR setting a new value in the PCD(%d)\n"</span>,
01933                                                      retval);
01934                                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a26">ep0_do_stall</a>(pcd, retval);
01935                                                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 0;
01936                                                 <span class="keywordflow">return</span> 0;
01937                                         }
01938 
01939                                         <span class="comment">/* If the gadget needs to be notified on the request */</span>
01940                                         <span class="keywordflow">if</span> (pcd-&gt;cfi-&gt;need_gadget_att == 1) {
01941                                                 <span class="comment">//retval = do_gadget_setup(pcd, &amp;pcd-&gt;cfi-&gt;ctrl_req);</span>
01942                                                 retval =
01943                                                     cfi_gadget_setup(pcd,
01944                                                                      &amp;pcd-&gt;cfi-&gt;
01945                                                                      ctrl_req);
01946 
01947                                                 <span class="comment">/* Return from the function if the gadget failed to process</span>
01948 <span class="comment">                                                 * the request properly - this should never happen !!!</span>
01949 <span class="comment">                                                 */</span>
01950                                                 <span class="keywordflow">if</span> (retval &lt; 0) {
01951                                                         CFI_INFO
01952                                                             (<span class="stringliteral">"ERROR setting a new value in the gadget(%d)\n"</span>,
01953                                                              retval);
01954                                                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 0;
01955                                                         <span class="keywordflow">return</span> 0;
01956                                                 }
01957                                         }
01958 
01959                                         CFI_INFO(<span class="stringliteral">"%s: RETVAL=%d\n"</span>, __func__,
01960                                                  retval);
01961                                         <span class="comment">/* If we hit here then the PCD and the gadget has properly</span>
01962 <span class="comment">                                         * handled the request - so send the ZLP IN to the host.</span>
01963 <span class="comment">                                         */</span>
01964                                         <span class="comment">/* @todo: MAS - decide whether we need to start the setup</span>
01965 <span class="comment">                                         * stage based on the need_setup value of the cfi object</span>
01966 <span class="comment">                                         */</span>
01967                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
01968                                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 0;
01969                                         <span class="keywordflow">return</span> 1;
01970                                 }
01971                         }
01972 <span class="preprocessor">#endif</span>
01973 <span class="preprocessor"></span>
01974                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
01975                 }
01976                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o4">ep0_pending</a> = 0;
01977                 <span class="keywordflow">return</span> 1;
01978         }
01979 
01980         <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>)) {
01981                 <span class="keywordflow">return</span> 0;
01982         }
01983         req = DWC_CIRCLEQ_FIRST(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
01984 
01985         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> == EP0_OUT_STATUS_PHASE
01986             || pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> == EP0_IN_STATUS_PHASE) {
01987                 is_last = 1;
01988         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
01989                 deptsiz.<a class="code" href="uniondeptsiz0__data.html#o0">d32</a> = DWC_READ_REG32(&amp;in_ep_regs-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o4">dieptsiz</a>);
01990                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> != 0)
01991                         desc_sts = dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o18">in_desc_addr</a>-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>;
01992 <span class="preprocessor">#ifdef DEBUG_EP0</span>
01993 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%d len=%d  xfersize=%d pktcnt=%d\n"</span>,
01994                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>,
01995                             deptsiz.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o1">xfersize</a>, deptsiz.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o3">pktcnt</a>);
01996 <span class="preprocessor">#endif</span>
01997 <span class="preprocessor"></span>
01998                 <span class="keywordflow">if</span> (((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> == 0)
01999                      &amp;&amp; (deptsiz.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o1">xfersize</a> == 0))
02000                     || ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> != 0)
02001                         &amp;&amp; (desc_sts.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o1">bytes</a> == 0))) {
02002                         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o4">actual</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
02003                         <span class="comment">/* Is a Zero Len Packet needed? */</span>
02004                         <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o5">sent_zlp</a>) {
02005 <span class="preprocessor">#ifdef DEBUG_EP0</span>
02006 <span class="preprocessor"></span>                                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"Setup Rx ZLP\n"</span>);
02007 <span class="preprocessor">#endif</span>
02008 <span class="preprocessor"></span>                                req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o5">sent_zlp</a> = 0;
02009                         }
02010                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a29">do_setup_out_status_phase</a>(pcd);
02011                 }
02012         } <span class="keywordflow">else</span> {
02013                 <span class="comment">/* ep0-OUT */</span>
02014 <span class="preprocessor">#ifdef DEBUG_EP0</span>
02015 <span class="preprocessor"></span>                deptsiz.<a class="code" href="uniondeptsiz0__data.html#o0">d32</a> = DWC_READ_REG32(&amp;out_ep_regs-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o4">doeptsiz</a>);
02016                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%d len=%d xsize=%d pktcnt=%d\n"</span>,
02017                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>,
02018                             deptsiz.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o1">xfersize</a>, deptsiz.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o3">pktcnt</a>);
02019 <span class="preprocessor">#endif</span>
02020 <span class="preprocessor"></span>                req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o4">actual</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
02021 
02022                 <span class="comment">/* Is a Zero Len Packet needed? */</span>
02023                 <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o5">sent_zlp</a>) {
02024 <span class="preprocessor">#ifdef DEBUG_EP0</span>
02025 <span class="preprocessor"></span>                        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"Setup Tx ZLP\n"</span>);
02026 <span class="preprocessor">#endif</span>
02027 <span class="preprocessor"></span>                        req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o5">sent_zlp</a> = 0;
02028                 }
02029                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> == 0)
02030                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
02031         }
02032 
02033         <span class="comment">/* Complete the request */</span>
02034         <span class="keywordflow">if</span> (is_last) {
02035                 <a class="code" href="dwc__otg__pcd_8h.html#a17">dwc_otg_request_done</a>(ep, req, 0);
02036                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = 0;
02037                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = 0;
02038                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 0;
02039                 <span class="keywordflow">return</span> 1;
02040         }
02041         <span class="keywordflow">return</span> 0;
02042 }
02043 
02044 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
02045 <span class="preprocessor"></span>
02051 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> cfi_calc_desc_residue(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
02052 {
02053         int32_t ret = 0;
02054         <span class="keywordtype">int</span> i;
02055         <span class="keyword">struct </span>dwc_otg_dma_desc *ddesc = NULL;
02056         <span class="keyword">struct </span><a class="code" href="structcfi__ep.html">cfi_ep</a> *cfiep;
02057 
02058         <span class="comment">/* See if the pcd_ep has its respective cfi_ep mapped */</span>
02059         cfiep = <a class="code" href="dwc__otg__cfi_8h.html#a34">get_cfi_ep_by_pcd_ep</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;cfi, ep);
02060         <span class="keywordflow">if</span> (!cfiep) {
02061                 CFI_INFO(<span class="stringliteral">"%s: Failed to find ep\n"</span>, __func__);
02062                 <span class="keywordflow">return</span> -1;
02063         }
02064 
02065         ddesc = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.descs;
02066 
02067         <span class="keywordflow">for</span> (i = 0; (i &lt; cfiep-&gt;<a class="code" href="structcfi__ep.html#o8">desc_count</a>) &amp;&amp; (i &lt; MAX_DMA_DESCS_PER_EP); i++) {
02068 
02069 <span class="preprocessor">#if defined(PRINT_CFI_DMA_DESCS)</span>
02070 <span class="preprocessor"></span>                print_desc(ddesc, ep-&gt;ep.name, i);
02071 <span class="preprocessor">#endif</span>
02072 <span class="preprocessor"></span>                ret += ddesc-&gt;status.b.bytes;
02073                 ddesc++;
02074         }
02075 
02076         <span class="keywordflow">if</span> (ret)
02077                 CFI_INFO(<span class="stringliteral">"!!!!!!!!!! WARNING (%s) - residue=%d\n"</span>, __func__,
02078                          ret);
02079 
02080         <span class="keywordflow">return</span> ret;
02081 }
02082 <span class="preprocessor">#endif</span>
02083 <span class="preprocessor"></span>
<a name="l02088"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a38">02088</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a38">complete_ep</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
02089 {
02090         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>);
02091         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
02092         <a class="code" href="structdwc__otg__dev__in__ep__regs.html">dwc_otg_dev_in_ep_regs_t</a> *in_ep_regs =
02093             dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>];
02094         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz;
02095         <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> desc_sts;
02096         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req = 0;
02097         <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc;
02098         uint32_t byte_count = 0;
02099         <span class="keywordtype">int</span> is_last = 0;
02100         <span class="keywordtype">int</span> i;
02101 
02102         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s() %d-%s\n"</span>, __func__, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>,
02103                     (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>));
02104 
02105         <span class="comment">/* Get any pending requests */</span>
02106         <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>)) {
02107                 req = DWC_CIRCLEQ_FIRST(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
02108                 <span class="keywordflow">if</span> (!req) {
02109                         DWC_PRINTF(<span class="stringliteral">"complete_ep 0x%p, req = NULL!\n"</span>, ep);
02110                         <span class="keywordflow">return</span>;
02111                 }
02112         } <span class="keywordflow">else</span> {
02113                 DWC_PRINTF(<span class="stringliteral">"complete_ep 0x%p, ep-&gt;queue empty!\n"</span>, ep);
02114                 <span class="keywordflow">return</span>;
02115         }
02116 
02117         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"Requests %d\n"</span>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o10">request_pending</a>);
02118 
02119         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
02120                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = DWC_READ_REG32(&amp;in_ep_regs-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o4">dieptsiz</a>);
02121 
02122                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
02123                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> == 0) {
02124                                 <span class="keywordflow">if</span> (deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> == 0
02125                                     &amp;&amp; deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> == 0) {
02126                                         byte_count =
02127                                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> -
02128                                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
02129 
02130                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> += byte_count;
02131                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> += byte_count;
02132                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> += byte_count;
02133 
02134                                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
02135                                                     <span class="stringliteral">"%d-%s len=%d  xfersize=%d pktcnt=%d\n"</span>,
02136                                                     ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>,
02137                                                     (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.
02138                                                      is_in ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>),
02139                                                     ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>,
02140                                                     deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>,
02141                                                     deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>);
02142 
02143                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> &lt;
02144                                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>) {
02145                                                 <a class="code" href="dwc__otg__cil_8c.html#a47">dwc_otg_ep_start_transfer</a>
02146                                                     (core_if, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02147                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a>) {
02148                                                 <span class="comment">/*     </span>
02149 <span class="comment">                                                 * This fragment of code should initiate 0</span>
02150 <span class="comment">                                                 * length transfer in case if it is queued</span>
02151 <span class="comment">                                                 * a transfer with size divisible to EPs max</span>
02152 <span class="comment">                                                 * packet size and with usb_request zero field</span>
02153 <span class="comment">                                                 * is set, which means that after data is transfered,</span>
02154 <span class="comment">                                                 * it is also should be transfered</span>
02155 <span class="comment">                                                 * a 0 length packet at the end. For Slave and</span>
02156 <span class="comment">                                                 * Buffer DMA modes in this case SW has</span>
02157 <span class="comment">                                                 * to initiate 2 transfers one with transfer size,</span>
02158 <span class="comment">                                                 * and the second with 0 size. For Descriptor</span>
02159 <span class="comment">                                                 * DMA mode SW is able to initiate a transfer,</span>
02160 <span class="comment">                                                 * which will handle all the packets including</span>
02161 <span class="comment">                                                 * the last  0 length.</span>
02162 <span class="comment">                                                 */</span>
02163                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
02164                                                 <a class="code" href="dwc__otg__cil_8c.html#a48">dwc_otg_ep_start_zl_transfer</a>
02165                                                     (core_if, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02166                                         } <span class="keywordflow">else</span> {
02167                                                 is_last = 1;
02168                                         }
02169                                 } <span class="keywordflow">else</span> {
02170                                         <span class="keywordflow">if</span>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC)
02171                                         {
02172                                                 req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o4">actual</a> = 0;
02173                                                 <a class="code" href="dwc__otg__pcd_8h.html#a17">dwc_otg_request_done</a>(ep, req, 0);
02174 
02175                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = 0;
02176                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = 0;
02177                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 0;
02178 
02179                                                 <span class="comment">/* If there is a request in the queue start it. */</span>
02180                                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a9">start_next_request</a>(ep);
02181                                         } <span class="keywordflow">else</span>
02182                                                 DWC_WARN
02183                                                 (<span class="stringliteral">"Incomplete transfer (%d - %s [siz=%d pkt=%d])\n"</span>,
02184                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>,
02185                                                 (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>),
02186                                                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>,
02187                                                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>);
02188                                 }
02189                         } <span class="keywordflow">else</span> {
02190                                 dma_desc = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>;
02191                                 byte_count = 0;
02192                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
02193 
02194 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
02195 <span class="preprocessor"></span>                                CFI_INFO(<span class="stringliteral">"%s: BUFFER_MODE=%d\n"</span>, __func__,
02196                                          ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode);
02197                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode != BM_STANDARD) {
02198                                         <span class="keywordtype">int</span> residue;
02199 
02200                                         residue = cfi_calc_desc_residue(ep);
02201                                         <span class="keywordflow">if</span> (residue &lt; 0)
02202                                                 <span class="keywordflow">return</span>;
02203 
02204                                         byte_count = residue;
02205                                 } <span class="keywordflow">else</span> {
02206 <span class="preprocessor">#endif</span>
02207 <span class="preprocessor"></span>                                        <span class="keywordflow">for</span> (i = 0; i &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a>;
02208                                              ++i) {
02209                                         desc_sts = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>;
02210                                         byte_count += desc_sts.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o1">bytes</a>;
02211                                         dma_desc++;
02212                                 }
02213 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
02214 <span class="preprocessor"></span>                                }
02215 <span class="preprocessor">#endif</span>
02216 <span class="preprocessor"></span>                                <span class="keywordflow">if</span> (byte_count == 0) {
02217                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> =
02218                                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>;
02219                                         is_last = 1;
02220                                 } <span class="keywordflow">else</span> {
02221                                         DWC_WARN(<span class="stringliteral">"Incomplete transfer\n"</span>);
02222                                 }
02223                         }
02224                 } <span class="keywordflow">else</span> {
02225                         <span class="keywordflow">if</span> (deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> == 0 &amp;&amp; deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> == 0) {
02226                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
02227                                             <span class="stringliteral">"%d-%s len=%d  xfersize=%d pktcnt=%d\n"</span>,
02228                                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>,
02229                                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>,
02230                                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>,
02231                                             deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>,
02232                                             deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>);
02233 
02234                                 <span class="comment">/*      Check if the whole transfer was completed, </span>
02235 <span class="comment">                                 *      if no, setup transfer for next portion of data</span>
02236 <span class="comment">                                 */</span>
02237                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>) {
02238                                         <a class="code" href="dwc__otg__cil_8h.html#a81">dwc_otg_ep_start_transfer</a>(core_if,
02239                                                                   &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02240                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a>) {
02241                                         <span class="comment">/*     </span>
02242 <span class="comment">                                         * This fragment of code should initiate 0</span>
02243 <span class="comment">                                         * length trasfer in case if it is queued</span>
02244 <span class="comment">                                         * a trasfer with size divisible to EPs max</span>
02245 <span class="comment">                                         * packet size and with usb_request zero field</span>
02246 <span class="comment">                                         * is set, which means that after data is transfered,</span>
02247 <span class="comment">                                         * it is also should be transfered</span>
02248 <span class="comment">                                         * a 0 length packet at the end. For Slave and</span>
02249 <span class="comment">                                         * Buffer DMA modes in this case SW has</span>
02250 <span class="comment">                                         * to initiate 2 transfers one with transfer size,</span>
02251 <span class="comment">                                         * and the second with 0 size. For Desriptor</span>
02252 <span class="comment">                                         * DMA mode SW is able to initiate a transfer,</span>
02253 <span class="comment">                                         * which will handle all the packets including</span>
02254 <span class="comment">                                         * the last  0 legth.</span>
02255 <span class="comment">                                         */</span>
02256                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
02257                                         <a class="code" href="dwc__otg__cil_8h.html#a82">dwc_otg_ep_start_zl_transfer</a>(core_if,
02258                                                                      &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02259                                 } <span class="keywordflow">else</span> {
02260                                         is_last = 1;
02261                                 }
02262                         } <span class="keywordflow">else</span> {
02263                                 DWC_WARN
02264                                     (<span class="stringliteral">"Incomplete transfer (%d-%s [siz=%d pkt=%d])\n"</span>,
02265                                      ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>,
02266                                      (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>),
02267                                      deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>, deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>);
02268                         }
02269                 }
02270         } <span class="keywordflow">else</span> {
02271                 <a class="code" href="structdwc__otg__dev__out__ep__regs.html">dwc_otg_dev_out_ep_regs_t</a> *out_ep_regs =
02272                     dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>];
02273                 desc_sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = 0;
02274                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
02275                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
02276                                 dma_desc = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>;
02277                                 byte_count = 0;
02278                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
02279 
02280 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
02281 <span class="preprocessor"></span>                                CFI_INFO(<span class="stringliteral">"%s: BUFFER_MODE=%d\n"</span>, __func__,
02282                                          ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode);
02283                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode != BM_STANDARD) {
02284                                         <span class="keywordtype">int</span> residue;
02285                                         residue = cfi_calc_desc_residue(ep);
02286                                         <span class="keywordflow">if</span> (residue &lt; 0)
02287                                                 <span class="keywordflow">return</span>;
02288                                         byte_count = residue;
02289                                 } <span class="keywordflow">else</span> {
02290 <span class="preprocessor">#endif</span>
02291 <span class="preprocessor"></span>
02292                                         <span class="keywordflow">for</span> (i = 0; i &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a>;
02293                                              ++i) {
02294                                                 desc_sts = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>;
02295                                                 byte_count += desc_sts.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o1">bytes</a>;
02296                                                 dma_desc++;
02297                                         }
02298 
02299 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
02300 <span class="preprocessor"></span>                                }
02301 <span class="preprocessor">#endif</span>
02302 <span class="preprocessor"></span>                                <span class="comment">/* Checking for interrupt Out transfers with not </span>
02303 <span class="comment">                                 * dword aligned mps sizes </span>
02304 <span class="comment">                                 */</span>
02305                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_INTR &amp;&amp;
02306                                                         (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>%4)) {
02307                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> - byte_count;
02308                                         <span class="keywordflow">if</span> ((ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> % ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) &amp;&amp;
02309                                                 (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>/ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> &lt; MAX_DMA_DESC_CNT))
02310                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> -=
02311                                                         (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> - 1) * ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> +
02312                                                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> % ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
02313                                         <span class="keywordflow">else</span>                                            
02314                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> -=
02315                                                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> * ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
02316                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> &gt; 0) {
02317                                                 <a class="code" href="dwc__otg__cil_8h.html#a81">dwc_otg_ep_start_transfer</a>(core_if,
02318                                                                   &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02319                                         } <span class="keywordflow">else</span> {
02320                                                 is_last = 1;
02321                                         }
02322                                 } <span class="keywordflow">else</span> {
02323                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>
02324                                                 - byte_count +
02325                                                 ((4 - (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> &amp; 0x3)) &amp; 0x3);
02326                                         is_last = 1;
02327                                 }       
02328                         } <span class="keywordflow">else</span> {
02329                                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = 0;
02330                                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
02331                                     DWC_READ_REG32(&amp;out_ep_regs-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o4">doeptsiz</a>);
02332 
02333                                 byte_count = (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> -
02334                                               ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> -
02335                                               deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>);
02336                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> += byte_count;
02337                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> += byte_count;
02338                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> += byte_count;
02339 
02340                                 <span class="comment">/*      Check if the whole transfer was completed, </span>
02341 <span class="comment">                                 *      if no, setup transfer for next portion of data</span>
02342 <span class="comment">                                 */</span>
02343                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>) {
02344                                         <a class="code" href="dwc__otg__cil_8h.html#a81">dwc_otg_ep_start_transfer</a>(core_if,
02345                                                                   &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02346                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a>) {
02347                                         <span class="comment">/*     </span>
02348 <span class="comment">                                         * This fragment of code should initiate 0</span>
02349 <span class="comment">                                         * length trasfer in case if it is queued</span>
02350 <span class="comment">                                         * a trasfer with size divisible to EPs max</span>
02351 <span class="comment">                                         * packet size and with usb_request zero field</span>
02352 <span class="comment">                                         * is set, which means that after data is transfered,</span>
02353 <span class="comment">                                         * it is also should be transfered</span>
02354 <span class="comment">                                         * a 0 length packet at the end. For Slave and</span>
02355 <span class="comment">                                         * Buffer DMA modes in this case SW has</span>
02356 <span class="comment">                                         * to initiate 2 transfers one with transfer size,</span>
02357 <span class="comment">                                         * and the second with 0 size. For Desriptor</span>
02358 <span class="comment">                                         * DMA mode SW is able to initiate a transfer,</span>
02359 <span class="comment">                                         * which will handle all the packets including</span>
02360 <span class="comment">                                         * the last  0 legth.</span>
02361 <span class="comment">                                         */</span>
02362                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
02363                                         <a class="code" href="dwc__otg__cil_8h.html#a82">dwc_otg_ep_start_zl_transfer</a>(core_if,
02364                                                                      &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02365                                 } <span class="keywordflow">else</span> {
02366                                         is_last = 1;
02367                                 }
02368                         }
02369                 } <span class="keywordflow">else</span> {
02370                         <span class="comment">/*      Check if the whole transfer was completed, </span>
02371 <span class="comment">                         *      if no, setup transfer for next portion of data</span>
02372 <span class="comment">                         */</span>
02373                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>) {
02374                                 <a class="code" href="dwc__otg__cil_8h.html#a81">dwc_otg_ep_start_transfer</a>(core_if, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02375                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a>) {
02376                                 <span class="comment">/*     </span>
02377 <span class="comment">                                 * This fragment of code should initiate 0</span>
02378 <span class="comment">                                 * length transfer in case if it is queued</span>
02379 <span class="comment">                                 * a transfer with size divisible to EPs max</span>
02380 <span class="comment">                                 * packet size and with usb_request zero field</span>
02381 <span class="comment">                                 * is set, which means that after data is transfered,</span>
02382 <span class="comment">                                 * it is also should be transfered</span>
02383 <span class="comment">                                 * a 0 length packet at the end. For Slave and</span>
02384 <span class="comment">                                 * Buffer DMA modes in this case SW has</span>
02385 <span class="comment">                                 * to initiate 2 transfers one with transfer size,</span>
02386 <span class="comment">                                 * and the second with 0 size. For Descriptor</span>
02387 <span class="comment">                                 * DMA mode SW is able to initiate a transfer,</span>
02388 <span class="comment">                                 * which will handle all the packets including</span>
02389 <span class="comment">                                 * the last  0 length.</span>
02390 <span class="comment">                                 */</span>
02391                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
02392                                 <a class="code" href="dwc__otg__cil_8h.html#a82">dwc_otg_ep_start_zl_transfer</a>(core_if,
02393                                                              &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
02394                         } <span class="keywordflow">else</span> {
02395                                 is_last = 1;
02396                         }
02397                 }
02398 
02399                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
02400                             <span class="stringliteral">"addr %p,    %d-%s len=%d cnt=%d xsize=%d pktcnt=%d\n"</span>,
02401                             &amp;out_ep_regs-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o4">doeptsiz</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>,
02402                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>,
02403                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>,
02404                             deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>, deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>);
02405         }
02406 
02407         <span class="comment">/* Complete the request */</span>
02408         <span class="keywordflow">if</span> (is_last) {
02409 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
02410 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.buff_mode != BM_STANDARD) {
02411                         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o4">actual</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.cfi_req_len - byte_count;
02412                 } <span class="keywordflow">else</span> {
02413 <span class="preprocessor">#endif</span>
02414 <span class="preprocessor"></span>                        req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o4">actual</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
02415 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
02416 <span class="preprocessor"></span>                }
02417 <span class="preprocessor">#endif</span>
02418 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>) {
02419                         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
02420                                 dwc_memcpy(req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o1">buf</a>, req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>, req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a>); 
02421                         }
02422                         DWC_DMA_FREE(req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o3">length</a>, req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o6">dw_align_buf</a>,
02423                                      req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#o7">dw_align_buf_dma</a>);
02424                 }
02425 
02426                 <a class="code" href="dwc__otg__pcd_8h.html#a17">dwc_otg_request_done</a>(ep, req, 0);
02427 
02428                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> = 0;
02429                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = 0;
02430                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = 0;
02431 
02432                 <span class="comment">/* If there is a request in the queue start it. */</span>
02433                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a9">start_next_request</a>(ep);
02434         }
02435 }
02436 
02437 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
02438 <span class="preprocessor"></span>
<a name="l02443"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a39">02443</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a39">dwc_otg_pcd_handle_iso_bna</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
02444 {
02445         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a> = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
02446         <span class="keyword">volatile</span> uint32_t *addr;
02447         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = 0 };
02448         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>;
02449         <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc;
02450         <span class="keywordtype">int</span> i;
02451 
02452         dma_desc =
02453             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a> + dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> * (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>);
02454 
02455         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
02456                 <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> sts = {.d32 = 0 };
02457                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a>; ++i, ++dma_desc) {
02458                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02459                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> = BS_HOST_READY;
02460                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02461                 }
02462         } <span class="keywordflow">else</span> {
02463                 <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> sts = {.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = 0 };
02464                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a>; ++i, ++dma_desc) {
02465                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02466                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> = BS_HOST_READY;
02467                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02468                 }
02469         }
02470 
02471         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> == 0) {
02472                 addr =
02473                     &amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;out_ep_regs[dwc_ep-&gt;
02474                                                            num]-&gt;doepctl;
02475         } <span class="keywordflow">else</span> {
02476                 addr =
02477                     &amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;in_ep_regs[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;diepctl;
02478         }
02479         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> = 1;
02480         DWC_MODIFY_REG32(addr, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
02481 }
02482 
<a name="l02490"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a40">02490</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a40">set_current_pkt_info</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * ep)
02491 {
02492         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz = {.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0 };
02493         dma_addr_t dma_addr;
02494         uint32_t offset;
02495 
02496         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>)
02497                 dma_addr = ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a>;
02498         <span class="keywordflow">else</span>
02499                 dma_addr = ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
02500 
02501         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
02502                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
02503                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
02504                                    in_ep_regs[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;dieptsiz);
02505                 offset = ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
02506         } <span class="keywordflow">else</span> {
02507                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
02508                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
02509                                    out_ep_regs[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doeptsiz);
02510                 offset =
02511                     ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> +
02512                     (0x4 &amp; (0x4 - (ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> &amp; 0x3)));
02513         }
02514 
02515         <span class="keywordflow">if</span> (!deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>) {
02516                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a>].<a class="code" href="structiso__pkt__info.html#o1">length</a> = ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
02517                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a>].<a class="code" href="structiso__pkt__info.html#o0">offset</a> =
02518                     ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> - dma_addr;
02519                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a>].<a class="code" href="structiso__pkt__info.html#o2">status</a> = 0;
02520         } <span class="keywordflow">else</span> {
02521                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a>].<a class="code" href="structiso__pkt__info.html#o1">length</a> = ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
02522                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a>].<a class="code" href="structiso__pkt__info.html#o0">offset</a> =
02523                     ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> - dma_addr;
02524                 ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a>].<a class="code" href="structiso__pkt__info.html#o2">status</a> = -DWC_E_NO_DATA;
02525         }
02526         ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> += offset;
02527         ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> += offset;
02528         ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a>++;
02529 }
02530 
<a name="l02538"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a41">02538</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a41">set_ddma_iso_pkts_info</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
02539                                    <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * <a class="code" href="structdwc__ep.html">dwc_ep</a>)
02540 {
02541         <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc;
02542         <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> sts = {.d32 = 0 };
02543         <a class="code" href="structiso__pkt__info.html">iso_pkt_info_t</a> *iso_packet;
02544         uint32_t data_per_desc;
02545         uint32_t offset;
02546         <span class="keywordtype">int</span> i, j;
02547 
02548         iso_packet = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>;
02549 
02552         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> == 0) {
02553                 dma_desc =
02554                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a> +
02555                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>;
02556                 offset = 0;
02557 
02558                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>;
02559                      i += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>) {
02560                         <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>; ++j) {
02561                                 data_per_desc =
02562                                     ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> &gt;
02563                                      dwc_ep-&gt;
02564                                      data_per_frame) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
02565                                     j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
02566                                 data_per_desc +=
02567                                     (data_per_desc % 4) ? (4 -
02568                                                            data_per_desc %
02569                                                            4) : 0;
02570 
02571                                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02572 
02573                                 <span class="comment">/* Write status in iso_packet_decsriptor  */</span>
02574                                 iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> =
02575                                     sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o16">rxsts</a> +
02576                                     (sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> ^ BS_DMA_DONE);
02577                                 <span class="keywordflow">if</span> (iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a>) {
02578                                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> = -DWC_E_NO_DATA;
02579                                 }
02580 
02581                                 <span class="comment">/* Received data length */</span>
02582                                 <span class="keywordflow">if</span> (!sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a>) {
02583                                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a> =
02584                                             data_per_desc -
02585                                             sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a>;
02586                                 } <span class="keywordflow">else</span> {
02587                                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a> =
02588                                             data_per_desc -
02589                                             sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> + (4 -
02590                                                                      dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>
02591                                                                      % 4);
02592                                 }
02593 
02594                                 iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o0">offset</a> = offset;
02595 
02596                                 offset += data_per_desc;
02597                                 dma_desc++;
02598                                 iso_packet++;
02599                         }
02600                 }
02601 
02602                 <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> - 1; ++j) {
02603                         data_per_desc =
02604                             ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> &gt;
02605                              dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
02606                             j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
02607                         data_per_desc +=
02608                             (data_per_desc % 4) ? (4 - data_per_desc % 4) : 0;
02609 
02610                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02611 
02612                         <span class="comment">/* Write status in iso_packet_decsriptor  */</span>
02613                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> =
02614                             sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o16">rxsts</a> +
02615                             (sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> ^ BS_DMA_DONE);
02616                         <span class="keywordflow">if</span> (iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a>) {
02617                                 iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> = -DWC_E_NO_DATA;
02618                         }
02619 
02620                         <span class="comment">/* Received data length */</span>
02621                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a> =
02622                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> - sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a>;
02623 
02624                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o0">offset</a> = offset;
02625 
02626                         offset += data_per_desc;
02627                         iso_packet++;
02628                         dma_desc++;
02629                 }
02630 
02631                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02632 
02633                 <span class="comment">/* Write status in iso_packet_decsriptor  */</span>
02634                 iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> =
02635                     sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o16">rxsts</a> + (sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> ^ BS_DMA_DONE);
02636                 <span class="keywordflow">if</span> (iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a>) {
02637                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> = -DWC_E_NO_DATA;
02638                 }
02639                 <span class="comment">/* Received data length */</span>
02640                 <span class="keywordflow">if</span> (!sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a>) {
02641                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a> =
02642                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> - sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a>;
02643                 } <span class="keywordflow">else</span> {
02644                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a> =
02645                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> - sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> +
02646                             (4 - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> % 4);
02647                 }
02648 
02649                 iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o0">offset</a> = offset;
02650         } <span class="keywordflow">else</span> {
02653                 dma_desc =
02654                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a> +
02655                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>;
02656 
02657                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> - 1; i++) {
02658                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02659 
02660                         <span class="comment">/* Write status in iso packet descriptor */</span>
02661                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> =
02662                             sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o19">txsts</a> +
02663                             (sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> ^ BS_DMA_DONE);
02664                         <span class="keywordflow">if</span> (iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> != 0) {
02665                                 iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> = -DWC_E_NO_DATA;
02666 
02667                         }
02668                         <span class="comment">/* Bytes has been transfered */</span>
02669                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a> =
02670                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> - sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o18">txbytes</a>;
02671 
02672                         dma_desc++;
02673                         iso_packet++;
02674                 }
02675 
02676                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02677                 <span class="keywordflow">while</span> (sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> == BS_DMA_BUSY) {
02678                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02679                 }
02680 
02681                 <span class="comment">/* Write status in iso packet descriptor ??? do be done with ERROR codes */</span>
02682                 iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> =
02683                     sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o19">txsts</a> + (sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> ^ BS_DMA_DONE);
02684                 <span class="keywordflow">if</span> (iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> != 0) {
02685                         iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o2">status</a> = -DWC_E_NO_DATA;
02686                 }
02687 
02688                 <span class="comment">/* Bytes has been transfered */</span>
02689                 iso_packet-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a> =
02690                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> - sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o18">txbytes</a>;
02691         }
02692 }
02693 
<a name="l02701"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a42">02701</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a42">reinit_ddma_iso_xfer</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * <a class="code" href="structdwc__ep.html">dwc_ep</a>)
02702 {
02703         <span class="keywordtype">int</span> i, j;
02704         <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc;
02705         dma_addr_t dma_ad;
02706         <span class="keyword">volatile</span> uint32_t *addr;
02707         <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> sts = {.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = 0 };
02708         uint32_t data_per_desc;
02709 
02710         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> == 0) {
02711                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>;
02712         } <span class="keywordflow">else</span> {
02713                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>;
02714         }
02715 
02716         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> == 0) {
02718                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
02719         } <span class="keywordflow">else</span> {
02721                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a>;
02722         }
02723 
02726         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> == 0) {
02727                 dma_desc =
02728                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a> +
02729                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>;
02730 
02731                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> = BS_HOST_READY;
02732                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o16">rxsts</a> = 0;
02733                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 0;
02734                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o7">sp</a> = 0;
02735                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 0;
02736                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o15">pid</a> = 0;
02737                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> = 0;
02738 
02739                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>;
02740                      i += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>) {
02741                         <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>; ++j) {
02742                                 data_per_desc =
02743                                     ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> &gt;
02744                                      dwc_ep-&gt;
02745                                      data_per_frame) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
02746                                     j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
02747                                 data_per_desc +=
02748                                     (data_per_desc % 4) ? (4 -
02749                                                            data_per_desc %
02750                                                            4) : 0;
02751                                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> = data_per_desc;
02752                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
02753                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02754 
02755                                 dma_ad += data_per_desc;
02756                                 dma_desc++;
02757                         }
02758                 }
02759 
02760                 <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> - 1; ++j) {
02761 
02762                         data_per_desc =
02763                             ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> &gt;
02764                              dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
02765                             j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
02766                         data_per_desc +=
02767                             (data_per_desc % 4) ? (4 - data_per_desc % 4) : 0;
02768                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> = data_per_desc;
02769 
02770                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
02771                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02772 
02773                         dma_desc++;
02774                         dma_ad += data_per_desc;
02775                 }
02776 
02777                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 1;
02778                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>;
02779 
02780                 data_per_desc =
02781                     ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> &gt;
02782                      dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a> -
02783                     j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
02784                 data_per_desc +=
02785                     (data_per_desc % 4) ? (4 - data_per_desc % 4) : 0;
02786                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o17">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#o12">rxbytes</a> = data_per_desc;
02787 
02788                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
02789                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02790         } <span class="keywordflow">else</span> {
02793                 dma_desc =
02794                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_17">iso_desc_addr</a> +
02795                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>;
02796 
02797                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> = BS_HOST_READY;
02798                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o19">txsts</a> = 0;
02799                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o7">sp</a> = 0;
02800                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 0;
02801                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o15">pid</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>;
02802                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a>;
02803                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o18">txbytes</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
02804                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = 0;
02805 
02806                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a> - 1; i++) {
02807                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
02808                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02809 
02810                         sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
02811                         dma_ad += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
02812                         dma_desc++;
02813                 }
02814 
02815                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o6">ioc</a> = 1;
02816                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o8">l</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>;
02817 
02818                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o1">buf</a> = dma_ad;
02819                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
02820 
02821                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> =
02822                     sts.<a class="code" href="uniondev__dma__desc__sts.html#o20">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#o14">framenum</a> + dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a> * 1;
02823         }
02824         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> = (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> ^ 1) &amp; 0x1;
02825 }
02826 
<a name="l02835"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a43">02835</a> <span class="keyword">static</span> uint32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a43">handle_iso_out_pkt_dropped</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
02836                                            <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * <a class="code" href="structdwc__ep.html">dwc_ep</a>)
02837 {
02838         uint32_t dma_addr;
02839         uint32_t drp_pkt;
02840         uint32_t drp_pkt_cnt;
02841         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz = {.d32 = 0 };
02842         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = 0 };
02843         <span class="keywordtype">int</span> i;
02844 
02845         deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
02846             DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
02847                            out_ep_regs[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doeptsiz);
02848 
02849         drp_pkt = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a> - deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>;
02850         drp_pkt_cnt = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a> - (drp_pkt % dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>);
02851 
02852         <span class="comment">/* Setting dropped packets status */</span>
02853         <span class="keywordflow">for</span> (i = 0; i &lt; drp_pkt_cnt; ++i) {
02854                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>[drp_pkt].<a class="code" href="structiso__pkt__info.html#o2">status</a> = -DWC_E_NO_DATA;
02855                 drp_pkt++;
02856                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>--;
02857         }
02858 
02859         <span class="keywordflow">if</span> (deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> &gt; 0) {
02860                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> =
02861                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> - (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a> -
02862                                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
02863         } <span class="keywordflow">else</span> {
02864                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> = 0;
02865                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> = 0;
02866         }
02867 
02868         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doeptsiz,
02869                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a>);
02870 
02871         <span class="keywordflow">if</span> (deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> &gt; 0) {
02872                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) {
02873                         dma_addr =
02874                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a> + dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> -
02875                             deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>;
02876                 } <span class="keywordflow">else</span> {
02877                         dma_addr =
02878                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a> + dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> -
02879                             deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>;;
02880                 }
02881 
02882                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
02883                                 out_ep_regs[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doepdma, dma_addr);
02884 
02886                 depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0;
02887                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> = 1;
02888                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o10">cnak</a> = 1;
02889 
02890                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
02891                                  out_ep_regs[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doepctl, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>,
02892                                  depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
02893                 <span class="keywordflow">return</span> 0;
02894         } <span class="keywordflow">else</span> {
02895                 <span class="keywordflow">return</span> 1;
02896         }
02897 }
02898 
<a name="l02906"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a44">02906</a> <span class="keyword">static</span> uint32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a44">set_iso_pkts_info</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * ep)
02907 {
02908         <span class="keywordtype">int</span> i, j;
02909         dma_addr_t dma_ad;
02910         <a class="code" href="structiso__pkt__info.html">iso_pkt_info_t</a> *packet_info = ep-&gt;<a class="code" href="structdwc__ep.html#z32_28">pkt_info</a>;
02911         uint32_t offset;
02912         uint32_t frame_data;
02913         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz;
02914 
02915         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> == 0) {
02917                 dma_ad = ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
02918         } <span class="keywordflow">else</span> {
02920                 dma_ad = ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a>;
02921         }
02922 
02923         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
02924                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
02925                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
02926                                    in_ep_regs[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;dieptsiz);
02927         } <span class="keywordflow">else</span> {
02928                 deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
02929                     DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
02930                                    out_ep_regs[ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doeptsiz);
02931         }
02932 
02933         <span class="keywordflow">if</span> (!deptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>) {
02934                 offset = 0;
02935                 <span class="keywordflow">for</span> (i = 0; i &lt; ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>; i += ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>) {
02936                         frame_data = ep-&gt;<a class="code" href="structdwc__ep.html#z32_22">data_per_frame</a>;
02937                         <span class="keywordflow">for</span> (j = 0; j &lt; ep-&gt;<a class="code" href="structdwc__ep.html#z32_25">pkt_per_frm</a>; ++j) {
02938 
02939                                 <span class="comment">/* Packet status - is not set as initially</span>
02940 <span class="comment">                                 * it is set to 0 and if packet was sent</span>
02941 <span class="comment">                                 successfully, status field will remain 0*/</span>
02942 
02943                                 <span class="comment">/* Bytes has been transfered */</span>
02944                                 packet_info-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a> =
02945                                     (ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> &lt;
02946                                      frame_data) ? ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a> : frame_data;
02947 
02948                                 <span class="comment">/* Received packet offset */</span>
02949                                 packet_info-&gt;<a class="code" href="structiso__pkt__info.html#o0">offset</a> = offset;
02950                                 offset += packet_info-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a>;
02951                                 frame_data -= packet_info-&gt;<a class="code" href="structiso__pkt__info.html#o1">length</a>;
02952 
02953                                 packet_info++;
02954                         }
02955                 }
02956                 <span class="keywordflow">return</span> 1;
02957         } <span class="keywordflow">else</span> {
02958                 <span class="comment">/* This is a workaround for in case of Transfer Complete with</span>
02959 <span class="comment">                 * PktDrpSts interrupts merging - in this case Transfer complete</span>
02960 <span class="comment">                 * interrupt for Isoc Out Endpoint is asserted without PktDrpSts</span>
02961 <span class="comment">                 * set and with DOEPTSIZ register non zero. Investigations showed,</span>
02962 <span class="comment">                 * that this happens when Out packet is dropped, but because of</span>
02963 <span class="comment">                 * interrupts merging during first interrupt handling PktDrpSts</span>
02964 <span class="comment">                 * bit is cleared and for next merged interrupts it is not reset.</span>
02965 <span class="comment">                 * In this case SW hadles the interrupt as if PktDrpSts bit is set.</span>
02966 <span class="comment">                 */</span>
02967                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>) {
02968                         <span class="keywordflow">return</span> 1;
02969                 } <span class="keywordflow">else</span> {
02970                         <span class="keywordflow">return</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a43">handle_iso_out_pkt_dropped</a>(core_if, ep);
02971                 }
02972         }
02973 }
02974 
<a name="l02982"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a45">02982</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a45">complete_iso_ep</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
02983 {
02984         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>);
02985         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a> = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
02986         uint8_t is_last = 0;
02987 
02988         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> == 0xffffffff) {
02989                 DWC_WARN(<span class="stringliteral">"Next frame is not set!\n"</span>);
02990                 <span class="keywordflow">return</span>;
02991         }
02992 
02993         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
02994                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
02995                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a41">set_ddma_iso_pkts_info</a>(core_if, dwc_ep);
02996                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a42">reinit_ddma_iso_xfer</a>(core_if, dwc_ep);
02997                         is_last = 1;
02998                 } <span class="keywordflow">else</span> {
02999                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o16">pti_enh_enable</a>) {
03000                                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd__intr_8c.html#a44">set_iso_pkts_info</a>(core_if, dwc_ep)) {
03001                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> =
03002                                             (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> ^ 1) &amp; 0x1;
03003                                         <a class="code" href="dwc__otg__cil_8h.html#a90">dwc_otg_iso_ep_start_buf_transfer</a>
03004                                             (core_if, dwc_ep);
03005                                         is_last = 1;
03006                                 }
03007                         } <span class="keywordflow">else</span> {
03008                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a40">set_current_pkt_info</a>(core_if, dwc_ep);
03009                                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a> &gt;= dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>) {
03010                                         is_last = 1;
03011                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a> = 0;
03012                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> =
03013                                             (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> ^ 1) &amp; 0x1;
03014                                         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) {
03015                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> =
03016                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_19">xfer_buff1</a>;
03017                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> =
03018                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a>;
03019                                         } <span class="keywordflow">else</span> {
03020                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> =
03021                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_18">xfer_buff0</a>;
03022                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> =
03023                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
03024                                         }
03025 
03026                                 }
03027                                 <a class="code" href="dwc__otg__cil_8h.html#a89">dwc_otg_iso_ep_start_frm_transfer</a>(core_if,
03028                                                                   dwc_ep);
03029                         }
03030                 }
03031         } <span class="keywordflow">else</span> {
03032                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a40">set_current_pkt_info</a>(core_if, dwc_ep);
03033                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a> &gt;= dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>) {
03034                         is_last = 1;
03035                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a> = 0;
03036                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> = (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> ^ 1) &amp; 0x1;
03037                         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) {
03038                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_19">xfer_buff1</a>;
03039                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a>;
03040                         } <span class="keywordflow">else</span> {
03041                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_18">xfer_buff0</a>;
03042                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
03043                         }
03044 
03045                 }
03046                 <a class="code" href="dwc__otg__cil_8h.html#a89">dwc_otg_iso_ep_start_frm_transfer</a>(core_if, dwc_ep);
03047         }
03048         <span class="keywordflow">if</span> (is_last)
03049                 <a class="code" href="dwc__otg__pcd_8h.html#a18">dwc_otg_iso_buffer_done</a>(pcd, ep, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o6">iso_req_handle</a>);
03050 }
03051 <span class="preprocessor">#endif </span><span class="comment">/* DWC_EN_ISOC */</span>
03052 
<a name="l03057"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a46">03057</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a46">dwc_otg_pcd_handle_noniso_bna</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
03058 {
03059         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a> = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
03060         <span class="keyword">volatile</span> uint32_t *addr;
03061         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = 0 };
03062         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>;
03063         <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc;
03064         <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> sts = {.<a class="code" href="structdwc__otg__pcd.html#o12">d32</a> = 0 };
03065         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o8">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>;
03066         <span class="keywordtype">int</span> i, start;
03067 
03068         <span class="keywordflow">if</span> (!dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a>)
03069                 DWC_WARN(<span class="stringliteral">"Descriptor count = %d\n"</span>, dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a>);
03070 
03071         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o40">cont_on_bna</a> &amp;&amp; !dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a>
03072                                                         &amp;&amp; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> != DWC_OTG_EP_TYPE_CONTROL) {
03073                 uint32_t doepdma;
03074                 <a class="code" href="structdwc__otg__dev__out__ep__regs.html">dwc_otg_dev_out_ep_regs_t</a> *out_regs =
03075                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>];
03076                 doepdma = DWC_READ_REG32(&amp;(out_regs-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o5">doepdma</a>));
03077                 start = (doepdma - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_1">dma_desc_addr</a>)/<span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a>);
03078                 dma_desc = &amp;(dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>[start]);
03079         } <span class="keywordflow">else</span> {
03080                 start = 0;
03081                 dma_desc = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_2">desc_addr</a>;
03082         }
03083         
03084 
03085         <span class="keywordflow">for</span> (i = start; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_10">desc_cnt</a>; ++i, ++dma_desc) {
03086                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
03087                 sts.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o10">bs</a> = BS_HOST_READY;
03088                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#o0">d32</a>;
03089         }
03090 
03091         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> == 0) {
03092                 addr =
03093                     &amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;out_ep_regs[dwc_ep-&gt;
03094                                                            num]-&gt;doepctl;
03095         } <span class="keywordflow">else</span> {
03096                 addr =
03097                     &amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;in_ep_regs[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;diepctl;
03098         }
03099         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> = 1;
03100         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o10">cnak</a> = 1;
03101         DWC_MODIFY_REG32(addr, 0, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
03102 }
03103 
<a name="l03110"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a47">03110</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a47">handle_ep0</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
03111 {
03112         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
03113         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep0 = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o17">ep0</a>;
03114         <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> desc_sts;
03115         <a class="code" href="uniondeptsiz0__data.html">deptsiz0_data_t</a> deptsiz;
03116         uint32_t byte_count;
03117 
03118 <span class="preprocessor">#ifdef DEBUG_EP0</span>
03119 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s()\n"</span>, __func__);
03120         <a class="code" href="dwc__otg__pcd__intr_8c.html#a4">print_ep0_state</a>(pcd);
03121 <span class="preprocessor">#endif</span>
03122 <span class="preprocessor"></span>
03123 <span class="comment">//      DWC_PRINTF("HANDLE EP0\n");</span>
03124 
03125         <span class="keywordflow">switch</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a>) {
03126         <span class="keywordflow">case</span> EP0_DISCONNECT:
03127                 <span class="keywordflow">break</span>;
03128 
03129         <span class="keywordflow">case</span> EP0_IDLE:
03130                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o5">request_config</a> = 0;
03131 
03132                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a36">pcd_setup</a>(pcd);
03133                 <span class="keywordflow">break</span>;
03134 
03135         <span class="keywordflow">case</span> EP0_IN_DATA_PHASE:
03136 <span class="preprocessor">#ifdef DEBUG_EP0</span>
03137 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"DATA_IN EP%d-%s: type=%d, mps=%d\n"</span>,
03138                             ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>, (ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>),
03139                             ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a>, ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>);
03140 <span class="preprocessor">#endif</span>
03141 <span class="preprocessor"></span>
03142                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a> != 0) {
03143                         <span class="comment">/*</span>
03144 <span class="comment">                         * For EP0 we can only program 1 packet at a time so we</span>
03145 <span class="comment">                         * need to do the make calculations after each complete.</span>
03146 <span class="comment">                         * Call write_packet to make the calculations, as in</span>
03147 <span class="comment">                         * slave mode, and use those values to determine if we</span>
03148 <span class="comment">                         * can complete.</span>
03149 <span class="comment">                         */</span>
03150                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> == 0) {
03151                                 deptsiz.<a class="code" href="uniondeptsiz0__data.html#o0">d32</a> =
03152                                     DWC_READ_REG32(&amp;core_if-&gt;
03153                                                    dev_if-&gt;in_ep_regs[0]-&gt;
03154                                                    dieptsiz);
03155                                 byte_count =
03156                                     ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> - deptsiz.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o1">xfersize</a>;
03157                         } <span class="keywordflow">else</span> {
03158                                 desc_sts =
03159                                     core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o18">in_desc_addr</a>-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>;
03160                                 byte_count =
03161                                     ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> - desc_sts.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o1">bytes</a>;
03162                         }
03163                         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> += byte_count;
03164                         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> += byte_count;
03165                         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> += byte_count;
03166                 }
03167                 <span class="keywordflow">if</span> (ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> &lt; ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>) {
03168                         <a class="code" href="dwc__otg__cil_8h.html#a84">dwc_otg_ep0_continue_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd),
03169                                                       &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
03170                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"CONTINUE TRANSFER\n"</span>);
03171                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a>) {
03172                         <a class="code" href="dwc__otg__cil_8h.html#a84">dwc_otg_ep0_continue_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd),
03173                                                       &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
03174                         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
03175                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"CONTINUE TRANSFER\n"</span>);
03176                 } <span class="keywordflow">else</span> {
03177                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a37">ep0_complete_request</a>(ep0);
03178                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"COMPLETE TRANSFER\n"</span>);
03179                 }
03180                 <span class="keywordflow">break</span>;
03181         <span class="keywordflow">case</span> EP0_OUT_DATA_PHASE:
03182 <span class="preprocessor">#ifdef DEBUG_EP0</span>
03183 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"DATA_OUT EP%d-%s: type=%d, mps=%d\n"</span>,
03184                             ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o0">num</a>, (ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>),
03185                             ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a>, ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>);
03186 <span class="preprocessor">#endif</span>
03187 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a> != 0) {
03188                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> == 0) {
03189                                 deptsiz.<a class="code" href="uniondeptsiz0__data.html#o0">d32</a> =
03190                                     DWC_READ_REG32(&amp;core_if-&gt;
03191                                                    dev_if-&gt;out_ep_regs[0]-&gt;
03192                                                    doeptsiz);
03193                                 byte_count =
03194                                     ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> - deptsiz.<a class="code" href="uniondeptsiz0__data.html#o7">b</a>.<a class="code" href="uniondeptsiz0__data.html#o1">xfersize</a>;
03195                         } <span class="keywordflow">else</span> {
03196                                 desc_sts =
03197                                     core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o20">out_desc_addr</a>-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#o0">status</a>;
03198                                 byte_count =
03199                                     ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a> - desc_sts.<a class="code" href="uniondev__dma__desc__sts.html#o11">b</a>.<a class="code" href="uniondev__dma__desc__sts.html#o1">bytes</a>;
03200                         }
03201                         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> += byte_count;
03202                         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> += byte_count;
03203                         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> += byte_count;
03204                 }
03205                 <span class="keywordflow">if</span> (ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> &lt; ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a>) {
03206                         <a class="code" href="dwc__otg__cil_8h.html#a84">dwc_otg_ep0_continue_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd),
03207                                                       &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
03208                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"CONTINUE TRANSFER\n"</span>);
03209                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a>) {
03210                         <a class="code" href="dwc__otg__cil_8h.html#a84">dwc_otg_ep0_continue_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd),
03211                                                       &amp;ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
03212                         ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_7">sent_zlp</a> = 0;
03213                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"CONTINUE TRANSFER\n"</span>);
03214                 } <span class="keywordflow">else</span> {
03215                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a37">ep0_complete_request</a>(ep0);
03216                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"COMPLETE TRANSFER\n"</span>);
03217                 }
03218                 <span class="keywordflow">break</span>;
03219 
03220         <span class="keywordflow">case</span> EP0_IN_STATUS_PHASE:
03221         <span class="keywordflow">case</span> EP0_OUT_STATUS_PHASE:
03222                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"CASE: EP0_STATUS\n"</span>);
03223                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a37">ep0_complete_request</a>(ep0);
03224                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> = EP0_IDLE;
03225                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
03226                 ep0-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o1">is_in</a> = 0;  <span class="comment">/* OUT for next SETUP */</span>
03227 
03228                 <span class="comment">/* Prepare for more SETUP Packets */</span>
03229                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
03230                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a18">ep0_out_start</a>(core_if, pcd);
03231                 }
03232                 <span class="keywordflow">break</span>;
03233 
03234         <span class="keywordflow">case</span> EP0_STALL:
03235                 DWC_ERROR(<span class="stringliteral">"EP0 STALLed, should not get here pcd_setup()\n"</span>);
03236                 <span class="keywordflow">break</span>;
03237         }
03238 <span class="preprocessor">#ifdef DEBUG_EP0</span>
03239 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__pcd__intr_8c.html#a4">print_ep0_state</a>(pcd);
03240 <span class="preprocessor">#endif</span>
03241 <span class="preprocessor"></span>}
03242 
<a name="l03246"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a48">03246</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a48">restart_transfer</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keyword">const</span> uint32_t epnum)
03247 {
03248         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if;
03249         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if;
03250         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> dieptsiz = {.d32 = 0 };
03251         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
03252 
03253         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a6">get_in_ep</a>(pcd, epnum);
03254 
03255 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
03256 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
03257                 <span class="keywordflow">return</span>;
03258         }
03259 <span class="preprocessor">#endif </span><span class="comment">/* DWC_EN_ISOC  */</span>
03260 
03261         core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
03262         dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
03263 
03264         dieptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o4">dieptsiz</a>);
03265 
03266         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"xfer_buff=%p xfer_count=%0x xfer_len=%0x"</span>
03267                     <span class="stringliteral">" stopped=%d\n"</span>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a>,
03268                     ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>);
03269         <span class="comment">/*</span>
03270 <span class="comment">         * If xfersize is 0 and pktcnt in not 0, resend the last packet.</span>
03271 <span class="comment">         */</span>
03272         <span class="keywordflow">if</span> (dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> &amp;&amp; dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> == 0 &amp;&amp;
03273             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a> != 0) {
03274                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> &lt;= ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) {
03275                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> = 0;
03276                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_3">start_xfer_buff</a>;
03277                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
03278                 } <span class="keywordflow">else</span> {
03279                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a> -= ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
03280                         <span class="comment">/* convert packet size to dwords. */</span>
03281                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a> -= ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
03282                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
03283                 }
03284                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 0;
03285                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"xfer_buff=%p xfer_count=%0x "</span>
03286                             <span class="stringliteral">"xfer_len=%0x stopped=%d\n"</span>,
03287                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_4">xfer_buff</a>,
03288                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_5">xfer_len</a>,
03289                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>);
03290                 <span class="keywordflow">if</span> (epnum == 0) {
03291                         <a class="code" href="dwc__otg__cil_8h.html#a83">dwc_otg_ep0_start_transfer</a>(core_if, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
03292                 } <span class="keywordflow">else</span> {
03293                         <a class="code" href="dwc__otg__cil_8h.html#a81">dwc_otg_ep_start_transfer</a>(core_if, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
03294                 }
03295         }
03296 }
03297 
03298 <span class="comment">/*</span>
03299 <span class="comment"> * This function create new nextep sequnce based on Learn Queue.</span>
03300 <span class="comment"> *</span>
03301 <span class="comment"> * @param core_if Programming view of DWC_otg controller</span>
03302 <span class="comment"> */</span>
03303 <span class="keywordtype">void</span> predict_nextep_seq( <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
03304 {
03305         <a class="code" href="structdwc__otg__dev__global__regs.html">dwc_otg_device_global_regs_t</a> *dev_global_regs =
03306             core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>;
03307         <span class="keyword">const</span> uint32_t TOKEN_Q_DEPTH = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o21">hwcfg2</a>.<a class="code" href="unionhwcfg2__data.html#o16">b</a>.<a class="code" href="unionhwcfg2__data.html#o14">dev_token_q_depth</a>;
03308         <span class="comment">/* Number of Token Queue Registers */</span>
03309         <span class="keyword">const</span> <span class="keywordtype">int</span> DTKNQ_REG_CNT = (TOKEN_Q_DEPTH + 7) / 8;
03310         <a class="code" href="uniondtknq1__data.html">dtknq1_data_t</a> dtknqr1;
03311         uint32_t in_tkn_epnums[4];
03312         uint8_t seqnum[MAX_EPS_CHANNELS];
03313         uint8_t intkn_seq[TOKEN_Q_DEPTH];
03314         <a class="code" href="uniongrstctl__data.html">grstctl_t</a> resetctl = {.<a class="code" href="unionhwcfg2__data.html#o0">d32</a> = 0 };
03315         uint8_t temp;
03316         <span class="keywordtype">int</span> ndx = 0;
03317         <span class="keywordtype">int</span> start = 0;
03318         <span class="keywordtype">int</span> end = 0;
03319         <span class="keywordtype">int</span> sort_done = 0;
03320         <span class="keywordtype">int</span> i = 0;
03321         <span class="keyword">volatile</span> uint32_t *addr = &amp;dev_global_regs-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o8">dtknqr1</a>;
03322 
03323 
03324         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCD,<span class="stringliteral">"dev_token_q_depth=%d\n"</span>,TOKEN_Q_DEPTH);
03325 
03326         <span class="comment">/* Read the DTKNQ Registers */</span>
03327         <span class="keywordflow">for</span> (i = 0; i &lt; DTKNQ_REG_CNT; i++) {
03328                 in_tkn_epnums[i] = DWC_READ_REG32(addr);
03329                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCDV, <span class="stringliteral">"DTKNQR%d=0x%08x\n"</span>, i + 1,
03330                             in_tkn_epnums[i]);
03331                 <span class="keywordflow">if</span> (addr == &amp;dev_global_regs-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o10">dvbusdis</a>) {
03332                         addr = &amp;dev_global_regs-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o12">dtknqr3_dthrctl</a>;
03333                 } <span class="keywordflow">else</span> {
03334                         ++addr;
03335                 }
03336 
03337         }
03338 
03339         <span class="comment">/* Copy the DTKNQR1 data to the bit field. */</span>
03340         dtknqr1.<a class="code" href="uniondtknq1__data.html#o0">d32</a> = in_tkn_epnums[0];
03341         <span class="keywordflow">if</span> (dtknqr1.<a class="code" href="uniondtknq1__data.html#o5">b</a>.<a class="code" href="uniondtknq1__data.html#o3">wrap_bit</a>) {
03342                 ndx = dtknqr1.<a class="code" href="uniondtknq1__data.html#o5">b</a>.<a class="code" href="uniondtknq1__data.html#o1">intknwptr</a>;
03343                 end = ndx -1;
03344                 <span class="keywordflow">if</span> (end &lt; 0) 
03345                         end = TOKEN_Q_DEPTH -1;
03346         } <span class="keywordflow">else</span> {
03347                 ndx = 0;
03348                 end = dtknqr1.<a class="code" href="uniondtknq1__data.html#o5">b</a>.<a class="code" href="uniondtknq1__data.html#o1">intknwptr</a> -1;
03349                 <span class="keywordflow">if</span> (end &lt; 0) 
03350                         end = 0;
03351         }
03352         start = ndx;
03353         
03354         <span class="comment">/* Fill seqnum[] by initial values: EP number + 31 */</span>
03355         <span class="keywordflow">for</span> (i=0; i &lt;= core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
03356                 seqnum[i] = i +31;
03357         }
03358         
03359         <span class="comment">/* Fill intkn_seq[] from in_tkn_epnums[0] */</span>
03360         <span class="keywordflow">for</span> (i=0; i &lt; 6; i++) 
03361                 intkn_seq[i] = (in_tkn_epnums[0] &gt;&gt; ((7-i) * 4)) &amp; 0xf;
03362         
03363         <span class="keywordflow">if</span> (TOKEN_Q_DEPTH &gt; 6) {
03364                 <span class="comment">/* Fill intkn_seq[] from in_tkn_epnums[1] */</span>
03365                 <span class="keywordflow">for</span> (i=6; i &lt; 14; i++) 
03366                         intkn_seq[i] = (in_tkn_epnums[1] &gt;&gt; ((7-(i-6)) * 4)) &amp; 0xf;
03367         }
03368         
03369         <span class="keywordflow">if</span> (TOKEN_Q_DEPTH &gt; 14) {
03370                 <span class="comment">/* Fill intkn_seq[] from in_tkn_epnums[1] */</span>
03371                 <span class="keywordflow">for</span> (i=14; i &lt; 22; i++) 
03372                         intkn_seq[i] = (in_tkn_epnums[2] &gt;&gt; ((7-(i-14)) * 4)) &amp; 0xf;
03373         }
03374 
03375         <span class="keywordflow">if</span> (TOKEN_Q_DEPTH &gt; 22) {
03376                 <span class="comment">/* Fill intkn_seq[] from in_tkn_epnums[1] */</span>
03377                 <span class="keywordflow">for</span> (i=22; i &lt; 30; i++) 
03378                         intkn_seq[i] = (in_tkn_epnums[3] &gt;&gt; ((7-(i-22)) * 4)) &amp; 0xf;
03379         }
03380 
03381         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCDV,<span class="stringliteral">"%s start=%d end=%d intkn_seq[]:\n"</span>, __func__, start, end);
03382         <span class="keywordflow">for</span> (i=0; i&lt;TOKEN_Q_DEPTH; i++) 
03383                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCDV,<span class="stringliteral">"%d\n"</span>, intkn_seq[i]);
03384 
03385         <span class="comment">/* Update seqnum based on intkn_seq[] */</span>
03386         i = 0;
03387         <span class="keywordflow">do</span> {
03388                 seqnum[intkn_seq[ndx]] = i;
03389                 ndx++;
03390                 i++;
03391                 <span class="keywordflow">if</span> (ndx == TOKEN_Q_DEPTH) 
03392                         ndx = 0;
03393         } <span class="keywordflow">while</span> ( i &lt; TOKEN_Q_DEPTH );
03394         
03395         <span class="comment">/* Mark non active EP's in seqnum[] by 0xff */</span>
03396         <span class="keywordflow">for</span> (i=0; i&lt;=core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
03397                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[i] == 0xff )
03398                         seqnum[i] = 0xff;
03399         }
03400         
03401         <span class="comment">/* Sort seqnum[] */</span>
03402         sort_done = 0;
03403         <span class="keywordflow">while</span> (!sort_done) {
03404                 sort_done = 1;
03405                 <span class="keywordflow">for</span> (i=0; i&lt;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
03406                         <span class="keywordflow">if</span> (seqnum[i] &gt; seqnum[i+1]) {
03407                                 temp = seqnum[i];
03408                                 seqnum[i] = seqnum[i+1];
03409                                 seqnum[i+1] = temp;
03410                                 sort_done = 0;
03411                         }
03412                 }
03413         }
03414 
03415         ndx = start + seqnum[0];
03416         <span class="keywordflow">if</span> (ndx &gt;= TOKEN_Q_DEPTH) 
03417                 ndx = ndx % TOKEN_Q_DEPTH;
03418         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o51">first_in_nextep_seq</a> = intkn_seq[ndx];
03419         
03420         <span class="comment">/* Update seqnum[] by EP numbers  */</span>
03421         <span class="keywordflow">for</span> (i=0; i&lt;=core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
03422                 ndx = start + i;
03423                 <span class="keywordflow">if</span> (seqnum[i] &lt; 31) {
03424                         ndx = start + seqnum[i];
03425                         <span class="keywordflow">if</span> (ndx &gt;= TOKEN_Q_DEPTH) 
03426                                 ndx = ndx % TOKEN_Q_DEPTH;
03427                         seqnum[i] = intkn_seq[ndx];
03428                 } <span class="keywordflow">else</span> {
03429                         <span class="keywordflow">if</span> (seqnum[i] &lt; 0xff) {
03430                                 seqnum[i] = seqnum[i] - 31;
03431                         } <span class="keywordflow">else</span> {
03432                                 <span class="keywordflow">break</span>;
03433                         }
03434                 }
03435         }
03436 
03437         <span class="comment">/* Update nextep_seq[] based on seqnum[] */</span>
03438         <span class="keywordflow">for</span> (i=0; i&lt;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
03439                 <span class="keywordflow">if</span> (seqnum[i] != 0xff) {
03440                         <span class="keywordflow">if</span> (seqnum[i+1] != 0xff) {
03441                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[seqnum[i]] = seqnum[i+1];
03442                         } <span class="keywordflow">else</span> {
03443                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[seqnum[i]] = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o51">first_in_nextep_seq</a>;
03444                                 <span class="keywordflow">break</span>;
03445                         }
03446                 } <span class="keywordflow">else</span> {
03447                         <span class="keywordflow">break</span>;
03448                 }
03449         }
03450         
03451         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCDV, <span class="stringliteral">"%s first_in_nextep_seq= %2d; nextep_seq[]:\n"</span>, 
03452                 __func__, core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o51">first_in_nextep_seq</a>);
03453         <span class="keywordflow">for</span> (i=0; i &lt;= core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
03454                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(DBG_PCDV,<span class="stringliteral">"%2d\n"</span>, core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[i]);
03455         }
03456 
03457         <span class="comment">/* Flush the Learning Queue */</span>
03458         resetctl.<a class="code" href="uniongrstctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o4">grstctl</a>);
03459         resetctl.<a class="code" href="uniongrstctl__data.html#o11">b</a>.<a class="code" href="uniongrstctl__data.html#o4">intknqflsh</a> = 1;
03460         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o4">grstctl</a>, resetctl.<a class="code" href="uniongrstctl__data.html#o0">d32</a>);
03461         
03462 
03463 }
03464 
<a name="l03468"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a50">03468</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a50">handle_in_ep_disable_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
03469                                              <span class="keyword">const</span> uint32_t epnum)
03470 {
03471         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
03472         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
03473         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> dieptsiz = {.d32 = 0 };
03474         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = {.d32 = 0 };
03475         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
03476         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
03477         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> <a class="code" href="uniongintmsk__data.html">gintmsk_data</a>;
03478         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl;
03479         uint32_t diepdma;
03480         uint32_t remain_to_transfer = 0;
03481         uint8_t i;
03482         uint32_t xfer_size;
03483         
03484         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a6">get_in_ep</a>(pcd, epnum);
03485         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
03486 
03487         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
03488                 <a class="code" href="dwc__otg__cil_8h.html#a104">dwc_otg_flush_tx_fifo</a>(core_if, dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a>);
03489                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a38">complete_ep</a>(ep);
03490                 <span class="keywordflow">return</span>;
03491         }
03492 
03493         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"diepctl%d=%0x\n"</span>, epnum,
03494                     DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>));
03495         dieptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o4">dieptsiz</a>);
03496         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
03497 
03498         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"pktcnt=%d size=%d\n"</span>,
03499                     dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>, dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>);
03500         
03501         <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a> == 0) || (depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o6">eptype</a> &amp; 1)) { 
03502                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>) {
03503                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o18">en_multiple_tx_fifo</a>)
03504                                 <span class="comment">/* Flush the Tx FIFO */</span>
03505                                 <a class="code" href="dwc__otg__cil_8h.html#a104">dwc_otg_flush_tx_fifo</a>(core_if, dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o3">tx_fifo_num</a>);
03506                         <span class="comment">/* Clear the Global IN NP NAK */</span>
03507                         dctl.<a class="code" href="uniondctl__data.html#o0">d32</a> = 0;
03508                         dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o7">cgnpinnak</a> = 1;
03509                         DWC_MODIFY_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>); 
03510                         <span class="comment">/* Restart the transaction */</span>
03511                         <span class="keywordflow">if</span> (dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> != 0 || dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> != 0) {
03512                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a48">restart_transfer</a>(pcd, epnum);
03513                         }
03514                 } <span class="keywordflow">else</span> {
03515                         <span class="comment">/* Restart the transaction */</span>
03516                         <span class="keywordflow">if</span> (dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> != 0 || dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> != 0) {
03517                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a48">restart_transfer</a>(pcd, epnum);
03518                         }
03519                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"STOPPED!!!\n"</span>);
03520                 }
03521                 <span class="keywordflow">return</span>;
03522         }
03523 
03524         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a> &gt; 2) {       <span class="comment">// NP IN EP</span>
03525                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a>--;
03526                 <span class="keywordflow">return</span>;
03527         }
03528 
03529         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a>--;
03530         
03531         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a> == 1) {      <span class="comment">// All NP IN Ep's disabled now</span>
03532 
03533                 predict_nextep_seq(core_if);
03534                         
03535                 <span class="comment">/* Update all active IN EP's NextEP field based of nextep_seq[] */</span>
03536                 <span class="keywordflow">for</span> ( i = 0; i &lt;= core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
03537                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
03538                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[i] != 0xff) {   <span class="comment">// Active NP IN EP</span>
03539                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o2">nextep</a> = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[i];
03540                                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
03541                         }
03542                 }
03543                 <span class="comment">/* Flush Shared NP TxFIFO */</span>
03544                 <a class="code" href="dwc__otg__cil_8h.html#a104">dwc_otg_flush_tx_fifo</a>(core_if, 0);
03545                 <span class="comment">/* Rewind buffers */</span>
03546                 <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {                
03547                         i = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o51">first_in_nextep_seq</a>;
03548                         <span class="keywordflow">do</span> {
03549                                 ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a6">get_in_ep</a>(pcd, i);
03550                                 dieptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o4">dieptsiz</a>);
03551                                 xfer_size = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_8">total_len</a> - ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_6">xfer_count</a>;
03552                                 <span class="keywordflow">if</span> (xfer_size &gt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a>) 
03553                                         xfer_size = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o8">maxxfer</a>;
03554                                 depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
03555                                 <span class="keywordflow">if</span> (dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> != 0) {
03556                                         <span class="keywordflow">if</span> (xfer_size == 0) {
03557                                                 remain_to_transfer = 0;
03558                                         } <span class="keywordflow">else</span> {
03559                                                 <span class="keywordflow">if</span> ((xfer_size % ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) == 0) {
03560                                                         remain_to_transfer = 
03561                                                                 dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> * ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>;
03562                                                 } <span class="keywordflow">else</span> {
03563                                                         remain_to_transfer = ((dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> -1) * ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>) 
03564                                                                 + (xfer_size % ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o7">maxpacket</a>);
03565                                                 }
03566                                         }
03567                                         diepdma = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o5">diepdma</a>);
03568                                         dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a> = remain_to_transfer;
03569                                         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o4">dieptsiz</a>, dieptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a>);
03570                                         diepdma = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_0">dma_addr</a> + (xfer_size - remain_to_transfer);
03571                                         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o5">diepdma</a>, diepdma);
03572                                 }
03573                                 i = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[i];
03574                         } <span class="keywordflow">while</span> (i != core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o51">first_in_nextep_seq</a>);
03575                 } <span class="keywordflow">else</span> { <span class="comment">// dma_desc_enable</span>
03576                                 DWC_PRINTF(<span class="stringliteral">"%s Learning Queue not supported in DDMA\n"</span>, __func__);
03577                 }
03578                                 
03579                 <span class="comment">/* Restart transfers in predicted sequences */</span>
03580                 i = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o51">first_in_nextep_seq</a>;
03581                 <span class="keywordflow">do</span> {
03582                         dieptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o4">dieptsiz</a>);
03583                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
03584                         <span class="keywordflow">if</span> (dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a> != 0) {
03585                                 depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
03586                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> = 1;
03587                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o10">cnak</a> = 1;
03588                                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
03589                         }
03590                         i = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o50">nextep_seq</a>[i];
03591                 } <span class="keywordflow">while</span> (i != core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o51">first_in_nextep_seq</a>);
03592 
03593                 <span class="comment">/* Clear the global non-periodic IN NAK handshake */</span>
03594                 dctl.<a class="code" href="uniondctl__data.html#o0">d32</a> = 0;
03595                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o7">cgnpinnak</a> = 1;
03596                 DWC_MODIFY_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>); 
03597                         
03598                 <span class="comment">/* Unmask EP Mismatch interrupt */</span>
03599                 gintmsk_data.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = 0;
03600                 gintmsk_data.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o18">epmismatch</a> = 1;
03601                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0, gintmsk_data.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
03602                 
03603                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a> = 0;
03604 
03605         } 
03606 }
03607 
<a name="l03611"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a51">03611</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#a51">handle_in_ep_timeout_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
03612                                              <span class="keyword">const</span> uint32_t epnum)
03613 {
03614         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
03615         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
03616 
03617 <span class="preprocessor">#ifdef DEBUG</span>
03618 <span class="preprocessor"></span>        <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> dieptsiz = {.d32 = 0 };
03619         uint32_t num = 0;
03620 <span class="preprocessor">#endif</span>
03621 <span class="preprocessor"></span>        <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = {.d32 = 0 };
03622         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
03623 
03624         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.d32 = 0 };
03625 
03626         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a6">get_in_ep</a>(pcd, epnum);
03627 
03628         <span class="comment">/* Disable the NP Tx Fifo Empty Interrrupt */</span>
03629         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o14">dma_enable</a>) {
03630                 intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o6">nptxfempty</a> = 1;
03631                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>,
03632                                  intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
03633         }
03636         <span class="comment">/*</span>
03637 <span class="comment">         * Non-periodic EP</span>
03638 <span class="comment">         */</span>
03639         <span class="comment">/* Enable the Global IN NAK Effective Interrupt */</span>
03640         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o7">ginnakeff</a> = 1;
03641         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, 0, intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
03642 
03643         <span class="comment">/* Set Global IN NAK */</span>
03644         dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o6">sgnpinnak</a> = 1;
03645         DWC_MODIFY_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
03646 
03647         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
03648 
03649 <span class="preprocessor">#ifdef DEBUG</span>
03650 <span class="preprocessor"></span>        dieptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[num]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o4">dieptsiz</a>);
03651         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"pktcnt=%d size=%d\n"</span>,
03652                     dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o2">pktcnt</a>, dieptsiz.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.<a class="code" href="uniondeptsiz__data.html#o1">xfersize</a>);
03653 <span class="preprocessor">#endif</span>
03654 <span class="preprocessor"></span>
03655 <span class="preprocessor">#ifdef DISABLE_PERIODIC_EP</span>
03656 <span class="preprocessor"></span>        <span class="comment">/*</span>
03657 <span class="comment">         * Set the NAK bit for this EP to</span>
03658 <span class="comment">         * start the disable process.</span>
03659 <span class="comment">         */</span>
03660         diepctl.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = 0;
03661         diepctl.<a class="code" href="uniondeptsiz__data.html#o5">b</a>.snak = 1;
03662         DWC_MODIFY_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[num]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>, diepctl.d32,
03663                          diepctl.d32);
03664         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o3">disabling</a> = 1;
03665         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> = 1;
03666 <span class="preprocessor">#endif</span>
03667 <span class="preprocessor"></span>}
03668 
<a name="l03672"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a52">03672</a> <span class="keyword">static</span> <span class="keyword">inline</span> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a52">handle_in_ep_nak_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
03673                                             <span class="keyword">const</span> uint32_t epnum)
03674 {
03676         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if;
03677         <a class="code" href="uniondiepint__data.html">diepmsk_data_t</a> intr_mask = {.d32 = 0 };
03678 
03679         DWC_PRINTF(<span class="stringliteral">"INTERRUPT Handler not implemented for %s\n"</span>, <span class="stringliteral">"IN EP NAK"</span>);
03680         core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
03681         intr_mask.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o12">nak</a> = 1;
03682 
03683         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
03684                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;
03685                                  diepeachintmsk[epnum], intr_mask.<a class="code" href="uniondiepint__data.html#o0">d32</a>, 0);
03686         } <span class="keywordflow">else</span> {
03687                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o4">diepmsk</a>,
03688                                  intr_mask.<a class="code" href="uniondiepint__data.html#o0">d32</a>, 0);
03689         }
03690 
03691         <span class="keywordflow">return</span> 1;
03692 }
03693 
<a name="l03697"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a53">03697</a> <span class="keyword">static</span> <span class="keyword">inline</span> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a53">handle_out_ep_babble_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
03698                                                 <span class="keyword">const</span> uint32_t epnum)
03699 {
03701         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if;
03702         <a class="code" href="uniondoepint__data.html">doepmsk_data_t</a> intr_mask = {.<a class="code" href="uniondiepint__data.html#o0">d32</a> = 0 };
03703 
03704         DWC_PRINTF(<span class="stringliteral">"INTERRUPT Handler not implemented for %s\n"</span>,
03705                    <span class="stringliteral">"OUT EP Babble"</span>);
03706         core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
03707         intr_mask.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o13">babble</a> = 1;
03708 
03709         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
03710                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;
03711                                  doepeachintmsk[epnum], intr_mask.<a class="code" href="uniondoepint__data.html#o0">d32</a>, 0);
03712         } <span class="keywordflow">else</span> {
03713                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o5">doepmsk</a>,
03714                                  intr_mask.<a class="code" href="uniondoepint__data.html#o0">d32</a>, 0);
03715         }
03716 
03717         <span class="keywordflow">return</span> 1;
03718 }
03719 
<a name="l03723"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a54">03723</a> <span class="keyword">static</span> <span class="keyword">inline</span> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a54">handle_out_ep_nak_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
03724                                              <span class="keyword">const</span> uint32_t epnum)
03725 {
03727         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if;
03728         <a class="code" href="uniondoepint__data.html">doepmsk_data_t</a> intr_mask = {.<a class="code" href="uniondoepint__data.html#o0">d32</a> = 0 };
03729 
03730         DWC_PRINTF(<span class="stringliteral">"INTERRUPT Handler not implemented for %s\n"</span>, <span class="stringliteral">"OUT EP NAK"</span>);
03731         core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
03732         intr_mask.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o14">nak</a> = 1;
03733 
03734         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
03735                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;
03736                                  doepeachintmsk[epnum], intr_mask.<a class="code" href="uniondoepint__data.html#o0">d32</a>, 0);
03737         } <span class="keywordflow">else</span> {
03738                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o5">doepmsk</a>,
03739                                  intr_mask.<a class="code" href="uniondoepint__data.html#o0">d32</a>, 0);
03740         }
03741 
03742         <span class="keywordflow">return</span> 1;
03743 }
03744 
<a name="l03748"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a55">03748</a> <span class="keyword">static</span> <span class="keyword">inline</span> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a55">handle_out_ep_nyet_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
03749                                               <span class="keyword">const</span> uint32_t epnum)
03750 {
03752         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if;
03753         <a class="code" href="uniondoepint__data.html">doepmsk_data_t</a> intr_mask = {.<a class="code" href="uniondoepint__data.html#o0">d32</a> = 0 };
03754 
03755         DWC_PRINTF(<span class="stringliteral">"INTERRUPT Handler not implemented for %s\n"</span>, <span class="stringliteral">"OUT EP NYET"</span>);
03756         core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
03757         intr_mask.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o15">nyet</a> = 1;
03758 
03759         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
03760                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;
03761                                  doepeachintmsk[epnum], intr_mask.<a class="code" href="uniondoepint__data.html#o0">d32</a>, 0);
03762         } <span class="keywordflow">else</span> {
03763                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o5">doepmsk</a>,
03764                                  intr_mask.<a class="code" href="uniondoepint__data.html#o0">d32</a>, 0);
03765         }
03766 
03767         <span class="keywordflow">return</span> 1;
03768 }
03769 
<a name="l03786"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a56">03786</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a56">dwc_otg_pcd_handle_in_ep_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
03787 {
03788 <span class="preprocessor">#define CLEAR_IN_EP_INTR(__core_if,__epnum,__intr) \</span>
03789 <span class="preprocessor">do { \</span>
03790 <span class="preprocessor">                diepint_data_t diepint = {.d32=0}; \</span>
03791 <span class="preprocessor">                diepint.b.__intr = 1; \</span>
03792 <span class="preprocessor">                DWC_WRITE_REG32(&amp;__core_if-&gt;dev_if-&gt;in_ep_regs[__epnum]-&gt;diepint, \</span>
03793 <span class="preprocessor">                diepint.d32); \</span>
03794 <span class="preprocessor">} while (0)</span>
03795 <span class="preprocessor"></span>
03796         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
03797         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>;
03798         <a class="code" href="uniondiepint__data.html">diepint_data_t</a> diepint = {.d32 = 0 };
03799         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = 0 };
03800         uint32_t ep_intr;
03801         uint32_t epnum = 0;
03802         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
03803         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
03804         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.d32 = 0 };
03805 
03806         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, pcd);
03807 
03808         <span class="comment">/* Read in the device interrupt bits */</span>
03809         ep_intr = <a class="code" href="dwc__otg__cil_8h.html#a109">dwc_otg_read_dev_all_in_ep_intr</a>(core_if);
03810 
03811         <span class="comment">/* Service the Device IN interrupts for each endpoint */</span>
03812         <span class="keywordflow">while</span> (ep_intr) {
03813                 <span class="keywordflow">if</span> (ep_intr &amp; 0x1) {
03814                         uint32_t empty_msk;
03815                         <span class="comment">/* Get EP pointer */</span>
03816                         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a6">get_in_ep</a>(pcd, epnum);
03817                         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
03818 
03819                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> =
03820                             DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
03821                         empty_msk =
03822                             DWC_READ_REG32(&amp;dev_if-&gt;
03823                                            dev_global_regs-&gt;dtknqr4_fifoemptymsk);
03824 
03825                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
03826                                     <span class="stringliteral">"IN EP INTERRUPT - %d\nepmty_msk - %8x  diepctl - %8x\n"</span>,
03827                                     epnum, empty_msk, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
03828 
03829                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>,
03830                                     <span class="stringliteral">"EP%d-%s: type=%d, mps=%d\n"</span>,
03831                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>, (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>),
03832                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a>, dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>);
03833 
03834                         diepint.<a class="code" href="uniondiepint__data.html#o0">d32</a> =
03835                             <a class="code" href="dwc__otg__cil_8h.html#a111">dwc_otg_read_dev_in_ep_intr</a>(core_if, dwc_ep);
03836 
03837                         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
03838                                     <span class="stringliteral">"EP %d Interrupt Register - 0x%x\n"</span>, epnum,
03839                                     diepint.<a class="code" href="uniondiepint__data.html#o0">d32</a>);
03840                         <span class="comment">/* Transfer complete */</span>
03841                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o1">xfercompl</a>) {
03842                                 <span class="comment">/* Disable the NP Tx FIFO Empty</span>
03843 <span class="comment">                                 * Interrrupt */</span>
03844                                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o18">en_multiple_tx_fifo</a> == 0) {
03845                                         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o6">nptxfempty</a> = 1;
03846                                         DWC_MODIFY_REG32
03847                                             (&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>,
03848                                              intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
03849                                 } <span class="keywordflow">else</span> {
03850                                         <span class="comment">/* Disable the Tx FIFO Empty Interrupt for this EP */</span>
03851                                         uint32_t fifoemptymsk =
03852                                             0x1 &lt;&lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>;
03853                                         DWC_MODIFY_REG32(&amp;core_if-&gt;
03854                                                          dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o13">dtknqr4_fifoemptymsk</a>,
03855                                                          fifoemptymsk, 0);
03856                                 }
03857                                 <span class="comment">/* Clear the bit in DIEPINTn for this interrupt */</span>
03858                                 CLEAR_IN_EP_INTR(core_if, epnum, xfercompl);
03859 
03860                                 <span class="comment">/* Complete the transfer */</span>
03861                                 <span class="keywordflow">if</span> (epnum == 0) {
03862                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a47">handle_ep0</a>(pcd);
03863                                 }
03864 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
03865 <span class="preprocessor"></span>                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
03866                                         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>)
03867                                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a45">complete_iso_ep</a>(pcd, ep);
03868                                 }
03869 <span class="preprocessor">#endif </span><span class="comment">/* DWC_EN_ISOC */</span>
03870 <span class="preprocessor">#ifdef DWC_UTE_PER_IO</span>
03871 <span class="preprocessor"></span>                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
03872                                         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>)
03873                                                 complete_xiso_ep(ep);
03874                                 }
03875 <span class="preprocessor">#endif </span><span class="comment">/* DWC_UTE_PER_IO */</span>
03876                                 <span class="keywordflow">else</span> {
03877                                         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC &amp;&amp; 
03878                                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a> &gt; 1) {
03879                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
03880                                                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> &gt; 0x3FFF)
03881                                                 {
03882                                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_13">frm_overrun</a> = 1;
03883                                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> &amp;= 0x3FFF;
03884                                                 } <span class="keywordflow">else</span> 
03885                                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_13">frm_overrun</a> = 0;
03886                                         }
03887                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a38">complete_ep</a>(ep);
03888                                         <span class="keywordflow">if</span>(diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o12">nak</a>)
03889                                                 CLEAR_IN_EP_INTR(core_if, epnum, nak);
03890                                 }
03891                         }
03892                         <span class="comment">/* Endpoint disable      */</span>
03893                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o2">epdisabled</a>) {
03894                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"EP%d IN disabled\n"</span>,
03895                                             epnum);
03896                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a50">handle_in_ep_disable_intr</a>(pcd, epnum);
03897 
03898                                 <span class="comment">/* Clear the bit in DIEPINTn for this interrupt */</span>
03899                                 CLEAR_IN_EP_INTR(core_if, epnum, epdisabled);
03900                         }
03901                         <span class="comment">/* AHB Error */</span>
03902                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o3">ahberr</a>) {
03903                                 DWC_ERROR(<span class="stringliteral">"EP%d IN AHB Error\n"</span>, epnum);
03904                                 <span class="comment">/* Clear the bit in DIEPINTn for this interrupt */</span>
03905                                 CLEAR_IN_EP_INTR(core_if, epnum, ahberr);
03906                         }
03907                         <span class="comment">/* TimeOUT Handshake (non-ISOC IN EPs) */</span>
03908                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o4">timeout</a>) {
03909                                 DWC_ERROR(<span class="stringliteral">"EP%d IN Time-out\n"</span>, epnum);
03910                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a51">handle_in_ep_timeout_intr</a>(pcd, epnum);
03911 
03912                                 CLEAR_IN_EP_INTR(core_if, epnum, timeout);
03913                         }
03915                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o5">intktxfemp</a>) {
03916                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>,
03917                                             <span class="stringliteral">"EP%d IN TKN TxFifo Empty\n"</span>,
03918                                             epnum);
03919                                 <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a> &amp;&amp; epnum != 0) {
03920 
03921                                         <a class="code" href="uniondiepint__data.html">diepmsk_data_t</a> diepmsk = {.d32 = 0 };
03922                                         diepmsk.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o5">intktxfemp</a> = 1;
03923 
03924                                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
03925                                                 DWC_MODIFY_REG32
03926                                                     (&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o16">diepeachintmsk</a>
03927                                                      [epnum], diepmsk.<a class="code" href="uniondiepint__data.html#o0">d32</a>, 0);
03928                                         } <span class="keywordflow">else</span> {
03929                                                 DWC_MODIFY_REG32
03930                                                     (&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o4">diepmsk</a>,
03931                                                      diepmsk.<a class="code" href="uniondiepint__data.html#o0">d32</a>, 0);
03932                                         }
03933                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>
03934                                            &amp;&amp; epnum == 0
03935                                            &amp;&amp; pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> ==
03936                                            EP0_OUT_STATUS_PHASE) {
03937                                         <span class="comment">// EP0 IN set STALL</span>
03938                                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> =
03939                                             DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>
03940                                                            [epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
03941 
03942                                         <span class="comment">/* set the disable and stall bits */</span>
03943                                         <span class="keywordflow">if</span> (depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a>) {
03944                                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> = 1;
03945                                         }
03946                                         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o8">stall</a> = 1;
03947                                         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>
03948                                                         [epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>,
03949                                                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
03950                                 }
03951                                 CLEAR_IN_EP_INTR(core_if, epnum, intktxfemp);
03952                         }
03954                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o6">intknepmis</a>) {
03955                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>,
03956                                             <span class="stringliteral">"EP%d IN TKN EP Mismatch\n"</span>, epnum);
03957                                 CLEAR_IN_EP_INTR(core_if, epnum, intknepmis);                           
03958                         }
03960                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o7">inepnakeff</a>) {
03961                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>,
03962                                             <span class="stringliteral">"EP%d IN EP NAK Effective\n"</span>,
03963                                             epnum);
03964                                 <span class="comment">/* Periodic EP */</span>
03965                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o3">disabling</a>) {
03966                                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0;
03967                                         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o11">snak</a> = 1;
03968                                         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> = 1;
03969                                         DWC_MODIFY_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>
03970                                                          [epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>,
03971                                                          depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>,
03972                                                          depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
03973                                 }
03974                                 CLEAR_IN_EP_INTR(core_if, epnum, inepnakeff);
03975 
03976                         }
03977 
03979                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o8">emptyintr</a>) {
03980                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>,
03981                                             <span class="stringliteral">"EP%d Tx FIFO Empty Intr \n"</span>,
03982                                             epnum);
03983                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a14">write_empty_tx_fifo</a>(pcd, epnum);
03984 
03985                                 CLEAR_IN_EP_INTR(core_if, epnum, emptyintr);
03986 
03987                         }
03988 
03990                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o10">bna</a>) {
03991                                 CLEAR_IN_EP_INTR(core_if, epnum, bna);
03992                                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
03993 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
03994 <span class="preprocessor"></span>                                        <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> ==
03995                                             DWC_OTG_EP_TYPE_ISOC) {
03996                                                 <span class="comment">/*</span>
03997 <span class="comment">                                                 * This checking is performed to prevent first "false" BNA</span>
03998 <span class="comment">                                                 * handling occuring right after reconnect</span>
03999 <span class="comment">                                                 */</span>
04000                                                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> !=
04001                                                     0xffffffff)
04002                                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a39">dwc_otg_pcd_handle_iso_bna</a>(ep);
04003                                         } <span class="keywordflow">else</span>
04004 <span class="preprocessor">#endif                          </span><span class="comment">/* DWC_EN_ISOC */</span>
04005                                         {
04006                                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a46">dwc_otg_pcd_handle_noniso_bna</a>(ep);
04007                                         }
04008                                 }
04009                         }
04010                         <span class="comment">/* NAK Interrutp */</span>
04011                         <span class="keywordflow">if</span> (diepint.<a class="code" href="uniondiepint__data.html#o14">b</a>.<a class="code" href="uniondiepint__data.html#o12">nak</a>) {
04012                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"EP%d IN NAK Interrupt\n"</span>,
04013                                             epnum);
04014                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC)
04015                                 {
04016                                         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl;
04017                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> == 0xFFFFFFFF) 
04018                                         {
04019                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o52">frame_num</a>;
04020                                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_11">bInterval</a> &gt; 1) 
04021                                                 {
04022                                                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0;
04023                                                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
04024                                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> &amp; 0x1) {
04025                                                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o13">setd1pid</a> = 1;
04026                                                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o12">setd0pid</a> = 0;
04027                                                         } <span class="keywordflow">else</span> {
04028                                                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o12">setd0pid</a> = 1;
04029                                                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o13">setd1pid</a> = 0;
04030                                                         }
04031                                                         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
04032                                                 }
04033                                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a9">start_next_request</a>(ep);
04034                                         }
04035                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> += ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_11">bInterval</a>;
04036                                         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> &gt; 0x3FFF)
04037                                         {
04038                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_13">frm_overrun</a> = 1;
04039                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> &amp;= 0x3FFF;
04040                                         } <span class="keywordflow">else</span> 
04041                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_13">frm_overrun</a> = 0;
04042                                 }
04043 
04044                                 CLEAR_IN_EP_INTR(core_if, epnum, nak);
04045                         }
04046                 }
04047                 epnum++;
04048                 ep_intr &gt;&gt;= 1;
04049         }
04050 
04051         <span class="keywordflow">return</span> 1;
04052 <span class="preprocessor">#undef CLEAR_IN_EP_INTR</span>
04053 <span class="preprocessor"></span>}
04054 
<a name="l04068"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a57">04068</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a57">dwc_otg_pcd_handle_out_ep_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
04069 {
04070 <span class="preprocessor">#define CLEAR_OUT_EP_INTR(__core_if,__epnum,__intr) \</span>
04071 <span class="preprocessor">do { \</span>
04072 <span class="preprocessor">                doepint_data_t doepint = {.d32=0}; \</span>
04073 <span class="preprocessor">                doepint.b.__intr = 1; \</span>
04074 <span class="preprocessor">                DWC_WRITE_REG32(&amp;__core_if-&gt;dev_if-&gt;out_ep_regs[__epnum]-&gt;doepint, \</span>
04075 <span class="preprocessor">                doepint.d32); \</span>
04076 <span class="preprocessor">} while (0)</span>
04077 <span class="preprocessor"></span>
04078         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
04079         uint32_t ep_intr;
04080         <a class="code" href="uniondoepint__data.html">doepint_data_t</a> doepint = {.d32 = 0 };
04081         uint32_t epnum = 0;
04082         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
04083         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
04084         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = {.d32 = 0 };
04085         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk = {.d32 = 0 };
04086 
04087 
04088         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s()\n"</span>, __func__);
04089 
04090         <span class="comment">/* Read in the device interrupt bits */</span>
04091         ep_intr = <a class="code" href="dwc__otg__cil_8h.html#a110">dwc_otg_read_dev_all_out_ep_intr</a>(core_if);
04092 
04093         <span class="keywordflow">while</span> (ep_intr) {
04094                 <span class="keywordflow">if</span> (ep_intr &amp; 0x1) {
04095                         <span class="comment">/* Get EP pointer */</span>
04096                         ep = <a class="code" href="dwc__otg__pcd__intr_8c.html#a7">get_out_ep</a>(pcd, epnum);
04097                         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
04098 
04099 <span class="preprocessor">#ifdef VERBOSE</span>
04100 <span class="preprocessor"></span>                        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>,
04101                                     <span class="stringliteral">"EP%d-%s: type=%d, mps=%d\n"</span>,
04102                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>, (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o1">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>),
04103                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a>, dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o7">maxpacket</a>);
04104 <span class="preprocessor">#endif</span>
04105 <span class="preprocessor"></span>                        doepint.<a class="code" href="uniondoepint__data.html#o0">d32</a> =
04106                             <a class="code" href="dwc__otg__cil_8h.html#a112">dwc_otg_read_dev_out_ep_intr</a>(core_if, dwc_ep);
04107 
04108                         <span class="comment">/* Transfer complete */</span>
04109                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o1">xfercompl</a>) {
04110 
04111                                 <span class="keywordflow">if</span> (epnum == 0) {
04112                                         <span class="comment">/* Clear the bit in DOEPINTn for this interrupt */</span>
04113                                         CLEAR_OUT_EP_INTR(core_if, epnum,
04114                                                           xfercompl);
04115                                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a> == 0
04116                                             || pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o3">ep0state</a> != EP0_IDLE)
04117                                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a47">handle_ep0</a>(pcd);
04118 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
04119 <span class="preprocessor"></span>                                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
04120                                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o12">pktdrpsts</a> == 0) {
04121                                                 <span class="comment">/* Clear the bit in DOEPINTn for this interrupt */</span>
04122                                                 CLEAR_OUT_EP_INTR(core_if,
04123                                                                   epnum,
04124                                                                   xfercompl);
04125                                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a45">complete_iso_ep</a>(pcd, ep);
04126                                         } <span class="keywordflow">else</span> {
04127 
04128                                                 <a class="code" href="uniondoepint__data.html">doepint_data_t</a> doepint = {.<a class="code" href="uniondoepint__data.html#o0">d32</a> = 0 };
04129                                                 doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o1">xfercompl</a> = 1;
04130                                                 doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o12">pktdrpsts</a> = 1;
04131                                                 DWC_WRITE_REG32
04132                                                     (&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>
04133                                                      [epnum]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o2">doepint</a>,
04134                                                      doepint.<a class="code" href="uniondoepint__data.html#o0">d32</a>);
04135                                                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd__intr_8c.html#a43">handle_iso_out_pkt_dropped</a>
04136                                                     (core_if, dwc_ep)) {
04137                                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a45">complete_iso_ep</a>(pcd,
04138                                                                         ep);
04139                                                 }
04140                                         }
04141 <span class="preprocessor">#endif </span><span class="comment">/* DWC_EN_ISOC */</span>
04142 <span class="preprocessor">#ifdef DWC_UTE_PER_IO</span>
04143 <span class="preprocessor"></span>                                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
04144                                         CLEAR_OUT_EP_INTR(core_if, epnum, xfercompl);
04145                                         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o2">stopped</a>)
04146                                                 complete_xiso_ep(ep);
04147 <span class="preprocessor">#endif </span><span class="comment">/* DWC_UTE_PER_IO */</span>
04148                                 } <span class="keywordflow">else</span> {
04149                                         <span class="comment">/* Clear the bit in DOEPINTn for this interrupt */</span>
04150                                         CLEAR_OUT_EP_INTR(core_if, epnum,
04151                                                           xfercompl);
04152 
04153                                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o39">dev_out_nak</a>) {
04154                                                 DWC_TIMER_CANCEL(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o37">ep_xfer_timer</a>[epnum]);
04155                                                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o36">ep_xfer_info</a>[epnum].state = 0;
04156 <span class="preprocessor">#ifdef DEBUG</span>
04157 <span class="preprocessor"></span>                                                <a class="code" href="dwc__otg__pcd__intr_8c.html#a5">print_memory_payload</a>(pcd, dwc_ep);
04158 <span class="preprocessor">#endif</span>
04159 <span class="preprocessor"></span>                                        }
04160                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a38">complete_ep</a>(ep);                                                
04161                                 }
04162 
04163                         }
04164 
04165                         <span class="comment">/* Endpoint disable      */</span>
04166                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o2">epdisabled</a>) {
04167 
04168                                 <span class="comment">/* Clear the bit in DOEPINTn for this interrupt */</span>
04169                                 CLEAR_OUT_EP_INTR(core_if, epnum, epdisabled);
04170                                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o39">dev_out_nak</a>) {
04171 <span class="preprocessor">#ifdef DEBUG</span>
04172 <span class="preprocessor"></span>                                        <a class="code" href="dwc__otg__pcd__intr_8c.html#a5">print_memory_payload</a>(pcd, dwc_ep);
04173 <span class="preprocessor">#endif</span>
04174 <span class="preprocessor"></span>                                        <span class="comment">/* In case of timeout condition */</span>
04175                                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o36">ep_xfer_info</a>[epnum].state == 2) {
04176                                                 dctl.<a class="code" href="uniondctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
04177                                                                                 dev_global_regs-&gt;dctl);
04178                                                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o9">cgoutnak</a> = 1;
04179                                                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>,
04180                                                                                                                                 dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
04181                                                 <span class="comment">/* Unmask goutnakeff interrupt which was masked</span>
04182 <span class="comment">                                                 * during handle nak out interrupt */</span>
04183                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o8">goutnakeff</a> = 1;
04184                                                 DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>,
04185                                                                                                                                 0, gintmsk.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
04186                                         
04187                                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a38">complete_ep</a>(ep);
04188                                         }
04189                                 }
04190                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC)
04191                                 {
04192                                         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl;
04193                                         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.<a class="code" href="uniondctl__data.html#o0">d32</a> = 0};
04194                                         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req = 0;
04195 
04196                                         dctl.<a class="code" href="uniondctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
04197                                                 dev_global_regs-&gt;dctl);
04198                                         dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o9">cgoutnak</a> = 1;
04199                                         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>,
04200                                                 dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
04201 
04202                                         intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = 0;
04203                                         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o22">incomplisoout</a> = 1;     
04204 
04205                                         <span class="comment">/* Get any pending requests */</span>
04206                                         <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>)) {
04207                                                 req = DWC_CIRCLEQ_FIRST(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o1">queue</a>);
04208                                                 <span class="keywordflow">if</span> (!req) {
04209                                                         DWC_PRINTF(<span class="stringliteral">"complete_ep 0x%p, req = NULL!\n"</span>, ep);
04210                                                 } <span class="keywordflow">else</span> {
04211                                                         <a class="code" href="dwc__otg__pcd_8h.html#a17">dwc_otg_request_done</a>(ep, req, 0);
04212                                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a9">start_next_request</a>(ep);
04213                                                 }
04214                                         } <span class="keywordflow">else</span> {
04215                                                 DWC_PRINTF(<span class="stringliteral">"complete_ep 0x%p, ep-&gt;queue empty!\n"</span>, ep);
04216                                         }
04217                                 }
04218                         }
04219                         <span class="comment">/* AHB Error */</span>
04220                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o3">ahberr</a>) {
04221                                 DWC_ERROR(<span class="stringliteral">"EP%d OUT AHB Error\n"</span>, epnum);
04222                                 DWC_ERROR(<span class="stringliteral">"EP%d DEPDMA=0x%08x \n"</span>,
04223                                           epnum, core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o5">doepdma</a>);
04224                                 CLEAR_OUT_EP_INTR(core_if, epnum, ahberr);
04225                         }
04226                         <span class="comment">/* Setup Phase Done (contorl EPs) */</span>
04227                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o4">setup</a>) {
04228 <span class="preprocessor">#ifdef DEBUG_EP0</span>
04229 <span class="preprocessor"></span>                                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"EP%d SETUP Done\n"</span>,
04230                                             epnum);
04231 <span class="preprocessor">#endif</span>
04232 <span class="preprocessor"></span>                                CLEAR_OUT_EP_INTR(core_if, epnum, setup);
04233 
04234                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a47">handle_ep0</a>(pcd);
04235                         }
04236 
04238                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o10">bna</a>) {
04239                                 CLEAR_OUT_EP_INTR(core_if, epnum, bna);
04240                                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
04241 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
04242 <span class="preprocessor"></span>                                        <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> ==
04243                                             DWC_OTG_EP_TYPE_ISOC) {
04244                                                 <span class="comment">/*</span>
04245 <span class="comment">                                                 * This checking is performed to prevent first "false" BNA</span>
04246 <span class="comment">                                                 * handling occuring right after reconnect</span>
04247 <span class="comment">                                                 */</span>
04248                                                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> !=
04249                                                     0xffffffff)
04250                                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a39">dwc_otg_pcd_handle_iso_bna</a>(ep);
04251                                         } <span class="keywordflow">else</span>
04252 <span class="preprocessor">#endif                          </span><span class="comment">/* DWC_EN_ISOC */</span>
04253                                         {
04254                                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a46">dwc_otg_pcd_handle_noniso_bna</a>(ep);
04255                                         }
04256                                 }
04257                         }
04258                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o6">stsphsercvd</a>) {
04259                                 CLEAR_OUT_EP_INTR(core_if, epnum, stsphsercvd);
04260                                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o15">dma_desc_enable</a>) {
04261                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a28">do_setup_in_status_phase</a>(pcd);
04262                                 }
04263                         }
04264                         <span class="comment">/* Babble Interrutp */</span>
04265                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o13">babble</a>) {
04266                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"EP%d OUT Babble\n"</span>,
04267                                             epnum);
04268                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a53">handle_out_ep_babble_intr</a>(pcd, epnum);
04269 
04270                                 CLEAR_OUT_EP_INTR(core_if, epnum, babble);
04271                         }
04272                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o5">outtknepdis</a>)
04273                         {
04274                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"EP%d OUT Token received when EP is \</span>
04275 <span class="stringliteral">                                        disabled\n"</span>,epnum);
04276                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC)
04277                                 {
04278                                         <a class="code" href="uniondoepint__data.html">doepmsk_data_t</a> doepmsk = {.d32 = 0};
04279                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o52">frame_num</a>;
04280                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_11">bInterval</a> &gt; 1) 
04281                                         {
04282                                                 <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl;
04283                                                 depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
04284                                                                                                         out_ep_regs[epnum]-&gt;doepctl);
04285                                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#z32_12">frame_num</a> &amp; 0x1) {
04286                                                         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o13">setd1pid</a> = 1;
04287                                                         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o12">setd0pid</a> = 0;
04288                                                 } <span class="keywordflow">else</span> {
04289                                                         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o12">setd0pid</a> = 1;
04290                                                         depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o13">setd1pid</a> = 0;
04291                                                 }
04292                                                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;
04293                                                                                 out_ep_regs[epnum]-&gt;doepctl, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
04294                                         }
04295                                         <a class="code" href="dwc__otg__pcd__intr_8c.html#a9">start_next_request</a>(ep);
04296                                         doepmsk.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o5">outtknepdis</a> = 1;
04297                                         DWC_MODIFY_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o5">doepmsk</a>, 
04298                                                                  doepmsk.<a class="code" href="uniondoepint__data.html#o0">d32</a>, 0);
04299                                 }
04300                                 CLEAR_OUT_EP_INTR(core_if, epnum, outtknepdis);
04301                         }
04302                         
04303                         <span class="comment">/* NAK Interrutp */</span>
04304                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o14">nak</a>) {
04305                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"EP%d OUT NAK\n"</span>, epnum);
04306                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a54">handle_out_ep_nak_intr</a>(pcd, epnum);
04307 
04308                                 CLEAR_OUT_EP_INTR(core_if, epnum, nak);
04309                         }
04310                         <span class="comment">/* NYET Interrutp */</span>
04311                         <span class="keywordflow">if</span> (doepint.<a class="code" href="uniondoepint__data.html#o17">b</a>.<a class="code" href="uniondoepint__data.html#o15">nyet</a>) {
04312                                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"EP%d OUT NYET\n"</span>, epnum);
04313                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a55">handle_out_ep_nyet_intr</a>(pcd, epnum);
04314 
04315                                 CLEAR_OUT_EP_INTR(core_if, epnum, nyet);
04316                         }
04317                 }
04318 
04319                 epnum++;
04320                 ep_intr &gt;&gt;= 1;
04321         }
04322 
04323         <span class="keywordflow">return</span> 1;
04324 
04325 <span class="preprocessor">#undef CLEAR_OUT_EP_INTR</span>
04326 <span class="preprocessor"></span>}
04327 <span class="keyword">static</span> <span class="keywordtype">int</span> drop_transfer(uint32_t trgt_fr, uint32_t curr_fr, uint8_t frm_overrun)
04328 {
04329         <span class="keywordtype">int</span> retval = 0;
04330         <span class="keywordflow">if</span>(!frm_overrun &amp;&amp; curr_fr &gt;= trgt_fr) 
04331                 retval = 1;
04332         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frm_overrun &amp;&amp; (curr_fr &gt;= trgt_fr &amp;&amp; ((curr_fr - trgt_fr) &lt; 0x3FFF/2)))
04333                 retval = 1;
04334         <span class="keywordflow">return</span> retval;
04335 }
<a name="l04348"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a59">04348</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a59">dwc_otg_pcd_handle_incomplete_isoc_in_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
04349 {
04350         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
04351 
04352 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
04353 <span class="preprocessor"></span>        <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if;
04354         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz = {.<a class="code" href="uniondoepint__data.html#o0">d32</a> = 0 };
04355         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.<a class="code" href="uniondoepint__data.html#o0">d32</a> = 0 };
04356         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts = {.<a class="code" href="uniondoepint__data.html#o0">d32</a> = 0 };
04357         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
04358         <span class="keywordtype">int</span> i;
04359 
04360         dev_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if;
04361 
04362         <span class="keywordflow">for</span> (i = 1; i &lt;= dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; ++i) {
04363                 dwc_ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
04364                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o2">active</a> &amp;&amp; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
04365                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
04366                             DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o4">dieptsiz</a>);
04367                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> =
04368                             DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
04369 
04370                         <span class="keywordflow">if</span> (depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> &amp;&amp; deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a>) {
04371                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a40">set_current_pkt_info</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd), dwc_ep);
04372                                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a> &gt;= dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>) {
04373                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a> = 0;
04374                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> =
04375                                             (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> ^ 1) &amp; 0x1;
04376 
04377                                         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) {
04378                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> =
04379                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_19">xfer_buff1</a>;
04380                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> =
04381                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a>;
04382                                         } <span class="keywordflow">else</span> {
04383                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> =
04384                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_18">xfer_buff0</a>;
04385                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> =
04386                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
04387                                         }
04388 
04389                                 }
04390 
04391                                 dsts.<a class="code" href="uniondsts__data.html#o0">d32</a> =
04392                                     DWC_READ_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
04393                                                    dev_global_regs-&gt;dsts);
04394                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> = dsts.<a class="code" href="uniondsts__data.html#o7">b</a>.<a class="code" href="uniondsts__data.html#o5">soffn</a>;
04395 
04396                                 <a class="code" href="dwc__otg__cil_8h.html#a89">dwc_otg_iso_ep_start_frm_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>
04397                                                                   (pcd),
04398                                                                   dwc_ep);
04399                         }
04400                 }
04401         }
04402 
04403 <span class="preprocessor">#else</span>
04404 <span class="preprocessor"></span>        <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0 };
04405         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *dwc_ep;
04406         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if;
04407         <span class="keywordtype">int</span> i;
04408         dev_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if;
04409 
04410         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>,<span class="stringliteral">"Incomplete ISO IN \n"</span>);
04411         
04412         <span class="keywordflow">for</span> (i = 1; i &lt;= dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; ++i) {
04413                 dwc_ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i-1].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
04414                 depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> =
04415                         DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
04416                 <span class="keywordflow">if</span> (depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> &amp;&amp; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
04417                         <span class="keywordflow">if</span> (drop_transfer(dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_12">frame_num</a>, <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;frame_num, 
04418                                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_13">frm_overrun</a>))
04419                         {
04420                                 depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> =
04421                                         DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
04422                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o11">snak</a> = 1;
04423                                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> = 1;
04424                                 DWC_MODIFY_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
04425                         }
04426                 }
04427         }
04428 
04429         <span class="comment">/*intr_mask.b.incomplisoin = 1;</span>
04430 <span class="comment">        DWC_MODIFY_REG32(&amp;GET_CORE_IF(pcd)-&gt;core_global_regs-&gt;gintmsk,</span>
04431 <span class="comment">                         intr_mask.d32, 0);      */</span>
04432 <span class="preprocessor">#endif                          //DWC_EN_ISOC</span>
04433 <span class="preprocessor"></span>
04434         <span class="comment">/* Clear interrupt */</span>
04435         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
04436         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o21">incomplisoin</a> = 1;
04437         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintsts,
04438                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
04439 
04440         <span class="keywordflow">return</span> 1;
04441 }
04442 
<a name="l04458"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a60">04458</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a60">dwc_otg_pcd_handle_incomplete_isoc_out_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
04459 {
04460 
04461         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
04462 
04463 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
04464 <span class="preprocessor"></span>        <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if;
04465         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
04466         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
04467         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
04468         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
04469         <span class="keywordtype">int</span> i;
04470 
04471         dev_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if;
04472 
04473         <span class="keywordflow">for</span> (i = 1; i &lt;= dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o5">num_out_eps</a>; ++i) {
04474                 dwc_ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o18">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
04475                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o2">active</a> &amp;&amp;
04476                     pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>.<a class="code" href="structdwc__ep.html#o4">type</a> == DWC_OTG_EP_TYPE_ISOC) {
04477                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
04478                             DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o4">doeptsiz</a>);
04479                         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> =
04480                             DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>);
04481 
04482                         <span class="keywordflow">if</span> (depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> &amp;&amp; deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a>) {
04483                                 <a class="code" href="dwc__otg__pcd__intr_8c.html#a40">set_current_pkt_info</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd),
04484                                                      &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>);
04485                                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a> &gt;= dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_27">pkt_cnt</a>) {
04486                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_29">cur_pkt</a> = 0;
04487                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> =
04488                                             (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a> ^ 1) &amp; 0x1;
04489 
04490                                         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_20">proc_buf_num</a>) {
04491                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> =
04492                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_19">xfer_buff1</a>;
04493                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> =
04494                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_15">dma_addr1</a>;
04495                                         } <span class="keywordflow">else</span> {
04496                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_30">cur_pkt_addr</a> =
04497                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_18">xfer_buff0</a>;
04498                                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_31">cur_pkt_dma_addr</a> =
04499                                                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_14">dma_addr0</a>;
04500                                         }
04501 
04502                                 }
04503 
04504                                 dsts.<a class="code" href="uniondsts__data.html#o0">d32</a> =
04505                                     DWC_READ_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
04506                                                    dev_global_regs-&gt;dsts);
04507                                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#z32_26">next_frame</a> = dsts.<a class="code" href="uniondsts__data.html#o7">b</a>.<a class="code" href="uniondsts__data.html#o5">soffn</a>;
04508 
04509                                 <a class="code" href="dwc__otg__cil_8h.html#a89">dwc_otg_iso_ep_start_frm_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>
04510                                                                   (pcd),
04511                                                                   dwc_ep);
04512                         }
04513                 }
04514         }
04515 <span class="preprocessor">#else</span>
04516 <span class="preprocessor"></span>
04517         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.<a class="code" href="uniondsts__data.html#o0">d32</a> = 0 };
04518         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if;
04519         <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz = {.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> = 0 };
04520         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0 };
04521         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = {.<a class="code" href="uniondepctl__data.html#o0">d32</a> = 0 };
04522         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *dwc_ep = NULL;
04523         <span class="keywordtype">int</span> i;
04524         core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
04525 
04526         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o5">num_out_eps</a>; ++i) {
04527                 dwc_ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o19">out_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#o7">dwc_ep</a>;
04528                 depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> =
04529                         DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doepctl);
04530                 <span class="keywordflow">if</span> (depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a> &amp;&amp; depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o4">dpid</a> == (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o52">frame_num</a> &amp; 0x1)) {
04531                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o22">isoc_ep</a> = dwc_ep;      
04532                         deptsiz.<a class="code" href="uniondeptsiz__data.html#o0">d32</a> =
04533                                         DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doeptsiz);
04534                                 <span class="keywordflow">break</span>;
04535                 }
04536         }
04537         dctl.<a class="code" href="uniondctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>);
04538         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>);
04539         intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>);
04540 
04541         <span class="keywordflow">if</span> (!intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o8">goutnakeff</a>) {
04542                 <span class="comment">/* Unmask it */</span>
04543                 intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o8">goutnakeff</a> = 1;
04544                 DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>, intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>);
04545         }
04546         <span class="keywordflow">if</span> (!gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o8">goutnakeff</a>) {
04547                 dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o8">sgoutnak</a> = 1;
04548         }
04549         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>, dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
04550 
04551         depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doepctl);
04552         <span class="keywordflow">if</span> (depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a>) {
04553                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> = 1;
04554                 depctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o11">snak</a> = 1;
04555         }
04556         DWC_WRITE_REG32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o2">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doepctl, depctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
04557 
04558         intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a> = 0;
04559         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o22">incomplisoout</a> = 1;
04560                 
04561 <span class="preprocessor">#endif </span><span class="comment">/* DWC_EN_ISOC */</span>
04562 
04563         <span class="comment">/* Clear interrupt */</span>
04564         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
04565         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o22">incomplisoout</a> = 1;
04566         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintsts,
04567                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
04568 
04569         <span class="keywordflow">return</span> 1;
04570 }
04571 
<a name="l04576"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a61">04576</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a61">dwc_otg_pcd_handle_in_nak_effective</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
04577 {
04578         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if;
04579         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> diepctl = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
04580         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
04581         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
04582         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
04583         <span class="keywordtype">int</span> i;
04584 
04585         <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a2">DBG_PCD</a>, <span class="stringliteral">"Global IN NAK Effective\n"</span>);
04586 
04587         <span class="comment">/* Disable all active IN EPs */</span>
04588         <span class="keywordflow">for</span> (i = 0; i &lt;= dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o4">num_in_eps</a>; i++) {
04589                 diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>);
04590                 <span class="keywordflow">if</span> (!(diepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o6">eptype</a> &amp; 1) &amp;&amp; diepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a>) {
04591                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a> &gt; 0)
04592                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o49">start_predict</a>++;
04593                         diepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> = 1;
04594                         diepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o11">snak</a> = 1;
04595                         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o1">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#o0">diepctl</a>, diepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
04596                 }                                               
04597         }
04598         
04599 
04600         <span class="comment">/* Disable the Global IN NAK Effective Interrupt */</span>
04601         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o7">ginnakeff</a> = 1;
04602         DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintmsk,
04603                          intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
04604 
04605         <span class="comment">/* Clear interrupt */</span>
04606         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
04607         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o7">ginnakeff</a> = 1;
04608         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintsts,
04609                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
04610 
04611         <span class="keywordflow">return</span> 1;
04612 }
04613 
<a name="l04618"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a62">04618</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a62">dwc_otg_pcd_handle_out_nak_effective</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
04619 {
04620         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;dev_if;
04621         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0 };
04622         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
04623         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> doepctl;
04624         <span class="keywordtype">int</span> i;
04625 
04626         <span class="comment">/* Disable the Global OUT NAK Effective Interrupt */</span>
04627         intr_mask.<a class="code" href="uniongintmsk__data.html#o33">b</a>.<a class="code" href="uniongintmsk__data.html#o8">goutnakeff</a> = 1;
04628         DWC_MODIFY_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintmsk,
04629                 intr_mask.<a class="code" href="uniongintmsk__data.html#o0">d32</a>, 0);
04630         
04631         <span class="comment">/* If DEV OUT NAK enabled*/</span>
04632         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o0">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#o39">dev_out_nak</a>) {
04633                 <span class="comment">/* Run over all out endpoints to determine the ep number on</span>
04634 <span class="comment">                 * which the timeout has happened </span>
04635 <span class="comment">                 */</span>
04636                 <span class="keywordflow">for</span> (i = 0; i &lt;= dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o5">num_out_eps</a>; i++) {
04637                         <span class="keywordflow">if</span> ( pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o2">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#o36">ep_xfer_info</a>[i].state == 2 )
04638                                 <span class="keywordflow">break</span>;
04639                 }
04640                 <span class="keywordflow">if</span> (i &gt; dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o5">num_out_eps</a>) {
04641                         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl;
04642                         dctl.<a class="code" href="uniondctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;
04643                                 dev_global_regs-&gt;dctl);
04644                         dctl.<a class="code" href="uniondctl__data.html#o17">b</a>.<a class="code" href="uniondctl__data.html#o9">cgoutnak</a> = 1;
04645                         DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o0">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#o1">dctl</a>,
04646                                 dctl.<a class="code" href="uniondctl__data.html#o0">d32</a>);
04647                         <span class="keywordflow">goto</span> out;
04648                 }
04649 
04650                 <span class="comment">/* Disable the endpoint */</span>
04651                 doepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;
04652                                                                                 out_ep_regs[i]-&gt;doepctl);
04653                 <span class="keywordflow">if</span> (doepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a>) {
04654                         doepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> = 1;
04655                         doepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o11">snak</a> = 1;
04656                 }
04657                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>, doepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
04658                 <span class="keywordflow">return</span> 1;
04659         }
04660         <span class="comment">/* We come here from Incomplete ISO OUT handler */</span>
04661         <span class="keywordflow">if</span>(dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o22">isoc_ep</a>)
04662         {
04663                 <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a> = (<a class="code" href="structdwc__ep.html">dwc_ep_t</a> *)dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o22">isoc_ep</a>;
04664                 uint32_t epnum = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>;
04665                 <a class="code" href="uniondoepint__data.html">doepint_data_t</a> doepint;
04666                 doepint.<a class="code" href="uniondoepint__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#o0">num</a>]-&gt;doepint);
04667                 dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o22">isoc_ep</a> = NULL;
04668                 doepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a> = DWC_READ_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>);
04669                 DWC_PRINTF(<span class="stringliteral">"Before disable DOEPCTL = %08x\n"</span>, doepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
04670                 <span class="keywordflow">if</span> (doepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o15">epena</a>) {
04671                         doepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o14">epdis</a> = 1;
04672                         doepctl.<a class="code" href="uniondepctl__data.html#o16">b</a>.<a class="code" href="uniondepctl__data.html#o11">snak</a> = 1;
04673                 }
04674                 DWC_WRITE_REG32(&amp;dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#o2">out_ep_regs</a>[epnum]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#o0">doepctl</a>, doepctl.<a class="code" href="uniondepctl__data.html#o0">d32</a>);
04675                 <span class="keywordflow">return</span> 1;
04676         } <span class="keywordflow">else</span>
04677                 DWC_PRINTF(<span class="stringliteral">"INTERRUPT Handler not implemented for %s\n"</span>,
04678                            <span class="stringliteral">"Global OUT NAK Effective\n"</span>);
04679         
04680 out:
04681         <span class="comment">/* Clear interrupt */</span>
04682         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a> = 0;
04683         gintsts.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o8">goutnakeff</a> = 1;
04684         DWC_WRITE_REG32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gintsts,
04685                         gintsts.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
04686 
04687         <span class="keywordflow">return</span> 1;
04688 }
04689 
<a name="l04702"></a><a class="code" href="dwc__otg__pcd__intr_8c.html#a63">04702</a> int32_t <a class="code" href="dwc__otg__pcd__intr_8c.html#a63">dwc_otg_pcd_handle_intr</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
04703 {
04704         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#a3">GET_CORE_IF</a>(pcd);
04705 <span class="preprocessor">#ifdef VERBOSE</span>
04706 <span class="preprocessor"></span>        <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o1">core_global_regs</a>;
04707 <span class="preprocessor">#endif</span>
04708 <span class="preprocessor"></span>        <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintr_status;
04709         int32_t retval = 0;
04710 
04711         <span class="comment">/* Exit from ISR if core is hibernated */</span>
04712         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o45">hibernation_suspend</a> == 1) {
04713                 <span class="keywordflow">return</span> retval;
04714         }
04715 <span class="preprocessor">#ifdef VERBOSE</span>
04716 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a7">DBG_ANY</a>, <span class="stringliteral">"%s() gintsts=%08x  gintmsk=%08x\n"</span>,
04717                     __func__,
04718                     DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>),
04719                     DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>));
04720 <span class="preprocessor">#endif</span>
04721 <span class="preprocessor"></span>
04722         <span class="keywordflow">if</span> (dwc_otg_is_device_mode(core_if)) {
04723                 DWC_SPINLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
04724 <span class="preprocessor">#ifdef VERBOSE</span>
04725 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s() gintsts=%08x  gintmsk=%08x\n"</span>,
04726                             __func__,
04727                             DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>),
04728                             DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o6">gintmsk</a>));
04729 <span class="preprocessor">#endif</span>
04730 <span class="preprocessor"></span>
04731                 gintr_status.<a class="code" href="uniongintsts__data.html#o0">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#a107">dwc_otg_read_core_intr</a>(core_if);
04732 
04733                 <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s: gintsts&amp;gintmsk=%08x\n"</span>,
04734                             __func__, gintr_status.<a class="code" href="uniongintsts__data.html#o0">d32</a>);
04735 
04736                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o4">sofintr</a>) {
04737                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a10">dwc_otg_pcd_handle_sof_intr</a>(pcd);
04738                 }
04739                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o5">rxstsqlvl</a>) {
04740                         retval |=
04741                             <a class="code" href="dwc__otg__pcd__intr_8c.html#a11">dwc_otg_pcd_handle_rx_status_q_level_intr</a>(pcd);
04742                 }
04743                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o6">nptxfempty</a>) {
04744                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a13">dwc_otg_pcd_handle_np_tx_fifo_empty_intr</a>(pcd);
04745                 }
04746                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o8">goutnakeff</a>) {
04747                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a62">dwc_otg_pcd_handle_out_nak_effective</a>(pcd);
04748                 }
04749                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o10">i2cintr</a>) {
04750                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a16">dwc_otg_pcd_handle_i2c_intr</a>(pcd);
04751                 }
04752                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o11">erlysuspend</a>) {
04753                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a17">dwc_otg_pcd_handle_early_suspend_intr</a>(pcd);
04754                 }
04755                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o13">usbreset</a>) {
04756                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a19">dwc_otg_pcd_handle_usb_reset_intr</a>(pcd);
04757                 }
04758                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o14">enumdone</a>) {
04759                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a21">dwc_otg_pcd_handle_enum_done_intr</a>(pcd);
04760                 }
04761                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o15">isooutdrop</a>) {
04762                         retval |=
04763                             <a class="code" href="dwc__otg__pcd__intr_8c.html#a22">dwc_otg_pcd_handle_isoc_out_packet_dropped_intr</a>
04764                             (pcd);
04765                 }
04766                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o16">eopframe</a>) {
04767                         retval |=
04768                             <a class="code" href="dwc__otg__pcd__intr_8c.html#a23">dwc_otg_pcd_handle_end_periodic_frame_intr</a>(pcd);
04769                 }
04770                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o19">inepint</a>) {
04771                         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
04772                                 retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a56">dwc_otg_pcd_handle_in_ep_intr</a>(pcd);
04773                         }
04774                 }
04775                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o20">outepintr</a>) {
04776                         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
04777                                 retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a57">dwc_otg_pcd_handle_out_ep_intr</a>(pcd);
04778                         }
04779                 }
04780                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o18">epmismatch</a>) {
04781                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a24">dwc_otg_pcd_handle_ep_mismatch_intr</a>(pcd);
04782                 }
04783                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o23">fetsusp</a>) {
04784                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a25">dwc_otg_pcd_handle_ep_fetsusp_intr</a>(pcd);
04785                 }
04786                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o7">ginnakeff</a>) {
04787                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a61">dwc_otg_pcd_handle_in_nak_effective</a>(pcd);
04788                 }
04789                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o21">incomplisoin</a>) {
04790                         retval |=
04791                             <a class="code" href="dwc__otg__pcd__intr_8c.html#a59">dwc_otg_pcd_handle_incomplete_isoc_in_intr</a>(pcd);
04792                 }
04793                 <span class="keywordflow">if</span> (gintr_status.<a class="code" href="uniongintsts__data.html#o33">b</a>.<a class="code" href="uniongintsts__data.html#o22">incomplisoout</a>) {
04794                         retval |=
04795                             <a class="code" href="dwc__otg__pcd__intr_8c.html#a60">dwc_otg_pcd_handle_incomplete_isoc_out_intr</a>(pcd);
04796                 }
04797 
04798                 <span class="comment">/* In MPI mode Device Endpoints interrupts are asserted</span>
04799 <span class="comment">                 * without setting outepintr and inepint bits set, so these</span>
04800 <span class="comment">                 * Interrupt handlers are called without checking these bit-fields</span>
04801 <span class="comment">                 */</span>
04802                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#o17">multiproc_int_enable</a>) {
04803                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a56">dwc_otg_pcd_handle_in_ep_intr</a>(pcd);
04804                         retval |= <a class="code" href="dwc__otg__pcd__intr_8c.html#a57">dwc_otg_pcd_handle_out_ep_intr</a>(pcd);
04805                 }
04806 <span class="preprocessor">#ifdef VERBOSE</span>
04807 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__dbg_8h.html#a10">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#a3">DBG_PCDV</a>, <span class="stringliteral">"%s() gintsts=%0x\n"</span>, __func__,
04808                             DWC_READ_REG32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#o5">gintsts</a>));
04809 <span class="preprocessor">#endif</span>
04810 <span class="preprocessor"></span>                DWC_SPINUNLOCK(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#o20">lock</a>);
04811         }
04812         <span class="keywordflow">return</span> retval;
04813 }
04814 
04815 <span class="preprocessor">#endif </span><span class="comment">/* DWC_HOST_ONLY */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 27 03:56:38 2011 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
